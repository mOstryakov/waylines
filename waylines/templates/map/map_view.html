{% extends 'base.html' %}
{% load static %}

{% block title %}–ö–∞—Ä—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤ - Waylines{% endblock %}

{% block content %}
<div class="container-fluid h-100 p-0">
    <!-- –ö–∞—Ä—Ç–∞ -->
    <div id="map" class="h-100"></div>
    
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div class="route-loading" id="route-loading">
        <div class="spinner-border spinner-border-sm" role="status"></div>
        <span>–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞...</span>
    </div>

    <!-- –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ–π -->
    <div class="map-controls">
        <button id="style-toggle" class="btn btn-sm btn-outline-secondary">üõ∞Ô∏è –°–ø—É—Ç–Ω–∏–∫</button>
        <button id="locate-me" class="btn btn-sm btn-outline-secondary">üìç –ú–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</button>
        <button id="hide-all" class="btn btn-sm btn-outline-secondary">üëÅÔ∏è –°–∫—Ä—ã—Ç—å –≤—Å–µ</button>
        <button id="filter-toggle" class="btn btn-sm btn-outline-primary">üîç –§–∏–ª—å—Ç—Ä—ã</button>
    </div>

    <!-- –°–∞–π–¥–±–∞—Ä —Å –º–∞—Ä—à—Ä—É—Ç–∞–º–∏ -->
    <div class="sidebar">
        <div class="header">
            <h5>üó∫Ô∏è –ö–∞—Ä—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤</h5>
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-secondary" onclick="toggleSidebar()">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
        </div>

        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="filters-section mb-3">
            <div class="search-bar mb-2">
                <input type="text" id="search-routes" class="form-control form-control-sm" 
                       placeholder="–ü–æ–∏—Å–∫ –º–∞—Ä—à—Ä—É—Ç–æ–≤...">
            </div>
            
            <div class="filter-controls">
                <select id="category-filter" class="form-select form-select-sm mb-2">
                    <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                    <option value="attraction">‚≠ê –ò–∑—é–º–∏–Ω–∫–∏</option>
                    <option value="nature">üåø –ü—Ä–∏—Ä–æ–¥–∞</option>
                    <option value="city">üèôÔ∏è –ì–æ—Ä–æ–¥—Å–∫–∏–µ</option>
                    <option value="historical">üèõÔ∏è –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ</option>
                    <option value="food">üç¥ –ì–∞—Å—Ç—Ä–æ–Ω–æ–º–∏—è</option>
                </select>
                
                <select id="difficulty-filter" class="form-select form-select-sm mb-2">
                    <option value="">–õ—é–±–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å</option>
                    <option value="easy">üü¢ –õ–µ–≥–∫–∏–π</option>
                    <option value="medium">üü° –°—Ä–µ–¥–Ω–∏–π</option>
                    <option value="hard">üî¥ –°–ª–æ–∂–Ω—ã–π</option>
                </select>
                
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="audio-only" checked>
                    <label class="form-check-label" for="audio-only">–° –∞—É–¥–∏–æ–≥–∏–¥–æ–º</label>
                </div>
            </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –º–∞—Ä—à—Ä—É—Ç–æ–≤ -->
        <div class="routes-list" style="max-height: 60vh; overflow-y: auto;">
            <div class="section-title">
                <span>üìç</span>
                <span>–ü—É–±–ª–∏—á–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã</span>
                <span class="badge bg-primary ms-2" id="routes-count">{{ routes|length }}</span>
            </div>
            
            {% if routes %}
            <div id="routes-container">
                {% for route in routes %}
                <div class="route-card card mb-2" data-route-id="{{ route.id }}" 
                    data-category="{{ route.theme|default:'other' }}"
                    data-difficulty="{{ route.route_type|default:'medium' }}"
                    data-has-audio="{{ route.has_audio_guide|yesno:'true,false' }}">
                    
                    <!-- –§–æ—Ç–æ –º–∞—Ä—à—Ä—É—Ç–∞ -->
                    {% if route.photos.all %}
                    <div class="route-photos" style="height: 120px; overflow: hidden; border-radius: 8px 8px 0 0;">
                        <img src="{{ route.photos.first.image.url }}" 
                            alt="{{ route.photos.first.caption|default:route.name }}"
                            style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    {% endif %}
                    
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-start mb-1">
                            <h6 class="route-title mb-0">{{ route.name }}</h6>  <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º name -->
                            <div class="route-rating">
                                <i class="fas fa-star text-warning"></i>
                                <small>{{ route.avg_rating|default:0|floatformat:1 }}</small>  <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º avg_rating -->
                            </div>
                        </div>
                        
                        <p class="text-muted small mb-2">{{ route.short_description }}</p>
                        
                        <!-- –ú–∏–Ω–∏–∞—Ç—é—Ä—ã —Ñ–æ—Ç–æ -->
                        {% if route.photos.all %}
                        <div class="route-photo-thumbnails d-flex gap-1 mb-2">
                            {% for photo in route.photos.all|slice:":3" %}
                            <img src="{{ photo.image.url }}" 
                                alt="{{ photo.caption }}"
                                style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;"
                                title="{{ photo.caption }}">
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <div class="route-meta d-flex justify-content-between align-items-center">
                            <div class="route-tags">
                                {% if route.theme %}
                                <span class="badge bg-light text-dark me-1">{{ route.theme }}</span>  <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º theme -->
                                {% endif %}
                                {% if route.has_audio_guide %}
                                <span class="badge bg-info text-white">üéß –ê—É–¥–∏–æ</span>
                                {% endif %}
                            </div>
                            
                            <div class="route-stats">
                                <small class="text-muted">
                                    <i class="fas fa-route"></i> {{ route.total_distance|floatformat:1 }} –∫–º  <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º total_distance -->
                                </small>
                            </div>
                        </div>
                        
                        <div class="route-actions mt-2 d-flex gap-1">
                            <button class="btn btn-sm btn-outline-primary flex-fill" 
                                    onclick="showRouteOnMap({{ route.id }})">
                                <i class="fas fa-map-marker-alt"></i> –ù–∞ –∫–∞—Ä—Ç–µ
                            </button>
                            <button class="btn btn-sm btn-outline-success" 
                                    onclick="viewRouteDetails({{ route.id }})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" 
                                    onclick="addToFavorites({{ route.id }})">
                                <i class="far fa-heart"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="fas fa-route fa-2x text-muted mb-2"></i>
                <p class="text-muted small">–ü–æ–∫–∞ –Ω–µ—Ç –ø—É–±–ª–∏—á–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤</p>
                {% if user.is_authenticated %}
                <a href="{% url 'create_route' %}" class="btn btn-primary btn-sm">
                    –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –º–∞—Ä—à—Ä—É—Ç
                </a>
                {% endif %}
            </div>
            {% endif %}

            <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø—Ä–∏ –ø—É—Å—Ç–æ–π –∫–∞—Ä—Ç–µ -->
            <div class="text-center text-muted py-3 border-top" id="empty-map-hint">
                <i class="fas fa-map-marked-alt fa-2x mb-2"></i>
                <p class="small mb-1">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ</p>
                <p class="small">–ö–∞—Ä—Ç–∞ –±—É–¥–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –ø–æ–¥ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç</p>
            </div>
        </div>

        <!-- –î–µ—Ç–∞–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞ -->
        <div class="route-details mt-3" id="route-details" style="display: none;">
            <div class="card">
                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0" id="selected-route-title">–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞</h6>
                    <button type="button" class="btn-close btn-close-sm" onclick="closeRouteDetails()"></button>
                </div>
                <div class="card-body py-2">
                    <div id="selected-route-content">
                        <!-- –î–µ—Ç–∞–ª–∏ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª–µ–π –º–∞—Ä—à—Ä—É—Ç–∞ -->
<div class="modal fade" id="route-details-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="route-modal-title">–î–µ—Ç–∞–ª–∏ –º–∞—Ä—à—Ä—É—Ç–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="route-modal-content">
                <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button type="button" class="btn btn-primary" onclick="startRoute()">–ù–∞—á–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
    }

    main {
        height: 100vh;
        overflow: hidden;
        position: relative;
    }

    #map {
        height: 100%;
        width: 100%;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 1;
    }

    .map-controls {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 5;
        background: white;
        padding: 6px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .sidebar {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 380px;
        max-height: 95vh;
        background: white;
        padding: 16px;
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        overflow-y: auto;
        z-index: 10;
        transition: transform 0.3s ease;
    }

    .sidebar.collapsed {
        transform: translateX(calc(100% - 50px));
    }

    .route-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.9);
        padding: 10px 20px;
        border-radius: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 1000;
        display: none;
        align-items: center;
        gap: 10px;
    }
    
    .route-card {
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .route-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .route-card.active {
        border-color: #2563eb;
        background: #f0f9ff;
    }
    
    .route-title {
        font-size: 14px;
        font-weight: 600;
        color: #1a1a1a;
    }
    
    .section-title {
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .filters-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 12px;
    }
    
    .search-bar {
        display: flex;
        gap: 8px;
    }

    .route-photos {
        height: 120px;
        overflow: hidden;
        border-radius: 8px 8px 0 0;
    }

    .route-photos img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .route-photo-thumbnails {
        display: flex;
        gap: 4px;
        margin-bottom: 8px;
    }

    .route-photo-thumbnails img {
        width: 40px;
        height: 40px;
        object-fit: cover;
        border-radius: 4px;
        border: 1px solid #e5e7eb;
    }
    
    /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–æ–≤ */
    .route-line {
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        transition: all 0.3s ease;
    }
    
    .route-marker {
        background: #2563eb;
        border: 3px solid white;
        border-radius: 50%;
        color: white;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        transition: all 0.3s ease;
    }
    
    .route-marker:hover {
        transform: scale(1.1);
        z-index: 1000;
    }
    
    .route-marker.start {
        background: #10b981;
    }
    
    .route-marker.end {
        background: #ef4444;
    }
    
    .route-popup {
        min-width: 280px;
    }
    
    .route-popup h6 {
        color: #1f2937;
        margin-bottom: 8px;
    }
    
    .route-popup .btn-group {
        display: flex;
        gap: 6px;
        margin-top: 12px;
    }
    
    .route-popup .btn-group .btn {
        flex: 1;
        font-size: 12px;
        padding: 6px 10px;
    }
    
    .current-location-marker {
        background: #ff4444;
        border: 3px solid white;
        border-radius: 50%;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
    .route-line,
    .route-marker {
        animation: fadeInUp 0.5s ease;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    #empty-map-hint {
        display: block;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let map;
    let currentStyle = 'streets';
    let visibleRoutes = {};
    let routeLayers = {};
    let selectedRouteId = null;
    let allRoutes = {{ routes_json|safe }};
    let osmLayer, satelliteLayer;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
    function initMap() {
        console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã...');
        
        // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É —Å —Ü–µ–Ω—Ç—Ä–æ–º –≤ –ú–æ—Å–∫–≤–µ
        map = L.map('map').setView([55.7558, 37.6176], 10);
        
        // –ë–∞–∑–æ–≤—ã–π —Å–ª–æ–π OpenStreetMap
        osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        });
        
        // –°–ø—É—Ç–Ω–∏–∫–æ–≤—ã–π —Å–ª–æ–π (ArcGIS)
        satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, DigitalGlobe, GeoEye, Earthstar Geographics, CNES/Airbus DS, USDA, USGS, AeroGRID, IGN, and the GIS User Community',
            maxZoom: 19
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º OSM –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        osmLayer.addTo(map);
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        document.getElementById('style-toggle').addEventListener('click', toggleMapStyle);
        document.getElementById('locate-me').addEventListener('click', locateUser);
        document.getElementById('hide-all').addEventListener('click', hideAllRoutes);
        document.getElementById('filter-toggle').addEventListener('click', toggleFilters);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
        initFilters();
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤ (–Ω–æ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏—Ö —Å—Ä–∞–∑—É)
        loadRoutesToMap();
        
        console.log('–ö–∞—Ä—Ç–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        console.log('–î–æ—Å—Ç—É–ø–Ω–æ –º–∞—Ä—à—Ä—É—Ç–æ–≤:', allRoutes.length);
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π –∫–∞—Ä—Ç—ã
    function toggleMapStyle() {
        if (currentStyle === 'streets') {
            map.removeLayer(osmLayer);
            satelliteLayer.addTo(map);
            currentStyle = 'satellite';
            document.getElementById('style-toggle').textContent = 'üó∫Ô∏è –ö–∞—Ä—Ç–∞';
        } else {
            map.removeLayer(satelliteLayer);
            osmLayer.addTo(map);
            currentStyle = 'streets';
            document.getElementById('style-toggle').textContent = 'üõ∞Ô∏è –°–ø—É—Ç–Ω–∏–∫';
        }
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –Ω–∞ –∫–∞—Ä—Ç—É (–ù–ï –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—Ä–∞–∑—É)
    function loadRoutesToMap() {
        console.log('–ú–∞—Ä—à—Ä—É—Ç—ã –≥–æ—Ç–æ–≤—ã –∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—é:', allRoutes.length);
        // –ù–µ –¥–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä—à—Ä—É—Ç—ã –Ω–∞ –∫–∞—Ä—Ç—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    }
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ –Ω–∞ –∫–∞—Ä—Ç—É
    function addRouteToMap(route) {
        if (!route.points || route.points.length === 0) return;
        
        const routeId = route.id;
        visibleRoutes[routeId] = route;
        
        // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã –¥–ª—è —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞
        const markers = [];
        route.points.forEach((point, index) => {
            const marker = L.marker([point.lat, point.lng], {
                icon: createRouteMarkerIcon(index, route.points.length)
            });
            
            marker.bindPopup(createPointPopup(point, route));
            markers.push(marker);
        });
        
        // –°–æ–∑–¥–∞–µ–º –ª–∏–Ω–∏—é –º–∞—Ä—à—Ä—É—Ç–∞ –µ—Å–ª–∏ –µ—Å—Ç—å 2+ —Ç–æ—á–∫–∏
        let routeLine = null;
        let outline = null;
        let shadow = null;
        
        if (route.points.length >= 2) {
            const coordinates = route.points.map(p => [p.lat, p.lng]);
            
            // 1. –ö–æ–Ω—Ç—É—Ä –¥–ª—è –ª—É—á—à–µ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏
            outline = L.polyline(coordinates, {
                color: 'white',
                weight: 8,
                opacity: 0.7,
                lineJoin: 'round',
                lineCap: 'round'
            });
            
            // 2. –û—Å–Ω–æ–≤–Ω–∞—è –ª–∏–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
            routeLine = L.polyline(coordinates, {
                color: getRouteColor(route),
                weight: 6,
                opacity: 0.9,
                lineJoin: 'round',
                lineCap: 'round',
                className: 'route-line'
            });
            
            // 3. –¢–µ–Ω—å –¥–ª—è –æ–±—ä–µ–º–∞
            shadow = L.polyline(coordinates, {
                color: '#1e40af',
                weight: 10,
                opacity: 0.2,
                lineJoin: 'round',
                lineCap: 'round'
            });
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ª–æ–∏ –º–∞—Ä—à—Ä—É—Ç–∞
        routeLayers[routeId] = {
            markers: markers,
            line: routeLine,
            outline: outline,
            shadow: shadow,
            visible: false
        };
        
        console.log(`–ú–∞—Ä—à—Ä—É—Ç ${routeId} –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è`);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    function getRouteColor(route) {
        const colors = {
            'nature': '#10b981',
            'city': '#3b82f6',
            'historical': '#f59e0b',
            'food': '#ef4444',
            'attraction': '#8b5cf6',
            'other': '#2563eb'
        };
        return colors[route.category?.name] || colors[route.category] || '#2563eb';
    }
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –¥–ª—è –º–∞—Ä–∫–µ—Ä–∞ –º–∞—Ä—à—Ä—É—Ç–∞
    function createRouteMarkerIcon(index, total) {
        const isStart = index === 0;
        const isEnd = index === total - 1;
        
        let backgroundColor = '#2563eb';
        if (isStart) backgroundColor = '#10b981';
        if (isEnd) backgroundColor = '#ef4444';
        
        const content = isStart ? 'A' : isEnd ? 'B' : (index + 1).toString();
        
        return L.divIcon({
            className: 'route-marker' + (isStart ? ' start' : '') + (isEnd ? ' end' : ''),
            html: `<div style="width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; color: white; font-weight: bold; background: ${backgroundColor}; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4);">${content}</div>`,
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });
    }
    
    // –°–æ–∑–¥–∞–Ω–∏–µ popup –¥–ª—è —Ç–æ—á–∫–∏
    function createPointPopup(point, route) {
        return `
            <div class="route-popup">
                <h6>${point.name || '–¢–æ—á–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞'}</h6>
                <p class="small mb-2">${point.address || ''}</p>
                ${point.description ? `<p class="small text-muted">${point.description}</p>` : ''}
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-primary" onclick="viewRouteDetails(${route.id})">
                        –ú–∞—Ä—à—Ä—É—Ç
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="startRouteFromPoint(${route.id}, ${point.order || 0})">
                        –û—Ç—Å—é–¥–∞
                    </button>
                </div>
            </div>
        `;
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç –Ω–∞ –∫–∞—Ä—Ç–µ
    function showRouteOnMap(routeId) {
        const route = allRoutes.find(r => r.id === routeId);
        if (!route || !route.points || route.points.length === 0) {
            showToast('–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –∏–º–µ–µ—Ç —Ç–æ—á–µ–∫', 'warning');
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        document.getElementById('route-loading').style.display = 'flex';
        
        // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ä–∞–Ω–µ–µ –ø–æ–∫–∞–∑–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã
        Object.keys(routeLayers).forEach(id => {
            hideRoute(id);
        });
        
        // –ï—Å–ª–∏ –º–∞—Ä—à—Ä—É—Ç –µ—â–µ –Ω–µ –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ –∫–∞—Ä—Ç—É - –¥–æ–±–∞–≤–ª—è–µ–º
        if (!routeLayers[routeId]) {
            addRouteToMap(route);
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç
        showRoute(routeId);
        
        // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –º–∞—Ä—à—Ä—É—Ç–∞
        document.querySelectorAll('.route-card').forEach(card => {
            card.classList.remove('active');
        });
        const targetCard = document.querySelector(`.route-card[data-route-id="${routeId}"]`);
        if (targetCard) {
            targetCard.classList.add('active');
            targetCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –º–∞—Ä—à—Ä—É—Ç–∞ –≤ —Å–∞–π–¥–±–∞—Ä–µ
        showRouteDetailsSidebar(route);
        
        // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –æ –ø—É—Å—Ç–æ–π –∫–∞—Ä—Ç–µ
        document.getElementById('empty-map-hint').style.display = 'none';
        
        // –ü–æ–¥–≥–æ–Ω—è–µ–º –∫–∞—Ä—Ç—É –ø–æ–¥ –º–∞—Ä—à—Ä—É—Ç
        const coordinates = route.points.map(p => [p.lat, p.lng]);
        const bounds = L.latLngBounds(coordinates);
        map.fitBounds(bounds, { 
            padding: [20, 20],
            duration: 1
        });
        
        selectedRouteId = routeId;
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        setTimeout(() => {
            document.getElementById('route-loading').style.display = 'none';
        }, 500);
        
        showToast(`–ú–∞—Ä—à—Ä—É—Ç "${route.title}" –ø–æ–∫–∞–∑–∞–Ω –Ω–∞ –∫–∞—Ä—Ç–µ`, 'success');
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç
    function showRoute(routeId) {
        const layers = routeLayers[routeId];
        if (layers) {
            // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ —Å–ª–æ–∏ –Ω–∞ –∫–∞—Ä—Ç—É
            if (layers.shadow) map.addLayer(layers.shadow);
            if (layers.outline) map.addLayer(layers.outline);
            if (layers.line) map.addLayer(layers.line);
            layers.markers.forEach(marker => map.addLayer(marker));
            layers.visible = true;
        }
    }
    
    // –°–∫—Ä—ã—Ç—å –º–∞—Ä—à—Ä—É—Ç
    function hideRoute(routeId) {
        const layers = routeLayers[routeId];
        if (layers && layers.visible) {
            // –£–±–∏—Ä–∞–µ–º –≤—Å–µ —Å–ª–æ–∏ —Å –∫–∞—Ä—Ç—ã
            layers.markers.forEach(marker => map.removeLayer(marker));
            if (layers.line) map.removeLayer(layers.line);
            if (layers.outline) map.removeLayer(layers.outline);
            if (layers.shadow) map.removeLayer(layers.shadow);
            layers.visible = false;
        }
    }
    
    // –°–∫—Ä—ã—Ç—å –≤—Å–µ –º–∞—Ä—à—Ä—É—Ç—ã
    function hideAllRoutes() {
        Object.keys(routeLayers).forEach(id => {
            hideRoute(id);
        });
        document.querySelectorAll('.route-card').forEach(card => {
            card.classList.remove('active');
        });
        document.getElementById('route-details').style.display = 'none';
        document.getElementById('empty-map-hint').style.display = 'block';
        selectedRouteId = null;
        showToast('–í—Å–µ –º–∞—Ä—à—Ä—É—Ç—ã —Å–∫—Ä—ã—Ç—ã', 'info');
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –º–∞—Ä—à—Ä—É—Ç–∞ –≤ —Å–∞–π–¥–±–∞—Ä–µ
    function showRouteDetailsSidebar(route) {
        const detailsDiv = document.getElementById('route-details');
        const title = document.getElementById('selected-route-title');
        const content = document.getElementById('selected-route-content');
        
        title.textContent = route.title;
        
        let contentHtml = `
            <div class="mb-2">
                <p class="small mb-2">${route.description || route.short_description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}</p>
            </div>
            
            <div class="route-stats mb-3">
                <div class="d-flex justify-content-between small mb-1">
                    <span>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ:</span>
                    <strong>${route.distance ? route.distance.toFixed(1) : '?'} –∫–º</strong>
                </div>
                <div class="d-flex justify-content-between small mb-1">
                    <span>–¢–æ—á–µ–∫:</span>
                    <strong>${route.points.length}</strong>
                </div>
                <div class="d-flex justify-content-between small">
                    <span>–†–µ–π—Ç–∏–Ω–≥:</span>
                    <strong>
                        <i class="fas fa-star text-warning"></i>
                        ${route.rating || '0.0'}
                    </strong>
                </div>
            </div>
            
            <div class="route-tags mb-3">
                ${route.category ? `<span class="badge bg-light text-dark me-1">${route.category.name}</span>` : ''}
                ${route.has_audio ? `<span class="badge bg-info text-white">üéß –ê—É–¥–∏–æ–≥–∏–¥</span>` : ''}
            </div>
            
            <div class="route-actions d-grid gap-1">
                <button class="btn btn-primary btn-sm" onclick="startRoute(${route.id})">
                    <i class="fas fa-play"></i> –ù–∞—á–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç
                </button>
                <button class="btn btn-outline-primary btn-sm" onclick="viewRouteDetails(${route.id})">
                    <i class="fas fa-info-circle"></i> –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                </button>
            </div>
        `;
        
        content.innerHTML = contentHtml;
        detailsDiv.style.display = 'block';
    }
    
    // –ó–∞–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏ –º–∞—Ä—à—Ä—É—Ç–∞
    function closeRouteDetails() {
        document.getElementById('route-details').style.display = 'none';
        document.querySelectorAll('.route-card').forEach(card => {
            card.classList.remove('active');
        });
        selectedRouteId = null;
    }
    
    // –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–µ—Ç–∞–ª–µ–π –º–∞—Ä—à—Ä—É—Ç–∞ (–º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ)
    function viewRouteDetails(routeId) {
        const route = allRoutes.find(r => r.id === routeId);
        if (!route) return;
        
        const modalTitle = document.getElementById('route-modal-title');
        const modalContent = document.getElementById('route-modal-content');
        
        modalTitle.textContent = route.title;
        
        let contentHtml = `
            <div class="row">
                <div class="col-md-6">
                    <h6>–û–ø–∏—Å–∞–Ω–∏–µ</h6>
                    <p>${route.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}</p>
                    
                    <h6>–î–µ—Ç–∞–ª–∏ –º–∞—Ä—à—Ä—É—Ç–∞</h6>
                    <ul class="list-unstyled">
                        <li><strong>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ:</strong> ${route.distance ? route.distance.toFixed(1) : '?'} –∫–º</li>
                        <li><strong>–¢–æ—á–µ–∫:</strong> ${route.points.length}</li>
                        <li><strong>–¢–∏–ø:</strong> ${getRouteTypeText(route.difficulty)}</li>
                        <li><strong>–ê—É–¥–∏–æ–≥–∏–¥:</strong> ${route.has_audio ? '‚úÖ –ï—Å—Ç—å' : '‚ùå –ù–µ—Ç'}</li>
                    </ul>
                </div>
                
                <div class="col-md-6">
                    <h6>–¢–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞</h6>
                    <div style="max-height: 300px; overflow-y: auto;">
        `;
        
        if (route.points && route.points.length > 0) {
            route.points.forEach((point, index) => {
                contentHtml += `
                    <div class="card mb-2">
                        <div class="card-body py-2">
                            <div class="d-flex align-items-center">
                                <span class="badge bg-primary me-2">${index + 1}</span>
                                <div>
                                    <strong>${point.name || '–¢–æ—á–∫–∞ ' + (index + 1)}</strong>
                                    <br>
                                    <small class="text-muted">${point.address || ''}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        } else {
            contentHtml += '<p class="text-muted">–¢–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</p>';
        }
        
        contentHtml += `
                </div>
            </div>
        </div>
        `;
        
        modalContent.innerHTML = contentHtml;
        
        const modal = new bootstrap.Modal(document.getElementById('route-details-modal'));
        modal.show();
    }

    function getRouteTypeText(routeType) {
        const types = {
            'walking': 'üö∂ –ü–µ—à–∏–π',
            'driving': 'üöó –ê–≤—Ç–æ–º–æ–±–∏–ª—å–Ω—ã–π',
            'cycling': 'üö¥ –í–µ–ª–æ—Å–∏–ø–µ–¥–Ω—ã–π',
            'mixed': 'üîÄ –°–º–µ—à–∞–Ω–Ω—ã–π'
        };
        return types[routeType] || routeType;
    }
    
    // –ù–∞—á–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç
    function startRoute(routeId) {
        window.location.href = `/routes/${routeId || selectedRouteId}/`;
    }
    
    // –ù–∞—á–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π —Ç–æ—á–∫–∏
    function startRouteFromPoint(routeId, pointOrder) {
        window.location.href = `/routes/${routeId}/?start_from=${pointOrder}`;
    }
    
    // –î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
    function addToFavorites(routeId) {
        fetch(`/routes/${routeId}/favorite/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('–ú–∞—Ä—à—Ä—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ', 'success');
            } else {
                showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ', 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'danger');
        });
    }
    
    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
    function locateUser() {
        if (!navigator.geolocation) {
            showToast('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'warning');
            return;
        }
        
        document.getElementById('route-loading').style.display = 'flex';
        
        navigator.geolocation.getCurrentPosition(
            position => {
                const latlng = [position.coords.latitude, position.coords.longitude];
                map.setView(latlng, 16);
                document.getElementById('route-loading').style.display = 'none';
                showToast('–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ', 'success');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
                L.marker(latlng, {
                    icon: L.divIcon({
                        className: 'current-location-marker',
                        html: '<div style="background: #ff4444; border: 3px solid white; border-radius: 50%; width: 20px; height: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(map).bindPopup('–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ').openPopup();
            },
            error => {
                document.getElementById('route-loading').style.display = 'none';
                showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ', 'danger');
            }
        );
    }
    
    function toggleFilters() {
        const filtersSection = document.querySelector('.filters-section');
        filtersSection.style.display = filtersSection.style.display === 'none' ? 'block' : 'none';
    }
    
    function toggleSidebar() {
        const sidebar = document.querySelector('.sidebar');
        sidebar.classList.toggle('collapsed');
    }
    
    function initFilters() {
        const searchInput = document.getElementById('search-routes');
        const categoryFilter = document.getElementById('category-filter');
        const difficultyFilter = document.getElementById('difficulty-filter');
        const audioOnly = document.getElementById('audio-only');
        
        [searchInput, categoryFilter, difficultyFilter, audioOnly].forEach(element => {
            element.addEventListener('change', applyFilters);
        });
    }
    
    function applyFilters() {
        const searchTerm = document.getElementById('search-routes').value.toLowerCase();
        const category = document.getElementById('category-filter').value;
        const difficulty = document.getElementById('difficulty-filter').value;
        const audioOnly = document.getElementById('audio-only').checked;
        
        let visibleCount = 0;
        
        document.querySelectorAll('.route-card').forEach(card => {
            const routeId = card.dataset.routeId;
            const routeCategory = card.dataset.category;
            const routeDifficulty = card.dataset.difficulty;
            const hasAudio = card.dataset.hasAudio === 'true';
            const title = card.querySelector('.route-title').textContent.toLowerCase();
            
            const matchesSearch = !searchTerm || title.includes(searchTerm);
            const matchesCategory = !category || routeCategory === category;
            const matchesDifficulty = !difficulty || routeDifficulty === difficulty;
            const matchesAudio = !audioOnly || hasAudio;
            
            if (matchesSearch && matchesCategory && matchesDifficulty && matchesAudio) {
                card.style.display = 'block';
                visibleCount++;
            } else {
                card.style.display = 'none';
                // –°–∫—Ä—ã–≤–∞–µ–º –º–∞—Ä—à—Ä—É—Ç –Ω–∞ –∫–∞—Ä—Ç–µ –µ—Å–ª–∏ –æ–Ω –ø–æ–∫–∞–∑–∞–Ω
                if (routeLayers[routeId] && routeLayers[routeId].visible) {
                    hideRoute(routeId);
                    card.classList.remove('active');
                }
            }
        });
        
        document.getElementById('routes-count').textContent = visibleCount;
    }
    
    function getDifficultyText(difficulty) {
        const difficulties = {
            'easy': 'üü¢ –õ–µ–≥–∫–∏–π',
            'medium': 'üü° –°—Ä–µ–¥–Ω–∏–π',
            'hard': 'üî¥ –°–ª–æ–∂–Ω—ã–π'
        };
        return difficulties[difficulty] || '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
    }
    
    function showToast(msg, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type} border-0 position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 2000;';
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${msg}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        document.body.appendChild(toast);
        
        const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
        bsToast.show();
        
        toast.addEventListener('hidden.bs.toast', () => {
            document.body.removeChild(toast);
        });
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        initMap();
    });
</script>
{% endblock %}