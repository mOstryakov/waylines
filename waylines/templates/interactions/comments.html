{% extends 'base.html' %}
{% load static %}

{% block title %}–ß–∞—Ç —Å {{ other_user.username }} - Waylines{% endblock %}

{% block content %}
<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
<div id="notifications" class="notifications-container"></div>

<div class="container-fluid h-100 p-0">
    <div class="row g-0 h-100">
        <!-- –ß–∞—Ç -->
        <div class="col-12" id="chat-main-col">
            <div class="chat-container h-100 d-flex flex-column bg-light">
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ -->
                <div class="chat-header bg-white border-bottom p-4 shadow-sm">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <a href="{% url 'chat:chat_dashboard' %}" class="btn btn-sm btn-outline-secondary me-3">
                                <i class="fas fa-arrow-left"></i>
                            </a>
                            <button class="btn btn-sm btn-outline-info me-3 d-md-none" onclick="toggleUserInfo()">
                                <i class="fas fa-info-circle"></i>
                            </button>
                            <div class="position-relative me-3">
                                <div class="avatar bg-gradient-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                     style="width: 50px; height: 50px; font-size: 18px; font-weight: 600;">
                                    {{ other_user.username|first|upper }}
                                </div>
                                <div class="position-absolute bottom-0 end-0 bg-success rounded-circle border border-2 border-white"
                                     style="width: 12px; height: 12px;"></div>
                            </div>
                            <div>
                                <h5 class="mb-1 fw-bold">{{ other_user.username }}</h5>
                                <small class="text-muted" id="last-activity">
                                    <i class="fas fa-circle text-success me-1" style="font-size: 8px;"></i>
                                    <span id="activity-text">
                                        {% if other_user.is_online %}
                                            –í —Å–µ—Ç–∏
                                        {% else %}
                                            –ë—ã–ª(–∞) {{ other_user.last_seen|timesince }} –Ω–∞–∑–∞–¥
                                        {% endif %}
                                    </span>
                                </small>
                            </div>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-light rounded-circle" type="button" data-bs-toggle="dropdown"
                                    style="width: 40px; height: 40px;">
                                <i class="fas fa-ellipsis-v text-muted"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                                <li><a class="dropdown-item" href="#" onclick="toggleUserInfo()">
                                    <i class="fas fa-info-circle me-2"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                                </a></li>
                                <li><a class="dropdown-item" href="{% url 'user_profile' other_user.username %}">
                                    <i class="fas fa-user me-2"></i> –ü—Ä–æ—Ñ–∏–ª—å
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="blockUser()">
                                    <i class="fas fa-ban me-2"></i> –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="refreshChat()">
                                    <i class="fas fa-sync-alt me-2"></i> –û–±–Ω–æ–≤–∏—Ç—å —á–∞—Ç
                                </a></li>
                                <li><a class="dropdown-item" href="{% url 'chat:chat_dashboard' %}">
                                    <i class="fas fa-comments me-2"></i> –í—Å–µ —á–∞—Ç—ã
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
                <div class="chat-messages flex-grow-1 p-4" id="chat-messages" 
                     style="overflow-y: auto; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                    {% for message in messages %}
                    <div class="message-wrapper mb-4 {% if message.sender == request.user %}own-message{% endif %}" 
                         data-message-id="{{ message.id }}">
                        <div class="message-bubble {% if message.sender == request.user %}own-bubble{% else %}other-bubble{% endif %}">
                            {% if message.sender != request.user %}
                            <div class="message-sender mb-1">
                                <small class="text-primary fw-bold">{{ message.sender.username }}</small>
                            </div>
                            {% endif %}
                            <div class="message-content">
                                {% if message.message_type == 'text' %}
                                    {{ message.content|linebreaks }}
                                {% elif message.message_type == 'image' %}
                                    <div class="media-message">
                                        <img src="{{ message.content }}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" class="img-fluid rounded" style="max-width: 300px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                        <div class="media-error" style="display: none; padding: 20px; text-align: center; color: #6c757d;">
                                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                            <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</p>
                                        </div>
                                    </div>
                                {% elif message.message_type == 'video' %}
                                    <div class="media-message">
                                        <video controls class="img-fluid rounded" style="max-width: 300px;">
                                            <source src="{{ message.content }}" type="video/mp4">
                                            –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
                                        </video>
                                    </div>
                                {% elif message.message_type == 'audio' %}
                                    <div class="media-message">
                                        <audio controls class="w-100">
                                            <source src="{{ message.content }}" type="audio/mpeg">
                                            –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ.
                                        </audio>
                                    </div>
                                {% elif message.message_type == 'voice' %}
                                    <div class="voice-message d-flex align-items-center">
                                        <button class="btn btn-sm btn-outline-primary play-voice-btn me-2" data-audio-url="{{ message.content }}">
                                            <i class="fas fa-play"></i>
                                        </button>
                                        <div class="voice-waveform flex-grow-1 me-2">
                                            <div class="waveform-bar"></div>
                                            <div class="waveform-bar"></div>
                                            <div class="waveform-bar"></div>
                                            <div class="waveform-bar"></div>
                                            <div class="waveform-bar"></div>
                                        </div>
                                        <small class="text-muted voice-duration">0:00</small>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="message-time text-end mt-1">
                                <small class="text-muted message-timestamp" data-timestamp="{{ message.created_at|date:'c' }}">
                                    {{ message.created_at|date:"H:i" }}
                                </small>
                                {% if message.sender == request.user %}
                                <i class="fas fa-check-double text-primary ms-1" style="font-size: 10px;"></i>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center text-muted py-5" id="empty-chat-message">
                        <div class="empty-state-icon mb-4">
                            <i class="fas fa-comments fa-4x text-light"></i>
                        </div>
                        <h4 class="fw-light">–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥</h4>
                        <p class="text-muted">–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ {{ other_user.username }}</p>
                    </div>
                    {% endfor %}
                </div>

                <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
                <div id="chat-loading" class="text-center py-3 bg-white border-top" style="display: none;">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                    <small class="text-muted ms-2">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</small>
                </div>

                <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è -->
                <div id="typing-indicator" class="px-4 py-2 bg-white border-top" style="display: none;">
                    <div class="typing-dots">
                        <small class="text-muted">
                            <i class="fas fa-pencil-alt me-2"></i>
                            <span id="typing-user">{{ other_user.username }}</span> –ø–µ—á–∞—Ç–∞–µ—Ç
                            <span class="typing-animation"></span>
                        </small>
                    </div>
                </div>

                <!-- –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è -->
                <div class="chat-input bg-white border-top p-3 shadow-sm">
                    <!-- –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
                    <div class="text-end mb-2">
                        <small class="text-muted user-timezone-info" id="user-timezone"></small>
                    </div>
                    
                    <!-- –ú–µ–¥–∏–∞-–ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä -->
                    <div id="media-preview" class="mb-3" style="display: none;">
                        <div class="d-flex align-items-center bg-light rounded p-2">
                            <div id="preview-content" class="flex-grow-1"></div>
                            <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="clearMedia()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <form id="chat-form" class="d-flex align-items-end gap-2" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="conversation_id" value="{{ conversation.id }}">
                        
                        <div class="flex-grow-1 position-relative">
                            <div class="input-group">
                                <div class="btn-group me-2">
                                    <button type="button" class="btn btn-outline-secondary rounded-circle d-flex align-items-center justify-content-center"
                                            style="width: 40px; height: 40px;" data-bs-toggle="dropdown">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <ul class="dropdown-menu shadow border-0 p-2">
                                        <li>
                                            <button type="button" class="dropdown-item d-flex align-items-center py-2" onclick="triggerFileInput('image')">
                                                <i class="fas fa-image text-success me-2"></i>
                                                <span>–§–æ—Ç–æ</span>
                                            </button>
                                        </li>
                                        <li>
                                            <button type="button" class="dropdown-item d-flex align-items-center py-2" onclick="triggerFileInput('video')">
                                                <i class="fas fa-video text-info me-2"></i>
                                                <span>–í–∏–¥–µ–æ</span>
                                            </button>
                                        </li>
                                        <li>
                                            <button type="button" class="dropdown-item d-flex align-items-center py-2" onclick="triggerFileInput('audio')">
                                                <i class="fas fa-music text-warning me-2"></i>
                                                <span>–ê—É–¥–∏–æ</span>
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                                
                                <!-- –¢–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥ -->
                                <input type="text" 
                                       class="form-control border-end-0" 
                                       id="chat-message-input" 
                                       name="message"
                                       placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                                       maxlength="1000"
                                       autocomplete="off"
                                       style="border-radius: 25px; padding: 12px 20px; border: 1px solid #e0e0e0;">
                                
                                <button type="button" class="btn btn-outline-secondary border-start-0" 
                                        style="border-radius: 0 25px 25px 0; border: 1px solid #e0e0e0;">
                                    <i class="fas fa-smile"></i>
                                </button>
                            </div>
                            
                            <!-- –°–∫—Ä—ã—Ç—ã–µ –∏–Ω–ø—É—Ç—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ -->
                            <input type="file" id="file-input" name="media_file" accept="image/*,video/*,audio/*" style="display: none;">
                            <input type="file" id="image-input" name="media_file" accept="image/*" style="display: none;">
                            <input type="file" id="video-input" name="media_file" accept="video/*" style="display: none;">
                            <input type="file" id="audio-input" name="media_file" accept="audio/*" style="display: none;">
                        </div>
                        
                        <!-- –ö–Ω–æ–ø–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è -->
                        <button type="button" class="btn btn-outline-primary rounded-circle d-flex align-items-center justify-content-center voice-toggle-btn" 
                                id="voice-toggle-btn"
                                style="width: 50px; height: 50px;"
                                onmousedown="startVoiceRecording()" 
                                onmouseup="stopVoiceRecording()"
                                onmouseleave="stopVoiceRecording()"
                                ontouchstart="startVoiceRecording()" 
                                ontouchend="stopVoiceRecording()">
                            <i class="fas fa-microphone"></i>
                        </button>
                        
                        <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è -->
                        <button type="submit" class="btn btn-primary rounded-circle d-flex align-items-center justify-content-center" 
                                id="chat-message-submit"
                                style="width: 50px; height: 50px;">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                    
                    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è -->
                    <div id="voice-recording-indicator" class="mt-3 text-center" style="display: none;">
                        <div class="d-flex align-items-center justify-content-center">
                            <div class="recording-animation me-3">
                                <div class="pulse"></div>
                                <i class="fas fa-microphone text-danger"></i>
                            </div>
                            <div class="recording-info">
                                <div class="recording-timer">
                                    <span id="voice-recording-time">0:00</span>
                                </div>
                                <small class="text-muted">–ó–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è...</small>
                            </div>
                            <button type="button" class="btn btn-danger btn-sm ms-3" onclick="cancelVoiceRecording()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-2 d-flex justify-content-between align-items-center px-2">
                        <small class="text-muted" id="char-counter">0/1000</small>
                        <small class="text-muted">
                            <i class="fas fa-bolt me-1 text-success"></i>
                            <span id="connection-status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –°–∞–π–¥–±–∞—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
<div class="user-info-sidebar-overlay" id="user-info-overlay" style="display: none;"></div>
<div class="user-info-sidebar" id="user-info-sidebar">
    <div class="user-info-content">
        <div class="user-info-header">
            <h5 class="fw-bold mb-0">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h5>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleUserInfo()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="user-info-body">
            <div class="text-center mb-4">
                <div class="position-relative mx-auto mb-3">
                    <div class="avatar bg-gradient-primary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto" 
                         style="width: 100px; height: 100px; font-size: 32px; font-weight: 600;">
                        {{ other_user.username|first|upper }}
                    </div>
                    <div class="position-absolute bottom-0 end-0 bg-success rounded-circle border border-3 border-white"
                         style="width: 20px; height: 20px;"></div>
                </div>
                <h5 class="fw-bold">{{ other_user.username }}</h5>
                <p class="text-muted mb-3">–£—á–∞—Å—Ç–Ω–∏–∫ Waylines</p>
                <div class="online-status">
                    <span class="badge bg-success bg-opacity-10 text-success px-3 py-2 rounded-pill" id="online-status">
                        <i class="fas fa-circle me-1" style="font-size: 8px;"></i>–í —Å–µ—Ç–∏
                    </span>
                </div>
            </div>

            <div class="mb-4">
                <h6 class="fw-semibold text-uppercase small mb-3">–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
                <div class="info-grid">
                    <div class="info-item d-flex justify-content-between align-items-center py-2 border-bottom">
                        <span class="text-muted">–ú–∞—Ä—à—Ä—É—Ç—ã</span>
                        <strong class="text-primary">{{ other_user.routes.count }}</strong>
                    </div>
                    <div class="info-item d-flex justify-content-between align-items-center py-2 border-bottom">
                        <span class="text-muted">–î—Ä—É–∑—å—è</span>
                        <strong class="text-primary">{{ accepted_friends_count }}</strong>
                    </div>
                    <div class="info-item d-flex justify-content-between align-items-center py-2 border-bottom">
                        <span class="text-muted">–°—Ç–∞—Ç—É—Å</span>
                        <strong class="text-success" id="last-seen">–í —Å–µ—Ç–∏</strong>
                    </div>
                    <div class="info-item d-flex justify-content-between align-items-center py-2">
                        <span class="text-muted">–í —á–∞—Ç–µ —Å</span>
                        <strong>{{ conversation.created_at|date:"d.m.Y" }}</strong>
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <h6 class="fw-semibold text-uppercase small mb-3">–î–µ–π—Å—Ç–≤–∏—è</h6>
                <div class="d-grid gap-2">
                    <a href="{% url 'user_profile' other_user.username %}" class="btn btn-outline-primary btn-sm py-2">
                        <i class="fas fa-user me-2"></i> –ü—Ä–æ—Ñ–∏–ª—å
                    </a>
                    <a href="{% url 'all_routes' %}?author={{ other_user.username }}" class="btn btn-outline-success btn-sm py-2">
                        <i class="fas fa-route me-2"></i> –ú–∞—Ä—à—Ä—É—Ç—ã
                    </a>
                    <button class="btn btn-outline-info btn-sm py-2" onclick="startRouteChat()">
                        <i class="fas fa-map-marked-alt me-2"></i> –û–±—â–∏–π –º–∞—Ä—à—Ä—É—Ç
                    </button>
                </div>
            </div>

            <div class="mt-auto">
                <div class="d-grid gap-2">
                    <button class="btn btn-warning btn-sm py-2" onclick="refreshChat()">
                        <i class="fas fa-sync-alt me-2"></i> –û–±–Ω–æ–≤–∏—Ç—å —á–∞—Ç
                    </button>
                    <a href="{% url 'chat:chat_dashboard' %}" class="btn btn-outline-secondary btn-sm py-2">
                        <i class="fas fa-comments me-2"></i> –í—Å–µ —á–∞—Ç—ã
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ —á–∞—Ç–∞ */
.chat-container {
    background: #f8f9fa;
    transition: all 0.3s ease;
}

.chat-messages {
    max-height: calc(100vh - 280px);
    min-height: 400px;
    scroll-behavior: smooth;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π */
.message-wrapper {
    display: flex;
    flex-direction: column;
}

.own-message {
    align-items: flex-end;
}

.other-message {
    align-items: flex-start;
}

.message-bubble {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 18px;
    position: relative;
    animation: messageSlideIn 0.3s ease-out;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.own-bubble {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    border-bottom-right-radius: 6px;
}

.other-bubble {
    background: white;
    color: #333;
    border-bottom-left-radius: 6px;
    border: 1px solid #e9ecef;
}

.message-content {
    line-height: 1.4;
    word-wrap: break-word;
}

.message-time {
    font-size: 0.75rem;
    opacity: 0.8;
}

.message-sender {
    font-size: 0.8rem;
    font-weight: 600;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –º–µ–¥–∏–∞-—Å–æ–æ–±—â–µ–Ω–∏–π */
.media-message img,
.media-message video {
    max-width: 100%;
    border-radius: 12px;
}

.voice-message {
    padding: 8px 12px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 20px;
}

.voice-waveform {
    display: flex;
    align-items: center;
    height: 30px;
}

.waveform-bar {
    width: 3px;
    height: 20px;
    background-color: currentColor;
    margin: 0 1px;
    border-radius: 2px;
    animation: waveform 1.5s ease-in-out infinite;
}

.waveform-bar:nth-child(2) { animation-delay: 0.2s; }
.waveform-bar:nth-child(3) { animation-delay: 0.4s; }
.waveform-bar:nth-child(4) { animation-delay: 0.6s; }
.waveform-bar:nth-child(5) { animation-delay: 0.8s; }

@keyframes waveform {
    0%, 100% { height: 10px; }
    50% { height: 20px; }
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ */
@keyframes messageSlideIn {
    from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—á–∞—Ç–∏ */
.typing-animation::after {
    content: '...';
    animation: typing 1.5s infinite;
}

@keyframes typing {
    0%, 20% { content: '.'; }
    40% { content: '..'; }
    60%, 100% { content: '...'; }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∞–≤–∞—Ç–∞—Ä–æ–≤ */
.avatar {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.bg-gradient-primary {
    background: linear-gradient(135deg, #007bff, #6610f2) !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è */
.empty-state-icon {
    opacity: 0.5;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
.chat-messages::-webkit-scrollbar {
    width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 10px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
.notifications-container {
    position: fixed;
    top: 80px;
    right: 20px;
    z-index: 1060;
    max-width: 350px;
    width: 100%;
}

.notification {
    background: white;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 10px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    border-left: 4px solid;
    transform: translateX(400px);
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    position: relative;
    overflow: hidden;
}

.notification.show {
    transform: translateX(0);
    opacity: 1;
}

.notification.hide {
    transform: translateX(400px);
    opacity: 0;
}

.notification-success {
    border-left-color: #10b981;
    color: #065f46;
}

.notification-error {
    border-left-color: #ef4444;
    color: #7f1d1d;
}

.notification-warning {
    border-left-color: #f59e0b;
    color: #78350f;
}

.notification-info {
    border-left-color: #3b82f6;
    color: #1e3a8a;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∞–π–¥–±–∞—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ */
.user-info-sidebar {
    position: fixed;
    top: 0;
    right: -400px;
    width: 350px;
    height: 100vh;
    background: white;
    box-shadow: -5px 0 15px rgba(0,0,0,0.1);
    z-index: 1040;
    transition: right 0.3s ease;
    overflow-y: auto;
}

.user-info-sidebar.active {
    right: 0;
}

.user-info-sidebar-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1039;
    display: none;
}

.user-info-content {
    height: 100%;
    display: flex;
    flex-direction: column;
}

.user-info-header {
    padding: 20px;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.user-info-body {
    padding: 20px;
    flex: 1;
    display: flex;
    flex-direction: column;
}

.info-grid .info-item {
    transition: background-color 0.2s ease;
}

.info-grid .info-item:hover {
    background-color: #f8f9fa;
    border-radius: 8px;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .chat-messages {
        max-height: calc(100vh - 200px);
        padding: 16px;
    }
    .message-bubble {
        max-width: 85%;
    }
    .notifications-container {
        right: 10px;
        left: 10px;
        max-width: none;
    }
    
    .user-info-sidebar {
        width: 100%;
        right: -100%;
    }
}

/* –≠—Ñ—Ñ–µ–∫—Ç—ã –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
.btn:hover {
    transform: translateY(-1px);
    transition: all 0.2s ease;
}

.message-bubble:hover {
    transform: translateY(-1px);
    transition: all 0.2s ease;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–µ–¥–∏–∞ */
#media-preview img,
#media-preview video {
    max-width: 150px;
    max-height: 150px;
    border-radius: 8px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π */
.recording-animation {
    position: relative;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.pulse {
    position: absolute;
    width: 100%;
    height: 100%;
    background-color: #dc3545;
    border-radius: 50%;
    animation: pulse 1.5s infinite;
    opacity: 0.6;
}

@keyframes pulse {
    0% {
        transform: scale(0.8);
        opacity: 0.6;
    }
    50% {
        transform: scale(1.2);
        opacity: 0.3;
    }
    100% {
        transform: scale(0.8);
        opacity: 0.6;
    }
}

.voice-toggle-btn.recording {
    background-color: #dc3545 !important;
    border-color: #dc3545 !important;
    color: white !important;
    animation: recordingPulse 1s infinite;
}

@keyframes recordingPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

#voice-recording-indicator {
    background: linear-gradient(135deg, #ffe6e6, #ffcccc);
    border-radius: 25px;
    padding: 12px 20px;
    border: 2px solid #dc3545;
}

/* –°–¥–≤–∏–≥ —á–∞—Ç–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–º —Å–∞–π–¥–±–∞—Ä–µ */
body.sidebar-open #chat-main-col {
    margin-right: 350px;
    transition: margin-right 0.3s ease;
}

@media (max-width: 768px) {
    body.sidebar-open #chat-main-col {
        margin-right: 0;
    }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –æ—à–∏–±–æ–∫ –º–µ–¥–∏–∞ */
.media-error {
    background: #f8f9fa;
    border-radius: 12px;
    border: 2px dashed #dee2e6;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ */
.user-timezone-info {
    font-size: 0.75rem;
    opacity: 0.7;
    cursor: help;
    display: inline-block;
    padding: 2px 8px;
    background: rgba(0, 123, 255, 0.1);
    border-radius: 12px;
    border: 1px solid rgba(0, 123, 255, 0.2);
}
</style>
{% endblock %}

{% block extra_js %}
<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º moment.js –∏ moment-timezone –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤—Ä–µ–º–µ–Ω–µ–º -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.43/moment-timezone-with-data.min.js"></script>

<script>
// ==================== –ù–ê–°–¢–†–û–ô–ö–ò –õ–û–ö–ê–õ–ò –ò –ß–ê–°–û–í–û–ì–û –ü–û–Ø–°–ê ====================

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —è–∑—ã–∫ –±—Ä–∞—É–∑–µ—Ä–∞
function getBrowserLocale() {
    return navigator.language || navigator.userLanguage || 'ru-RU';
}

// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å moment.js
function setupMomentLocale() {
    const browserLocale = getBrowserLocale();
    const language = browserLocale.split('-')[0];
    
    // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ª–æ–∫–∞–ª–∏ –≤ moment.js
    const supportedLocales = [
        'ru', 'en', 'fr', 'de', 'es', 'it', 'zh', 'ja', 'ko', 'ar',
        'pt', 'nl', 'pl', 'tr', 'sv', 'da', 'fi', 'no', 'cs', 'hu'
    ];
    
    if (supportedLocales.includes(language)) {
        moment.locale(language);
        console.log(`üåê –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ª–æ–∫–∞–ª—å: ${language}`);
    } else {
        moment.locale('en');
        console.log(`üåê –Ø–∑—ã–∫ ${language} –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–Ω–≥–ª–∏–π—Å–∫–∏–π`);
    }
}

// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function showUserTimezone() {
    const timezone = moment.tz.guess();
    const timezoneElement = document.getElementById('user-timezone');
    
    if (timezoneElement) {
        const offset = moment().tz(timezone).format('Z');
        const timezoneName = timezone.replace(/_/g, ' ');
        
        // –õ–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
        const timezoneText = {
            'ru': `–í–∞—à —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å: ${timezoneName} (UTC${offset})`,
            'en': `Your timezone: ${timezoneName} (UTC${offset})`,
            'de': `Ihre Zeitzone: ${timezoneName} (UTC${offset})`,
            'fr': `Votre fuseau horaire: ${timezoneName} (UTC${offset})`,
            'es': `Su zona horaria: ${timezoneName} (UTC${offset})`,
            'zh': `ÊÇ®ÁöÑÊó∂Âå∫: ${timezoneName} (UTC${offset})`,
            'ja': `„ÅÇ„Å™„Åü„ÅÆ„Çø„Ç§„É†„Çæ„Éº„É≥: ${timezoneName} (UTC${offset})`,
            'ko': `Í∑ÄÌïòÏùò ÏãúÍ∞ÑÎåÄ: ${timezoneName} (UTC${offset})`,
            'ar': `ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ≤ŸÖŸÜŸäÿ© ÿßŸÑÿÆÿßÿµÿ© ÿ®ŸÉ: ${timezoneName} (UTC${offset})`
        };
        
        const currentLocale = moment.locale();
        const text = timezoneText[currentLocale] || timezoneText['en'];
        timezoneElement.textContent = text;
        timezoneElement.title = text;
    }
}

// –õ–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —è–∑—ã–∫–æ–≤
const localeStrings = {
    ru: {
        justNow: '—Ç–æ–ª—å–∫–æ —á—Ç–æ',
        minutesAgo: '–º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥',
        hoursAgo: '—á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥',
        yesterday: '–≤—á–µ—Ä–∞',
        today: '—Å–µ–≥–æ–¥–Ω—è',
        at: '–≤',
        online: '–í —Å–µ—Ç–∏',
        offline: '–ù–µ –≤ —Å–µ—Ç–∏',
        wasAgo: '–ë—ã–ª(–∞)'
    },
    en: {
        justNow: 'just now',
        minutesAgo: 'minutes ago',
        hoursAgo: 'hours ago',
        yesterday: 'yesterday',
        today: 'today',
        at: 'at',
        online: 'Online',
        offline: 'Offline',
        wasAgo: 'Was'
    },
    de: {
        justNow: 'gerade eben',
        minutesAgo: 'Minuten vor',
        hoursAgo: 'Stunden vor',
        yesterday: 'gestern',
        today: 'heute',
        at: 'um',
        online: 'Online',
        offline: 'Offline',
        wasAgo: 'War'
    },
    fr: {
        justNow: '√† l\'instant',
        minutesAgo: 'minutes il y a',
        hoursAgo: 'heures il y a',
        yesterday: 'hier',
        today: 'aujourd\'hui',
        at: '√†',
        online: 'En ligne',
        offline: 'Hors ligne',
        wasAgo: '√âtait'
    },
    es: {
        justNow: 'ahora mismo',
        minutesAgo: 'minutos atr√°s',
        hoursAgo: 'horas atr√°s',
        yesterday: 'ayer',
        today: 'hoy',
        at: 'a',
        online: 'En l√≠nea',
        offline: 'Desconectado',
        wasAgo: 'Estaba'
    },
    zh: {
        justNow: 'ÂàöÊâç',
        minutesAgo: 'ÂàÜÈíüÂâç',
        hoursAgo: 'Â∞èÊó∂Ââç',
        yesterday: 'Êò®Â§©',
        today: '‰ªäÂ§©',
        at: 'Âú®',
        online: 'Âú®Á∫ø',
        offline: 'Á¶ªÁ∫ø',
        wasAgo: 'ÊõæÁªè'
    },
    ja: {
        justNow: '„Åü„Å£„Åü‰ªä',
        minutesAgo: 'ÂàÜÂâç',
        hoursAgo: 'ÊôÇÈñìÂâç',
        yesterday: 'Êò®Êó•',
        today: '‰ªäÊó•',
        at: '„Åß',
        online: '„Ç™„É≥„É©„Ç§„É≥',
        offline: '„Ç™„Éï„É©„Ç§„É≥',
        wasAgo: '„Åß„Åó„Åü'
    },
    ko: {
        justNow: 'Î∞©Í∏à',
        minutesAgo: 'Î∂Ñ Ï†Ñ',
        hoursAgo: 'ÏãúÍ∞Ñ Ï†Ñ',
        yesterday: 'Ïñ¥Ï†ú',
        today: 'Ïò§Îäò',
        at: 'ÏóêÏÑú',
        online: 'Ïò®ÎùºÏù∏',
        offline: 'Ïò§ÌîÑÎùºÏù∏',
        wasAgo: 'Ïù¥ÏóàÎã§'
    },
    ar: {
        justNow: 'ÿßŸÑÿ¢ŸÜ',
        minutesAgo: 'ÿØŸÇŸäŸÇÿ© ŸÖÿ∂ÿ™',
        hoursAgo: 'ÿ≥ÿßÿπÿ© ŸÖÿ∂ÿ™',
        yesterday: 'ÿ£ŸÖÿ≥',
        today: 'ÿßŸÑŸäŸàŸÖ',
        at: 'ŸÅŸä',
        online: 'ŸÖÿ™ÿµŸÑ',
        offline: 'ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ',
        wasAgo: 'ŸÉÿßŸÜ'
    }
};

// –ü–æ–ª—É—á–∞–µ–º –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —è–∑—ã–∫–∞
function getLocalizedStrings() {
    const currentLocale = moment.locale();
    return localeStrings[currentLocale] || localeStrings.en;
}

// ==================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –í–†–ï–ú–ï–ù–ï–ú ====================

// –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è —Å–æ–æ–±—â–µ–Ω–∏—è —Å —É—á–µ—Ç–æ–º –ª–æ–∫–∞–ª–∏
function formatMessageTime(timestamp) {
    if (!timestamp) return '';
    
    const messageTime = moment.utc(timestamp).local(); // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º UTC –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
    const now = moment();
    const diffMinutes = now.diff(messageTime, 'minutes');
    const diffHours = now.diff(messageTime, 'hours');
    
    const strings = getLocalizedStrings();
    
    // –ï—Å–ª–∏ –º–µ–Ω—å—à–µ –º–∏–Ω—É—Ç—ã –Ω–∞–∑–∞–¥
    if (diffMinutes < 1) {
        return strings.justNow;
    }
    
    // –ï—Å–ª–∏ –º–µ–Ω—å—à–µ —á–∞—Å–∞ –Ω–∞–∑–∞–¥
    if (diffMinutes < 60) {
        const localizedMinutes = getLocalizedMinutes(diffMinutes, moment.locale());
        return `${diffMinutes} ${localizedMinutes} ${strings.minutesAgo}`;
    }
    
    // –ï—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è
    if (messageTime.isSame(now, 'day')) {
        return `${strings.today} ${strings.at} ${messageTime.format('HH:mm')}`;
    }
    
    // –ï—Å–ª–∏ –≤—á–µ—Ä–∞
    if (messageTime.isSame(now.clone().subtract(1, 'day'), 'day')) {
        return `${strings.yesterday} ${strings.at} ${messageTime.format('HH:mm')}`;
    }
    
    // –ï—Å–ª–∏ –≤ —ç—Ç–æ–º –≥–æ–¥—É
    if (messageTime.isSame(now, 'year')) {
        return messageTime.format('D MMM HH:mm');
    }
    
    // –ò–Ω–∞—á–µ –ø–æ–ª–Ω–∞—è –¥–∞—Ç–∞
    return messageTime.format('DD.MM.YYYY HH:mm');
}

// –ü–æ–ª—É—á–∞–µ–º –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Å–ª–æ–≤–æ "–º–∏–Ω—É—Ç–∞" –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —è–∑—ã–∫–æ–≤
function getLocalizedMinutes(minutes, locale) {
    switch(locale) {
        case 'ru':
            return getRussianMinutes(minutes);
        case 'en':
            return 'minute' + (minutes === 1 ? '' : 's');
        case 'de':
            return 'Minute' + (minutes === 1 ? '' : 'n');
        case 'fr':
            return 'minute' + (minutes === 1 ? '' : 's');
        case 'es':
            return 'minuto' + (minutes === 1 ? '' : 's');
        case 'zh':
            return 'ÂàÜÈíü';
        case 'ja':
            return 'ÂàÜ';
        case 'ko':
            return 'Î∂Ñ';
        case 'ar':
            return 'ÿØŸÇŸäŸÇÿ©';
        default:
            return 'minute' + (minutes === 1 ? '' : 's');
    }
}

// –†—É—Å—Å–∫–æ–µ —Å–∫–ª–æ–Ω–µ–Ω–∏–µ –º–∏–Ω—É—Ç
function getRussianMinutes(minutes) {
    const lastDigit = minutes % 10;
    const lastTwoDigits = minutes % 100;
    
    if (lastTwoDigits >= 11 && lastTwoDigits <= 14) {
        return '–º–∏–Ω—É—Ç';
    }
    
    switch(lastDigit) {
        case 1: return '–º–∏–Ω—É—Ç—É';
        case 2:
        case 3:
        case 4: return '–º–∏–Ω—É—Ç—ã';
        default: return '–º–∏–Ω—É—Ç';
    }
}

// –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –≤–æ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
function updateAllMessageTimes() {
    const timeElements = document.querySelectorAll('.message-timestamp[data-timestamp]');
    
    timeElements.forEach(element => {
        const timestamp = element.dataset.timestamp;
        if (timestamp) {
            const formattedTime = formatMessageTime(timestamp);
            if (formattedTime) {
                element.textContent = formattedTime;
                
                // –î–æ–±–∞–≤–ª—è–µ–º title —Å –ø–æ–ª–Ω–æ–π –¥–∞—Ç–æ–π
                const fullDate = moment.utc(timestamp).local().format('LLLL');
                element.title = fullDate;
            }
        }
    });
}

// ==================== –û–°–ù–û–í–ù–û–ô –ö–û–î –ß–ê–¢–ê ====================

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
const conversationId = {{ conversation.id }};
const currentUserId = {{ request.user.id }};
const currentUsername = "{{ request.user.username }}";
const otherUserId = {{ other_user.id }};
const otherUsername = "{{ other_user.username }}";
let isSending = false;
let firebaseChat;
let mediaFile = null;
let mediaType = null;
let voiceBlob = null;
let mediaRecorder = null;
let audioChunks = [];
let recordingTimer = null;
let recordingStartTime = null;
let isRecording = false;
let currentAudio = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞...');
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å –∏ —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å
    setupMomentLocale();
    showUserTimezone();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
    updateAllMessageTimes();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
    setInterval(updateAllMessageTimes, 60000);
    
    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É —Ñ–æ—Ä–º—ã
    const chatForm = document.querySelector('#chat-form');
    if (chatForm) {
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            handleMessageSubmit(e);
        });
    }
    
    initializeFirebaseChat();
    setupEventListeners();
    updateCharCounter();
    document.querySelector('#chat-message-input').focus();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    updateActivityStatus();
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase —á–∞—Ç–∞
function initializeFirebaseChat() {
    try {
        firebaseChat = new FirebaseChat(conversationId, {
            id: currentUserId,
            username: currentUsername
        });
        console.log('‚úÖ –ß–∞—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        updateConnectionStatus('connected', '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ');
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
        updateConnectionStatus('error', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
        showError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —á–∞—Ç—É');
    }
}

// –ö–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Firebase
class FirebaseChat {
    constructor(conversationId, currentUser) {
        this.conversationId = conversationId;
        this.currentUser = currentUser;
        this.database = firebase.database();
        this.messagesRef = this.database.ref(`chats/${conversationId}/messages`);
        this.typingRef = this.database.ref(`chats/${conversationId}/typing`);
        this.usersRef = this.database.ref(`chats/${conversationId}/users`);
        this.connectedRef = this.database.ref('.info/connected');
        
        this.init();
    }

    async init() {
        await this.setupConnectionMonitoring();
        await this.setupMessagesListener();
        await this.setupTypingListener();
        await this.setUserOnline();
        await this.loadMessageHistory();
    }

    async setupConnectionMonitoring() {
        this.connectedRef.on('value', (snap) => {
            if (snap.val() === true) {
                updateConnectionStatus('connected', '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ');
            } else {
                updateConnectionStatus('disconnected', '–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
            }
        });
    }

    async setupMessagesListener() {
        this.messagesRef.orderByChild('timestamp').on('child_added', (snapshot) => {
            const message = snapshot.val();
            this.addMessageToChat(message);
        });
    }

    async setupTypingListener() {
        this.typingRef.on('child_changed', (snapshot) => {
            const typingData = snapshot.val();
            if (typingData.isTyping && typingData.userId !== this.currentUser.id) {
                showTypingIndicator(typingData.username);
            } else {
                hideTypingIndicator();
            }
        });
    }

    async setUserOnline() {
        this.usersRef.child(this.currentUser.id).set({
            userId: this.currentUser.id,
            username: this.currentUser.username,
            lastSeen: Date.now(),
            isOnline: true
        });
        
        this.usersRef.on('child_changed', (snapshot) => {
            const userData = snapshot.val();
            if (userData.userId === otherUserId) {
                updateUserStatus(userData);
            }
        });
        
        this.usersRef.child(otherUserId).once('value').then((snapshot) => {
            const userData = snapshot.val();
            if (userData) {
                updateUserStatus(userData);
            }
        });
    }

    async loadMessageHistory() {
        try {
            const snapshot = await this.messagesRef.orderByChild('timestamp').limitToLast(50).once('value');
            const messages = [];
            
            snapshot.forEach((childSnapshot) => {
                const message = childSnapshot.val();
                messages.push(message);
            });
            
            messages.sort((a, b) => a.timestamp - b.timestamp);
            this.renderMessages(messages);
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
            showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π');
        }
    }

    async sendMessage(messageText, messageType = 'text', mediaFile = null) {
        if (isSending) {
            showWarning('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è...');
            return false;
        }
        
        isSending = true;
        const messageInput = document.querySelector('#chat-message-input');
        const submitBtn = document.querySelector('#chat-message-submit');
        
        messageInput.disabled = true;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        try {
            let mediaUrl = null;
            
            if (mediaFile) {
                mediaUrl = await this.uploadMediaToServer(mediaFile, messageType);
                if (!mediaUrl) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–¥–∏–∞—Ñ–∞–π–ª–∞');
                }
            }
            
            const messageId = Date.now().toString();
            const messageData = {
                id: messageId,
                content: messageText || (mediaUrl ? '' : ''),
                sender: this.currentUser.username,
                sender_id: this.currentUser.id,
                timestamp: Date.now(), // –°–æ—Ö—Ä–∞–Ω—è–µ–º timestamp –≤ UTC
                message_type: messageType
            };
            
            if (mediaUrl) {
                messageData.content = mediaUrl;
            }
            
            this.addMessageToChat({
                ...messageData,
                is_own: true,
                is_temp: true
            });
            
            await this.messagesRef.child(messageId).set(messageData);
            
            console.log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
            
            messageInput.value = '';
            updateCharCounter();
            this.setTyping(false);
            clearMedia();
            
            return true;
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
            showError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
            return false;
        } finally {
            isSending = false;
            messageInput.disabled = false;
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
        }
    }

    async uploadMediaToServer(file, messageType) {
        return new Promise((resolve, reject) => {
            const formData = new FormData();
            formData.append('media_file', file);
            formData.append('conversation_id', conversationId);
            formData.append('message_type', messageType);
            
            fetch('/chat/upload-media/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.file_url) {
                    resolve(data.file_url);
                } else {
                    reject(new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞'));
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                reject(error);
            });
        });
    }

    setTyping(isTyping) {
        this.typingRef.child(this.currentUser.id).set({
            isTyping: isTyping,
            userId: this.currentUser.id,
            username: this.currentUser.username,
            timestamp: Date.now()
        });
    }

    renderMessages(messages) {
        const messagesContainer = document.querySelector('#chat-messages');
        messagesContainer.innerHTML = '';
        
        if (messages.length === 0) {
            this.showEmptyChatMessage();
            return;
        }
        
        console.log('üé® –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π:', messages.length);
        
        messages.forEach(messageData => {
            this.addMessageToChat(messageData);
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
        setTimeout(updateAllMessageTimes, 100);
    }

    addMessageToChat(messageData) {
        const messagesContainer = document.querySelector('#chat-messages');
        
        const emptyMessage = messagesContainer.querySelector('#empty-chat-message');
        if (emptyMessage) {
            emptyMessage.remove();
        }
        
        const existingMessage = messagesContainer.querySelector(`[data-message-id="${messageData.id}"]`);
        if (existingMessage) {
            if (messageData.is_temp) {
                existingMessage.remove();
            } else {
                return;
            }
        }

        const messageWrapper = document.createElement('div');
        messageWrapper.className = `message-wrapper mb-4 ${messageData.sender_id == currentUserId ? 'own-message' : 'other-message'}`;
        messageWrapper.dataset.messageId = messageData.id;
        
        const isOwn = messageData.sender_id == currentUserId;
        const senderName = isOwn ? '–í—ã' : messageData.sender;

        let messageContent = '';
        switch(messageData.message_type) {
            case 'text':
                messageContent = `<div class="message-content">${escapeHtml(messageData.content).replace(/\n/g, '<br>')}</div>`;
                break;
            case 'image':
                messageContent = `
                    <div class="message-content">
                        <div class="media-message">
                            <img src="${messageData.content}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" class="img-fluid rounded" style="max-width: 300px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <div class="media-error" style="display: none; padding: 20px; text-align: center; color: #6c757d;">
                                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</p>
                            </div>
                        </div>
                    </div>
                `;
                break;
            case 'video':
                messageContent = `
                    <div class="message-content">
                        <div class="media-message">
                            <video controls class="img-fluid rounded" style="max-width: 300px;">
                                <source src="${messageData.content}" type="video/mp4">
                                –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
                            </video>
                        </div>
                    </div>
                `;
                break;
            case 'audio':
                messageContent = `
                    <div class="message-content">
                        <div class="media-message">
                            <audio controls class="w-100">
                                <source src="${messageData.content}" type="audio/mpeg">
                                –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ.
                            </audio>
                        </div>
                    </div>
                `;
                break;
            case 'voice':
                messageContent = `
                    <div class="message-content">
                        <div class="voice-message d-flex align-items-center">
                            <button class="btn btn-sm btn-outline-primary play-voice-btn me-2" data-audio-url="${messageData.content}">
                                <i class="fas fa-play"></i>
                            </button>
                            <div class="voice-waveform flex-grow-1 me-2">
                                <div class="waveform-bar"></div>
                                <div class="waveform-bar"></div>
                                <div class="waveform-bar"></div>
                                <div class="waveform-bar"></div>
                                <div class="waveform-bar"></div>
                            </div>
                            <small class="text-muted voice-duration">0:00</small>
                        </div>
                    </div>
                `;
                break;
            default:
                messageContent = `<div class="message-content">${escapeHtml(messageData.content).replace(/\n/g, '<br>')}</div>`;
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
        const formattedTime = formatMessageTime(messageData.timestamp);
        const fullDate = messageData.timestamp ? moment.utc(messageData.timestamp).local().format('LLLL') : '';

        messageWrapper.innerHTML = `
            <div class="message-bubble ${isOwn ? 'own-bubble' : 'other-bubble'}">
                ${!isOwn ? `<div class="message-sender mb-1"><small class="text-primary fw-bold">${escapeHtml(senderName)}</small></div>` : ''}
                ${messageContent}
                <div class="message-time text-end mt-1">
                    <small class="${isOwn ? 'text-light' : 'text-muted'} message-timestamp" 
                           data-timestamp="${messageData.timestamp}"
                           title="${fullDate}">
                        ${formattedTime}
                    </small>
                    ${isOwn ? '<i class="fas fa-check-double text-light ms-1" style="font-size: 10px;"></i>' : ''}
                </div>
            </div>
        `;

        if (!messageData.is_temp || messageData.is_own) {
            messageWrapper.style.animation = 'messageSlideIn 0.3s ease-out';
        }
        
        messagesContainer.appendChild(messageWrapper);
        scrollToBottom();
        
        if (messageData.message_type === 'voice') {
            const playBtn = messageWrapper.querySelector('.play-voice-btn');
            if (playBtn) {
                playBtn.addEventListener('click', function() {
                    playVoiceMessage(this.dataset.audioUrl, this);
                });
            }
        }
    }

    showEmptyChatMessage() {
        const messagesContainer = document.querySelector('#chat-messages');
        messagesContainer.innerHTML = `
            <div class="text-center text-muted py-5" id="empty-chat-message">
                <div class="empty-state-icon mb-4">
                    <i class="fas fa-comments fa-4x text-light"></i>
                </div>
                <h4 class="fw-light">–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥</h4>
                <p class="text-muted">–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ {{ other_user.username }}</p>
            </div>
        `;
    }

    destroy() {
        if (this.messagesRef) this.messagesRef.off();
        if (this.typingRef) this.typingRef.off();
        if (this.usersRef) this.usersRef.off();
        if (this.connectedRef) this.connectedRef.off();
    }
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
function setupEventListeners() {
    const messageInput = document.querySelector('#chat-message-input');
    
    let typingTimer;
    messageInput.addEventListener('input', function() {
        if (firebaseChat && messageInput.value.trim().length > 0) {
            firebaseChat.setTyping(true);
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                if (firebaseChat) {
                    firebaseChat.setTyping(false);
                }
            }, 1000);
        }
        updateCharCounter();
    });
    
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleMessageSubmit(e);
        }
    });
    
    window.addEventListener('resize', scrollToBottom);
    
    document.getElementById('file-input').addEventListener('change', handleFileSelect);
    document.getElementById('image-input').addEventListener('change', handleFileSelect);
    document.getElementById('video-input').addEventListener('change', handleFileSelect);
    document.getElementById('audio-input').addEventListener('change', handleFileSelect);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
async function handleMessageSubmit(e) {
    e.preventDefault();
    
    const messageInput = document.querySelector('#chat-message-input');
    const message = messageInput.value.trim();
    
    if (!message && !mediaFile) {
        showWarning('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–∞–π–ª');
        messageInput.focus();
        return;
    }
    
    if (!firebaseChat) {
        showError('–ß–∞—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
        return;
    }
    
    await firebaseChat.sendMessage(message, mediaType || 'text', mediaFile);
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
function updateActivityStatus() {
    const isOnline = Math.random() > 0.5;
    const lastSeen = new Date(Date.now() - Math.floor(Math.random() * 24 * 60 * 60 * 1000));
    
    updateUserStatus({
        userId: otherUserId,
        isOnline: isOnline,
        lastSeen: lastSeen.getTime()
    });
}

function updateUserStatus(userData) {
    const onlineStatus = document.getElementById('online-status');
    const lastSeen = document.getElementById('last-seen');
    const activityText = document.getElementById('activity-text');
    const activityIcon = document.querySelector('#last-activity i');
    const strings = getLocalizedStrings();
    
    if (userData.isOnline) {
        onlineStatus.className = 'badge bg-success bg-opacity-10 text-success px-3 py-2 rounded-pill';
        onlineStatus.innerHTML = `<i class="fas fa-circle me-1" style="font-size: 8px;"></i>${strings.online}`;
        lastSeen.textContent = strings.online;
        lastSeen.className = 'text-success';
        activityText.textContent = strings.online;
        activityIcon.className = 'fas fa-circle text-success me-1';
    } else {
        onlineStatus.className = 'badge bg-secondary bg-opacity-10 text-secondary px-3 py-2 rounded-pill';
        onlineStatus.innerHTML = `<i class="fas fa-circle me-1" style="font-size: 8px;"></i>${strings.offline}`;
        
        const timeAgo = getTimeAgo(userData.lastSeen);
        lastSeen.textContent = timeAgo;
        lastSeen.className = 'text-muted';
        activityText.textContent = `${strings.wasAgo} ${timeAgo} ${strings.minutesAgo}`;
        activityIcon.className = 'fas fa-circle text-secondary me-1';
    }
}

function getTimeAgo(timestamp) {
    const now = Date.now();
    const diff = now - timestamp;
    
    const minutes = Math.floor(diff / (1000 * 60));
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    
    const strings = getLocalizedStrings();
    
    if (minutes < 1) return strings.justNow;
    if (minutes < 60) return `${minutes} ${getLocalizedMinutes(minutes, moment.locale())}`;
    if (hours < 24) return `${hours} ${strings.hoursAgo.replace('ago', '').trim()}`;
    return `${days} ${days === 1 ? 'day' : 'days'}`;
}

// ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–µ–¥–∏–∞ (–æ—Å—Ç–∞–≤—å—Ç–µ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
function triggerFileInput(type) { /* ... */ }
function handleFileSelect(event) { /* ... */ }
function showMediaPreview(file, type) { /* ... */ }
function clearMedia() { /* ... */ }

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–æ—Å—Ç–∞–≤—å—Ç–µ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
async function startVoiceRecording() { /* ... */ }
function stopVoiceRecording() { /* ... */ }
function cancelVoiceRecording() { /* ... */ }
function showRecordingIndicator() { /* ... */ }
function hideRecordingIndicator() { /* ... */ }
function updateRecordingTimer() { /* ... */ }
async function sendVoiceMessage() { /* ... */ }
function playVoiceMessage(audioUrl, button) { /* ... */ }

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (–æ—Å—Ç–∞–≤—å—Ç–µ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
function toggleUserInfo() { /* ... */ }
function showTypingIndicator(username) { /* ... */ }
function hideTypingIndicator() { /* ... */ }
function updateCharCounter() { /* ... */ }
function updateConnectionStatus(status, message) { /* ... */ }
function scrollToBottom() { /* ... */ }
function escapeHtml(text) { /* ... */ }
function getCSRFToken() { /* ... */ }
function refreshChat() { /* ... */ }
function blockUser() { /* ... */ }
function startRouteChat() { /* ... */ }

// –§—É–Ω–∫—Ü–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–æ—Å—Ç–∞–≤—å—Ç–µ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
function showError(message) { showNotification(message, 'error'); }
function showSuccess(message) { showNotification(message, 'success'); }
function showWarning(message) { showNotification(message, 'warning'); }
function showInfo(message) { showNotification(message, 'info'); }

function showNotification(message, type = 'info') {
    const notifications = document.getElementById('notifications');
    const notificationId = 'notification-' + Date.now();
    
    const typeConfig = {
        'success': { class: 'notification-success', icon: 'fa-check-circle', duration: 3000 },
        'error': { class: 'notification-error', icon: 'fa-exclamation-circle', duration: 5000 },
        'warning': { class: 'notification-warning', icon: 'fa-exclamation-triangle', duration: 4000 },
        'info': { class: 'notification-info', icon: 'fa-info-circle', duration: 3000 }
    };
    
    const config = typeConfig[type] || typeConfig.info;
    
    const notification = document.createElement('div');
    notification.id = notificationId;
    notification.className = `notification ${config.class}`;
    notification.innerHTML = `
        <div class="notification-content">
            <div class="notification-icon"><i class="fas ${config.icon}"></i></div>
            <div class="notification-message">${escapeHtml(message)}</div>
            <button type="button" class="notification-close" onclick="closeNotification('${notificationId}')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="notification-progress"></div>
    `;
    
    notifications.appendChild(notification);
    setTimeout(() => notification.classList.add('show'), 10);
    
    setTimeout(() => closeNotification(notificationId), config.duration);
}

function closeNotification(notificationId) {
    const notification = document.getElementById(notificationId);
    if (notification) {
        notification.classList.remove('show');
        notification.classList.add('hide');
        setTimeout(() => notification.remove(), 400);
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', function() {
    if (firebaseChat) {
        firebaseChat.destroy();
    }
    
    if (currentAudio) {
        currentAudio.pause();
    }
});

console.log('üéâ –ß–∞—Ç —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä–∞–∑–Ω—ã—Ö —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!');
console.log('üåç –¢–µ–∫—É—â–∏–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å:', moment.tz.guess());
console.log('üó£Ô∏è –¢–µ–∫—É—â–∞—è –ª–æ–∫–∞–ª—å:', moment.locale());
</script>
{% endblock %}