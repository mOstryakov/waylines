{% extends 'base.html' %}

{% block title %}–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞ - Waylines{% endblock %}

{% block content %}
<div class="container-fluid h-100 p-0">
    <div class="row g-0 h-100">
        <!-- –ö–∞—Ä—Ç–∞ -->
        <div class="col-md-8">
            <div id="map" class="h-100"></div>
        </div>

        <!-- –°–∞–π–¥–±–∞—Ä -->
        <div class="col-md-4">
            <div class="sidebar h-100 bg-white border-start">
                <div class="p-3 border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞</h5>
                        <button class="btn btn-primary btn-sm" onclick="showAddPlaceModal()">
                            <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å
                        </button>
                    </div>
                </div>

                <div class="p-3" style="max-height: calc(100vh - 120px); overflow-y: auto;">
                    {% if places %}
                    <div class="places-list">
                        {% for place in places %}
                        <div class="place-item card mb-2" data-lat="{{ place.latitude }}" data-lng="{{ place.longitude }}">
                            <div class="card-body py-2">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">{{ place.name }}</h6>
                                        <p class="text-muted small mb-1">{{ place.address }}</p>
                                        <span class="badge bg-light text-dark">{{ place.get_category_display }}</span>
                                    </div>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary border-0" data-bs-toggle="dropdown">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li>
                                                <a class="dropdown-item" href="#" onclick="showOnMap({{ place.latitude }}, {{ place.longitude }})">
                                                    <i class="fas fa-map-marker-alt"></i> –ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item" href="#" onclick="addToRoute({{ place.latitude }}, {{ place.longitude }}, '{{ place.name }}')">
                                                    <i class="fas fa-route"></i> –î–æ–±–∞–≤–∏—Ç—å –≤ –º–∞—Ä—à—Ä—É—Ç
                                                </a>
                                            </li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <a class="dropdown-item text-danger" href="#">
                                                    <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                {% if place.notes %}
                                <p class="small text-muted mt-1 mb-0">{{ place.notes }}</p>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-map-marker-alt fa-3x text-muted mb-3"></i>
                        <h5>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –º–µ—Å—Ç</h5>
                        <p class="text-muted">–î–æ–±–∞–≤—å—Ç–µ –º–µ—Å—Ç–∞ –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å</p>
                        <button class="btn btn-primary" onclick="showAddPlaceModal()">
                            <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤–æ–µ –º–µ—Å—Ç–æ
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Å—Ç–∞ -->
<div class="modal fade" id="add-place-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –º–µ—Å—Ç–æ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="add-place-form">
                    <div class="mb-3">
                        <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞ *</label>
                        <input type="text" id="place-name" class="form-control" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                        <select id="place-category" class="form-select">
                            <option value="favorite">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</option>
                            <option value="home">üè† –î–æ–º</option>
                            <option value="work">üíº –†–∞–±–æ—Ç–∞</option>
                            <option value="restaurant">üç¥ –†–µ—Å—Ç–æ—Ä–∞–Ω</option>
                            <option value="park">üå≥ –ü–∞—Ä–∫</option>
                            <option value="shop">üõçÔ∏è –ú–∞–≥–∞–∑–∏–Ω</option>
                            <option value="hotel">üè® –û—Ç–µ–ª—å</option>
                            <option value="other">üîπ –î—Ä—É–≥–æ–µ</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">–ê–¥—Ä–µ—Å</label>
                        <input type="text" id="place-address" class="form-control" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</label>
                        <div class="input-group">
                            <span class="input-group-text">–®–∏—Ä–æ—Ç–∞</span>
                            <input type="text" id="place-lat" class="form-control" readonly>
                            <span class="input-group-text">–î–æ–ª–≥–æ—Ç–∞</span>
                            <input type="text" id="place-lng" class="form-control" readonly>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">–ó–∞–º–µ—Ç–∫–∏</label>
                        <textarea id="place-notes" class="form-control" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="savePlace()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–µ—Å—Ç–æ</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let map;
    let currentMarker = null;

    function initMap() {
        map = L.map('map').setView([55.7558, 37.6176], 10);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞ –Ω–∞ –∫–∞—Ä—Ç—É
        {% for place in places %}
        const marker = L.marker([{{ place.latitude }}, {{ place.longitude }}]).addTo(map);
        marker.bindPopup(`
            <div>
                <strong>{{ place.name }}</strong><br>
                <small>{{ place.address }}</small><br>
                <span class="badge bg-light text-dark">{{ place.get_category_display }}</span>
            </div>
        `);
        {% endfor %}

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –º–µ—Å—Ç–∞
        map.on('click', function(e) {
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }
            
            currentMarker = L.marker(e.latlng).addTo(map);
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
            document.getElementById('place-lat').value = e.latlng.lat.toFixed(6);
            document.getElementById('place-lng').value = e.latlng.lng.toFixed(6);
            
            // –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
            getAddressFromCoordinates(e.latlng.lat, e.latlng.lng);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            $('#add-place-modal').modal('show');
        });
    }

    function showAddPlaceModal() {
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
        document.getElementById('add-place-form').reset();
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–µ
        if (!currentMarker) {
            const center = map.getCenter();
            document.getElementById('place-lat').value = center.lat.toFixed(6);
            document.getElementById('place-lng').value = center.lng.toFixed(6);
            getAddressFromCoordinates(center.lat, center.lng);
        }
        
        $('#add-place-modal').modal('show');
    }

    function getAddressFromCoordinates(lat, lng) {
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
            .then(response => response.json())
            .then(data => {
                if (data.display_name) {
                    document.getElementById('place-address').value = data.display_name;
                }
            })
            .catch(() => {
                document.getElementById('place-address').value = '–ê–¥—Ä–µ—Å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω';
            });
    }

    function savePlace() {
        const formData = {
            name: document.getElementById('place-name').value,
            category: document.getElementById('place-category').value,
            address: document.getElementById('place-address').value,
            lat: parseFloat(document.getElementById('place-lat').value),
            lng: parseFloat(document.getElementById('place-lng').value),
            notes: document.getElementById('place-notes').value
        };

        if (!formData.name) {
            alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞');
            return;
        }

        fetch('{% url "add_saved_place" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + data.error);
            }
        });
    }

    function showOnMap(lat, lng) {
        map.setView([lat, lng], 15);
    }

    function addToRoute(lat, lng, name) {
    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ—á–∫—É –≤ —Ç–µ–∫—É—â–∏–π –º–∞—Ä—à—Ä—É—Ç (–µ—Å–ª–∏ –æ–Ω —Å–æ–∑–¥–∞–µ—Ç—Å—è)
    if (window.currentRoute) {
        window.currentRoute.addWaypoint(lat, lng, name);
        showToast(`–ú–µ—Å—Ç–æ "${name}" –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –º–∞—Ä—à—Ä—É—Ç`);
    } else {
        // –ï—Å–ª–∏ –º–∞—Ä—à—Ä—É—Ç –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π
        if (confirm(`–î–æ–±–∞–≤–∏—Ç—å "${name}" –≤ –Ω–æ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç?`)) {
            window.location.href = '{% url "create_route" %}?lat=' + lat + '&lng=' + lng;
        }
    }
}

function showToast(message) {
    // –°–æ–∑–¥–∞–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º toast-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const toast = document.createElement('div');
    toast.className = 'position-fixed bottom-0 end-0 p-3';
    toast.innerHTML = `
        <div class="toast show" role="alert">
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    initMap();
});
{% endblock %}