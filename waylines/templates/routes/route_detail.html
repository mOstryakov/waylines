{% extends 'base.html' %}
{% load static %}

{% block title %}{{ route.name }} - Waylines{% endblock %}

{% block content %}
<div class="container">
    <!-- Заголовок и фото -->
    <div class="row mb-4">
        <div class="col-md-8">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'home' %}">Главная</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'all_routes' %}">Маршруты</a></li>
                    <li class="breadcrumb-item active">{{ route.name }}</li>
                </ol>
            </nav>
            
            <h1 class="display-5 fw-bold mb-3">{{ route.name }}</h1>
            
            <div class="d-flex flex-wrap gap-2 mb-3">
                <span class="badge bg-primary">{{ route.get_route_type_display }}</span>
                {% if route.mood %}<span class="badge bg-success">{{ route.get_mood_display }}</span>{% endif %}
                {% if route.theme %}<span class="badge bg-info">{{ route.get_theme_display }}</span>{% endif %}
                {% if route.is_elderly_friendly %}<span class="badge bg-warning">Для пожилых</span>{% endif %}
                {% if route.has_audio_guide %}<span class="badge bg-secondary">Аудиогид</span>{% endif %}
                {% if not route.is_active %}<span class="badge bg-danger">Не актуален</span>{% endif %}
            </div>
        </div>
        <div class="col-md-4 text-end">
            <div class="btn-group">
                {% if user.is_authenticated %}
                <button class="btn btn-outline-primary" id="favorite-btn" data-route-id="{{ route.id }}">
                    <i class="{% if is_favorite %}fas{% else %}far{% endif %} fa-heart"></i>
                    <span id="favorite-text">{% if is_favorite %}В избранном{% else %}В избранное{% endif %}</span>
                </button>
                <button class="btn btn-outline-secondary" onclick="shareRoute()">
                    <i class="fas fa-share-alt"></i> Поделиться
                </button>
                {% if route.author == user %}
                <a href="{% url 'edit_route' route.id %}" class="btn btn-primary">
                    <i class="fas fa-edit"></i> Редактировать
                </a>
                {% endif %}
                {% else %}
                <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-primary">Войдите чтобы добавить в избранное</a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Фото маршрута -->
    {% if route.photos.all %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="route-photos-carousel">
                <div id="routePhotosCarousel" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        {% for photo in route.photos.all %}
                        <div class="carousel-item {% if forloop.first %}active{% endif %}">
                            <img src="{{ photo.image.url }}" class="d-block w-100 rounded" style="height: 400px; object-fit: cover;" alt="{{ photo.caption }}">
                            {% if photo.caption %}
                            <div class="carousel-caption d-none d-md-block">
                                <p>{{ photo.caption }}</p>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% if route.photos.count > 1 %}
                    <button class="carousel-control-prev" type="button" data-bs-target="#routePhotosCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon"></span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#routePhotosCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon"></span>
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row">
        <!-- Основная информация -->
        <div class="col-lg-8">
            <!-- Описание -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Описание маршрута</h5>
                </div>
                <div class="card-body">
                    {% if route.description %}
                    <p class="card-text">{{ route.description|linebreaks }}</p>
                    {% else %}
                    <p class="card-text text-muted">Описание отсутствует</p>
                    {% endif %}
                    
                    <div class="row mt-4">
                        <div class="col-md-3">
                            <small class="text-muted">Расстояние</small>
                            <div class="fw-bold">{{ route.total_distance|floatformat:1 }} км</div>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Продолжительность</small>
                            <div class="fw-bold">{{ route.duration_minutes }} мин</div>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Точек</small>
                            <div class="fw-bold">{{ route.points.count }}</div>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Автор</small>
                            <div class="fw-bold">
                                <a href="{% url 'user_profile' route.author.username %}">{{ route.author.username }}</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Карта и точки -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Карта маршрута</h5>
                </div>
                <div class="card-body p-0">
                    <div id="route-map" style="height: 400px; border-radius: 0 0 0.375rem 0.375rem;"></div>
                </div>
            </div>

            <!-- Список точек -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Точки маршрута</h5>
                </div>
                <div class="card-body">
                    <div class="points-list">
                        {% for point in points %}
                        <div class="point-item mb-3 pb-3 border-bottom">
                            <div class="d-flex align-items-start">
                                <div class="point-marker me-3">
                                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" 
                                         style="width: 32px; height: 32px; font-weight: bold;">
                                        {{ forloop.counter }}
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">{{ point.name }}</h6>
                                    {% if point.address %}
                                    <p class="text-muted small mb-1">{{ point.address }}</p>
                                    {% endif %}
                                    {% if point.description %}
                                    <p class="mb-2">{{ point.description }}</p>
                                    {% endif %}
                                    
                                    {% if point.photos.all %}
                                    <div class="point-photos d-flex gap-2 mb-2">
                                        {% for photo in point.photos.all %}
                                        <img src="{{ photo.image.url }}" class="rounded" style="width: 60px; height: 60px; object-fit: cover;" 
                                             alt="{{ photo.caption }}" data-bs-toggle="tooltip" title="{{ photo.caption }}">
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    
                                    {% if point.tags %}
                                    <div class="point-tags">
                                        {% for tag in point.tags %}
                                        <span class="badge bg-light text-dark border">{{ tag }}</span>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Комментарии -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Обсуждение маршрута</h5>
                </div>
                <div class="card-body">
                    {% if user.is_authenticated %}
                    <form method="post" action="{% url 'add_route_comment' route.id %}" class="mb-4">
                        {% csrf_token %}
                        <div class="mb-3">
                            <textarea name="text" class="form-control" rows="3" placeholder="Оставьте ваш комментарий..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Отправить комментарий</button>
                    </form>
                    {% else %}
                    <div class="alert alert-info">
                        <a href="{% url 'login' %}?next={{ request.path }}">Войдите</a>, чтобы оставить комментарий
                    </div>
                    {% endif %}
                    
                    <div class="comments-list">
                        {% for comment in comments %}
                        <div class="comment-item mb-3 pb-3 border-bottom">
                            <div class="d-flex align-items-start">
                                <div class="me-3">
                                    <div class="rounded-circle bg-light d-flex align-items-center justify-content-center" 
                                         style="width: 40px; height: 40px;">
                                        <i class="fas fa-user text-muted"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <strong>{{ comment.user.username }}</strong>
                                        <small class="text-muted">{{ comment.created_at|timesince }} назад</small>
                                    </div>
                                    <p class="mb-0">{{ comment.text }}</p>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-muted text-center py-3">Пока нет комментариев. Будьте первым!</p>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Чат маршрута -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-comments"></i> Обсуждение маршрута
                        <small class="text-muted">(realtime)</small>
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="route-chat-container" style="height: 400px;">
                        <!-- Сообщения чата -->
                        <div class="chat-messages p-3" id="route-chat-messages" 
                             style="height: 300px; overflow-y: auto; background: #f8f9fa;">
                            {% for message in route.chat.messages.all|slice:":20" %}
                            <div class="message mb-3 {% if message.user == request.user %}message-own{% endif %}">
                                <div class="message-header d-flex justify-content-between align-items-center mb-1">
                                    <strong>
                                        {% if message.user == route.author %}
                                        <i class="fas fa-crown text-warning" title="Автор маршрута"></i>
                                        {% endif %}
                                        {{ message.user.username }}
                                    </strong>
                                    <small class="text-muted">{{ message.timestamp|date:"H:i" }}</small>
                                </div>
                                <div class="message-body bg-light rounded p-2">
                                    {{ message.message }}
                                </div>
                            </div>
                            {% empty %}
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-comments fa-2x mb-2"></i>
                                <p>Обсуждение маршрута пока пустое</p>
                                <small>Будьте первым, кто оставит сообщение!</small>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Форма отправки сообщения -->
                        {% if user.is_authenticated %}
                        <div class="chat-input border-top p-3 bg-white">
                            <form id="route-chat-form" class="d-flex gap-2">
                                {% csrf_token %}
                                <input type="text" 
                                       class="form-control" 
                                       id="route-chat-message-input" 
                                       placeholder="Напишите сообщение..." 
                                       maxlength="1000"
                                       required>
                                <button type="submit" class="btn btn-primary" id="route-chat-message-submit">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </form>
                        </div>
                        {% else %}
                        <div class="border-top p-3 bg-light text-center">
                            <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-outline-primary">
                                <i class="fas fa-sign-in-alt"></i> Войдите, чтобы участвовать в обсуждении
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Боковая панель -->
        <div class="col-lg-4">
            <!-- Рейтинг -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Рейтинг</h5>
                </div>
                <div class="card-body text-center">
                    <div class="rating-display mb-3">
                        <div class="h1 mb-0">{{ route.get_average_rating|floatformat:1 }}</div>
                        <div class="rating-stars mb-2">
                            {% with rating=route.get_average_rating %}
                            {% for i in "12345" %}
                                {% if forloop.counter <= rating %}
                                <i class="fas fa-star"></i>
                                {% else %}
                                <i class="far fa-star"></i>
                                {% endif %}
                            {% endfor %}
                            {% endwith %}
                        </div>
                        <small class="text-muted">на основе {{ route.ratings.count }} оценок</small>
                    </div>
                    
                    {% if user.is_authenticated and route.author != user %}
                    <div class="rating-form">
                        <p class="small mb-2">Ваша оценка:</p>
                        <div class="star-rating mb-2">
                            {% for i in "12345" %}
                            <button type="button" class="btn btn-link p-0 me-1 star-btn" data-rating="{{ forloop.counter }}">
                                <i class="{% if user_rating and forloop.counter <= user_rating %}fas{% else %}far{% endif %} fa-star fa-lg text-warning"></i>
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Информация о маршруте -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Информация</h5>
                </div>
                <div class="card-body">
                    <div class="info-item mb-2">
                        <small class="text-muted">Создан</small>
                        <div>{{ route.created_at|date:"d.m.Y" }}</div>
                    </div>
                    <div class="info-item mb-2">
                        <small class="text-muted">Обновлен</small>
                        <div>{{ route.updated_at|date:"d.m.Y" }}</div>
                    </div>
                    <div class="info-item mb-2">
                        <small class="text-muted">Статус</small>
                        <div>
                            {% if route.is_active %}
                            <span class="badge bg-success">Актуален</span>
                            {% else %}
                            <span class="badge bg-danger">Не актуален</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="info-item">
                        <small class="text-muted">Приватность</small>
                        <div>{{ route.get_privacy_display }}</div>
                    </div>
                </div>
            </div>

            <!-- Похожие маршруты -->
            {% if similar_routes %}
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Похожие маршруты</h5>
                </div>
                <div class="card-body">
                    {% for similar in similar_routes %}
                    <div class="similar-route mb-3">
                        <a href="{% url 'route_detail' similar.id %}" class="text-decoration-none">
                            <h6 class="mb-1">{{ similar.name }}</h6>
                        </a>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">{{ similar.total_distance|floatformat:1 }} км</small>
                            <small class="rating-stars">
                                {% with rating=similar.get_average_rating %}
                                {% for i in "12345" %}
                                    {% if forloop.counter <= rating %}
                                    <i class="fas fa-star"></i>
                                    {% else %}
                                    <i class="far fa-star"></i>
                                    {% endif %}
                                {% endfor %}
                                {% endwith %}
                            </small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.message-own .message-body {
    background: #007bff !important;
    color: white;
}
.chat-messages {
    border-radius: 0.375rem;
}
.message {
    animation: fadeIn 0.3s ease-in;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Инициализация карты
    function initMap() {
        const map = L.map('route-map').setView([{{ points.0.latitude|default:55.7558 }}, {{ points.0.longitude|default:37.6176 }}], 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        // Добавляем точки маршрута
        const points = [
            {% for point in points %}
            {
                lat: {{ point.latitude }},
                lng: {{ point.longitude }},
                name: "{{ point.name|escapejs }}",
                address: "{{ point.address|escapejs }}"
            },
            {% endfor %}
        ];
        
        // Создаем маркеры
        points.forEach((point, index) => {
            const marker = L.marker([point.lat, point.lng]).addTo(map);
            marker.bindPopup(`
                <div>
                    <strong>Точка ${index + 1}: ${point.name}</strong><br>
                    <small>${point.address}</small>
                </div>
            `);
        });
        
        // Создаем линию маршрута если есть больше одной точки
        if (points.length > 1) {
            const routeLine = L.polyline(points.map(p => [p.lat, p.lng]), {
                color: '#2563eb',
                weight: 4,
                opacity: 0.7
            }).addTo(map);
            
            map.fitBounds(routeLine.getBounds());
        }
    }
    
    // Избранное
    document.getElementById('favorite-btn').addEventListener('click', function() {
        const routeId = this.dataset.routeId;
        const favoriteText = document.getElementById('favorite-text');
        const heartIcon = this.querySelector('i');
        
        fetch(`/routes/${routeId}/favorite/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.is_favorite) {
                    heartIcon.className = 'fas fa-heart';
                    favoriteText.textContent = 'В избранном';
                    this.classList.add('active');
                } else {
                    heartIcon.className = 'far fa-heart';
                    favoriteText.textContent = 'В избранное';
                    this.classList.remove('active');
                }
            }
        });
    });
    
    // Рейтинг
    document.querySelectorAll('.star-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const rating = this.dataset.rating;
            
            fetch(`/routes/{{ route.id }}/rate/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({rating: parseInt(rating)})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
        });
    });
    
    // Поделиться
    function shareRoute() {
        if (navigator.share) {
            navigator.share({
                title: '{{ route.name }}',
                text: 'Посмотрите этот маршрут на Waylines',
                url: window.location.href,
            });
        } else {
            // Fallback - копирование ссылки
            navigator.clipboard.writeText(window.location.href).then(() => {
                alert('Ссылка скопирована в буфер обмена');
            });
        }
    }

    // Чат маршрута
    {% if user.is_authenticated %}
    const routeId = {{ route.id }};
    const routeCurrentUserId = {{ user.id }};
    const routeCurrentUsername = "{{ user.username }}";

    // WebSocket соединение для чата маршрута
    const routeChatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/route_chat/' + routeId + '/'
    );

    routeChatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        addRouteChatMessage(data);
    };

    // Отправка сообщения в чат маршрута
    document.querySelector('#route-chat-form').onsubmit = function(e) {
        e.preventDefault();
        const messageInput = document.querySelector('#route-chat-message-input');
        const message = messageInput.value.trim();
        
        if (message) {
            routeChatSocket.send(JSON.stringify({
                'message': message,
                'user_id': routeCurrentUserId,
                'username': routeCurrentUsername
            }));
            messageInput.value = '';
        }
    };

    // Добавление сообщения в чат маршрута
    function addRouteChatMessage(data) {
        const messagesContainer = document.querySelector('#route-chat-messages');
        
        // Убираем сообщение о пустом чате
        if (messagesContainer.querySelector('.text-center')) {
            messagesContainer.innerHTML = '';
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = 'message mb-3';
        
        if (data.user_id == routeCurrentUserId) {
            messageDiv.classList.add('message-own');
        }

        const isAuthor = data.username === "{{ route.author.username }}";
        const authorIcon = isAuthor ? '<i class="fas fa-crown text-warning" title="Автор маршрута"></i> ' : '';

        messageDiv.innerHTML = `
            <div class="message-header d-flex justify-content-between align-items-center mb-1">
                <strong>${authorIcon}${data.username}</strong>
                <small class="text-muted">${data.timestamp}</small>
            </div>
            <div class="message-body bg-light rounded p-2">
                ${data.message}
            </div>
        `;

        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Автопрокрутка чата маршрута
    const routeMessagesContainer = document.querySelector('#route-chat-messages');
    if (routeMessagesContainer) {
        routeMessagesContainer.scrollTop = routeMessagesContainer.scrollHeight;
    }

    // Обработка Enter для чата маршрута
    document.querySelector('#route-chat-message-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            document.querySelector('#route-chat-form').dispatchEvent(new Event('submit'));
        }
    });
    {% endif %}
    
    // Инициализация при загрузке
    document.addEventListener('DOMContentLoaded', function() {
        initMap();
        
        // Инициализация tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
</script>
{% endblock %}