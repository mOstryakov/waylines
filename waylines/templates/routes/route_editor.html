{% extends 'base.html' %}
{% load static %}

{% block title %}{% if route %}Редактировать {{ route.name }}{% else %}Создать маршрут{% endif %} - Waylines{% endblock %}

{% block content %}
<div class="container-fluid h-100 p-0">
    <div class="row g-0 h-100">
        <!-- Карта -->
        <div class="col-md-8 position-relative">
            <div id="map" class="h-100"></div>
            
            <!-- Элементы управления картой -->
            <div class="map-controls position-absolute top-0 start-0 m-3">
                <div class="btn-group-vertical shadow">
                    <button id="style-toggle" class="btn btn-sm btn-light border">
                        <i class="fas fa-satellite"></i>
                    </button>
                    <button id="locate-me" class="btn btn-sm btn-light border">
                        <i class="fas fa-location-arrow"></i>
                    </button>
                    <button id="reset-route" class="btn btn-sm btn-light border text-danger">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>

            <!-- Индикатор загрузки -->
            <div class="route-loading position-absolute top-50 start-50 translate-middle bg-white rounded p-3 shadow" 
                 style="display: none; z-index: 1000;">
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                    <span>Построение маршрута...</span>
                </div>
            </div>
        </div>

        <!-- Сайдбар редактора -->
        <div class="col-md-4">
            <div class="sidebar h-100 bg-white border-start">
                <div class="p-3 border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            {% if route %}Редактировать маршрут{% else %}Новый маршрут{% endif %}
                        </h5>
                        <a href="{% if route %}{% url 'route_detail' route.id %}{% else %}{% url 'my_routes' %}{% endif %}" 
                           class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> Назад
                        </a>
                    </div>
                </div>

                <div class="p-3" style="max-height: calc(100vh - 120px); overflow-y: auto;">
                    <!-- Основная информация -->
                    <div class="mb-4">
                        <h6 class="fw-bold mb-3">Основная информация</h6>
                        
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Название маршрута *</label>
                            <input type="text" id="route-name" class="form-control form-control-sm" 
                                   value="{{ route.name|default:'' }}" placeholder="Введите название маршрута" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small fw-bold">Краткое описание</label>
                            <textarea id="route-short-description" class="form-control form-control-sm" rows="2" 
                                      placeholder="Краткое описание для карточки маршрута">{{ route.short_description|default:'' }}</textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small fw-bold">Полное описание</label>
                            <textarea id="route-description" class="form-control form-control-sm" rows="3" 
                                      placeholder="Подробное описание маршрута">{{ route.description|default:'' }}</textarea>
                        </div>
                    </div>

                    <!-- Настройки маршрута -->
                    <div class="mb-4">
                        <h6 class="fw-bold mb-3">Настройки маршрута</h6>
                        
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label small fw-bold">Тип маршрута</label>
                                <select id="route-type" class="form-select form-select-sm">
                                    {% for value, label in route.route_types %}
                                    <option value="{{ value }}" {% if route.route_type == value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label small fw-bold">Приватность</label>
                                <select id="route-privacy" class="form-select form-select-sm">
                                    {% for value, label in route.privacy_choices %}
                                    <option value="{{ value }}" {% if route.privacy == value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label small fw-bold">Настроение</label>
                                <select id="route-mood" class="form-select form-select-sm">
                                    <option value="">Выберите настроение</option>
                                    {% for value, label in route.mood_choices %}
                                    <option value="{{ value }}" {% if route.mood == value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label small fw-bold">Тема</label>
                                <select id="route-theme" class="form-select form-select-sm">
                                    <option value="">Выберите тему</option>
                                    {% for value, label in route.theme_choices %}
                                    <option value="{{ value }}" {% if route.theme == value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label small fw-bold">Продолжительность (мин)</label>
                                <input type="number" id="route-duration" class="form-control form-control-sm" 
                                       value="{{ route.duration_minutes|default:0 }}" min="0">
                            </div>
                            <div class="col-6">
                                <label class="form-label small fw-bold">Расстояние (км)</label>
                                <input type="number" id="route-distance" class="form-control form-control-sm" 
                                       value="{{ route.total_distance|default:0 }}" min="0" step="0.1" readonly>
                            </div>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="route-audio-guide" 
                                   {% if route.has_audio_guide %}checked{% endif %}>
                            <label class="form-check-label small" for="route-audio-guide">
                                Есть аудиогид
                            </label>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="route-elderly-friendly" 
                                   {% if route.is_elderly_friendly %}checked{% endif %}>
                            <label class="form-check-label small" for="route-elderly-friendly">
                                Подходит для пожилых
                            </label>
                        </div>

                        {% if route %}
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="route-active" 
                                   {% if route.is_active %}checked{% endif %}>
                            <label class="form-check-label small" for="route-active">
                                Маршрут активен
                            </label>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Статистика и точки -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-bold mb-0">Точки маршрута</h6>
                            <span class="badge bg-primary" id="points-count">0</span>
                        </div>

                        <div class="route-stats bg-light rounded p-3 mb-3">
                            <div class="row text-center small">
                                <div class="col-6">
                                    <div class="fw-bold" id="total-distance">0 км</div>
                                    <div class="text-muted">Расстояние</div>
                                </div>
                                <div class="col-6">
                                    <div class="fw-bold" id="estimated-time">0 мин</div>
                                    <div class="text-muted">Время</div>
                                </div>
                            </div>
                        </div>

                        <!-- Список точек -->
                        <div class="points-list mb-3">
                            <div id="points-list-container">
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-map-marker-alt fa-2x mb-2"></i>
                                    <p class="small">Кликните по карте чтобы добавить точки</p>
                                </div>
                            </div>
                        </div>

                        <button class="btn btn-outline-primary btn-sm w-100 mb-3" id="optimize-route">
                            <i class="fas fa-magic"></i> Оптимизировать порядок
                        </button>

                        <div class="search-bar mb-3">
                            <div class="input-group input-group-sm">
                                <input type="text" id="search-place" class="form-control" 
                                       placeholder="Поиск места...">
                                <button class="btn btn-outline-secondary" type="button" id="search-btn">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div id="search-suggestions" class="search-suggestions"></div>
                        </div>
                    </div>

                    <!-- Кнопки действий -->
                    <div class="border-top pt-3">
                        <div class="d-grid gap-2">
                            <button id="save-route" class="btn btn-primary">
                                <i class="fas fa-save"></i> 
                                {% if route %}Сохранить изменения{% else %}Создать маршрут{% endif %}
                            </button>
                            
                            {% if route %}
                            <a href="{% url 'route_detail' route.id %}" class="btn btn-outline-secondary">
                                <i class="fas fa-eye"></i> Предпросмотр
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальные окна -->
{% include 'modals/point_editor_modal.html' %}
{% include 'modals/delete_confirm_modal.html' %}
{% include 'modals/reset_confirm_modal.html' %}

<!-- Загрузка данных маршрута если редактирование -->
{% if route %}
<script id="route-data" type="application/json">
{{ route_data_json|safe }}
</script>
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
    .sidebar {
        box-shadow: -2px 0 10px rgba(0,0,0,0.1);
    }
    
    .map-controls .btn {
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.9);
    }
    
    .route-loading {
        backdrop-filter: blur(5px);
    }
    
    .point-item {
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .point-item:hover {
        background: #f8f9fa;
    }
    
    .point-item.active {
        background: #e3f2fd;
        border-color: #2196f3;
    }
    
    .search-suggestions {
        position: absolute;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1050;
        display: none;
        width: calc(100% - 40px);
    }
    
    .search-suggestion {
        padding: 0.5rem 1rem;
        cursor: pointer;
        border-bottom: 1px solid #f8f9fa;
    }
    
    .search-suggestion:hover {
        background: #f8f9fa;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/route_editor.js' %}"></script>
{% endblock %}