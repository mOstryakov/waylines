<!-- templates/routes/route_editor.html -->
{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="route-editor-container">
    <div class="container-fluid h-100">
        <div class="row g-0 h-100">
            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ -->
            <div class="col-lg-4 h-100">
                <div class="left-panel-wrapper h-100 position-relative">
                    <div class="left-panel-scrollable h-100 overflow-y-auto" id="left-panel-scrollable">
                        <!-- –ü–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                        <div class="card shadow-sm border-0 m-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <a href="{% if route %}{% url 'route_detail' route.id %}{% else %}{% url 'my_routes' %}{% endif %}" 
                                       class="btn btn-outline-secondary btn-sm">
                                        <i class="fas fa-arrow-left"></i>
                                    </a>
                                    <h5 class="card-title mb-0 fw-bold text-dark text-center flex-grow-1 mx-2">
                                        {% if route %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ{% else %}–°–æ–∑–¥–∞–Ω–∏–µ{% endif %} –º–∞—Ä—à—Ä—É—Ç–∞
                                    </h5>
                                    <button id="save-btn" class="btn btn-primary btn-sm">
                                        <i class="fas fa-save me-1"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                    </button>
                                </div>

                                <!-- –ü–æ–∏—Å–∫ -->
                                <div class="search-bar position-relative mb-3 d-flex gap-2">
                                    <div class="position-relative flex-grow-1">
                                        <input type="text" id="search-place" class="form-control form-control-sm" 
                                               placeholder="–ü–æ–∏—Å–∫ –º–µ—Å—Ç..." style="border-radius: 20px;">
                                        <div id="search-suggestions" class="search-suggestions"></div>
                                    </div>
                                    <button id="search-btn" class="btn btn-primary btn-sm rounded-pill">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>

                                <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ–π -->
                                <div class="d-flex gap-2 justify-content-between mb-3">
                                    <div class="btn-group">
                                        <button id="undo-btn" class="btn btn-outline-secondary btn-sm" disabled>
                                            <i class="fas fa-undo"></i>
                                        </button>
                                        <button id="redo-btn" class="btn btn-outline-secondary btn-sm" disabled>
                                            <i class="fas fa-redo"></i>
                                        </button>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button id="style-toggle" class="btn btn-outline-secondary btn-sm rounded-pill">
                                            <i class="fas fa-satellite me-1"></i>–°–ø—É—Ç–Ω–∏–∫
                                        </button>
                                        <button id="locate-me" class="btn btn-outline-primary btn-sm rounded-pill">
                                            <i class="fas fa-location-arrow"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞ -->
                                <div class="route-stats mb-3">
                                    <div class="card bg-light border-0">
                                        <div class="card-body py-2 px-3">
                                            <div class="d-flex justify-content-between text-center">
                                                <div>
                                                    <div class="h6 mb-0 fw-bold text-dark" id="total-distance">0 –∫–º</div>
                                                    <div class="small text-muted">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ</div>
                                                </div>
                                                <div>
                                                    <div class="h6 mb-0 fw-bold text-dark" id="points-count-display">0</div>
                                                    <div class="small text-muted">–¢–æ—á–µ–∫</div>
                                                </div>
                                                <div>
                                                    <div class="h6 mb-0 fw-bold text-dark" id="estimated-time">-</div>
                                                    <div class="small text-muted">–í—Ä–µ–º—è</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- –î–µ–π—Å—Ç–≤–∏—è —Å –º–∞—Ä—à—Ä—É—Ç–æ–º -->
                                <div class="d-flex gap-2">
                                    <button id="optimize-btn" class="btn btn-outline-success btn-sm flex-fill">
                                        <i class="fas fa-magic me-1"></i>–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                                    </button>
                                    <button id="reset-route" class="btn btn-outline-danger btn-sm" 
                                            data-bs-toggle="tooltip" title="–û—á–∏—Å—Ç–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                        <div class="card shadow-sm border-0 m-3">
                            <div class="card-header bg-white border-0">
                                <h5 class="card-title mb-0 fw-bold text-dark">
                                    <i class="fas fa-info-circle text-primary me-2"></i>
                                    –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                                </h5>
                            </div>
                            <div class="card-body">
                                <input type="hidden" id="route_type" value="walking">
                                <input type="hidden" id="total_distance" value="0">
                                <input type="hidden" id="duration_minutes" value="0">
                                <input type="hidden" id="is_active" value="true">
                                
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ *</label>
                                    <input type="text" class="form-control form-control-lg border-0 bg-light" id="name" 
                                           placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞" required
                                           style="border-radius: 12px; padding: 12px 16px;">
                                </div>
                                
                                <div class="mb-4">
                                    <label class="form-label fw-semibold">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</label>
                                    <textarea class="form-control border-0 bg-light" id="short_description" rows="3" 
                                              placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –∫—Ä–∞—Ç–∫–æ –æ –≤–∞—à–µ–º –º–∞—Ä—à—Ä—É—Ç–µ..."
                                              style="border-radius: 12px; padding: 12px 16px; resize: none;"></textarea>
                                </div>

                                <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–∞—Ä—à—Ä—É—Ç–∞ -->
                                <div class="route-params mb-4">
                                    <h6 class="fw-bold text-dark mb-3">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞</h6>
                                    
                                    <div class="row g-3">
                                        <!-- –¢–∏–ø –º–∞—Ä—à—Ä—É—Ç–∞ -->
                                        <div class="col-12">
                                            <label class="form-label small fw-semibold text-muted">–¢–∏–ø –º–∞—Ä—à—Ä—É—Ç–∞</label>
                                            <div class="btn-group w-100" role="group">
                                                <button type="button" class="btn btn-outline-primary route-type-btn active" data-type="walking">
                                                    <i class="fas fa-walking me-1"></i>–ü–µ—à–∏–π
                                                </button>
                                                <button type="button" class="btn btn-outline-primary route-type-btn" data-type="driving">
                                                    <i class="fas fa-car me-1"></i>–ê–≤—Ç–æ
                                                </button>
                                                <button type="button" class="btn btn-outline-primary route-type-btn" data-type="cycling">
                                                    <i class="fas fa-bicycle me-1"></i>–í–µ–ª–æ
                                                </button>
                                            </div>
                                        </div>

                                        <!-- –°–ª–æ–∂–Ω–æ—Å—Ç—å -->
                                        <div class="col-12">
                                            <label class="form-label small fw-semibold text-muted">–°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
                                            <select class="form-select border-0 bg-light" id="difficulty" style="border-radius: 12px; padding: 8px 16px;">
                                                <option value="easy">üòä –õ—ë–≥–∫–∞—è</option>
                                                <option value="medium">üòê –°—Ä–µ–¥–Ω—è—è</option>
                                                <option value="hard">üò∞ –°–ª–æ–∂–Ω–∞—è</option>
                                                <option value="extreme">üíÄ –≠–∫—Å—Ç—Ä–∏–º</option>
                                            </select>
                                        </div>

                                        <!-- –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ -->
                                        <div class="col-12">
                                            <label class="form-label small fw-semibold text-muted">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</label>
                                            <select class="form-select border-0 bg-light" id="mood" style="border-radius: 12px; padding: 8px 16px;">
                                                <option value="">üé≠ –í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</option>
                                                <option value="adventure">üèîÔ∏è –ü—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ</option>
                                                <option value="relax">üòå –û—Ç–¥—ã—Ö</option>
                                                <option value="romantic">üíñ –†–æ–º–∞–Ω—Ç–∏–∫–∞</option>
                                                <option value="family">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –°–µ–º–µ–π–Ω—ã–π</option>
                                                <option value="extreme">‚ö° –≠–∫—Å—Ç—Ä–∏–º</option>
                                                <option value="historical">üèõÔ∏è –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π</option>
                                                <option value="nature">üå≥ –ü—Ä–∏—Ä–æ–¥–Ω—ã–π</option>
                                            </select>
                                        </div>

                                        <!-- –¢–µ–º–∞ -->
                                        <div class="col-12">
                                            <label class="form-label small fw-semibold text-muted">–¢–µ–º–∞—Ç–∏–∫–∞</label>
                                            <select class="form-select border-0 bg-light" id="theme" style="border-radius: 12px; padding: 8px 16px;">
                                                <option value="">üè∑Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É</option>
                                                <option value="historical">üèõÔ∏è –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è</option>
                                                <option value="nature">üå≥ –ü—Ä–∏—Ä–æ–¥–Ω–∞—è</option>
                                                <option value="urban">üèôÔ∏è –ì–æ—Ä–æ–¥—Å–∫–∞—è</option>
                                                <option value="cultural">üé® –ö—É–ª—å—Ç—É—Ä–Ω–∞—è</option>
                                                <option value="gastronomic">üç¥ –ì–∞—Å—Ç—Ä–æ–Ω–æ–º–∏—á–µ—Å–∫–∞—è</option>
                                                <option value="religious">‚õ™ –†–µ–ª–∏–≥–∏–æ–∑–Ω–∞—è</option>
                                                <option value="architectural">üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è</option>
                                            </select>
                                        </div>

                                        <!-- –í—Ä–µ–º—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è -->
                                        <div class="col-12">
                                            <label class="form-label small fw-semibold text-muted">–í—Ä–µ–º—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è</label>
                                            <input type="text" class="form-control border-0 bg-light" id="duration_display" 
                                                   placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 2-3 —á–∞—Å–∞, 1 –¥–µ–Ω—å, 30 –º–∏–Ω—É—Ç"
                                                   style="border-radius: 12px; padding: 8px 16px;">
                                        </div>

                                        <!-- –ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å -->
                                        <div class="col-12">
                                            <label class="form-label small fw-semibold text-muted">–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</label>
                                            <select class="form-select border-0 bg-light" id="privacy" style="border-radius: 12px; padding: 8px 16px;">
                                                <option value="public">üåç –ü—É–±–ª–∏—á–Ω—ã–π</option>
                                                <option value="private">üîí –ü—Ä–∏–≤–∞—Ç–Ω—ã–π</option>
                                                <option value="link">üîó –ü–æ —Å—Å—ã–ª–∫–µ</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
                                <div class="additional-settings">
                                    <h6 class="fw-bold text-dark mb-3">–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏</h6>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="has_audio_guide">
                                                <label class="form-check-label small fw-medium" for="has_audio_guide">
                                                    <i class="fas fa-headphones me-1"></i>–ê—É–¥–∏–æ–≥–∏–¥
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="is_elderly_friendly">
                                                <label class="form-check-label small fw-medium" for="is_elderly_friendly">
                                                    <i class="fas fa-wheelchair me-1"></i>–î–ª—è –ø–æ–∂–∏–ª—ã—Ö
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="is_child_friendly">
                                                <label class="form-check-label small fw-medium" for="is_child_friendly">
                                                    <i class="fas fa-baby me-1"></i>–î–ª—è –¥–µ—Ç–µ–π
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- –ú–µ–¥–∏–∞ –∫–æ–Ω—Ç–µ–Ω—Ç –º–∞—Ä—à—Ä—É—Ç–∞ -->
                        <div class="card shadow-sm border-0 m-3">
                            <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0 fw-bold text-dark">
                                    <i class="fas fa-images text-primary me-2"></i>
                                    –§–æ—Ç–æ –º–∞—Ä—à—Ä—É—Ç–∞
                                </h5>
                                <span class="badge bg-primary bg-opacity-10 text-primary">–î–æ 10 —Ñ–æ—Ç–æ</span>
                            </div>
                            <div class="card-body">
                                <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–æ—Ç–æ -->
                                <div id="existing-photos-data" style="display: none;">
                                    {% if route and route.photos.all %}
                                        {% for photo in route.photos.all %}
                                            <div class="existing-photo-data"
                                                 data-photo-id="{{ photo.id }}"
                                                 data-image-url="{{ photo.image.url }}"
                                                 data-caption="{{ photo.caption|default:'' }}"
                                                 data-is-main="{% if photo.is_main %}true{% else %}false{% endif %}">
                                            </div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                                
                                <!-- –û—Å–Ω–æ–≤–Ω–æ–µ —Ñ–æ—Ç–æ -->
                                <div class="main-photo-section mb-4">
                                    <label class="form-label fw-semibold small text-muted mb-3">–ì–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ</label>
                                    <div class="main-photo-upload position-relative border-2 border-dashed rounded-4 p-4 text-center cursor-pointer bg-light bg-opacity-50"
                                         onclick="document.getElementById('route-main-photo').click()">
                                        <input type="file" id="route-main-photo" class="d-none" accept="image/*">
                                        
                                        <!-- –û–ø—Ä–µ–¥–µ–ª—è–µ–º –µ—Å—Ç—å –ª–∏ –≥–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ -->
                                        {% with main_photo=route.photos.all|dictsort:"is_main"|last %}
                                        {% if route and route.photos.all and main_photo.is_main %}
                                            <!-- –ï—Å–ª–∏ –µ—Å—Ç—å –≥–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ -->
                                            <div class="main-photo-preview position-absolute top-0 start-0 w-100 h-100 rounded-3">
                                                <img src="{{ main_photo.image.url }}" 
                                                     class="w-100 h-100 object-fit-cover rounded-3 shadow-sm"
                                                     data-photo-id="{{ main_photo.id }}">
                                                <button type="button" class="btn btn-sm btn-light position-absolute top-0 end-0 m-3 photo-remove-btn shadow"
                                                        onclick="removeMainRoutePhoto('{{ main_photo.id }}')">
                                                    <i class="fas fa-times text-danger"></i>
                                                </button>
                                            </div>
                                            <!-- –°–∫—Ä—ã–≤–∞–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä -->
                                            <div class="h-100 d-flex flex-column align-items-center justify-content-center text-muted placeholder-content" 
                                                 style="display: none;">
                                                <i class="fas fa-camera fa-3x mb-3 opacity-50"></i>
                                                <div class="fw-medium mb-1">–î–æ–±–∞–≤–∏—Ç—å –≥–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ</div>
                                                <small class="opacity-75">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 16:9</small>
                                            </div>
                                        {% else %}
                                            <!-- –ï—Å–ª–∏ –Ω–µ—Ç —Ñ–æ—Ç–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä -->
                                            <div class="h-100 d-flex flex-column align-items-center justify-content-center text-muted placeholder-content">
                                                <i class="fas fa-camera fa-3x mb-3 opacity-50"></i>
                                                <div class="fw-medium mb-1">–î–æ–±–∞–≤–∏—Ç—å –≥–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ</div>
                                                <small class="opacity-75">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 16:9</small>
                                            </div>
                                            <!-- –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é -->
                                            <div class="main-photo-preview position-absolute top-0 start-0 w-100 h-100 rounded-3" style="display: none;">
                                                <img src="" class="w-100 h-100 object-fit-cover rounded-3 shadow-sm">
                                                <button type="button" class="btn btn-sm btn-light position-absolute top-0 end-0 m-3 photo-remove-btn shadow">
                                                    <i class="fas fa-times text-danger"></i>
                                                </button>
                                            </div>
                                        {% endif %}
                                        {% endwith %}
                                    </div>
                                </div>

                                <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–æ—Ç–æ -->
                                <div class="additional-photos-section">
                                    <label class="form-label fw-semibold small text-muted mb-3">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–æ—Ç–æ</label>
                                    <div class="additional-photos-grid">
                                        <!-- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–æ—Ç–æ -->
                                        {% if route and route.photos.all %}
                                            {% for photo in route.photos.all %}
                                                {% if not photo.is_main %} {# –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ #}
                                                    <div class="additional-photo-item existing-photo" 
                                                         data-photo-id="{{ photo.id }}">
                                                        <img src="{{ photo.image.url }}" 
                                                             class="w-100 h-100 object-fit-cover"
                                                             data-caption="{{ photo.caption|default:'' }}">
                                                        <button type="button" class="btn btn-sm btn-light position-absolute top-0 end-0 m-1 photo-remove-btn shadow-sm" 
                                                                onclick="removeAdditionalRoutePhoto(this, '{{ photo.id }}')">
                                                            <i class="fas fa-times text-danger" style="font-size: 10px;"></i>
                                                        </button>
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                        
                                        <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Ñ–æ—Ç–æ -->
                                        <div class="additional-photo-upload border-2 border-dashed rounded-3 p-3 text-center cursor-pointer bg-light bg-opacity-50"
                                             onclick="document.getElementById('route-additional-photos').click()">
                                            <input type="file" id="route-additional-photos" class="d-none" accept="image/*" multiple>
                                            <i class="fas fa-plus-circle fa-2x text-muted mb-2"></i>
                                            <div class="small text-muted fw-medium">–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- –°–ø–∏—Å–æ–∫ —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞ -->
                        <div class="card shadow-sm border-0 m-3 mb-4">
                            <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0 fw-bold text-dark">
                                    <i class="fas fa-map-marker-alt text-primary me-2"></i>
                                    –¢–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞
                                    <span class="badge bg-primary rounded-pill ms-2" id="points-count">0</span>
                                </h5>
                                <button id="add-waypoint-btn" class="btn btn-sm btn-primary rounded-pill">
                                    <i class="fas fa-plus me-1"></i>–î–æ–±–∞–≤–∏—Ç—å
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <div id="points-list" class="points-list">
                                    <div class="empty-state text-center py-5">
                                        <div class="empty-icon mb-3">
                                            <i class="fas fa-map-marked-alt fa-3x text-muted opacity-50"></i>
                                        </div>
                                        <h6 class="text-muted fw-medium mb-2">–¢–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞ –ø–æ–∫–∞ –Ω–µ—Ç</h6>
                                        <p class="text-muted small mb-0">–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–µ–∫</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- –ë–ª–æ–∫ –¥–µ—Ç–∞–ª–µ–π —Ç–æ—á–∫–∏ -->
                        <div id="point-details" class="card shadow-sm border-0 m-3" style="display: none;">
                            <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0 fw-bold text-dark" id="point-details-title">–î–µ—Ç–∞–ª–∏ —Ç–æ—á–∫–∏</h5>
                                <button type="button" class="btn-close" onclick="closePointDetails()"></button>
                            </div>
                            <div class="card-body">
                                <div id="point-details-content">
                                    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω JavaScript -->
                                </div>
                                {% include 'ai_audio/audio_controls.html' %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –∫–∞—Ä—Ç–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è -->
            <div class="col-lg-8 h-100 position-relative">
                <div class="map-container h-100 position-sticky top-0">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body p-0 position-relative h-100">
                            <!-- –ö–∞—Ä—Ç–∞ -->
                            <div id="map" class="route-editor-map h-100"></div>

                            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
                            <div id="route-loading" class="position-absolute top-50 start-50 translate-middle" style="display: none;">
                                <div class="bg-white rounded-3 p-4 shadow-lg text-center">
                                    <div class="spinner-border text-primary mb-3" role="status"></div>
                                    <div class="fw-medium text-dark">–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –í–∫–ª—é—á–∞–µ–º –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
{% include 'routes/modals/delete_confirm_modal.html' %}
{% include 'routes/modals/point_editor_modal.html' %}
{% include 'routes/modals/reset_confirm_modal.html' %}

<style>
.route-editor-container {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    height: 100vh;
    overflow: hidden;
}

.left-panel-wrapper {
    background: transparent;
}

.left-panel-scrollable {
    height: 100%;
    padding-bottom: 2rem;
    overflow-y: auto;
    position: relative;
    z-index: 1;
}

.map-container {
    position: sticky;
    top: 0;
    height: 100vh;
}

.route-editor-map {
    border-radius: 0;
    height: 100%;
    touch-action: pan-x pan-y;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫—Ä–∞—Å–∏–≤—ã—Ö —Ç–æ—á–µ–∫ */
.points-list {
    max-height: 500px;
    overflow-y: auto;
}

.point-item {
    border-radius: 12px;
    border: 1px solid #e9ecef;
    transition: all 0.3s ease;
    background: white;
    margin-bottom: 0.75rem;
    overflow: hidden;
}

.point-item:hover {
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transform: translateY(-2px);
    border-color: #3b82f6;
}

.point-item.active {
    background: linear-gradient(135deg, #e3f2fd 0%, #f0f7ff 100%);
    border-color: #3b82f6;
}

.point-header {
    padding: 1rem;
    border-bottom: 1px solid #f8f9fa;
    background: white;
}

.point-content {
    padding: 1rem;
}

.point-marker {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 16px;
    color: white;
    flex-shrink: 0;
    border: 3px solid white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.marker-start { background: linear-gradient(135deg, #10b981, #34d399); }
.marker-end { background: linear-gradient(135deg, #ef4444, #f87171); }
.marker-waypoint { background: linear-gradient(135deg, #3b82f6, #60a5fa); }

.point-title {
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 4px;
    font-size: 1rem;
}

.point-description {
    color: #6b7280;
    font-size: 0.9rem;
    line-height: 1.4;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ–æ—Ç–æ */
.additional-photos-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
}

.additional-photo-item {
    width: 80px;
    height: 80px;
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid #e5e7eb;
    transition: all 0.3s ease;
}

.additional-photo-item:hover {
    transform: scale(1.05);
    border-color: #3b82f6;
}

.additional-photo-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.additional-photo-upload {
    width: 80px;
    height: 80px;
    border: 2px dashed #d1d5db;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: #f9fafb;
    color: #6b7280;
}

.additional-photo-upload:hover {
    border-color: #3b82f6;
    background: #f0f4ff;
    color: #3b82f6;
}

/* –û—Å–Ω–æ–≤–Ω–æ–µ —Ñ–æ—Ç–æ */
.main-photo-upload {
    min-height: 200px;
    position: relative;
}

.main-photo-preview {
    display: block !important; /* –í–∞–∂–Ω–æ: –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º inline —Å—Ç–∏–ª–∏ */
}

.main-photo-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.h-100 {
    min-height: 200px;
}

/* –ì–∞–ª–µ—Ä–µ—è —Ñ–æ—Ç–æ —Ç–æ—á–∫–∏ */
.point-photos-gallery {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    gap: 0.5rem;
    margin-top: 0.75rem;
}

.point-photo-item {
    aspect-ratio: 1;
    border-radius: 8px;
    overflow: hidden;
    position: relative;
    border: 2px solid #e5e7eb;
    transition: all 0.3s ease;
}

.point-photo-item:hover {
    transform: scale(1.05);
    border-color: #3b82f6;
}

.point-photo-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.point-photo-remove {
    position: absolute;
    top: 4px;
    right: 4px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: rgba(239, 68, 68, 0.9);
    color: white;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.point-photo-item:hover .point-photo-remove {
    opacity: 1;
}

.point-add-photo {
    aspect-ratio: 1;
    border: 2px dashed #d1d5db;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f9fafb;
    color: #6b7280;
    cursor: pointer;
    transition: all 0.3s ease;
}

.point-add-photo:hover {
    border-color: #3b82f6;
    background: #f0f4ff;
    color: #3b82f6;
}

/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –º–µ–¥–∏–∞ */
.point-media-indicators {
    display: flex;
    gap: 8px;
    margin-top: 0.75rem;
    flex-wrap: wrap;
}

.media-indicator {
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 4px;
    transition: all 0.3s ease;
}

.media-indicator:hover {
    transform: translateY(-1px);
}

.media-photo { background: #fef3c7; color: #d97706; border: 1px solid #fcd34d; }
.media-audio { background: #dbeafe; color: #2563eb; border: 1px solid #93c5fd; }
.media-category { background: #f3e8ff; color: #7c3aed; border: 1px solid #c4b5fd; }

/* –î–µ–π—Å—Ç–≤–∏—è —Å —Ç–æ—á–∫–æ–π */
.point-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.75rem;
}

.point-action-btn {
    flex: 1;
    padding: 6px 12px;
    font-size: 0.8rem;
    border-radius: 6px;
    transition: all 0.3s ease;
}

.point-action-btn:hover {
    transform: translateY(-1px);
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ */
@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.point-item {
    animation: slideInUp 0.4s ease-out;
}

/* –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä */
.left-panel-scrollable::-webkit-scrollbar {
    width: 8px;
}

.left-panel-scrollable::-webkit-scrollbar-track {
    background: #f8f9fa;
    border-radius: 4px;
}

.left-panel-scrollable::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.left-panel-scrollable::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 992px) {
    .map-container {
        position: relative;
        height: 50vh;
    }
    
    .left-panel-scrollable {
        height: auto;
        max-height: 50vh;
    }
    
    .additional-photos-grid {
        justify-content: center;
    }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö –ø–æ–¥—Å–∫–∞–∑–æ–∫ */
.search-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0 0 1rem 1rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    z-index: 1000;
    display: none;
    max-height: 300px;
    overflow-y: auto;
}

.search-suggestion {
    padding: 12px 16px;
    cursor: pointer;
    border-bottom: 1px solid #f8f9fa;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 12px;
}

.search-suggestion:hover {
    background-color: #f8f9fa;
    transform: translateX(4px);
}

.search-suggestion:last-child {
    border-bottom: none;
}

.search-suggestion i {
    font-size: 18px;
    width: 24px;
    text-align: center;
}

.search-suggestion-content {
    flex: 1;
    min-width: 0;
}

.search-suggestion-name {
    font-weight: 600;
    margin-bottom: 2px;
    color: #1f2937;
}

.search-suggestion-address {
    font-size: 12px;
    color: #6b7280;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* –£–ª—É—á—à–µ–Ω–Ω—ã–π empty state */
.empty-state {
    color: #6c757d;
    padding: 3rem 2rem;
}

.empty-icon {
    opacity: 0.7;
}

/* –§–∏–∫—Å –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–º–µ—â–µ–Ω–∏—è –ø–∞–Ω–µ–ª–∏ */
.map-container * {
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

.left-panel-scrollable * {
    -webkit-user-select: auto;
    -moz-user-select: auto;
    -ms-user-select: auto;
    user-select: auto;
}

.user-location-marker {
    background: transparent;
    border: none;
}

.user-location-pulse {
    position: relative;
    width: 20px;
    height: 20px;
}

.user-location-dot {
    width: 12px;
    height: 12px;
    background: #ff4444;
    border: 3px solid white;
    border-radius: 50%;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.7);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.7);
    }
    70% {
        box-shadow: 0 0 0 10px rgba(255, 68, 68, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(255, 68, 68, 0);
    }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∞—É–¥–∏–æ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ */
.audio-bar {
    width: 3px;
    background: #3b82f6;
    border-radius: 1px;
    transition: height 0.1s ease;
}

.recording-pulse {
    animation: recordingPulse 1.5s infinite;
}

@keyframes recordingPulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.7; }
    100% { transform: scale(1); opacity: 1; }
}

.audio-recording-section.recording-active {
    background: #fef3cd;
    border-color: #f59e0b;
}

.generate-audio-btn,
.regenerate-audio-btn,
.delete-audio-btn,
.retry-audio-btn {
    pointer-events: auto !important;
    cursor: pointer !important;
    opacity: 1 !important;
}

/* –£–±–µ–¥–∏—Å—å —á—Ç–æ –∫–Ω–æ–ø–∫–∏ –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã—Ç—ã */
.audio-generation-section {
    position: relative;
    z-index: 10;
}

/* –£–±–µ—Ä–∏ –ª—é–±—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ */
.audio-generation-section * {
    pointer-events: auto !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
{% if route_data_json %}
    window.routeData = {{ route_data_json|safe }};
    console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç–∞ –ø–µ—Ä–µ–¥–∞–Ω—ã. –¢–æ—á–µ–∫:', window.routeData.points ? window.routeData.points.length : 0);
{% else %}
    window.routeData = null;
{% endif %}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–æ—Ç–æ
let removedExistingPhotos = new Set(); // ID —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–æ—Ç–æ
let newMainPhotoFile = null;
let newAdditionalPhotoFiles = [];

// –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–æ—Ç–æ
let existingPhotos = {
    main: null,
    additional: []
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–æ—Ç–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    // –°–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–æ—Ç–æ –∏–∑ —Å–∫—Ä—ã—Ç—ã—Ö –ø–æ–ª–µ–π
    const existingPhotoData = document.querySelectorAll('#existing-photos-data .existing-photo-data');
    existingPhotoData.forEach(div => {
        const photoId = parseInt(div.dataset.photoId);
        const isMain = div.dataset.isMain === 'true';
        const caption = div.dataset.caption || '';
        
        if (isMain) {
            existingPhotos.main = { id: photoId, caption: caption };
        } else {
            existingPhotos.additional.push({ id: photoId, caption: caption });
        }
    });
    
    console.log('üì∏ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', existingPhotos);
});

// URL –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
window.routeSaveUrl = '{% if route %}/routes/api/routes/{{ route.id }}/{% else %}/routes/api/routes/{% endif %}';
</script>
<script src="{% static 'js/audio_generation.js' %}"></script>
<script src="{% static 'js/route_editor.js' %}"></script>
<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    // –¢–∏–ø –º–∞—Ä—à—Ä—É—Ç–∞
    document.querySelectorAll('.route-type-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.route-type-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–∏–ø–∞ –º–∞—Ä—à—Ä—É—Ç–∞
            if (window.routeEditorUtils && typeof window.routeEditorUtils.updateEstimatedTime === 'function') {
                window.routeEditorUtils.updateEstimatedTime();
            }
        });
    });
    
    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏–π –æ—Ç –∫–∞—Ä—Ç—ã –∫ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏
    const map = document.getElementById('map');
    if (map) {
        map.addEventListener('click', function(e) {
            e.stopPropagation();
        });
        
        map.addEventListener('touchstart', function(e) {
            e.stopPropagation();
        });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
    const saveBtn = document.getElementById('save-btn');
    if (saveBtn) {
        saveBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('üîÑ –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞–∂–∞—Ç–∞');
            saveRouteWithPhotos();
        });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
    setupPhotoUploadHandlers();
});

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
function setupPhotoUploadHandlers() {
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ñ–æ—Ç–æ
    const mainPhotoInput = document.getElementById('route-main-photo');
    if (mainPhotoInput) {
        mainPhotoInput.addEventListener('change', handleMainPhotoUpload);
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ–æ—Ç–æ
    const additionalPhotosInput = document.getElementById('route-additional-photos');
    if (additionalPhotosInput) {
        additionalPhotosInput.addEventListener('change', handleAdditionalPhotosUpload);
    }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ñ–æ—Ç–æ
function handleMainPhotoUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    if (!validateImageFile(file)) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const uploadSection = document.querySelector('.main-photo-upload');
        const preview = uploadSection.querySelector('.main-photo-preview');
        const placeholder = uploadSection.querySelector('.placeholder-content');
        
        // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–≤—å—é –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
        if (!preview) {
            const previewDiv = document.createElement('div');
            previewDiv.className = 'main-photo-preview position-absolute top-0 start-0 w-100 h-100 rounded-3';
            previewDiv.innerHTML = `
                <img src="" class="w-100 h-100 object-fit-cover rounded-3 shadow-sm">
                <button type="button" class="btn btn-sm btn-light position-absolute top-0 end-0 m-3 photo-remove-btn shadow" onclick="removeMainRoutePhoto('new')">
                    <i class="fas fa-times text-danger"></i>
                </button>
            `;
            uploadSection.appendChild(previewDiv);
        }
        
        const newPreview = uploadSection.querySelector('.main-photo-preview');
        if (newPreview) {
            const img = newPreview.querySelector('img');
            if (img) img.src = e.target.result;
            newPreview.style.display = 'block';
        }
        
        if (placeholder) placeholder.style.display = 'none';
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
        newMainPhotoFile = file;
        console.log('üñºÔ∏è –ù–æ–≤–æ–µ –æ—Å–Ω–æ–≤–Ω–æ–µ —Ñ–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:', file.name);
    };
    reader.readAsDataURL(file);
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ–æ—Ç–æ
function handleAdditionalPhotosUpload(e) {
    const files = e.target.files;
    if (!files || files.length === 0) return;
    
    const grid = document.querySelector('.additional-photos-grid');
    if (!grid) return;
    
    // –°—á–∏—Ç–∞–µ–º —Å–∫–æ–ª—å–∫–æ —É–∂–µ –µ—Å—Ç—å —Ñ–æ—Ç–æ (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ + –Ω–æ–≤—ã–µ)
    const existingCount = grid.querySelectorAll('.additional-photo-item').length;
    const uploadButton = grid.querySelector('.additional-photo-upload');
    
    if (existingCount + files.length > 10) {
        showToast('–ú–∞–∫—Å–∏–º—É–º –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å 10 —Ñ–æ—Ç–æ', 'warning');
        return;
    }
    
    Array.from(files).forEach(file => {
        if (!validateImageFile(file)) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const photoItem = document.createElement('div');
            photoItem.className = 'additional-photo-item new-photo';
            photoItem.style.cssText = 'width: 80px; height: 80px; position: relative; border-radius: 8px; overflow: hidden;';
            photoItem.innerHTML = `
                <img src="${e.target.result}" class="w-100 h-100 object-fit-cover">
                <button type="button" class="btn btn-sm btn-light position-absolute top-0 end-0 m-1 photo-remove-btn shadow-sm" 
                        style="width: 20px; height: 20px; padding: 0; display: flex; align-items: center; justify-content: center;"
                        onclick="removeAdditionalRoutePhoto(this, 'new')">
                    <i class="fas fa-times text-danger" style="font-size: 10px;"></i>
                </button>
            `;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª —Å —Å—Å—ã–ª–∫–æ–π –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç
            const fileWithPreview = file;
            fileWithPreview.previewElement = photoItem;
            newAdditionalPhotoFiles.push(fileWithPreview);
            console.log('üñºÔ∏è –ù–æ–≤–æ–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:', file.name);
            
            // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–¥ –∫–Ω–æ–ø–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
            if (uploadButton) {
                grid.insertBefore(photoItem, uploadButton);
            } else {
                grid.appendChild(photoItem);
            }
        };
        reader.readAsDataURL(file);
    });
    
    // –û—á–∏—â–∞–µ–º input –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
    e.target.value = '';
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ —Å —Ñ–æ—Ç–æ
async function saveRouteWithPhotos() {
    try {
        console.log('üíæ –ù–∞—á–∏–Ω–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ —Å —Ñ–æ—Ç–æ...');
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
        const formData = getRouteFormData();
        
        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ñ–æ—Ç–æ
        const photosData = collectPhotosData();
        console.log('üì∑ –î–∞–Ω–Ω—ã–µ –æ —Ñ–æ—Ç–æ:', photosData);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ñ–æ—Ç–æ –≤ formData
        formData.append('photos_data', JSON.stringify(photosData));
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–æ–≤–æ–µ –æ—Å–Ω–æ–≤–Ω–æ–µ —Ñ–æ—Ç–æ, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
        if (newMainPhotoFile) {
            console.log('üñºÔ∏è –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –æ—Å–Ω–æ–≤–Ω–æ–µ —Ñ–æ—Ç–æ');
            formData.append('main_photo', newMainPhotoFile);
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–æ—Ç–æ
        newAdditionalPhotoFiles.forEach((file, index) => {
            console.log(`üñºÔ∏è –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ ${index + 1}`);
            formData.append(`additional_photos_${index}`, file);
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º ID —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ
        if (removedExistingPhotos.size > 0) {
            console.log('üóëÔ∏è –£–¥–∞–ª–µ–Ω–Ω—ã–µ —Ñ–æ—Ç–æ:', Array.from(removedExistingPhotos));
            formData.append('removed_photo_ids', JSON.stringify(Array.from(removedExistingPhotos)));
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        showLoading('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞...');
        
        console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –ø–æ URL:', window.routeSaveUrl);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
        const response = await fetch(window.routeSaveUrl, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCSRFToken()
            }
        });
        
        console.log('üì• –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç, —Å—Ç–∞—Ç—É—Å:', response.status);
        
        if (!response.ok) {
            throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status} ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', result);
        
        if (result.success) {
            showToast('–ú–∞—Ä—à—Ä—É—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!', 'success');
            
            // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –º–∞—Ä—à—Ä—É—Ç–∞
            setTimeout(() => {
                if (result.route_id) {
                    window.location.href = `/routes/${result.route_id}/`;
                } else if (window.routeData && window.routeData.id) {
                    window.location.href = `/routes/${window.routeData.id}/`;
                } else {
                    window.location.href = '/routes/my/';
                }
            }, 1500);
        } else {
            showToast(result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞', 'danger');
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:', error);
        showToast(error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏', 'danger');
    } finally {
        hideLoading();
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –æ —Ñ–æ—Ç–æ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è)
function collectPhotosData() {
    const photosData = {
        existing_main_photo_id: null,
        existing_additional_photo_ids: [],
        captions: {}
    };
    
    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º –æ—Å–Ω–æ–≤–Ω–æ–º —Ñ–æ—Ç–æ
    if (existingPhotos.main && !removedExistingPhotos.has(existingPhotos.main.id)) {
        photosData.existing_main_photo_id = existingPhotos.main.id;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å—å –µ—Å–ª–∏ –µ—Å—Ç—å
        if (existingPhotos.main.caption) {
            photosData.captions[existingPhotos.main.id] = existingPhotos.main.caption;
        }
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ–æ—Ç–æ
    existingPhotos.additional.forEach(photo => {
        if (!removedExistingPhotos.has(photo.id)) {
            photosData.existing_additional_photo_ids.push(photo.id);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å—å –µ—Å–ª–∏ –µ—Å—Ç—å
            if (photo.caption) {
                photosData.captions[photo.id] = photo.caption;
            }
        }
    });
    
    return photosData;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã –º–∞—Ä—à—Ä—É—Ç–∞
function getRouteFormData() {
    const formData = new FormData();
    
    // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç–∞
    formData.append('name', document.getElementById('name').value || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è');
    formData.append('short_description', document.getElementById('short_description').value || '');
    formData.append('difficulty', document.getElementById('difficulty').value || 'medium');
    formData.append('mood', document.getElementById('mood').value || '');
    formData.append('theme', document.getElementById('theme').value || '');
    formData.append('duration_display', document.getElementById('duration_display').value || '');
    formData.append('privacy', document.getElementById('privacy').value || 'public');
    formData.append('has_audio_guide', document.getElementById('has_audio_guide').checked);
    formData.append('is_elderly_friendly', document.getElementById('is_elderly_friendly').checked);
    formData.append('is_child_friendly', document.getElementById('is_child_friendly').checked);
    
    // –¢–∏–ø –º–∞—Ä—à—Ä—É—Ç–∞
    const routeTypeBtn = document.querySelector('.route-type-btn.active');
    formData.append('route_type', routeTypeBtn ? routeTypeBtn.dataset.type : 'walking');
    
    // –î–∞–Ω–Ω—ã–µ –æ —Ç–æ—á–∫–∞—Ö –º–∞—Ä—à—Ä—É—Ç–∞
    if (window.routeEditor && window.routeEditor.getRouteData) {
        const routeData = window.routeEditor.getRouteData();
        formData.append('route_data', JSON.stringify(routeData));
    } else if (window.routeData) {
        formData.append('route_data', JSON.stringify(window.routeData));
    }
    
    console.log('üìù –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã:', {
        name: document.getElementById('name').value,
        route_type: routeTypeBtn ? routeTypeBtn.dataset.type : 'walking',
        points_count: window.routeData ? window.routeData.points.length : 0
    });
    
    return formData;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ñ–æ—Ç–æ –º–∞—Ä—à—Ä—É—Ç–∞
function removeMainRoutePhoto(photoId = null) {
    const uploadSection = document.querySelector('.main-photo-upload');
    const preview = uploadSection.querySelector('.main-photo-preview');
    const placeholder = uploadSection.querySelector('.placeholder-content');
    const fileInput = document.getElementById('route-main-photo');
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å ID —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ñ–æ—Ç–æ, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –≤ —Å–ø–∏—Å–æ–∫ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö
    if (photoId && photoId !== 'new') {
        removedExistingPhotos.add(parseInt(photoId));
        console.log('üóëÔ∏è –û—Å–Ω–æ–≤–Ω–æ–µ —Ñ–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ —Å–ø–∏—Å–æ–∫ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö, ID:', photoId);
    }
    
    // –ï—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ - —É–¥–∞–ª—è–µ–º —Ñ–∞–π–ª
    if (photoId === 'new') {
        newMainPhotoFile = null;
        console.log('üóëÔ∏è –ù–æ–≤–æ–µ –æ—Å–Ω–æ–≤–Ω–æ–µ —Ñ–æ—Ç–æ —É–¥–∞–ª–µ–Ω–æ');
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä
    if (placeholder) {
        placeholder.style.display = 'flex';
    }
    
    // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
    if (preview) {
        preview.style.display = 'none';
    }
    
    // –û—á–∏—â–∞–µ–º —Ñ–∞–π–ª–æ–≤—ã–π –∏–Ω–ø—É—Ç
    if (fileInput) {
        fileInput.value = '';
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ñ–æ—Ç–æ
function removeAdditionalRoutePhoto(button, photoId = null) {
    const photoItem = button.closest('.additional-photo-item');
    if (photoItem) {
        // –ï—Å–ª–∏ —ç—Ç–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Ñ–æ—Ç–æ, –¥–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö
        if (photoId && photoId !== 'new') {
            removedExistingPhotos.add(parseInt(photoId));
            console.log('üóëÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ —Å–ø–∏—Å–æ–∫ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö, ID:', photoId);
        }
        
        // –ï—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ, —É–¥–∞–ª—è–µ–º –∏–∑ –º–∞—Å—Å–∏–≤–∞
        if (photoId === 'new') {
            const index = newAdditionalPhotoFiles.findIndex(file => 
                file.previewElement === photoItem
            );
            if (index !== -1) {
                newAdditionalPhotoFiles.splice(index, 1);
                console.log('üóëÔ∏è –ù–æ–≤–æ–µ —Ñ–æ—Ç–æ —É–¥–∞–ª–µ–Ω–æ –∏–∑ –º–∞—Å—Å–∏–≤–∞, –∏–Ω–¥–µ–∫—Å:', index);
            }
        }
        
        photoItem.remove();
    }
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–∞
function validateImageFile(file) {
    if (!file.type.startsWith('image/')) {
        showToast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–∏—Ä–∞–π—Ç–µ —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'warning');
        return false;
    }
    
    if (file.size > 5 * 1024 * 1024) {
        showToast('–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 5MB', 'warning');
        return false;
    }
    
    return true;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞—Å—á–µ—Ç–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
function updateEstimatedTime() {
    const distanceElement = document.getElementById('total-distance');
    const timeElement = document.getElementById('estimated-time');
    const routeTypeBtn = document.querySelector('.route-type-btn.active');
    
    if (!distanceElement || !timeElement || !routeTypeBtn) return;
    
    const routeType = routeTypeBtn.dataset.type;
    
    // –ü–æ–ª—É—á–∞–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞ (—É–±–∏—Ä–∞–µ–º "–∫–º" –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —á–∏—Å–ª–æ)
    const distanceText = distanceElement.textContent.trim();
    const distance = parseFloat(distanceText.replace(' –∫–º', '').replace(',', '.'));
    
    if (isNaN(distance) || distance === 0) {
        timeElement.textContent = '-';
        return;
    }
    
    // –°–∫–æ—Ä–æ—Å—Ç–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –º–∞—Ä—à—Ä—É—Ç–æ–≤ (–∫–º/—á)
    const speeds = {
        'walking': 5,    // –ø–µ—à–∫–æ–º
        'cycling': 15,   // –Ω–∞ –≤–µ–ª–æ—Å–∏–ø–µ–¥–µ
        'driving': 60    // –Ω–∞ –º–∞—à–∏–Ω–µ
    };
    
    const speed = speeds[routeType] || 5;
    const timeInHours = distance / speed;
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è
    let formattedTime;
    if (timeInHours < 0.1) {
        // –ú–µ–Ω—å—à–µ 6 –º–∏–Ω—É—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –º–∏–Ω—É—Ç–∞—Ö
        const minutes = Math.round(timeInHours * 60);
        formattedTime = `${minutes} –º–∏–Ω`;
    } else if (timeInHours < 1) {
        // –ú–µ–Ω—å—à–µ —á–∞—Å–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –º–∏–Ω—É—Ç–∞—Ö
        const minutes = Math.round(timeInHours * 60);
        formattedTime = `${minutes} –º–∏–Ω`;
    } else if (timeInHours < 24) {
        // –ú–µ–Ω—å—à–µ —Å—É—Ç–æ–∫ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ —á–∞—Å–∞—Ö –∏ –º–∏–Ω—É—Ç–∞—Ö
        const hours = Math.floor(timeInHours);
        const minutes = Math.round((timeInHours - hours) * 60);
        if (minutes > 0) {
            formattedTime = `${hours} —á ${minutes} –º–∏–Ω`;
        } else {
            formattedTime = `${hours} —á`;
        }
    } else {
        // –ë–æ–ª—å—à–µ —Å—É—Ç–æ–∫ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –¥–Ω—è—Ö –∏ —á–∞—Å–∞—Ö
        const days = Math.floor(timeInHours / 24);
        const hours = Math.round(timeInHours % 24);
        if (hours > 0) {
            formattedTime = `${days} –¥ ${hours} —á`;
        } else {
            formattedTime = `${days} –¥`;
        }
    }
    
    timeElement.textContent = formattedTime;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞
function updateRouteStats(distance, pointsCount) {
    const distanceElement = document.getElementById('total-distance');
    const pointsElement = document.getElementById('points-count-display');
    const pointsBadge = document.getElementById('points-count');
    
    if (distanceElement) {
        distanceElement.textContent = distance.toFixed(1) + ' –∫–º';
    }
    
    if (pointsElement) {
        pointsElement.textContent = pointsCount;
    }
    
    if (pointsBadge) {
        pointsBadge.textContent = pointsCount;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è
    updateEstimatedTime();
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function getCSRFToken() {
    const cookieValue = document.cookie
        .split('; ')
        .find(row => row.startsWith('csrftoken='))
        ?.split('=')[1];
    return cookieValue;
}

function showLoading(message = '–ó–∞–≥—Ä—É–∑–∫–∞...') {
    const loadingDiv = document.getElementById('route-loading');
    if (loadingDiv) {
        loadingDiv.querySelector('.fw-medium').textContent = message;
        loadingDiv.style.display = 'block';
    }
}

function hideLoading() {
    const loadingDiv = document.getElementById('route-loading');
    if (loadingDiv) {
        loadingDiv.style.display = 'none';
    }
}

function showToast(message, type = 'info') {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ route_editor.js
    if (window.routeEditor && typeof window.routeEditor.showToast === 'function') {
        window.routeEditor.showToast(message, type);
    } else {
        // Fallback
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 300px;
            word-wrap: break-word;
        `;
        
        const colors = {
            'success': '#10b981',
            'warning': '#f59e0b', 
            'danger': '#ef4444',
            'info': '#3b82f6'
        };
        
        toast.style.backgroundColor = colors[type] || colors.info;
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 3000);
    }
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–æ—á–∫–∞–º–∏
function closePointDetails() {
    const detailsDiv = document.getElementById('point-details');
    if (detailsDiv) {
        detailsDiv.style.display = 'none';
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ route_editor.js
window.routeEditorUtils = {
    updateRouteStats,
    updateEstimatedTime,
    showToast,
    closePointDetails,
    saveRouteWithPhotos,
    collectPhotosData,
    getRouteFormData
};

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤—ã–∑–æ–≤–∞ –∏–∑ HTML
window.closePointDetails = closePointDetails;
window.removeMainRoutePhoto = removeMainRoutePhoto;
window.removeAdditionalRoutePhoto = removeAdditionalRoutePhoto;
</script>
{% endblock %}