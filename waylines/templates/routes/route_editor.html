<!-- templates/routes/route_editor.html -->
{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="route-editor-container">
    <div class="container-fluid h-100">
        <div class="row g-0 h-100">
            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ -->
            <div class="col-lg-4 h-100">
                <div class="left-panel-wrapper h-100 position-relative">
                    <div class="left-panel-scrollable h-100 overflow-y-auto">
                        <!-- –ü–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                        <div class="card shadow-sm border-0 m-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <a href="{% if route %}{% url 'route_detail' route.id %}{% else %}{% url 'my_routes' %}{% endif %}" 
                                       class="btn btn-outline-secondary btn-sm">
                                        <i class="fas fa-arrow-left"></i>
                                    </a>
                                    <h5 class="card-title mb-0 fw-bold text-dark text-center flex-grow-1 mx-2">
                                        {% if route %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ{% else %}–°–æ–∑–¥–∞–Ω–∏–µ{% endif %} –º–∞—Ä—à—Ä—É—Ç–∞
                                    </h5>
                                    <button id="save-btn" class="btn btn-primary btn-sm">
                                        <i class="fas fa-save me-1"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                    </button>
                                </div>

                                <!-- –ü–æ–∏—Å–∫ -->
                                <div class="search-bar position-relative mb-3 d-flex gap-2">
                                    <div class="position-relative flex-grow-1">
                                        <input type="text" id="search-place" class="form-control form-control-sm" 
                                               placeholder="–ü–æ–∏—Å–∫ –º–µ—Å—Ç..." style="border-radius: 20px;">
                                        <div id="search-suggestions" class="search-suggestions"></div>
                                    </div>
                                    <button id="search-btn" class="btn btn-primary btn-sm rounded-pill">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>

                                <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ–π -->
                                <div class="d-flex gap-2 justify-content-between mb-3">
                                    <div class="btn-group">
                                        <button id="undo-btn" class="btn btn-outline-secondary btn-sm" disabled>
                                            <i class="fas fa-undo"></i>
                                        </button>
                                        <button id="redo-btn" class="btn btn-outline-secondary btn-sm" disabled>
                                            <i class="fas fa-redo"></i>
                                        </button>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button id="style-toggle" class="btn btn-outline-secondary btn-sm rounded-pill">
                                            <i class="fas fa-satellite me-1"></i>–°–ø—É—Ç–Ω–∏–∫
                                        </button>
                                        <button id="locate-me" class="btn btn-outline-primary btn-sm rounded-pill">
                                            <i class="fas fa-location-arrow"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞ -->
                                <div class="route-stats mb-3">
                                    <div class="card bg-light border-0">
                                        <div class="card-body py-2 px-3">
                                            <div class="d-flex justify-content-between text-center">
                                                <div>
                                                    <div class="h6 mb-0 fw-bold text-dark" id="total-distance">0 –∫–º</div>
                                                    <div class="small text-muted">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ</div>
                                                </div>
                                                <div>
                                                    <div class="h6 mb-0 fw-bold text-dark" id="points-count-display">0</div>
                                                    <div class="small text-muted">–¢–æ—á–µ–∫</div>
                                                </div>
                                                <div>
                                                    <div class="h6 mb-0 fw-bold text-dark" id="estimated-time">-</div>
                                                    <div class="small text-muted">–í—Ä–µ–º—è</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- –î–µ–π—Å—Ç–≤–∏—è —Å –º–∞—Ä—à—Ä—É—Ç–æ–º -->
                                <div class="d-flex gap-2">
                                    <button id="optimize-btn" class="btn btn-outline-success btn-sm flex-fill">
                                        <i class="fas fa-magic me-1"></i>–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                                    </button>
                                    <button id="reset-route" class="btn btn-outline-danger btn-sm" 
                                            data-bs-toggle="tooltip" title="–û—á–∏—Å—Ç–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                        <div class="card shadow-sm border-0 m-3">
                            <div class="card-header bg-white border-0">
                                <h5 class="card-title mb-0 fw-bold text-dark">
                                    <i class="fas fa-info-circle text-primary me-2"></i>
                                    –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                                </h5>
                            </div>
                            <div class="card-body">
                                <input type="hidden" id="route_type" value="walking">
                                <input type="hidden" id="total_distance" value="0">
                                <input type="hidden" id="duration_minutes" value="0">
                                <input type="hidden" id="is_active" value="true">
                                
                                <!-- –ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ —Å –∫–Ω–æ–ø–∫–æ–π —É–¥–∞–ª–µ–Ω–∏—è -->
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ *</label>
                                    <div class="d-flex align-items-center gap-2 mb-2">
                                        <input type="text" class="form-control form-control-lg border-0 bg-light flex-grow-1" id="name" 
                                               placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞" required
                                               style="border-radius: 12px; padding: 12px 16px;">
                                        {% if route %}
                                        <button type="button" class="btn btn-outline-danger btn-lg" 
                                                data-bs-toggle="modal" data-bs-target="#deleteRouteModal"
                                                title="–£–¥–∞–ª–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç" style="border-radius: 12px; padding: 12px 16px;">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</label>
                                    <textarea class="form-control border-0 bg-light" id="short_description" rows="3" 
                                              placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞..."
                                              style="border-radius: 12px; padding: 12px 16px; resize: none;"></textarea>
                                </div>
                                
                                <div class="mb-4">
                                    <label class="form-label fw-semibold">–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞</label>
                                    <textarea class="form-control border-0 bg-light" id="description" rows="5" 
                                              placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞..."
                                              style="border-radius: 12px; padding: 12px 16px; resize: none;"></textarea>
                                </div>

                                <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–∞—Ä—à—Ä—É—Ç–∞ -->
                                <div class="route-params mb-4">
                                    <h6 class="fw-bold text-dark mb-3">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–∞—Ä—à—Ä—É—Ç–∞</h6>
                                    
                                    <div class="row g-3">
                                        <!-- –¢–∏–ø –º–∞—Ä—à—Ä—É—Ç–∞ -->
                                        <div class="col-12">
                                            <label class="form-label small fw-semibold text-muted">–¢–∏–ø –º–∞—Ä—à—Ä—É—Ç–∞</label>
                                            <div class="btn-group w-100" role="group">
                                                <button type="button" class="btn btn-outline-primary route-type-btn active" data-type="walking">
                                                    <i class="fas fa-walking me-1"></i>–ü–µ—à–∏–π
                                                </button>
                                                <button type="button" class="btn btn-outline-primary route-type-btn" data-type="driving">
                                                    <i class="fas fa-car me-1"></i>–ê–≤—Ç–æ
                                                </button>
                                                <button type="button" class="btn btn-outline-primary route-type-btn" data-type="cycling">
                                                    <i class="fas fa-bicycle me-1"></i>–í–µ–ª–æ
                                                </button>
                                            </div>
                                        </div>

                                        <!-- –í—Ä–µ–º—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è -->
                                        <div class="col-12">
                                            <label class="form-label small fw-semibold text-muted">–í—Ä–µ–º—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è</label>
                                            <input type="text" class="form-control border-0 bg-light" id="duration_display" 
                                                   placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 2-3 —á–∞—Å–∞, 1 –¥–µ–Ω—å, 30 –º–∏–Ω—É—Ç"
                                                   style="border-radius: 12px; padding: 8px 16px;">
                                        </div>

                                        <!-- –ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å -->
                                        <div class="col-12">
                                            <label class="form-label small fw-semibold text-muted">–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</label>
                                            <select class="form-select border-0 bg-light" id="privacy" style="border-radius: 12px; padding: 8px 16px;">
                                                <option value="public">üåç –ü—É–±–ª–∏—á–Ω—ã–π</option>
                                                <option value="private">üîí –ü—Ä–∏–≤–∞—Ç–Ω—ã–π</option>
                                                <option value="link">üîó –ü–æ —Å—Å—ã–ª–∫–µ</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
                                <div class="additional-settings mb-4">
                                    <h6 class="fw-bold text-dark mb-3">–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏</h6>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="has_audio_guide">
                                                <label class="form-check-label small fw-medium" for="has_audio_guide">
                                                    <i class="fas fa-headphones me-1"></i>–ê—É–¥–∏–æ–≥–∏–¥
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="is_elderly_friendly">
                                                <label class="form-check-label small fw-medium" for="is_elderly_friendly">
                                                    <i class="fas fa-wheelchair me-1"></i>–î–ª—è –ø–æ–∂–∏–ª—ã—Ö
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="is_child_friendly">
                                                <label class="form-check-label small fw-medium" for="is_child_friendly">
                                                    <i class="fas fa-baby me-1"></i>–î–ª—è –¥–µ—Ç–µ–π
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- –ú–µ–¥–∏–∞ –∫–æ–Ω—Ç–µ–Ω—Ç –º–∞—Ä—à—Ä—É—Ç–∞ -->
                        <div class="card shadow-sm border-0 m-3">
                            <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0 fw-bold text-dark">
                                    <i class="fas fa-images text-primary me-2"></i>
                                    –§–æ—Ç–æ –º–∞—Ä—à—Ä—É—Ç–∞
                                </h5>
                                <span class="badge bg-primary bg-opacity-10 text-primary">–î–æ 10 —Ñ–æ—Ç–æ</span>
                            </div>
                            <div class="card-body">
                                <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–æ—Ç–æ -->
                                <div id="existing-photos-data" style="display: none;">
                                    {% if route and route.photos.all %}
                                        {% for photo in route.photos.all|dictsort:"order" %}
                                            <div class="existing-photo-data"
                                                 data-photo-id="{{ photo.id }}"
                                                 data-image-url="{{ photo.image.url }}"
                                                 data-caption="{{ photo.caption|default:'' }}"
                                                 data-is-main="{% if photo.is_main %}true{% else %}false{% endif %}"
                                                 data-order="{{ photo.order }}">
                                            </div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                                
                                <!-- –ì–∞–ª–µ—Ä–µ—è —Ñ–æ—Ç–æ –º–∞—Ä—à—Ä—É—Ç–∞ -->
                                <div class="route-photos-section">
                                    <label class="form-label fw-semibold small text-muted mb-3 d-block">
                                        –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ ‚≠ê —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ –≥–ª–∞–≤–Ω—ã–º
                                    </label>
                                    
                                    <div class="additional-photos-grid">
                                        <!-- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–æ—Ç–æ -->
                                        {% if route and route.photos.all %}
                                            {% for photo in route.photos.all|dictsort:"order" %}
                                                <div class="additional-photo-item existing-photo{% if photo.is_main %} main-photo-selected{% endif %}" 
                                                     data-photo-id="{{ photo.id }}"
                                                     data-order="{{ photo.order }}">
                                                    <img src="{{ photo.image.url }}" 
                                                         class="w-100 h-100"
                                                         data-caption="{{ photo.caption|default:'' }}"
                                                         data-is-main="{% if photo.is_main %}true{% else %}false{% endif %}">
                                                    
                                                    <!-- –í–µ—Ä—Ö–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ -->
                                                    <div class="photo-controls-top">
                                                        <button type="button" 
                                                                onclick="makeMainRoutePhoto(this)"
                                                                title="–°–¥–µ–ª–∞—Ç—å –≥–ª–∞–≤–Ω—ã–º">
                                                            <i class="fas fa-star {% if photo.is_main %}text-warning{% else %}text-light{% endif %}"></i>
                                                        </button>
                                                        <button type="button" class="photo-remove-btn" 
                                                                onclick="removeAdditionalRoutePhoto(this, '{{ photo.id }}')"
                                                                title="–£–¥–∞–ª–∏—Ç—å">
                                                            <i class="fas fa-times text-danger"></i>
                                                        </button>
                                                    </div>
                                                    
                                                    <!-- –ù–∏–∂–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ -->
                                                    <div class="photo-controls-bottom">
                                                        <button type="button" 
                                                                onclick="moveRoutePhotoUp(this)"
                                                                title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–≤–µ—Ä—Ö">
                                                            <i class="fas fa-arrow-up"></i>
                                                        </button>
                                                        <button type="button" 
                                                                onclick="moveRoutePhotoDown(this)"
                                                                title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–Ω–∏–∑">
                                                            <i class="fas fa-arrow-down"></i>
                                                        </button>
                                                    </div>
                                                    
                                                    <!-- –ù–æ–º–µ—Ä –ø–æ—Ä—è–¥–∫–∞ -->
                                                    <div class="photo-order-badge">{{ forloop.counter }}</div>
                                                </div>
                                            {% endfor %}
                                        {% endif %}
                                        
                                        <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Ñ–æ—Ç–æ -->
                                        <div class="additional-photo-upload"
                                             onclick="document.getElementById('route-photos-input').click()">
                                            <input type="file" id="route-photos-input" class="d-none" accept="image/*" multiple>
                                            <i class="fas fa-plus-circle fa-2x text-muted mb-2"></i>
                                            <div class="small text-muted fw-medium">–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</div>
                                        </div>
                                    </div>
                                    
                                    <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø—Ä–æ –≥–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ -->
                                    <div class="mt-3 pt-3 border-top">
                                        <div class="alert alert-info bg-primary bg-opacity-10 border-primary border-opacity-25 small mb-0">
                                            <i class="fas fa-info-circle me-2"></i>
                                            –ì–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ –æ—Ç–º–µ—á–µ–Ω–æ –∑–æ–ª–æ—Ç–æ–π –∑–≤–µ–∑–¥–æ–π ‚≠ê
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- –°–ø–∏—Å–æ–∫ —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞ —Å –≥–∞–ª–µ—Ä–µ–µ–π –í–°–ï–• —Ñ–æ—Ç–æ -->
                        <div class="card shadow-sm border-0 m-3 mb-4">
                            <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0 fw-bold text-dark">
                                    <i class="fas fa-map-marker-alt text-primary me-2"></i>
                                    –¢–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞
                                    <span class="badge bg-primary rounded-pill ms-2" id="points-count">0</span>
                                </h5>
                                <button id="add-waypoint-btn" class="btn btn-sm btn-primary rounded-pill">
                                    <i class="fas fa-plus me-1"></i>–î–æ–±–∞–≤–∏—Ç—å
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <div id="points-list" class="points-list">
                                    <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
                                    <div class="empty-state text-center py-5" id="empty-points-state">
                                        <div class="empty-icon mb-3">
                                            <i class="fas fa-map-marked-alt fa-3x text-muted opacity-50"></i>
                                        </div>
                                        <h6 class="text-muted fw-medium mb-2">–¢–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞ –ø–æ–∫–∞ –Ω–µ—Ç</h6>
                                        <p class="text-muted small mb-0">–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–µ–∫</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- –ë–ª–æ–∫ –¥–µ—Ç–∞–ª–µ–π —Ç–æ—á–∫–∏ -->
                        <div id="point-details" class="card shadow-sm border-0 m-3" style="display: none;">
                            <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0 fw-bold text-dark" id="point-details-title">–î–µ—Ç–∞–ª–∏ —Ç–æ—á–∫–∏</h5>
                                <button type="button" class="btn-close" onclick="closePointDetails()"></button>
                            </div>
                            <div class="card-body">
                                <div id="point-details-content">
                                    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω JavaScript -->
                                </div>
                                {% include 'ai_audio/audio_controls.html' %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –∫–∞—Ä—Ç–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è -->
            <div class="col-lg-8 h-100 position-relative">
                <div class="map-container h-100">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body p-0 position-relative h-100">
                            <!-- –ö–∞—Ä—Ç–∞ -->
                            <div id="map" class="route-editor-map h-100"></div>

                            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
                            <div id="route-loading" class="position-absolute top-50 start-50 translate-middle" style="display: none;">
                                <div class="bg-white rounded-3 p-4 shadow-lg text-center">
                                    <div class="spinner-border text-primary mb-3" role="status"></div>
                                    <div class="fw-medium text-dark">–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ -->
<div class="modal fade" id="deleteRouteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>–£–¥–∞–ª–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body py-4">
                <div class="alert alert-warning border-warning bg-warning bg-opacity-10 mb-4">
                    <div class="d-flex">
                        <i class="fas fa-exclamation-circle me-3 mt-1 text-warning"></i>
                        <div>
                            <h6 class="alert-heading text-dark mb-1">–í–Ω–∏–º–∞–Ω–∏–µ!</h6>
                            <p class="mb-0 text-dark">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å. –ú–∞—Ä—à—Ä—É—Ç –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ.</p>
                        </div>
                    </div>
                </div>
                
                <div class="delete-options mb-4">
                    <h6 class="text-dark mb-3">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è:</h6>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="deleteAllData" checked>
                        <label class="form-check-label text-dark" for="deleteAllData">
                            <strong>–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –º–µ–¥–∏–∞—Ñ–∞–π–ª—ã</strong>
                            <p class="small text-muted mb-0">–í—Å–µ —Ñ–æ—Ç–æ –º–∞—Ä—à—Ä—É—Ç–∞, —Ñ–æ—Ç–æ —Ç–æ—á–µ–∫ –∏ –∞—É–¥–∏–æ—Ñ–∞–π–ª—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–∞</p>
                        </label>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="clearCache" checked>
                        <label class="form-check-label text-dark" for="clearCache">
                            <strong>–û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à</strong>
                            <p class="small text-muted mb-0">–û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç–∞ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</p>
                        </label>
                    </div>
                </div>
                
                <div class="confirmation-section">
                    <p class="text-muted small mb-3">
                        –î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞:
                        <strong class="text-dark" id="routeNameToDelete">{{ route.name|default:"[–Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞]" }}</strong>
                    </p>
                    <input type="text" class="form-control" id="confirmRouteName" 
                           placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è">
                    <div class="invalid-feedback" id="confirmError" style="display: none;">
                        –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∏–º–µ–Ω–µ–º –º–∞—Ä—à—Ä—É—Ç–∞
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>–û—Ç–º–µ–Ω–∞
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" disabled>
                    <i class="fas fa-trash-alt me-2"></i>–£–¥–∞–ª–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≥–∞–ª–µ—Ä–µ–∏ —Ñ–æ—Ç–æ —Ç–æ—á–∫–∏ -->
<div class="modal fade" id="pointGalleryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title text-dark">
                    <i class="fas fa-images me-2 text-primary"></i>
                    <span id="pointGalleryTitle">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Ç–æ—á–∫–∏</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <!-- –ö–∞—Ä—É—Å–µ–ª—å –¥–ª—è —Ñ–æ—Ç–æ -->
                <div id="pointGalleryCarousel" class="carousel slide">
                    <div class="carousel-inner" id="pointGalleryCarouselInner">
                        <!-- –§–æ—Ç–æ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                    </div>
                    
                    <!-- –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
                    <button class="carousel-control-prev" type="button" data-bs-target="#pointGalleryCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">–ü—Ä–µ–¥—ã–¥—É—â–µ–µ</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#pointGalleryCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">–°–ª–µ–¥—É—é—â–µ–µ</span>
                    </button>
                </div>
                
                <!-- –ü–æ–¥–ø–∏—Å—å –∫ —Ñ–æ—Ç–æ -->
                <div class="p-3 border-top">
                    <div id="pointPhotoCaption" class="text-center text-muted small">
                        <!-- –ü–æ–¥–ø–∏—Å—å –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <div class="d-flex justify-content-between align-items-center w-100">
                    <div class="photo-counter">
                        <span class="badge bg-primary bg-opacity-10 text-primary">
                            –§–æ—Ç–æ <span id="currentPhotoIndex">1</span> –∏–∑ <span id="totalPhotosCount">0</span>
                        </span>
                    </div>
                    <div class="photo-actions">
                        <button type="button" class="btn btn-outline-primary btn-sm me-2" id="makeMainPhotoBtn" onclick="makePointPhotoMain()">
                            <i class="fas fa-star me-1"></i>–°–¥–µ–ª–∞—Ç—å –≥–ª–∞–≤–Ω—ã–º
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" id="deleteCurrentPhotoBtn" onclick="deleteCurrentPointPhoto()">
                            <i class="fas fa-trash-alt me-1"></i>–£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –í–∫–ª—é—á–∞–µ–º –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
{% include 'routes/modals/delete_confirm_modal.html' %}
{% include 'routes/modals/point_editor_modal.html' %}
{% include 'routes/modals/reset_confirm_modal.html' %}

<style>
.route-editor-container {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    height: 100vh;
    overflow: hidden;
    position: relative;
}

.left-panel-wrapper {
    background: transparent;
}

.left-panel-scrollable {
    height: 100%;
    padding-bottom: 2rem;
    overflow-y: auto;
    position: relative;
    z-index: 1;
}

.map-container {
    position: sticky;
    top: 0;
    height: 100vh;
}

.route-editor-map {
    border-radius: 0;
    height: 100%;
    width: 100%;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
}

/* –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∫–∞—Ä—Ç–∞ –≤—Å–µ–≥–¥–∞ –∏–º–µ–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã */
#map {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100% !important;
    height: 100% !important;
    z-index: 1;
}

/* –î–ª—è Leaflet-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
.leaflet-container {
    position: absolute !important;
    width: 100% !important;
    height: 100% !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å–ø–∏—Å–∫–∞ —Ç–æ—á–µ–∫ */
.points-list {
    max-height: 500px;
    overflow-y: auto;
}

.point-item {
    border-radius: 12px;
    border: 1px solid #e9ecef;
    transition: all 0.3s ease;
    background: white;
    margin: 0.75rem;
    overflow: hidden;
}

.point-item:hover {
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transform: translateY(-2px);
    border-color: #3b82f6;
}

.point-item.active {
    background: linear-gradient(135deg, #e3f2fd 0%, #f0f7ff 100%);
    border-color: #3b82f6;
}

.point-header {
    padding: 1rem;
    border-bottom: 1px solid #f8f9fa;
    background: white;
    cursor: pointer;
}

.point-content {
    padding: 1rem;
}

.point-marker {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 16px;
    color: white;
    flex-shrink: 0;
    border: 3px solid white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.marker-start { background: linear-gradient(135deg, #10b981, #34d399); }
.marker-end { background: linear-gradient(135deg, #ef4444, #f87171); }
.marker-waypoint { background: linear-gradient(135deg, #3b82f6, #60a5fa); }

.point-title {
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 4px;
    font-size: 1rem;
}

.point-description {
    color: #6b7280;
    font-size: 0.9rem;
    line-height: 1.4;
}

/* –°–¢–ò–õ–ò –î–õ–Ø –ì–ê–õ–ï–†–ï–ò –§–û–¢–û –¢–û–ß–ï–ö (–í–°–ï–• –§–û–¢–û!) */
.point-photos-section {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #e9ecef;
    display: block !important; /* –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–∞–ª–µ—Ä–µ—é */
}

.point-photos-section h6 {
    font-size: 0.9rem;
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
}

.point-photos-section h6 i {
    margin-right: 0.5rem;
    color: #6b7280;
}

/* –ì–∞–ª–µ—Ä–µ—è –º–∏–Ω–∏–∞—Ç—é—Ä - –í–°–ï –§–û–¢–û */
.point-photos-gallery {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 10px;
    margin-top: 0.5rem;
}

.point-photo-item {
    position: relative;
    aspect-ratio: 1;
    border-radius: 10px;
    overflow: hidden;
    border: 2px solid #e5e7eb;
    transition: all 0.3s ease;
    background: #f8f9fa;
    cursor: pointer;
}

.point-photo-item:hover {
    transform: translateY(-3px) scale(1.05);
    border-color: #3b82f6;
    box-shadow: 0 6px 15px rgba(59, 130, 246, 0.2);
    z-index: 5;
}

.point-photo-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.point-photo-item:hover img {
    transform: scale(1.1);
}

/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≥–ª–∞–≤–Ω–æ–≥–æ —Ñ–æ—Ç–æ */
.point-photo-main-badge {
    position: absolute;
    top: 6px;
    left: 6px;
    width: 22px;
    height: 22px;
    background: #f59e0b;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    z-index: 10;
}

/* –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ */
.point-add-photo {
    aspect-ratio: 1;
    border: 2px dashed #d1d5db;
    border-radius: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: #f9fafb;
    color: #6b7280;
    cursor: pointer;
    transition: all 0.3s ease;
}

.point-add-photo:hover {
    border-color: #3b82f6;
    background: #f0f4ff;
    color: #3b82f6;
    transform: translateY(-2px);
}

.point-add-photo i {
    font-size: 20px;
    margin-bottom: 6px;
}

.point-add-photo .small {
    font-size: 10px;
    font-weight: 500;
}

/* –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö —Ñ–æ—Ç–æ (–¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —Ñ–æ—Ç–æ) */
.view-all-photos-btn {
    margin-top: 0.75rem;
    font-size: 0.85rem;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    color: #6c757d;
    transition: all 0.3s ease;
}

.view-all-photos-btn:hover {
    background: #e9ecef;
    border-color: #3b82f6;
    color: #3b82f6;
    transform: translateY(-1px);
}

.view-all-photos-btn i {
    margin-right: 0.25rem;
    font-size: 0.75rem;
}

/* –ú–ò–ù–ò–ê–¢–Æ–†–´ –í –®–ê–ü–ö–ï –¢–û–ß–ö–ò (–≥–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ) */
.point-photo-preview {
    width: 80px;
    height: 80px;
    flex-shrink: 0;
    position: relative;
    cursor: pointer;
    margin-right: 1rem;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid #e5e7eb;
    transition: all 0.3s ease;
    background: #f8f9fa;
}

.point-photo-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: all 0.3s ease;
}

.point-photo-preview:hover {
    border-color: #3b82f6;
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
}

/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≥–ª–∞–≤–Ω–æ–≥–æ —Ñ–æ—Ç–æ –≤ –ø—Ä–µ–≤—å—é */
.main-photo-indicator {
    position: absolute;
    top: 6px;
    left: 6px;
    width: 22px;
    height: 22px;
    background: #f59e0b;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    z-index: 2;
}

/* –ë–µ–π–¥–∂ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ñ–æ—Ç–æ */
.photo-count-badge {
    position: absolute;
    top: -6px;
    right: -6px;
    width: 22px;
    height: 22px;
    background: #3b82f6;
    color: white;
    border-radius: 50%;
    font-size: 10px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    z-index: 3;
}

/* –ì–∞–ª–µ—Ä–µ—è –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ */
#pointGalleryCarouselInner .carousel-item {
    text-align: center;
    padding: 20px;
    min-height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8f9fa;
}

#pointGalleryCarouselInner .carousel-item img {
    max-height: 60vh;
    width: auto;
    max-width: 100%;
    margin: 0 auto;
    display: block;
    border-radius: 8px;
    object-fit: contain;
}

.carousel-control-prev,
.carousel-control-next {
    width: 50px;
    height: 50px;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255, 255, 255, 0.9);
    border-radius: 50%;
    margin: 0 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.carousel-control-prev:hover,
.carousel-control-next:hover {
    background: white;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
}

.carousel-control-prev-icon,
.carousel-control-next-icon {
    filter: invert(30%);
}

/* –ö–Ω–æ–ø–∫–∏ –≤ –≥–∞–ª–µ—Ä–µ–µ */
.photo-actions .btn {
    transition: all 0.3s ease;
}

.photo-actions .btn:hover {
    transform: translateY(-2px);
}

#makeMainPhotoBtn.active {
    background-color: #f59e0b;
    border-color: #f59e0b;
    color: white;
}

#makeMainPhotoBtn.active:hover {
    background-color: #d97706;
    border-color: #d97706;
}

/* –£–õ–£–ß–®–ï–ù–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ì–ê–õ–ï–†–ï–ò –§–û–¢–û –ú–ê–†–®–†–£–¢–ê */
.route-photos-section {
    margin-top: 0.5rem;
}

.additional-photos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
    gap: 12px;
    margin-top: 0.5rem;
}

.additional-photo-item {
    position: relative;
    aspect-ratio: 1;
    border-radius: 12px;
    overflow: hidden;
    border: 2px solid #e5e7eb;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: #f8f9fa;
}

.additional-photo-item:hover {
    transform: translateY(-3px) scale(1.05);
    border-color: #3b82f6;
    box-shadow: 0 8px 20px rgba(59, 130, 246, 0.2);
    z-index: 10;
}

.additional-photo-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.additional-photo-item:hover img {
    transform: scale(1.1);
}

/* –í—ã–±—Ä–∞–Ω–Ω–æ–µ –≥–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ */
.additional-photo-item.main-photo-selected {
    border: 3px solid #f59e0b;
    box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1), 0 6px 20px rgba(245, 158, 11, 0.25);
    animation: glow 2s infinite alternate;
}

@keyframes glow {
    from {
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1), 0 6px 20px rgba(245, 158, 11, 0.25);
    }
    to {
        box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.2), 0 8px 25px rgba(245, 158, 11, 0.3);
    }
}

/* –ù–æ–º–µ—Ä –ø–æ—Ä—è–¥–∫–∞ —Ñ–æ—Ç–æ */
.photo-order-badge {
    position: absolute;
    bottom: 6px;
    left: 6px;
    width: 22px;
    height: 22px;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    border-radius: 50%;
    font-size: 11px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0.9;
    z-index: 5;
}

/* –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –§–û–¢–û */
.photo-controls-top {
    position: absolute;
    top: 6px;
    right: 6px;
    display: flex;
    gap: 4px;
    opacity: 0;
    transform: translateY(-5px);
    transition: all 0.3s ease;
    z-index: 20;
}

.additional-photo-item:hover .photo-controls-top {
    opacity: 1;
    transform: translateY(0);
}

.photo-controls-top button {
    width: 28px;
    height: 28px;
    padding: 0;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.5);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    transition: all 0.2s ease;
}

.photo-controls-top button:hover {
    transform: scale(1.1);
    background: white;
    box-shadow: 0 3px 8px rgba(0,0,0,0.2);
}

.photo-controls-top button i {
    font-size: 11px;
}

/* –°—Ç–∏–ª—å –¥–ª—è –∑–≤–µ–∑–¥–æ—á–∫–∏ –≥–ª–∞–≤–Ω–æ–≥–æ —Ñ–æ—Ç–æ */
.photo-controls-top button i.fa-star.text-warning {
    color: #f59e0b !important;
}

.photo-controls-top button i.fa-star.text-light {
    color: rgba(255, 255, 255, 0.7) !important;
}

.photo-controls-top button:hover i.fa-star.text-light {
    color: #f59e0b !important;
}

.photo-controls-bottom {
    position: absolute;
    bottom: 6px;
    right: 6px;
    display: flex;
    gap: 4px;
    opacity: 0;
    transform: translateY(5px);
    transition: all 0.3s ease;
    z-index: 20;
}

.additional-photo-item:hover .photo-controls-bottom {
    opacity: 1;
    transform: translateY(0);
}

.photo-controls-bottom button {
    width: 28px;
    height: 28px;
    padding: 0;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.5);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    transition: all 0.2s ease;
}

.photo-controls-bottom button:hover {
    transform: scale(1.1);
    background: white;
    box-shadow: 0 3px 8px rgba(0,0,0,0.2);
}

.photo-controls-bottom button i {
    font-size: 11px;
}

/* –ö–ù–û–ü–ö–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ù–û–í–´–• –§–û–¢–û */
.additional-photo-upload {
    aspect-ratio: 1;
    border: 2px dashed #d1d5db;
    border-radius: 12px;
    background: #f9fafb;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    color: #6b7280;
}

.additional-photo-upload:hover {
    border-color: #3b82f6;
    background: #f0f4ff;
    color: #3b82f6;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
}

.additional-photo-upload i {
    font-size: 24px;
    margin-bottom: 8px;
}

.additional-photo-upload .small {
    font-size: 11px;
    font-weight: 500;
    text-align: center;
    padding: 0 4px;
}

/* –î–µ–π—Å—Ç–≤–∏—è —Ç–æ—á–µ–∫ */
.point-actions {
    display: flex;
    gap: 4px;
}

.point-actions .btn {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∞–¥—Ä–µ—Å–∞ —Ç–æ—á–∫–∏ */
.point-address {
    font-size: 0.85rem;
    color: #6b7280;
    display: flex;
    align-items: center;
}

.point-address i {
    font-size: 12px;
    margin-right: 4px;
}

/* –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è/–∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è */
.point-item {
    animation: fadeInUp 0.3s ease forwards;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è */
.delete-options .form-check {
    padding-left: 2rem;
}

.delete-options .form-check-input {
    width: 1.2em;
    height: 1.2em;
    margin-left: -2rem;
}

.delete-options .form-check-input:checked {
    background-color: #dc3545;
    border-color: #dc3545;
}

.confirmation-section input {
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
}

.confirmation-section input:focus {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
}

#confirmDeleteBtn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

#confirmDeleteBtn:not(:disabled):hover {
    background-color: #bb2d3b;
    border-color: #b02a37;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
}

/* –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ */
@media (max-width: 768px) {
    .additional-photos-grid {
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 10px;
    }
    
    .point-photos-gallery {
        grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
        gap: 8px;
    }
    
    .point-photo-preview {
        width: 60px;
        height: 60px;
        margin-right: 0.75rem;
    }
    
    .photo-count-badge {
        width: 20px;
        height: 20px;
        font-size: 9px;
    }
    
    .main-photo-indicator {
        width: 20px;
        height: 20px;
        font-size: 9px;
    }
    
    .map-container {
        position: relative;
        height: 50vh;
    }
    
    .left-panel-scrollable {
        height: auto;
        max-height: 50vh;
    }
    
    .point-marker {
        width: 36px;
        height: 36px;
        font-size: 14px;
    }
}

@media (max-width: 576px) {
    .additional-photos-grid {
        grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
        gap: 8px;
    }
    
    .point-photos-gallery {
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        gap: 6px;
    }
    
    .point-photo-preview {
        width: 50px;
        height: 50px;
        margin-right: 0.5rem;
    }
    
    .photo-count-badge {
        width: 18px;
        height: 18px;
        font-size: 8px;
    }
    
    .main-photo-indicator {
        width: 18px;
        height: 18px;
        font-size: 8px;
    }
    
    .point-marker {
        width: 32px;
        height: 32px;
        font-size: 12px;
    }
    
    .point-title {
        font-size: 0.9rem;
    }
    
    .point-description {
        font-size: 0.8rem;
    }
}

/* –£–ª—É—á—à–µ–Ω–Ω—ã–π empty state */
.empty-state {
    color: #6c757d;
    padding: 3rem 2rem;
}

.empty-icon {
    opacity: 0.7;
}

/* –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä */
.left-panel-scrollable::-webkit-scrollbar {
    width: 8px;
}

.left-panel-scrollable::-webkit-scrollbar-track {
    background: #f8f9fa;
    border-radius: 4px;
}

.left-panel-scrollable::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.left-panel-scrollable::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
{% if route_data_json %}
    window.routeData = {{ route_data_json|safe }};
    console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç–∞ –ø–µ—Ä–µ–¥–∞–Ω—ã. –¢–æ—á–µ–∫:', window.routeData.points ? window.routeData.points.length : 0);
{% else %}
    window.routeData = null;
{% endif %}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ñ–æ—Ç–æ –º–∞—Ä—à—Ä—É—Ç–∞
let removedExistingPhotos = new Set();
let newPhotoFiles = [];
window.mainPhotoToSet = null;
window.routeSaveUrl = '{% if route %}/routes/api/routes/{{ route.id }}/{% else %}/routes/api/routes/{% endif %}';

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ñ–æ—Ç–æ —Ç–æ—á–µ–∫
window.removedPointPhotoIds = new Set();
window.newPointPhotoFiles = [];
window.pointMainPhotoToSet = null;
window.currentPointId = null;

// –•—Ä–∞–Ω–∏–ª–∏—â–µ —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞
window.routePoints = [];

// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –≥–∞–ª–µ—Ä–µ–∏ —Ç–æ—á–µ–∫
let currentPointGallery = null;
let currentPointGalleryIndex = 0;
let currentGalleryPhotos = [];

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –º–∞—Ä—à—Ä—É—Ç–∞ –µ—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º
    if (window.routeData) {
        populateFormData();
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–æ—á–∫–∏ –∏–∑ –¥–∞–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–∞
        if (window.routeData.points && window.routeData.points.length > 0) {
            window.routePoints = window.routeData.points;
            updatePointsList(window.routePoints);
        }
    }
    
    setupPhotoUploadHandlers();
    setupRouteTypeButtons();
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    const saveBtn = document.getElementById('save-btn');
    if (saveBtn && typeof routeEditor?.saveRoute === 'function') {
        saveBtn.addEventListener('click', () => routeEditor.saveRoute());
    }
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
    setupDeleteModal();
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–∞–ª–µ—Ä–µ–∏ —Ç–æ—á–µ–∫
    setupPointGallery();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Ä—è–¥–∫–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞ —Ñ–æ—Ç–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    updatePhotoOrderNumbers();
});

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
function setupDeleteModal() {
    const confirmInput = document.getElementById('confirmRouteName');
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    const routeName = document.getElementById('routeNameToDelete').textContent;
    const confirmError = document.getElementById('confirmError');
    
    if (!confirmInput || !confirmBtn) return;
    
    confirmInput.addEventListener('input', function() {
        const isMatch = this.value.trim() === routeName;
        confirmBtn.disabled = !isMatch;
        
        if (this.value.trim() && !isMatch) {
            this.classList.add('is-invalid');
            confirmError.style.display = 'block';
        } else {
            this.classList.remove('is-invalid');
            confirmError.style.display = 'none';
        }
    });
    
    confirmBtn.addEventListener('click', deleteRoute);
}

// –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
async function deleteRoute() {
    const deleteAllData = document.getElementById('deleteAllData').checked;
    const clearCache = document.getElementById('clearCache').checked;
    const routeId = '{{ route.id }}';
    
    try {
        showLoading('–£–¥–∞–ª–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞...');
        
        const response = await fetch(`/routes/api/routes/${routeId}/delete/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                delete_all_data: deleteAllData,
                clear_cache: clearCache
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('–ú–∞—Ä—à—Ä—É—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω', 'success');
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteRouteModal'));
            modal.hide();
            
            // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –º–æ–∏—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
            setTimeout(() => {
                window.location.href = '/routes/my/';
            }, 1500);
        } else {
            throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞:', error);
        showToast(error.message, 'danger');
    } finally {
        hideLoading();
    }
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–∞–ª–µ—Ä–µ–∏ —Ç–æ—á–µ–∫
function setupPointGallery() {
    const galleryModal = document.getElementById('pointGalleryModal');
    if (!galleryModal) return;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—É—Å–µ–ª–∏
    const carousel = new bootstrap.Carousel(document.getElementById('pointGalleryCarousel'), {
        interval: false
    });
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–ª–∞–π–¥–∞
    galleryModal.addEventListener('slide.bs.carousel', function(event) {
        currentPointGalleryIndex = event.to;
        updateGalleryCounter();
        updateGalleryActions();
        updateGalleryCaption();
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    galleryModal.addEventListener('hidden.bs.modal', function() {
        currentPointGallery = null;
        currentGalleryPhotos = [];
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞ –≤ —Å–ø–∏—Å–∫–µ (–û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø - –ü–û–ö–ê–ó–´–í–ê–ï–¢ –í–°–ï –§–û–¢–û)
function createPointListItem(pointData) {
    const pointId = pointData.id || pointData.tempId || 'point-' + Date.now();
    const pointNumber = pointData.order || 1;
    const pointName = pointData.name || `–¢–æ—á–∫–∞ ${pointNumber}`;
    const pointDescription = pointData.description || '';
    const pointAddress = pointData.address || '';
    const pointCategory = pointData.category || '';
    
    // –ü–æ–ª—É—á–∞–µ–º –í–°–ï —Ñ–æ—Ç–æ —Ç–æ—á–∫–∏
    const pointPhotos = pointData.photos || [];
    
    // –ù–∞—Ö–æ–¥–∏–º –≥–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ
    const mainPhoto = pointPhotos.find(p => p.is_main);
    
    // –ï—Å–ª–∏ –Ω–µ—Ç –≥–ª–∞–≤–Ω–æ–≥–æ, –±–µ—Ä–µ–º –ø–µ—Ä–≤–æ–µ —Ñ–æ—Ç–æ –¥–ª—è –ø—Ä–µ–≤—å—é
    const previewPhoto = mainPhoto || (pointPhotos.length > 0 ? pointPhotos[0] : null);
    
    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç
    const pointItem = document.createElement('div');
    pointItem.className = 'point-item';
    pointItem.dataset.pointId = pointId;
    pointItem.dataset.lat = pointData.lat || '';
    pointItem.dataset.lng = pointData.lng || '';
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –º–∞—Ä–∫–µ—Ä–∞
    let markerClass = 'marker-waypoint';
    let markerText = pointNumber;
    
    if (pointData.is_start) {
        markerClass = 'marker-start';
    } else if (pointData.is_end) {
        markerClass = 'marker-end';
    }
    
    // HTML –¥–ª—è –ø—Ä–µ–≤—å—é –≥–ª–∞–≤–Ω–æ–≥–æ —Ñ–æ—Ç–æ –≤ —à–∞–ø–∫–µ
    let photoPreviewHtml = '';
    if (previewPhoto) {
        const photoUrl = getPhotoUrl(previewPhoto);
        
        photoPreviewHtml = `
            <div class="point-photo-preview position-relative me-3" 
                 onclick="openPointGallery('${pointId}', ${pointPhotos.indexOf(previewPhoto)})"
                 title="${pointPhotos.length > 1 ? '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π' : '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ'}">
                <img src="${photoUrl}" 
                     alt="–§–æ—Ç–æ —Ç–æ—á–∫–∏">
                
                ${previewPhoto.is_main ? `
                    <div class="main-photo-indicator" title="–ì–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ">
                        <i class="fas fa-star"></i>
                    </div>
                ` : ''}
                
                ${pointPhotos.length > 1 ? `
                    <div class="photo-count-badge" title="${pointPhotos.length - 1} –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ–æ—Ç–æ">
                        +${pointPhotos.length - 1}
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    // –°–æ–∑–¥–∞–µ–º –≥–∞–ª–µ—Ä–µ—é –í–°–ï–• —Ñ–æ—Ç–æ –¥–ª—è —Ç–æ—á–∫–∏
    let photosGalleryHtml = '';
    if (pointPhotos.length > 0) {
        photosGalleryHtml = `
            <div class="point-photos-section">
                <h6>
                    <i class="fas fa-images"></i>
                    –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Ç–æ—á–∫–∏
                    <span class="badge bg-primary bg-opacity-10 text-primary ms-2">${pointPhotos.length}</span>
                </h6>
                <div class="point-photos-gallery">
                    ${pointPhotos.map((photo, index) => {
                        const photoUrl = getPhotoUrl(photo);
                        return `
                            <div class="point-photo-item" onclick="openPointGallery('${pointId}', ${index})">
                                <img src="${photoUrl}" 
                                     alt="${photo.caption || '–§–æ—Ç–æ —Ç–æ—á–∫–∏'}"
                                     class="w-100 h-100 object-fit-cover">
                                ${photo.is_main ? `
                                    <div class="point-photo-main-badge">
                                        <i class="fas fa-star"></i>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                    <div class="point-add-photo" onclick="openPointPhotoUploader('${pointId}')">
                        <i class="fas fa-plus"></i>
                        <div class="small">–î–æ–±–∞–≤–∏—Ç—å</div>
                    </div>
                </div>
                ${pointPhotos.length > 8 ? `
                    <div class="text-center mt-2">
                        <button class="btn btn-sm view-all-photos-btn" onclick="openPointGallery('${pointId}')">
                            <i class="fas fa-expand-alt me-1"></i> –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ ${pointPhotos.length} —Ñ–æ—Ç–æ
                        </button>
                    </div>
                ` : ''}
            </div>
        `;
    } else {
        photosGalleryHtml = `
            <div class="point-photos-section">
                <h6>
                    <i class="fas fa-images"></i>
                    –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Ç–æ—á–∫–∏
                </h6>
                <div class="point-photos-gallery">
                    <div class="point-add-photo" onclick="openPointPhotoUploader('${pointId}')">
                        <i class="fas fa-plus"></i>
                        <div class="small">–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</div>
                    </div>
                </div>
            </div>
        `;
    }
    
    pointItem.innerHTML = `
        <div class="point-header d-flex align-items-center p-3">
            ${photoPreviewHtml}
            
            <div class="point-marker ${markerClass} me-3">
                ${markerText}
            </div>
            
            <div class="flex-grow-1">
                <div class="point-title d-flex align-items-center">
                    ${pointName}
                    ${pointCategory ? `<span class="badge bg-light text-dark ms-2">${pointCategory}</span>` : ''}
                </div>
                ${pointAddress ? `
                    <div class="point-address small text-muted mt-1">
                        <i class="fas fa-location-dot me-1"></i>${pointAddress}
                    </div>
                ` : ''}
                ${pointDescription ? `
                    <div class="point-description small text-muted mt-2">
                        ${pointDescription.substring(0, 100)}${pointDescription.length > 100 ? '...' : ''}
                    </div>
                ` : ''}
            </div>
            
            <div class="point-actions ms-3">
                <button class="btn btn-sm btn-outline-secondary edit-point-btn" 
                        onclick="editPoint('${pointId}')"
                        title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger delete-point-btn ms-1"
                        onclick="deletePoint('${pointId}')"
                        title="–£–¥–∞–ª–∏—Ç—å">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        
        <div class="point-content">
            <!-- –ì–∞–ª–µ—Ä–µ—è –í–°–ï–• —Ñ–æ—Ç–æ —Ç–æ—á–∫–∏ -->
            ${photosGalleryHtml}
        </div>
    `;
    
    return pointItem;
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è URL —Ñ–æ—Ç–æ
function getPhotoUrl(photo) {
    if (photo.url) return photo.url;
    if (photo.image) return photo.image;
    if (photo.image_url) return photo.image_url;
    if (photo instanceof File) {
        return URL.createObjectURL(photo);
    }
    return '/static/images/default-photo.jpg';
}

// –û—Ç–∫—Ä—ã—Ç–∏–µ –≥–∞–ª–µ—Ä–µ–∏ —Ñ–æ—Ç–æ —Ç–æ—á–∫–∏ (–í–°–ï–• –§–û–¢–û)
function openPointGallery(pointId, startIndex = 0) {
    const point = getPointById(pointId);
    if (!point) {
        showToast('–¢–æ—á–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'warning');
        return;
    }
    
    const pointPhotos = point.photos || [];
    if (pointPhotos.length === 0) {
        showToast('–£ —ç—Ç–æ–π —Ç–æ—á–∫–∏ –Ω–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π', 'warning');
        return;
    }
    
    // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω –∏–Ω–¥–µ–∫—Å —Ñ–æ—Ç–æ, –Ω–æ –µ–≥–æ –Ω–µ—Ç –≤ –º–∞—Å—Å–∏–≤–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º 0
    const safeStartIndex = startIndex < pointPhotos.length ? startIndex : 0;
    
    currentPointGallery = point;
    currentGalleryPhotos = pointPhotos;
    currentPointGalleryIndex = safeStartIndex;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
    const title = document.getElementById('pointGalleryTitle');
    if (title) {
        title.textContent = `–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Ç–æ—á–∫–∏: ${point.name}`;
    }
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –∫–∞—Ä—É—Å–µ–ª—å
    const carouselInner = document.getElementById('pointGalleryCarouselInner');
    if (carouselInner) {
        carouselInner.innerHTML = '';
        
        pointPhotos.forEach((photo, index) => {
            const isActive = index === safeStartIndex;
            const photoUrl = getPhotoUrl(photo);
            
            const item = document.createElement('div');
            item.className = `carousel-item ${isActive ? 'active' : ''}`;
            item.innerHTML = `
                <img src="${photoUrl}" 
                     class="d-block" 
                     alt="${photo.caption || '–§–æ—Ç–æ —Ç–æ—á–∫–∏'}"
                     style="max-height: 60vh; max-width: 100%; border-radius: 8px; object-fit: contain;">
            `;
            carouselInner.appendChild(item);
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
        updateGalleryCounter();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å—å
        updateGalleryCaption();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
        updateGalleryActions();
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = new bootstrap.Modal(document.getElementById('pointGalleryModal'));
    modal.show();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ —Ñ–æ—Ç–æ –≤ –≥–∞–ª–µ—Ä–µ–µ
function updateGalleryCounter() {
    const currentIndex = document.getElementById('currentPhotoIndex');
    const totalCount = document.getElementById('totalPhotosCount');
    
    if (currentIndex) {
        currentIndex.textContent = currentPointGalleryIndex + 1;
    }
    if (totalCount) {
        totalCount.textContent = currentGalleryPhotos.length;
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∏ —Ñ–æ—Ç–æ –≤ –≥–∞–ª–µ—Ä–µ–µ
function updateGalleryCaption() {
    const captionDiv = document.getElementById('pointPhotoCaption');
    if (!captionDiv || !currentGalleryPhotos[currentPointGalleryIndex]) return;
    
    const currentPhoto = currentGalleryPhotos[currentPointGalleryIndex];
    captionDiv.textContent = currentPhoto.caption || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è';
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π —Å —Ñ–æ—Ç–æ –≤ –≥–∞–ª–µ—Ä–µ–µ
function updateGalleryActions() {
    const currentPhoto = currentGalleryPhotos[currentPointGalleryIndex];
    const makeMainBtn = document.getElementById('makeMainPhotoBtn');
    
    if (makeMainBtn && currentPhoto) {
        const isMain = currentPhoto.is_main || false;
        makeMainBtn.classList.toggle('active', isMain);
        makeMainBtn.innerHTML = isMain 
            ? '<i class="fas fa-star me-1"></i>–ì–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ' 
            : '<i class="fas fa-star me-1"></i>–°–¥–µ–ª–∞—Ç—å –≥–ª–∞–≤–Ω—ã–º';
        
        // –í–∫–ª—é—á–∞–µ–º/–≤—ã–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è
        makeMainBtn.disabled = isMain;
    }
}

// –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ —Ç–æ—á–∫–∏ –≥–ª–∞–≤–Ω—ã–º
function makePointPhotoMain() {
    if (!currentPointGallery) return;
    
    const point = currentPointGallery;
    const currentPhoto = currentGalleryPhotos[currentPointGalleryIndex];
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ –¥–ª—è –≤—Å–µ—Ö —Ñ–æ—Ç–æ —Ç–æ—á–∫–∏
    point.photos.forEach(p => {
        p.is_main = false;
    });
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Ñ–æ—Ç–æ –∫–∞–∫ –≥–ª–∞–≤–Ω–æ–µ
    currentPhoto.is_main = true;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–∫—É –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
    const pointIndex = window.routePoints.findIndex(p => 
        p.id === point.id || p.tempId === point.id
    );
    if (pointIndex !== -1) {
        window.routePoints[pointIndex] = point;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º UI
    updateGalleryActions();
    updatePointsList(window.routePoints);
    
    showToast('–§–æ—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∫–∞–∫ –≥–ª–∞–≤–Ω–æ–µ –¥–ª—è —Ç–æ—á–∫–∏', 'success');
}

// –£–¥–∞–ª–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Ñ–æ—Ç–æ —Ç–æ—á–∫–∏
function deleteCurrentPointPhoto() {
    if (!currentPointGallery || !currentGalleryPhotos[currentPointGalleryIndex]) return;
    
    const photo = currentGalleryPhotos[currentPointGalleryIndex];
    const photoId = photo.id;
    
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Ñ–æ—Ç–æ?')) return;
    
    const point = currentPointGallery;
    const photoIndex = point.photos.findIndex(p => 
        (p.id && p.id === photoId) || p === photo
    );
    
    if (photoIndex !== -1) {
        // –ï—Å–ª–∏ —Ñ–æ—Ç–æ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –¥–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö
        if (photoId && typeof photoId === 'number') {
            window.removedPointPhotoIds.add(photoId);
        }
        
        // –£–¥–∞–ª—è–µ–º –∏–∑ –º–∞—Å—Å–∏–≤–∞
        point.photos.splice(photoIndex, 1);
        currentGalleryPhotos.splice(currentPointGalleryIndex, 1);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–∫—É –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
        const pointIndex = window.routePoints.findIndex(p => 
            p.id === point.id || p.tempId === point.id
        );
        if (pointIndex !== -1) {
            window.routePoints[pointIndex] = point;
        }
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≥–∞–ª–µ—Ä–µ—é –µ—Å–ª–∏ —Ñ–æ—Ç–æ –±–æ–ª—å—à–µ –Ω–µ—Ç
        if (point.photos.length === 0) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('pointGalleryModal'));
            if (modal) modal.hide();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ç–æ—á–µ–∫
            updatePointsList(window.routePoints);
            showToast('–§–æ—Ç–æ —É–¥–∞–ª–µ–Ω–æ', 'success');
            return;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≥–∞–ª–µ—Ä–µ—é
        const newIndex = Math.min(currentPointGalleryIndex, point.photos.length - 1);
        openPointGallery(point.id, newIndex);
        updatePointsList(window.routePoints);
        showToast('–§–æ—Ç–æ —É–¥–∞–ª–µ–Ω–æ', 'success');
    }
}

// –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –¥–∞–Ω–Ω—ã–º–∏ –º–∞—Ä—à—Ä—É—Ç–∞
function populateFormData() {
    if (!window.routeData) return;
    
    console.log('üìù –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –º–∞—Ä—à—Ä—É—Ç–∞...');
    
    // –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è
    document.getElementById('name').value = window.routeData.name || '';
    document.getElementById('short_description').value = window.routeData.short_description || '';
    document.getElementById('description').value = window.routeData.description || '';
    document.getElementById('duration_display').value = window.routeData.duration_display || '';
    document.getElementById('privacy').value = window.routeData.privacy || 'public';
    
    // –ß–µ–∫–±–æ–∫—Å—ã
    if (window.routeData.has_audio_guide) {
        document.getElementById('has_audio_guide').checked = true;
    }
    if (window.routeData.is_elderly_friendly) {
        document.getElementById('is_elderly_friendly').checked = true;
    }
    if (window.routeData.is_child_friendly) {
        document.getElementById('is_child_friendly').checked = true;
    }
    
    // –¢–∏–ø –º–∞—Ä—à—Ä—É—Ç–∞
    if (window.routeData.route_type) {
        document.querySelectorAll('.route-type-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.type === window.routeData.route_type) {
                btn.classList.add('active');
            }
        });
    }
    
    console.log('‚úÖ –§–æ—Ä–º–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –¥–∞–Ω–Ω—ã–º–∏ –º–∞—Ä—à—Ä—É—Ç–∞');
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–æ–∫ —Ç–∏–ø–∞ –º–∞—Ä—à—Ä—É—Ç–∞
function setupRouteTypeButtons() {
    document.querySelectorAll('.route-type-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.route-type-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            console.log('üîÑ –¢–∏–ø –º–∞—Ä—à—Ä—É—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞:', this.dataset.type);
        });
    });
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
function setupPhotoUploadHandlers() {
    // –ï–¥–∏–Ω—ã–π input –¥–ª—è –≤—Å–µ—Ö —Ñ–æ—Ç–æ –º–∞—Ä—à—Ä—É—Ç–∞
    const photosInput = document.getElementById('route-photos-input');
    if (photosInput) {
        photosInput.addEventListener('change', handlePhotosUpload);
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–æ–≤—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ —Ñ–æ—Ç–æ –º–∞—Ä—à—Ä—É—Ç–∞
function updatePhotoOrderNumbers() {
    const photoItems = document.querySelectorAll('.additional-photo-item:not(.additional-photo-upload)');
    photoItems.forEach((item, index) => {
        const orderBadge = item.querySelector('.photo-order-badge');
        if (orderBadge) {
            orderBadge.textContent = index + 1;
        } else {
            // –°–æ–∑–¥–∞–µ–º –±–µ–π–¥–∂ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            const badge = document.createElement('div');
            badge.className = 'photo-order-badge';
            badge.textContent = index + 1;
            item.appendChild(badge);
        }
        item.dataset.order = index;
    });
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ –º–∞—Ä—à—Ä—É—Ç–∞
function handlePhotosUpload(e) {
    const files = e.target.files;
    if (!files || files.length === 0) return;
    
    const grid = document.querySelector('.additional-photos-grid');
    if (!grid) return;
    
    // –°—á–∏—Ç–∞–µ–º —Å–∫–æ–ª—å–∫–æ —É–∂–µ –µ—Å—Ç—å —Ñ–æ—Ç–æ
    const existingCount = grid.querySelectorAll('.additional-photo-item:not(.additional-photo-upload)').length;
    const uploadButton = grid.querySelector('.additional-photo-upload');
    
    if (existingCount + files.length > 10) {
        showToast('–ú–∞–∫—Å–∏–º—É–º –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å 10 —Ñ–æ—Ç–æ', 'warning');
        e.target.value = '';
        return;
    }
    
    Array.from(files).forEach((file, index) => {
        if (!validateImageFile(file)) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const photoId = 'new-' + Date.now() + '-' + index + '-' + Math.random().toString(36).substr(2, 9);
            
            const photoItem = document.createElement('div');
            photoItem.className = 'additional-photo-item new-photo';
            photoItem.dataset.photoId = photoId;
            photoItem.dataset.order = existingCount + index;
            photoItem.innerHTML = `
                <img src="${e.target.result}" class="w-100 h-100 object-fit-cover">
                <div class="photo-controls-top">
                    <button type="button" 
                            onclick="makeMainRoutePhoto(this)"
                            title="–°–¥–µ–ª–∞—Ç—å –≥–ª–∞–≤–Ω—ã–º">
                        <i class="fas fa-star text-light"></i>
                    </button>
                    <button type="button" class="photo-remove-btn" 
                            onclick="removeAdditionalRoutePhoto(this, '${photoId}')"
                            title="–£–¥–∞–ª–∏—Ç—å">
                        <i class="fas fa-times text-danger"></i>
                    </button>
                </div>
                <div class="photo-controls-bottom">
                    <button type="button" 
                            onclick="moveRoutePhotoUp(this)"
                            title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–≤–µ—Ä—Ö">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                    <button type="button" 
                            onclick="moveRoutePhotoDown(this)"
                            title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–Ω–∏–∑">
                        <i class="fas fa-arrow-down"></i>
                    </button>
                </div>
                <div class="photo-order-badge">${existingCount + index + 1}</div>
            `;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º ID
            file.previewId = photoId;
            newPhotoFiles.push(file);
            console.log('üñºÔ∏è –ù–æ–≤–æ–µ —Ñ–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:', file.name, 'ID:', photoId);
            
            // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–¥ –∫–Ω–æ–ø–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
            if (uploadButton) {
                grid.insertBefore(photoItem, uploadButton);
            } else {
                grid.appendChild(photoItem);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Ä—è–¥–∫–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞
            updatePhotoOrderNumbers();
        };
        reader.readAsDataURL(file);
    });
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ input
    e.target.value = '';
}

// –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –æ —Ñ–æ—Ç–æ –º–∞—Ä—à—Ä—É—Ç–∞
function collectRoutePhotosData() {
    const photosData = {
        main_photo_id: null,
        additional_photo_ids: [],
        captions: {},
        photo_order: {},
        new_photos: [],
        removed_photos: Array.from(removedExistingPhotos)
    };
    
    console.log('üîç –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –æ —Ñ–æ—Ç–æ –º–∞—Ä—à—Ä—É—Ç–∞...');
    
    const allPhotoItems = document.querySelectorAll('.additional-photos-grid .additional-photo-item:not(.additional-photo-upload)');
    
    let mainPhotoFound = false;
    let photoOrder = 1;
    
    allPhotoItems.forEach((item, index) => {
        const photoId = item.dataset.photoId;
        if (!photoId) return;
        
        const isMainByClass = item.classList.contains('main-photo-selected');
        const isMainById = window.mainPhotoToSet === photoId;
        const isMain = isMainByClass || isMainById;
        
        if (isMain && !mainPhotoFound) {
            mainPhotoFound = true;
            
            if (photoId.startsWith('new-')) {
                photosData.main_photo_id = 'new';
            } else {
                const photoIdInt = parseInt(photoId);
                if (!isNaN(photoIdInt)) {
                    photosData.main_photo_id = photoIdInt;
                }
            }
        }
        
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã–µ —Ñ–æ—Ç–æ
        if (!photoId.startsWith('new-')) {
            const photoIdInt = parseInt(photoId);
            if (!isNaN(photoIdInt) && removedExistingPhotos.has(photoIdInt)) {
                return;
            }
        }
        
        if (isMain && photoId.startsWith('new-')) {
            const file = newPhotoFiles.find(f => f.previewId === photoId);
            if (file) {
                photosData.new_photos.unshift(file);
                photosData.photo_order['main'] = photoOrder;
            }
        } else if (!photoId.startsWith('new-')) {
            const photoIdInt = parseInt(photoId);
            if (!isNaN(photoIdInt)) {
                if (photosData.main_photo_id !== photoIdInt) {
                    photosData.additional_photo_ids.push(photoIdInt);
                    photosData.photo_order[photoIdInt] = photoOrder;
                }
            }
        } else if (photoId.startsWith('new-')) {
            const file = newPhotoFiles.find(f => f.previewId === photoId);
            if (file) {
                photosData.new_photos.push(file);
                photosData.photo_order[photoId] = photoOrder;
            }
        }
        
        const img = item.querySelector('img');
        if (img && img.dataset.caption) {
            photosData.captions[photoId] = img.dataset.caption;
        }
        
        photoOrder++;
    });
    
    if (!mainPhotoFound && allPhotoItems.length > 0) {
        const firstItem = allPhotoItems[0];
        const firstPhotoId = firstItem.dataset.photoId;
        
        if (firstPhotoId) {
            if (firstPhotoId.startsWith('new-')) {
                photosData.main_photo_id = 'new';
            } else {
                const firstPhotoIdInt = parseInt(firstPhotoId);
                if (!isNaN(firstPhotoIdInt)) {
                    photosData.main_photo_id = firstPhotoIdInt;
                }
            }
        }
    }
    
    return photosData;
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã –º–∞—Ä—à—Ä—É—Ç–∞
function getRouteFormData() {
    const formData = new FormData();
    
    // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    formData.append('name', document.getElementById('name').value || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è');
    formData.append('short_description', document.getElementById('short_description').value || '');
    formData.append('description', document.getElementById('description').value || '');
    formData.append('privacy', document.getElementById('privacy').value || 'public');
    
    // –¢–∏–ø –º–∞—Ä—à—Ä—É—Ç–∞
    const routeTypeBtn = document.querySelector('.route-type-btn.active');
    formData.append('route_type', routeTypeBtn ? routeTypeBtn.dataset.type : 'walking');
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    formData.append('duration_display', document.getElementById('duration_display').value || '');
    formData.append('has_audio_guide', document.getElementById('has_audio_guide').checked);
    formData.append('is_elderly_friendly', document.getElementById('is_elderly_friendly').checked);
    formData.append('is_child_friendly', document.getElementById('is_child_friendly').checked);
    
    // –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è
    formData.append('total_distance', document.getElementById('total_distance').value || 0);
    formData.append('duration_minutes', document.getElementById('duration_minutes').value || 0);
    formData.append('is_active', document.getElementById('is_active').value || 'true');
    
    // –î–∞–Ω–Ω—ã–µ –æ —Ñ–æ—Ç–æ –º–∞—Ä—à—Ä—É—Ç–∞
    const photosData = collectRoutePhotosData();
    formData.append('photos_data', JSON.stringify(photosData));
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Ñ–æ—Ç–æ —Ñ–∞–π–ª—ã
    photosData.new_photos.forEach((file, index) => {
        if (file && file instanceof File) {
            formData.append(`photo_${index}`, file);
        }
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã–µ —Ñ–æ—Ç–æ ID
    if (photosData.removed_photos && photosData.removed_photos.length > 0) {
        formData.append('removed_photos', JSON.stringify(photosData.removed_photos));
    }
    
    // –î–∞–Ω–Ω—ã–µ –æ —Ç–æ—á–∫–∞—Ö –º–∞—Ä—à—Ä—É—Ç–∞
    const routeData = {
        waypoints: window.routePoints.map(point => ({
            id: point.id,
            name: point.name || `–¢–æ—á–∫–∞ ${point.order || 1}`,
            description: point.description || '',
            address: point.address || '',
            lat: point.lat || 0,
            lng: point.lng || 0,
            category: point.category || '',
            hint_author: point.hint_author || '',
            tags: point.tags || [],
            photos: point.photos || [],
            order: point.order || 1,
            is_start: point.is_start || false,
            is_end: point.is_end || false
        })),
        total_distance: parseFloat(document.getElementById('total_distance')?.value || 0),
        duration_minutes: parseFloat(document.getElementById('duration_minutes')?.value || 0),
        removed_point_photo_ids: Array.from(window.removedPointPhotoIds || [])
    };
    
    formData.append('route_data', JSON.stringify(routeData));
    
    return formData;
}

// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–æ—Ç–æ –º–∞—Ä—à—Ä—É—Ç–∞ –∫–∞–∫ –≥–ª–∞–≤–Ω–æ–≥–æ
function makeMainRoutePhoto(button) {
    const photoItem = button.closest('.additional-photo-item');
    if (!photoItem) return;
    
    const photoId = photoItem.dataset.photoId;
    if (!photoId) return;
    
    window.mainPhotoToSet = photoId;
    
    document.querySelectorAll('.additional-photo-item').forEach(item => {
        item.classList.remove('main-photo-selected');
        const starIcon = item.querySelector('.photo-controls-top button i.fa-star');
        if (starIcon) {
            starIcon.className = 'fas fa-star text-light';
        }
    });
    
    photoItem.classList.add('main-photo-selected');
    const starIcon = photoItem.querySelector('.photo-controls-top button i.fa-star');
    if (starIcon) {
        starIcon.className = 'fas fa-star text-warning';
    }
    
    showToast('–§–æ—Ç–æ –≤—ã–±—Ä–∞–Ω–æ –∫–∞–∫ –≥–ª–∞–≤–Ω–æ–µ', 'success');
}

// –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ –º–∞—Ä—à—Ä—É—Ç–∞
function removeAdditionalRoutePhoto(button, photoId = null) {
    const photoItem = button.closest('.additional-photo-item');
    if (photoItem) {
        if (photoId && !photoId.startsWith('new-')) {
            const idInt = parseInt(photoId);
            if (!isNaN(idInt)) {
                removedExistingPhotos.add(idInt);
            }
        }
        
        if (photoId && photoId.startsWith('new-')) {
            const index = newPhotoFiles.findIndex(file => 
                file.previewId === photoId
            );
            if (index !== -1) {
                newPhotoFiles.splice(index, 1);
            }
        }
        
        if (photoItem.classList.contains('main-photo-selected')) {
            window.mainPhotoToSet = null;
        }
        
        photoItem.remove();
        updatePhotoOrderNumbers();
    }
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
function validateImageFile(file) {
    if (!file.type.startsWith('image/')) {
        showToast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–∏—Ä–∞–π—Ç–µ —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'warning');
        return false;
    }
    
    if (file.size > 5 * 1024 * 1024) {
        showToast('–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 5MB', 'warning');
        return false;
    }
    
    return true;
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —Ñ–æ—Ç–æ –º–∞—Ä—à—Ä—É—Ç–∞
function moveRoutePhotoUp(button) {
    const photoItem = button.closest('.additional-photo-item');
    if (!photoItem) return;
    
    const prevItem = photoItem.previousElementSibling;
    if (prevItem && !prevItem.classList.contains('additional-photo-upload')) {
        photoItem.parentNode.insertBefore(photoItem, prevItem);
        updatePhotoOrderNumbers();
    }
}

function moveRoutePhotoDown(button) {
    const photoItem = button.closest('.additional-photo-item');
    if (!photoItem) return;
    
    const nextItem = photoItem.nextElementSibling;
    if (nextItem && !nextItem.classList.contains('additional-photo-upload')) {
        photoItem.parentNode.insertBefore(nextItem, photoItem);
        updatePhotoOrderNumbers();
    }
}

// =====================================
// –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –¢–û–ß–ö–ê–ú–ò –ú–ê–†–®–†–£–¢–ê
// =====================================

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Ç–æ—á–µ–∫ (—Å –í–°–ï–ú–ò —Ñ–æ—Ç–æ)
function updatePointsList(points) {
    const pointsList = document.getElementById('points-list');
    const emptyState = document.getElementById('empty-points-state');
    
    if (!pointsList) return;
    
    // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
    pointsList.innerHTML = '';
    
    if (!points || points.length === 0) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        const emptyClone = emptyState.cloneNode(true);
        emptyClone.id = 'empty-points-state-active';
        pointsList.appendChild(emptyClone);
        document.getElementById('points-count').textContent = '0';
        document.getElementById('points-count-display').textContent = '0';
        return;
    }
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–æ—á–∫–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É
    const sortedPoints = [...points].sort((a, b) => {
        const orderA = a.order || (a.is_start ? 0 : (a.is_end ? points.length - 1 : 1));
        const orderB = b.order || (b.is_start ? 0 : (b.is_end ? points.length - 1 : 1));
        return orderA - orderB;
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ—á–∫–∏ –≤ —Å–ø–∏—Å–æ–∫
    sortedPoints.forEach((point, index) => {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Ä—è–¥–æ–∫
        point.order = index + 1;
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü
        if (index === 0 && !point.is_end) {
            point.is_start = true;
            point.is_end = false;
        } else if (index === sortedPoints.length - 1 && !point.is_start) {
            point.is_end = true;
            point.is_start = false;
        } else {
            point.is_start = false;
            point.is_end = false;
        }
        
        const pointItem = createPointListItem(point);
        pointsList.appendChild(pointItem);
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
    const count = sortedPoints.length;
    document.getElementById('points-count').textContent = count;
    document.getElementById('points-count-display').textContent = count;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ—á–∫–∏ –ø–æ ID
function getPointById(pointId) {
    return window.routePoints.find(point => 
        point.id === pointId || point.tempId === pointId
    );
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π —Ç–æ—á–∫–∏
function addNewPoint(pointData) {
    if (!pointData.id && !pointData.tempId) {
        pointData.tempId = 'point-' + Date.now();
    }
    
    window.routePoints.push(pointData);
    updatePointsList(window.routePoints);
    updateRouteStats();
    
    showToast('–¢–æ—á–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞', 'success');
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ—á–∫–∏
function editPoint(pointId) {
    const point = getPointById(pointId);
    if (!point) return;
    
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ—á–∫–∏
    if (typeof window.openPointEditor === 'function') {
        window.openPointEditor(point);
    } else {
        // –ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–ª–µ—Ä—Ç
        showToast('–§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ—á–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'warning');
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ—á–∫–∏
function deletePoint(pointId) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ç–æ—á–∫—É –º–∞—Ä—à—Ä—É—Ç–∞?')) return;
    
    const pointIndex = window.routePoints.findIndex(point => 
        point.id === pointId || point.tempId === pointId
    );
    
    if (pointIndex !== -1) {
        window.routePoints.splice(pointIndex, 1);
        updatePointsList(window.routePoints);
        updateRouteStats();
        
        showToast('–¢–æ—á–∫–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
    }
}

// –û—Ç–∫—Ä—ã—Ç–∏–µ –∑–∞–≥—Ä—É–∑—á–∏–∫–∞ —Ñ–æ—Ç–æ –¥–ª—è —Ç–æ—á–∫–∏
function openPointPhotoUploader(pointId) {
    const point = getPointById(pointId);
    if (!point) return;
    
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä —Ç–æ—á–∫–∏ —Å –∞–∫—Ç–∏–≤–∞—Ü–∏–µ–π –≤–∫–ª–∞–¥–∫–∏ —Ñ–æ—Ç–æ
    if (typeof window.openPointEditor === 'function') {
        window.openPointEditor(point, 'photos');
    } else {
        showToast('–†–µ–¥–∞–∫—Ç–æ—Ä —Ç–æ—á–µ–∫ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω', 'warning');
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞
function updateRouteStats() {
    const distance = window.routePoints.reduce((total, point, index) => {
        if (index === 0) return 0;
        const prevPoint = window.routePoints[index - 1];
        // –ü—Ä–æ—Å—Ç–∞—è –∫–∞–ª—å–∫—É–ª—è—Ü–∏—è —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è (–¥–ª—è –¥–µ–º–æ)
        const latDiff = point.lat - prevPoint.lat;
        const lngDiff = point.lng - prevPoint.lng;
        return total + Math.sqrt(latDiff * latDiff + lngDiff * lngDiff) * 111; // 1 –≥—Ä–∞–¥—É—Å ‚âà 111 –∫–º
    }, 0);
    
    const pointsCount = window.routePoints.length;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    const totalDistanceElement = document.getElementById('total-distance');
    const pointsCountElement = document.getElementById('points-count-display');
    
    if (totalDistanceElement) {
        totalDistanceElement.textContent = distance.toFixed(1) + ' –∫–º';
    }
    
    if (pointsCountElement) {
        pointsCountElement.textContent = pointsCount;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è
    const totalDistanceHidden = document.getElementById('total_distance');
    const durationMinutesHidden = document.getElementById('duration_minutes');
    
    if (totalDistanceHidden) {
        totalDistanceHidden.value = distance.toFixed(1);
    }
    
    if (durationMinutesHidden) {
        // –ü—Ä–∏–º–µ—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏: 5 –º–∏–Ω—É—Ç –Ω–∞ –∫–∏–ª–æ–º–µ—Ç—Ä –¥–ª—è –ø–µ—à–µ—Ö–æ–¥–∞
        const durationMinutes = distance * 5;
        durationMinutesHidden.value = durationMinutes.toFixed(0);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
        const estimatedTimeElement = document.getElementById('estimated-time');
        if (estimatedTimeElement) {
            if (durationMinutes < 60) {
                estimatedTimeElement.textContent = Math.ceil(durationMinutes) + ' –º–∏–Ω';
            } else {
                const hours = Math.floor(durationMinutes / 60);
                const minutes = Math.ceil(durationMinutes % 60);
                estimatedTimeElement.textContent = hours + ' —á ' + minutes + ' –º–∏–Ω';
            }
        }
    }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –¥–µ—Ç–∞–ª–µ–π —Ç–æ—á–∫–∏
function closePointDetails() {
    const detailsDiv = document.getElementById('point-details');
    if (detailsDiv) {
        detailsDiv.style.display = 'none';
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function getCSRFToken() {
    const cookieValue = document.cookie
        .split('; ')
        .find(row => row.startsWith('csrftoken='))
        ?.split('=')[1];
    return cookieValue || '';
}

function showLoading(message = '–ó–∞–≥—Ä—É–∑–∫–∞...') {
    const loadingDiv = document.getElementById('route-loading');
    if (loadingDiv) {
        loadingDiv.querySelector('.fw-medium').textContent = message;
        loadingDiv.style.display = 'block';
    }
}

function hideLoading() {
    const loadingDiv = document.getElementById('route-loading');
    if (loadingDiv) {
        loadingDiv.style.display = 'none';
    }
}

function showToast(message, type = 'info', duration = 3000) {
    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–æ—Å—Ç–æ–≤ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 300px;
        `;
        document.body.appendChild(toastContainer);
    }
    
    const toast = document.createElement('div');
    toast.style.cssText = `
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        word-wrap: break-word;
        animation: slideIn 0.3s ease-out;
        transform-origin: top right;
    `;
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
    const styleSheet = document.createElement('style');
    styleSheet.textContent = `
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100px);
            }
        }
    `;
    document.head.appendChild(styleSheet);
    
    const colors = {
        'success': '#10b981',
        'warning': '#f59e0b', 
        'danger': '#ef4444',
        'info': '#3b82f6'
    };
    
    toast.style.backgroundColor = colors[type] || colors.info;
    toast.textContent = message;
    
    toastContainer.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-out forwards';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, duration);
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
window.removeAdditionalRoutePhoto = removeAdditionalRoutePhoto;
window.makeMainRoutePhoto = makeMainRoutePhoto;
window.validateImageFile = validateImageFile;
window.moveRoutePhotoUp = moveRoutePhotoUp;
window.moveRoutePhotoDown = moveRoutePhotoDown;
window.closePointDetails = closePointDetails;
window.handlePhotosUpload = handlePhotosUpload;
window.updatePhotoOrderNumbers = updatePhotoOrderNumbers;
window.openPointGallery = openPointGallery;
window.openPointPhotoUploader = openPointPhotoUploader;

// –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞
window.updatePointsList = updatePointsList;
window.addNewPoint = addNewPoint;
window.editPoint = editPoint;
window.deletePoint = deletePoint;
window.getPointById = getPointById;
window.updateRouteStats = updateRouteStats;

// –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –≥–∞–ª–µ—Ä–µ–∏ —Ç–æ—á–µ–∫
window.makePointPhotoMain = makePointPhotoMain;
window.deleteCurrentPointPhoto = deleteCurrentPointPhoto;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
window.initializePhotoHandlers = function() {
    if (!window.removedExistingPhotos) window.removedExistingPhotos = new Set();
    if (!window.newPhotoFiles) window.newPhotoFiles = [];
    if (!window.mainPhotoToSet) window.mainPhotoToSet = null;
    if (!window.removedPointPhotoIds) window.removedPointPhotoIds = new Set();
    if (!window.newPointPhotoFiles) window.newPointPhotoFiles = [];
    if (!window.pointMainPhotoToSet) window.pointMainPhotoToSet = null;
    if (!window.routePoints) window.routePoints = [];
    
    console.log('‚úÖ –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ñ–æ—Ç–æ –∏ —Ç–æ—á–µ–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');
};

// –í—ã–∑—ã–≤–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.initializePhotoHandlers();
</script>
<script src="{% static 'js/route_editor.js' %}"></script>
<script src="{% static 'js/audio_generation.js' %}"></script>
{% endblock %}