{% extends 'base.html' %}
{% load static %}

{% block title %}{% if route %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å {{ route.name }}{% else %}–°–æ–∑–¥–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç{% endif %} - Waylines{% endblock %}

{% block content %}
<div class="container-fluid h-100 p-0">
    <div class="row g-0 h-100">
        <!-- –ö–∞—Ä—Ç–∞ -->
        <div class="col-md-8 position-relative">
            <div id="map" class="h-100"></div>
            
            <!-- –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ–π -->
            <div class="map-controls position-absolute top-0 start-0 m-3">
                <div class="btn-group-vertical shadow">
                    <button id="style-toggle" class="btn btn-sm btn-light border" title="–°–º–µ–Ω–∏—Ç—å —Å—Ç–∏–ª—å –∫–∞—Ä—Ç—ã">
                        <i class="fas fa-satellite"></i>
                    </button>
                    <button id="locate-me" class="btn btn-sm btn-light border" title="–ú–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ">
                        <i class="fas fa-location-arrow"></i>
                    </button>
                    <button id="reset-route" class="btn btn-sm btn-light border text-danger" title="–°–±—Ä–æ—Å–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>

            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
            <div class="route-loading position-absolute top-50 start-50 translate-middle bg-white rounded p-3 shadow" 
                 id="route-loading" style="display: none; z-index: 1000;">
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                    <span>–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞...</span>
                </div>
            </div>
        </div>

        <!-- –°–∞–π–¥–±–∞—Ä —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ -->
        <div class="col-md-4">
            <div class="sidebar h-100 bg-white border-start">
                <div class="p-3 border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            {% if route %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç{% else %}–ù–æ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç{% endif %}
                        </h5>
                        <a href="{% if route %}{% url 'route_detail' route.id %}{% else %}{% url 'my_routes' %}{% endif %}" 
                           class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥
                        </a>
                    </div>
                </div>

                <div class="p-3" style="max-height: calc(100vh - 120px); overflow-y: auto;">
                    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                    <div class="mb-4">
                        <h6 class="fw-bold mb-3">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
                        
                        <div class="mb-3">
                            <label class="form-label small fw-bold">–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ *</label>
                            <input type="text" id="name" class="form-control form-control-sm" 
                                   value="{{ route.name|default:'' }}" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small fw-bold">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea id="short_description" class="form-control form-control-sm" rows="2" 
                                      placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞">{{ route.short_description|default:'' }}</textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small fw-bold">–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea id="description" class="form-control form-control-sm" rows="3" 
                                      placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞">{{ route.description|default:'' }}</textarea>
                        </div>
    
                        <div class="mb-3">
                            <label class="form-label small fw-bold">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω)</label>
                            <input type="number" id="duration_minutes" class="form-control form-control-sm" 
                                value="{{ route.duration_minutes|default:0 }}" min="0">
                        </div>
                    </div>

                    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞ -->
                    <div class="mb-4">
                        <h6 class="fw-bold mb-3">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞</h6>
                        
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label small fw-bold">–¢–∏–ø –º–∞—Ä—à—Ä—É—Ç–∞</label>
                                <select id="route_type" class="form-select form-select-sm">
                                    <option value="walking">–ü–µ—à–∏–π</option>
                                    <option value="driving">–ê–≤—Ç–æ–º–æ–±–∏–ª—å–Ω—ã–π</option>
                                    <option value="cycling">–í–µ–ª–æ—Å–∏–ø–µ–¥–Ω—ã–π</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label small fw-bold">–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</label>
                                <select id="privacy" class="form-select form-select-sm">
                                    <option value="public">–ü—É–±–ª–∏—á–Ω—ã–π</option>
                                    <option value="private">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π</option>
                                    <option value="link">–ü–æ —Å—Å—ã–ª–∫–µ</option>
                                    <option value="personal">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π</option>
                                </select>
                            </div>
                        </div>

                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label small fw-bold">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</label>
                                <select id="mood" class="form-select form-select-sm">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</option>
                                    <option value="relaxed">–°–ø–æ–∫–æ–π–Ω—ã–π</option>
                                    <option value="adventure">–ü—Ä–∏–∫–ª—é—á–µ–Ω—á–µ—Å–∫–∏–π</option>
                                    <option value="romantic">–†–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π</option>
                                    <option value="family">–°–µ–º–µ–π–Ω—ã–π</option>
                                    <option value="extreme">–≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–π</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label small fw-bold">–¢–µ–º–∞</label>
                                <select id="theme" class="form-select form-select-sm">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É</option>
                                    <option value="historical">–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π</option>
                                    <option value="nature">–ü—Ä–∏—Ä–æ–¥–Ω—ã–π</option>
                                    <option value="city">–ì–æ—Ä–æ–¥—Å–∫–æ–π</option>
                                    <option value="gastronomy">–ì–∞—Å—Ç—Ä–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π</option>
                                    <option value="art">–ò—Å–∫—É—Å—Å—Ç–≤–æ</option>
                                </select>
                            </div>
                        </div>

                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label small fw-bold">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω)</label>
                                <input type="number" id="duration_minutes" class="form-control form-control-sm" 
                                       value="{{ route.duration_minutes|default:0 }}" min="0">
                            </div>
                            <div class="col-6">
                                <label class="form-label small fw-bold">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ (–∫–º)</label>
                                <input type="number" id="total_distance" class="form-control form-control-sm" 
                                       value="{{ route.total_distance|default:0 }}" min="0" step="0.1" readonly>
                            </div>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="has_audio_guide" 
                                   {% if route.has_audio_guide %}checked{% endif %}>
                            <label class="form-check-label small" for="has_audio_guide">
                                –ï—Å—Ç—å –∞—É–¥–∏–æ–≥–∏–¥
                            </label>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="is_elderly_friendly" 
                                   {% if route.is_elderly_friendly %}checked{% endif %}>
                            <label class="form-check-label small" for="is_elderly_friendly">
                                –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –ø–æ–∂–∏–ª—ã—Ö
                            </label>
                        </div>

                        {% if route %}
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="is_active" 
                                   {% if route.is_active %}checked{% endif %}>
                            <label class="form-check-label small" for="is_active">
                                –ú–∞—Ä—à—Ä—É—Ç –∞–∫—Ç–∏–≤–µ–Ω
                            </label>
                        </div>
                        {% endif %}
                    </div>

                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ —Ç–æ—á–∫–∏ -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-bold mb-0">–¢–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞</h6>
                            <span class="badge bg-primary" id="points-count">0</span>
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ -->
                        <div class="history-controls d-flex justify-content-center gap-2 mb-3">
                            <button id="undo-btn" class="btn btn-sm btn-outline-secondary" title="–û—Ç–º–µ–Ω–∏—Ç—å (Ctrl+Z)" disabled>
                                <i class="fas fa-undo"></i>
                            </button>
                            <button id="redo-btn" class="btn btn-sm btn-outline-secondary" title="–ü–æ–≤—Ç–æ—Ä–∏—Ç—å (Ctrl+Y)" disabled>
                                <i class="fas fa-redo"></i>
                            </button>
                        </div>

                        <div class="route-stats bg-light rounded p-3 mb-3">
                            <div class="row text-center small">
                                <div class="col-6">
                                    <div class="fw-bold" id="total-distance">0 –∫–º</div>
                                    <div class="text-muted">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ</div>
                                </div>
                                <div class="col-6">
                                    <div class="fw-bold" id="estimated-time">0 –º–∏–Ω</div>
                                    <div class="text-muted">–í—Ä–µ–º—è</div>
                                </div>
                            </div>
                        </div>

                        <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–∏–ø–∞ –º–∞—Ä—à—Ä—É—Ç–∞ -->
                        <div class="route-type-toggle d-flex gap-2 mb-3">
                            <div class="route-type-btn active flex-fill text-center py-2 rounded" data-type="walking">
                                üö∂ –ü–µ—à–∏–π
                            </div>
                            <div class="route-type-btn flex-fill text-center py-2 rounded" data-type="driving">
                                üöó –ê–≤—Ç–æ
                            </div>
                            <div class="route-type-btn flex-fill text-center py-2 rounded" data-type="cycling">
                                üö¥ –í–µ–ª–æ
                            </div>
                        </div>

                        <!-- –°–ø–∏—Å–æ–∫ —Ç–æ—á–µ–∫ -->
                        <div class="points-list mb-3">
                            <div id="points-list">
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-map-marker-alt fa-2x mb-2"></i>
                                    <p class="small">–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫–∏</p>
                                </div>
                            </div>
                        </div>

                        <!-- –î–µ—Ç–∞–ª–∏ —Ç–æ—á–∫–∏ -->
                        <div class="point-details card mb-3" id="point-details" style="display: none;">
                            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                                <h6 class="mb-0" id="point-details-title">–î–µ—Ç–∞–ª–∏ —Ç–æ—á–∫–∏</h6>
                                <button type="button" class="btn-close btn-close-sm" onclick="routeEditor.closePointDetails()"></button>
                            </div>
                            <div class="card-body py-2">
                                <div id="point-details-content">
                                    <!-- –î–µ—Ç–∞–ª–∏ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                </div>
                            </div>
                        </div>

                        <button class="btn btn-outline-primary btn-sm w-100 mb-3" id="optimize-btn">
                            <i class="fas fa-magic"></i> –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ä—è–¥–æ–∫
                        </button>

                        <button class="btn btn-outline-secondary btn-sm w-100 mb-3" id="add-waypoint-btn">
                            <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É –≤—Ä—É—á–Ω—É—é
                        </button>

                        <div class="search-bar mb-3">
                            <div class="input-group input-group-sm">
                                <input type="text" id="search-place" class="form-control" 
                                       placeholder="–ü–æ–∏—Å–∫ –º–µ—Å—Ç–∞...">
                                <button class="btn btn-outline-secondary" type="button" id="search-btn">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div id="search-suggestions" class="search-suggestions"></div>
                        </div>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                    <div class="border-top pt-3">
                        <div class="d-grid gap-2">
                            <button id="save-btn" class="btn btn-primary">
                                <i class="fas fa-save"></i> 
                                {% if route %}–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è{% else %}–°–æ–∑–¥–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç{% endif %}
                            </button>
                            
                            {% if route %}
                            <a href="{% url 'route_detail' route.id %}" class="btn btn-outline-secondary">
                                <i class="fas fa-eye"></i> –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
{% include 'routes/modals/point_editor_modal.html' %}
{% include 'routes/modals/delete_confirm_modal.html' %}
{% include 'routes/modals/reset_confirm_modal.html' %}

<!-- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–∞ –µ—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ -->
{% if route_data_json %}
<script>
    window.routeData = {{ route_data_json|safe }};
</script>
{% endif %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
    .sidebar {
        box-shadow: -2px 0 10px rgba(0,0,0,0.1);
    }
    
    .map-controls .btn {
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.9);
    }
    
    .route-loading {
        backdrop-filter: blur(5px);
    }
    
    .waypoint-item {
        transition: all 0.2s ease;
        cursor: pointer;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 8px;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
    }
    
    .waypoint-item:hover {
        background: #f0f9ff;
        border-color: #2563eb;
    }
    
    .waypoint-item.active {
        background: #f0f9ff;
        border-color: #2563eb;
    }
    
    .waypoint-marker {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 12px;
        color: white;
        margin-right: 12px;
        flex-shrink: 0;
    }
    
    .marker-start {
        background: #48bb78;
    }
    
    .marker-end {
        background: #f56565;
    }
    
    .marker-waypoint {
        background: #2563eb;
    }
    
    .waypoint-content {
        flex: 1;
        min-width: 0;
    }
    
    .waypoint-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 4px;
    }
    
    .waypoint-name {
        font-weight: 600;
        font-size: 14px;
        color: #1a1a1a;
        flex: 1;
    }
    
    .waypoint-address {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 6px;
    }
    
    .waypoint-category {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 11px;
        color: #2563eb;
        background: #eff6ff;
        padding: 2px 6px;
        border-radius: 8px;
    }
    
    .route-type-toggle {
        display: flex;
        gap: 8px;
    }
    
    .route-type-btn {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #dee2e6;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s ease;
    }
    
    .route-type-btn.active {
        background: #2563eb;
        color: white;
        border-color: #2563eb;
    }
    
    .route-type-btn:hover:not(.active) {
        background: #f8f9fa;
    }
    
    .search-suggestions {
        position: absolute;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1050;
        display: none;
        width: calc(100% - 40px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    }
    
    .search-suggestion {
        padding: 0.5rem 1rem;
        cursor: pointer;
        border-bottom: 1px solid #f8f9fa;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .search-suggestion:hover {
        background: #f8f9fa;
    }
    
    .hint-section {
        margin-top: 12px;
        padding: 12px;
        background: #fefce8;
        border-radius: 6px;
        border-left: 3px solid #f59e0b;
    }
    
    .hint-text {
        font-size: 14px;
        color: #92400e;
        line-height: 1.4;
    }
    
    .hint-author {
        font-size: 12px;
        color: #b45309;
        margin-top: 4px;
        font-style: italic;
    }
    
    .point-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-bottom: 12px;
    }
    
    .point-tag {
        background: #e5e7eb;
        color: #374151;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 12px;
    }
    
    .point-photos {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        flex-wrap: wrap;
    }
    
    .point-photo {
        width: 80px;
        height: 80px;
        border-radius: 6px;
        object-fit: cover;
        border: 1px solid #e5e7eb;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="{% static 'js/route_editor.js' %}"></script>
{% endblock %}