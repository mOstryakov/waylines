<!-- templates/routes/modals/point_editor_modal.html -->
<div class="modal fade" id="point-editor-modal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-map-marker-alt text-primary me-2"></i>
          –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="point-form">
          <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è -->
          <input type="hidden" id="edit-point-index">
          <input type="hidden" id="edit-point-id">

          <div class="row">
            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label fw-semibold">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏ *</label>
                <input type="text" id="point-name" class="form-control border-0 bg-light" required
                       placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏"
                       style="border-radius: 12px; padding: 12px 16px;">
              </div>

              <div class="mb-3">
                <label class="form-label fw-semibold">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <select id="point-category" class="form-select border-0 bg-light" 
                        style="border-radius: 12px; padding: 12px 16px;">
                  <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                  <option value="attraction">üèõÔ∏è –ò–∑—é–º–∏–Ω–∫–∞</option>
                  <option value="nature">üåø –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–∞—è</option>
                  <option value="forest">üå≤ –õ–µ—Å</option>
                  <option value="bus_stop">üöå –ê–≤—Ç–æ–±—É—Å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞</option>
                  <option value="viewpoint">üëÅÔ∏è –°–º–æ—Ç—Ä–æ–≤–∞—è –ø–ª–æ—â–∞–¥–∫–∞</option>
                  <option value="restaurant">üçΩÔ∏è –†–µ—Å—Ç–æ—Ä–∞–Ω</option>
                  <option value="hotel">üè® –û—Ç–µ–ª—å</option>
                  <option value="museum">üèõÔ∏è –ú—É–∑–µ–π</option>
                  <option value="park">üå≥ –ü–∞—Ä–∫</option>
                  <option value="monument">üóΩ –ü–∞–º—è—Ç–Ω–∏–∫</option>
                  <option value="church">‚õ™ –•—Ä–∞–º</option>
                  <option value="beach">üèñÔ∏è –ü–ª—è–∂</option>
                </select>
              </div>

              <div class="mb-3">
                <label class="form-label fw-semibold">–ê–¥—Ä–µ—Å</label>
                <input type="text" id="point-address" class="form-control border-0 bg-light"
                       placeholder="–ê–¥—Ä–µ—Å –º–µ—Å—Ç–∞"
                       style="border-radius: 12px; padding: 12px 16px;">
                <div class="form-text small text-muted mt-1">
                  –ï—Å–ª–∏ –∞–¥—Ä–µ—Å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ –≤—Ä—É—á–Ω—É—é
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label fw-semibold">–ê–≤—Ç–æ—Ä –ø–æ–¥—Å–∫–∞–∑–∫–∏</label>
                <input type="text" id="point-hint-author" class="form-control border-0 bg-light"
                       placeholder="–ò–º—è –∞–≤—Ç–æ—Ä–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∏"
                       style="border-radius: 12px; padding: 12px 16px;">
              </div>
            </div>

            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label fw-semibold">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</label>
                <div class="coord-inputs">
                  <div class="input-group mb-2">
                    <span class="input-group-text bg-light border-0" style="border-radius: 12px 0 0 12px;">
                      <i class="fas fa-latitude me-1"></i>–®–∏—Ä–æ—Ç–∞
                    </span>
                    <input type="text" id="point-lat" class="form-control border-0 bg-light" readonly
                           style="border-radius: 0 12px 12px 0;">
                  </div>
                  <div class="input-group">
                    <span class="input-group-text bg-light border-0" style="border-radius: 12px 0 0 12px;">
                      <i class="fas fa-longitude me-1"></i>–î–æ–ª–≥–æ—Ç–∞
                    </span>
                    <input type="text" id="point-lng" class="form-control border-0 bg-light" readonly
                           style="border-radius: 0 12px 12px 0;">
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label fw-semibold">–¢–µ–≥–∏</label>
                <input type="text" id="point-tags" class="form-control border-0 bg-light"
                       placeholder="—Ç–µ–≥1, —Ç–µ–≥2, —Ç–µ–≥3..."
                       style="border-radius: 12px; padding: 12px 16px;">
                <div class="form-text small text-muted mt-1">
                  –í–≤–µ–¥–∏—Ç–µ —Ç–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
                </div>
              </div>
            </div>
          </div>

          <div class="mb-4">
            <label class="form-label fw-semibold">–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ—á–∫–∏</label>
            <textarea id="point-description" class="form-control border-0 bg-light" rows="4" 
                      placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ–± —ç—Ç–æ–º –º–µ—Å—Ç–µ..."
                      style="border-radius: 12px; padding: 12px 16px; resize: none;"></textarea>
          </div>

          <!-- –°–ï–ö–¶–ò–Ø –§–û–¢–û–ì–†–ê–§–ò–ô –¢–û–ß–ö–ò -->
          <div class="card border-0 bg-light mb-4">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                  <h6 class="fw-bold text-dark mb-1">
                    <i class="fas fa-camera text-primary me-2"></i>
                    –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Ç–æ—á–∫–∏
                  </h6>
                  <p class="small text-muted mb-0">–î–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ —ç—Ç–æ–≥–æ –º–µ—Å—Ç–∞</p>
                </div>
                <span class="badge bg-primary bg-opacity-10 text-primary" id="photo-count-badge">0/5 —Ñ–æ—Ç–æ</span>
              </div>

              <!-- –ì–∞–ª–µ—Ä–µ—è —Ñ–æ—Ç–æ —Ç–æ—á–∫–∏ -->
              <div class="point-photos-section">
                <label class="form-label fw-semibold small text-muted mb-3 d-block">
                  –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ ‚≠ê —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ –≥–ª–∞–≤–Ω—ã–º
                </label>

                <div class="additional-photos-grid" id="point-photos-grid">
                  <!-- –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å—é–¥–∞ -->
                  <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Ñ–æ—Ç–æ -->
                  <div class="additional-photo-upload"
                       onclick="document.getElementById('point-photos-input').click()">
                    <input type="file" id="point-photos-input" class="d-none" accept="image/*" multiple>
                    <i class="fas fa-plus-circle fa-2x text-muted mb-2"></i>
                    <div class="small text-muted fw-medium">–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</div>
                  </div>
                </div>

                <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø—Ä–æ –≥–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ -->
                <div class="mt-3 pt-3 border-top border-opacity-25">
                  <div class="alert alert-info bg-primary bg-opacity-10 border-primary border-opacity-25 small mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    –ì–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ –æ—Ç–º–µ—á–µ–Ω–æ –∑–æ–ª–æ—Ç–æ–π –∑–≤–µ–∑–¥–æ–π ‚≠ê
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- –°–ï–ö–¶–ò–Ø –ê–£–î–ò–û–ì–ò–î–ê -->
          <div class="card border-0 bg-light mb-4">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-3">
                <div>
                  <h6 class="fw-bold text-dark mb-1">
                    <i class="fas fa-headphones text-primary me-2"></i>
                    –ê—É–¥–∏–æ–≥–∏–¥ —Ç–æ—á–∫–∏
                  </h6>
                  <p class="small text-muted mb-0">–ó–∞–ø–∏—à–∏—Ç–µ, –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ AI-–∞—É–¥–∏–æ</p>
                </div>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="enable-audio-guide" checked>
                  <label class="form-check-label small fw-medium" for="enable-audio-guide">
                    –í–∫–ª—é—á–∏—Ç—å –∞—É–¥–∏–æ
                  </label>
                </div>
              </div>

              <!-- –ê—É–¥–∏–æ–ø–ª–µ–µ—Ä (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ–≥–¥–∞ –∞—É–¥–∏–æ –µ—Å—Ç—å) -->
              <div class="audio-player mb-3" id="point-audio-player" style="display: none;">
                <div class="card bg-white border-0 shadow-sm">
                  <div class="card-body">
                    <div class="d-flex align-items-center gap-3">
                      <button class="btn btn-outline-primary btn-sm rounded-circle audio-play-btn" 
                              style="width: 40px; height: 40px;" type="button">
                        <i class="fas fa-play"></i>
                      </button>
                      <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-1">
                          <div class="progress flex-grow-1" style="height: 6px;">
                            <div class="audio-progress progress-bar" role="progressbar" style="width: 0%"></div>
                          </div>
                          <div class="ms-2 audio-duration small text-muted">0:00</div>
                        </div>
                        <div class="small text-muted" id="audio-filename">–ó–∞–ø–∏—Å—å –∞—É–¥–∏–æ–≥–∏–¥–∞</div>
                      </div>
                      <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary btn-sm" id="re-record-audio" title="–ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å" type="button">
                          <i class="fas fa-redo"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm" id="remove-audio" title="–£–¥–∞–ª–∏—Ç—å –∞—É–¥–∏–æ" type="button">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- –ê—É–¥–∏–æ—Ä–µ–∫–æ—Ä–¥–µ—Ä (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ–≥–¥–∞ –∞—É–¥–∏–æ –Ω–µ—Ç) -->
              <div class="audio-recorder" id="point-audio-recorder">
                <div class="row g-3">
                  <div class="col-md-6">
                    <button class="btn btn-primary w-100" id="start-audio-record" type="button">
                      <i class="fas fa-microphone me-2"></i>–ó–∞–ø–∏—Å–∞—Ç—å –∞—É–¥–∏–æ
                    </button>
                    <div class="recording-indicator mt-2" id="recording-indicator" style="display: none;">
                      <div class="d-flex align-items-center justify-content-center gap-2">
                        <div class="recording-pulse rounded-circle bg-danger" style="width: 12px; height: 12px;"></div>
                        <span class="small fw-medium" id="recording-timer">00:00</span>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <button class="btn btn-outline-secondary w-100" id="upload-audio-file" type="button">
                      <i class="fas fa-upload me-2"></i>–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞—É–¥–∏–æ
                    </button>
                    <input type="file" id="audio-file-input" accept="audio/*" style="display: none;">
                  </div>
                </div>

                <!-- –í–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏ -->
                <div class="recording-visualizer mt-3" id="recording-visualizer" style="display: none;">
                  <div class="card bg-white border-0">
                    <div class="card-body">
                      <div class="audio-visualizer d-flex align-items-end justify-content-center gap-1" 
                           id="live-visualizer" style="height: 60px;"></div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- –°–ï–ö–¶–ò–Ø AI-–ì–ï–ù–ï–†–ê–¶–ò–ò –ê–£–î–ò–û –ò –≠–ö–°–ö–£–†–°–ò–ô -->
              <div class="ai-audio-generator mt-4" id="ai-audio-generator">
                <div class="border-top pt-4 mt-4">
                  <div class="d-flex align-items-center justify-content-between mb-3">
                    <div>
                      <h6 class="fw-bold text-dark mb-1">
                        <i class="fas fa-robot text-primary me-2"></i>
                        AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∞—É–¥–∏–æ–≥–∏–¥–æ–≤
                      </h6>
                      <p class="small text-muted mb-0">–°–æ–∑–¥–∞–π—Ç–µ —Ç–µ–∫—Å—Ç —ç–∫—Å–∫—É—Ä—Å–∏–∏ –∏ –∞—É–¥–∏–æ–≥–∏–¥ –≤ –æ–¥–∏–Ω –∫–ª–∏–∫</p>
                    </div>
                    <span class="badge bg-success bg-opacity-10 text-success">Yandex GPT + SpeechKit</span>
                  </div>

                  <!-- –ë–ª–æ–∫ 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏–Ω—Ç–µ–∑–∞ -->
                  <div class="ai-config-section mb-4">
                    <div class="row g-3">
                      <!-- –Ø–∑—ã–∫ -->
                      <div class="col-md-4">
                        <label class="form-label small fw-semibold">–Ø–∑—ã–∫</label>
                        <select class="form-select form-select-sm" id="ai-language-select">
                          <option value="ru-RU" selected>üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                          <option value="kk-KK">üá∞üáø –ö–∞–∑–∞—Ö—Å–∫–∏–π</option>
                          <option value="uz-UZ">üá∫üáø –£–∑–±–µ–∫—Å–∫–∏–π</option>
                          <option value="en-US">üá∫üá∏ –ê–Ω–≥–ª–∏–π—Å–∫–∏–π</option>
                          <option value="de-DE">üá©üá™ –ù–µ–º–µ—Ü–∫–∏–π</option>
                          <option value="he-IL">üáÆüá± –ò–≤—Ä–∏—Ç</option>
                      </select>
                      </div>
                      
                      <!-- –ì–æ–ª–æ—Å -->
                      <div class="col-md-4">
                        <label class="form-label small fw-semibold">–ì–æ–ª–æ—Å</label>
                        <select class="form-select form-select-sm" id="ai-voice-select">
                          <!-- –ì–æ–ª–æ—Å–∞ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —è–∑—ã–∫–∞ -->
                        </select>
                      </div>
                      
                      <!-- –ê–º–ø–ª—É–∞ -->
                      <div class="col-md-4">
                        <label class="form-label small fw-semibold">–ê–º–ø–ª—É–∞</label>
                        <select class="form-select form-select-sm" id="ai-role-select">
                          <option value="–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π" selected>–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π</option>
                          <option value="–†–∞–¥–æ—Å—Ç–Ω—ã–π">–†–∞–¥–æ—Å—Ç–Ω—ã–π</option>
                          <option value="–†–∞–∑–¥—Ä–∞–∂–µ–Ω–Ω—ã–π">–†–∞–∑–¥—Ä–∞–∂–µ–Ω–Ω—ã–π</option>
                        </select>
                      </div>
                    </div>
                    
                    <!-- –°–∫–æ—Ä–æ—Å—Ç—å –∏ –≤—ã—Å–æ—Ç–∞ –≥–æ–ª–æ—Å–∞ -->
                    <div class="row g-3 mt-2">
                      <div class="col-md-6">
                        <label class="form-label small fw-semibold d-flex justify-content-between">
                          <span>–°–∫–æ—Ä–æ—Å—Ç—å —Ä–µ—á–∏</span>
                          <span id="speed-value" class="text-primary">1x</span>
                        </label>
                        <div class="d-flex align-items-center gap-2">
                          <span class="small text-muted">0.1x</span>
                          <input type="range" class="form-range flex-grow-1" id="speed-slider" 
                                 min="0.1" max="3" step="0.1" value="1">
                          <span class="small text-muted">3x</span>
                        </div>
                      </div>
                      
                      <div class="col-md-6">
                        <label class="form-label small fw-semibold d-flex justify-content-between">
                          <span>–í—ã—Å–æ—Ç–∞ –≥–æ–ª–æ—Å–∞</span>
                          <span id="pitch-value" class="text-primary">0</span>
                        </label>
                        <div class="d-flex align-items-center gap-2">
                          <span class="small text-muted">-1000</span>
                          <input type="range" class="form-range flex-grow-1" id="pitch-slider" 
                                 min="-1000" max="1000" step="10" value="0">
                          <span class="small text-muted">1000</span>
                        </div>
                      </div>
                    </div>
                    
                    <!-- –§–æ—Ä–º–∞—Ç –∞—É–¥–∏–æ -->
                    <div class="row g-3 mt-3">
                      <div class="col-md-12">
                        <label class="form-label small fw-semibold">–§–æ—Ä–º–∞—Ç –∞—É–¥–∏–æ</label>
                        <div class="d-flex gap-3">
                          <div class="form-check">
                            <input class="form-check-input" type="radio" name="audio-format" id="format-mp3" value="mp3" checked>
                            <label class="form-check-label small" for="format-mp3">
                              MP3
                            </label>
                          </div>
                          <div class="form-check">
                            <input class="form-check-input" type="radio" name="audio-format" id="format-ogg" value="ogg">
                            <label class="form-check-label small" for="format-ogg">
                              OggOpus
                            </label>
                          </div>
                          <div class="form-check">
                            <input class="form-check-input" type="radio" name="audio-format" id="format-wav" value="wav">
                            <label class="form-check-label small" for="format-wav">
                              WAV
                            </label>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- –ë–ª–æ–∫ 2: –í—ã–±–æ—Ä —Ç–∏–ø–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ -->
                  <div class="generation-type-section mb-4">
                    <div class="row g-3">
                      <div class="col-md-12">
                        <label class="form-label small fw-semibold">–¢–∏–ø –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</label>
                        <div class="btn-group w-100" role="group">
                          <input type="radio" class="btn-check" name="generation-type" id="generate-audio" 
                                 value="audio" autocomplete="off" checked>
                          <label class="btn btn-outline-primary" for="generate-audio">
                            <i class="fas fa-volume-up me-2"></i>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∞—É–¥–∏–æ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é
                          </label>
                          
                          <input type="radio" class="btn-check" name="generation-type" id="generate-both" 
                                 value="both" autocomplete="off">
                          <label class="btn btn-outline-success" for="generate-both">
                            <i class="fas fa-magic me-2"></i>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –∞—É–¥–∏–æ
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- –ë–ª–æ–∫ 3: –¢–µ–∫—Å—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ -->
                  <div class="mb-4" id="audio-from-description-section">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <label class="form-label small fw-semibold mb-0">–¢–µ–∫—Å—Ç –¥–ª—è –∞—É–¥–∏–æ–≥–∏–¥–∞</label>
                      <div>
                        <button class="btn btn-sm btn-outline-secondary" id="use-description-btn" type="button">
                          <i class="fas fa-sync me-1"></i>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ—á–∫–∏
                        </button>
                        <button class="btn btn-sm btn-outline-primary" id="edit-text-btn" type="button">
                          <i class="fas fa-edit me-1"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                      </div>
                    </div>
                    
                    <div class="card bg-white border">
                      <div class="card-body">
                        <div id="ai-text-preview" 
                             style="min-height: 150px; max-height: 250px; overflow-y: auto; font-size: 0.9em; line-height: 1.5;"
                             class="ai-generated-text"
                             contenteditable="false">
                          <div class="text-center text-muted py-4">
                            <i class="fas fa-comment-alt fa-2x mb-2"></i>
                            <div>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞—É–¥–∏–æ</div>
                            <div class="small mt-1">–ù–∞–∂–º–∏—Ç–µ "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ—á–∫–∏" –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- –ë–ª–æ–∫ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–ø–∏—Å–∞–Ω–∏—è -->
                  <div class="mb-4" id="generate-description-section" style="display: none;">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label small fw-semibold">–°—Ç–∏–ª—å –æ–ø–∏—Å–∞–Ω–∏—è</label>
                        <select class="form-select form-select-sm" id="description-style">
                          <option value="storytelling" selected>üìñ –†–∞—Å—Å–∫–∞–∑ –æ—Ç –≥–∏–¥–∞</option>
                          <option value="historical">üèõÔ∏è –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π</option>
                          <option value="touristic">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –¢—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π</option>
                          <option value="poetic">üé≠ –ü–æ—ç—Ç–∏—á–µ—Å–∫–∏–π</option>
                          <option value="scientific">üî¨ –ù–∞—É—á–Ω—ã–π</option>
                        </select>
                      </div>
                      
                      <div class="col-md-6">
                        <label class="form-label small fw-semibold">–î–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞</label>
                        <select class="form-select form-select-sm" id="description-length">
                          <option value="short">–ö—Ä–∞—Ç–∫–∏–π (1-2 –∞–±–∑–∞—Ü–∞)</option>
                          <option value="medium" selected>–°—Ä–µ–¥–Ω–∏–π (3-4 –∞–±–∑–∞—Ü–∞)</option>
                          <option value="long">–ü–æ–¥—Ä–æ–±–Ω—ã–π (5+ –∞–±–∑–∞—Ü–µ–≤)</option>
                        </select>
                      </div>
                    </div>
                    
                    <div class="mt-3">
                      <div class="coordinates-info text-muted small">
                        <i class="fas fa-map-marker-alt me-1"></i>
                        <span id="current-coordinates-display">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: –Ω–µ —É–∫–∞–∑–∞–Ω—ã</span>
                      </div>
                      <div class="form-text small mt-1">
                        –û–ø–∏—Å–∞–Ω–∏–µ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∏ –∞–¥—Ä–µ—Å–∞ —Ç–æ—á–∫–∏
                      </div>
                    </div>
                  </div>

                  <!-- –ë–ª–æ–∫ 5: –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                  <div class="ai-controls-section">
                    <div class="d-grid gap-2">
                      <button class="btn btn-primary btn-lg" id="ai-generate-main-btn" type="button">
                        <i class="fas fa-magic me-2"></i>
                        <span id="generate-btn-text">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∞—É–¥–∏–æ</span>
                      </button>
                    </div>
                  </div>

                  <!-- –ë–ª–æ–∫ 6: –ü—Ä–æ–≥—Ä–µ—Å—Å –∏ —Å—Ç–∞—Ç—É—Å -->
                  <div class="ai-status-section mt-4">
                    <div class="ai-generation-progress" id="ai-generation-progress" style="display: none;">
                      <div class="alert alert-info border-0">
                        <div class="d-flex align-items-center">
                          <div class="spinner-border spinner-border-sm me-3" role="status"></div>
                          <div class="flex-grow-1">
                            <div class="fw-medium small" id="progress-status">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</div>
                            <div class="progress mt-2" style="height: 4px;">
                              <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="ai-audio-success mt-3" id="ai-audio-success" style="display: none;">
                      <div class="alert alert-success border-0">
                        <div class="d-flex align-items-center">
                          <i class="fas fa-volume-up me-3"></i>
                          <div class="flex-grow-1">
                            <div class="fw-medium small">–ê—É–¥–∏–æ–≥–∏–¥ —Å–æ–∑–¥–∞–Ω!</div>
                            <div class="small mt-1" id="success-message">–ê—É–¥–∏–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ –∫ —Ç–æ—á–∫–µ</div>
                          </div>
                          <button class="btn btn-success btn-sm" id="play-generated-audio-btn" type="button">
                            <i class="fas fa-play me-1"></i>–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏
                          </button>
                        </div>
                      </div>
                    </div>

                    <div class="ai-generation-error mt-3" id="ai-generation-error" style="display: none;">
                      <div class="alert alert-danger border-0">
                        <div class="d-flex align-items-center">
                          <i class="fas fa-exclamation-triangle me-3"></i>
                          <div class="flex-grow-1">
                            <div class="fw-medium small" id="ai-error-title">–û—à–∏–±–∫–∞</div>
                            <div class="small mt-1" id="ai-error-message"></div>
                          </div>
                        </div>
                        <button class="btn btn-sm btn-outline-danger mt-2" id="retry-ai-generation" type="button">
                          <i class="fas fa-redo me-1"></i>–ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∞—É–¥–∏–æ -->
              <div class="mt-3 pt-3 border-top border-opacity-25">
                <div class="alert alert-warning bg-warning bg-opacity-10 border-warning border-opacity-25 small mb-0">
                  <i class="fas fa-info-circle me-2"></i>
                  –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: MP3, WAV, M4A. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä - 50MB
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i>–û—Ç–º–µ–Ω–∞
        </button>
        <button type="button" id="save-point-btn" class="btn btn-primary">
          <i class="fas fa-save me-1"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ—á–∫—É
        </button>
      </div>
    </div>
  </div>
</div>

<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π - –£–õ–£–ß–®–ï–ù–ù–´–ï */
.additional-photos-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  padding: 10px 0;
}

.additional-photo-item {
  position: relative;
  width: 120px;
  height: 120px;
  border-radius: 8px;
  overflow: hidden;
  cursor: pointer;
  transition: all 0.3s ease;
  background: #fff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.additional-photo-item:hover {
  transform: translateY(-5px);
  box-shadow: 0 5px 15px rgba(0,0,0,0.15);
}

.additional-photo-item.main-photo-selected {
  border: 3px solid #ffc107;
  box-shadow: 0 0 15px rgba(255, 193, 7, 0.4);
}

.additional-photo-upload {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 120px;
  height: 120px;
  border: 2px dashed #dee2e6;
  border-radius: 8px;
  background-color: #f8f9fa;
  cursor: pointer;
  transition: all 0.3s ease;
  order: 999; /* –í—Å–µ–≥–¥–∞ –≤ –∫–æ–Ω—Ü–µ */
}

.additional-photo-upload:hover {
  border-color: #0d6efd;
  background-color: #e7f1ff;
  transform: scale(1.05);
}

.additional-photo-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

/* –£–±–∏—Ä–∞–µ–º –Ω–∞–ª–æ–∂–µ–Ω–∏–µ - –í–ê–ñ–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï */
.photo-controls-top {
  position: absolute;
  top: 5px;
  right: 5px;
  display: flex;
  gap: 5px;
  z-index: 10; /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º z-index */
}

.photo-controls-top button {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: rgba(0,0,0,0.75);
  border: none;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
  z-index: 11; /* –ö–Ω–æ–ø–∫–∏ –≤—ã—à–µ –≤—Å–µ–≥–æ */
}

.photo-controls-top button:hover {
  background: rgba(0,0,0,0.9);
  transform: scale(1.1);
}

.photo-controls-bottom {
  position: absolute;
  bottom: 5px;
  left: 5px;
  display: flex;
  gap: 5px;
  z-index: 10;
}

.photo-controls-bottom button {
  width: 28px;
  height: 28px;
  border-radius: 4px;
  background: rgba(255,255,255,0.95);
  border: 1px solid #dee2e6;
  color: #495057;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  cursor: pointer;
  transition: all 0.2s;
  z-index: 11;
}

.photo-controls-bottom button:hover {
  background: white;
  border-color: #0d6efd;
  color: #0d6efd;
  transform: scale(1.1);
}

.photo-order-badge {
  position: absolute;
  top: 5px;
  left: 5px;
  background: rgba(13, 110, 253, 0.95);
  color: white;
  font-size: 10px;
  padding: 3px 7px;
  border-radius: 4px;
  font-weight: bold;
  z-index: 10;
  min-width: 24px;
  text-align: center;
}

.recording-pulse {
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}

/* –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è */
.additional-photo-item * {
  box-sizing: border-box;
}

/* –§–∏–∫—Å–∏—Ä—É–µ–º z-index –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω */
#point-editor-modal {
  z-index: 1060;
}

#point-editor-modal .modal-dialog {
  z-index: 1061;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.additional-photo-item {
  animation: fadeInUp 0.3s ease forwards;
}
</style>

<script>
// ====== POINT EDITOR ======
window.pointEditor = {
    currentPointIndex: null,
    currentPointId: null,
    pointPhotos: [],
    pointAudio: null,
    audioElement: null,
    recordingTimer: null,
    visualizerInterval: null,
    isGeneratingAudio: false,
    generatedText: null,
    currentGenerationType: 'audio',
    
    // –ö–∞—Ä—Ç–∞ –≥–æ–ª–æ—Å–æ–≤ –ø–æ —è–∑—ã–∫–∞–º
    voiceMapByLanguage: {
        'ru-RU': [
            {name: '–§–∏–ª–∏–ø–ø', code: 'filipp'},
            {name: '–ï—Ä–º–∏–ª', code: 'ermil'},
            {name: '–ó–∞—Ö–∞—Ä', code: 'zahar'},
            {name: '–î–∞—à–∞', code: 'dasha'},
            {name: '–Æ–ª–∏—è', code: 'julia'},
            {name: '–õ–µ—Ä–∞', code: 'lera'},
            {name: '–ú–∞—Ä–∏–Ω–∞', code: 'marina'},
            {name: '–ê–ª–µ–∫—Å–∞–Ω–¥—Ä', code: 'alexander'},
            {name: '–ö–∏—Ä–∏–ª–ª', code: 'kirill'},
            {name: '–ê–Ω—Ç–æ–Ω', code: 'anton'},
            {name: '–ú–∞—à–∞', code: 'masha'}
        ],
        'kk-KK': [
            {name: '–ú–∞–¥–∏', code: 'madi'},
            {name: '–ê–º–∏—Ä–∞', code: 'amira'},
            {name: '–ñ–∞–Ω–∞—Ä', code: 'zhanar'},
            {name: '–°–∞—É–ª–µ', code: 'saule'}
        ],
        'uz-UZ': [
            {name: '–Æ–ª–¥—É–∑', code: 'yuldus'},
            {name: '–ù–∏–≥–æ—Ä–∞', code: 'nigora'},
            {name: '–ó–∞–º–∏—Ä–∞', code: 'zamira'}
        ],
        'en-US': [
            {name: '–î–∂–æ–Ω', code: 'john'}
        ],
        'de-DE': [
            {name: '–õ–µ–∞', code: 'lea'}
        ],
        'he-IL': [
            {name: '–ù–∞–æ–º–∏', code: 'naomi'}
        ]
    },
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    init: function() {
        console.log('üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —Ç–æ—á–µ–∫...');
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Ñ–æ—Ç–æ —Ç–æ—á–∫–∏
        this.setupPointPhotoHandlers();
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∞—É–¥–∏–æ
        this.setupAudioHandlers();
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        this.setupAIGenerationHandlers();
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        document.getElementById('save-point-btn').addEventListener('click', () => this.savePoint());
        
        // –°–æ–∑–¥–∞–µ–º –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç
        this.setupAudioElement();
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª–∞–π–¥–µ—Ä–æ–≤
        this.setupSliders();
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        this.setupGenerationTypeHandlers();
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –≤—ã–±–æ—Ä–∞ –≥–æ–ª–æ—Å–æ–≤
        this.setupVoiceSelection();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å route_editor.js
        this.initCompatibility();
        
        console.log('‚úÖ –†–µ–¥–∞–∫—Ç–æ—Ä —Ç–æ—á–µ–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    },
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    initCompatibility: function() {
        // –°–æ–∑–¥–∞–µ–º audioGenerationManager –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å route_editor.js
        window.audioGenerationManager = {
            showAudioForPoint: (pointId, pointData) => {
                console.log('üéµ audioGenerationManager.showAudioForPoint:', pointId);
                this.handleAudioForPoint(pointId, pointData);
            },
            
            showNoAudio: () => {
                console.log('üéµ audioGenerationManager.showNoAudio');
                this.showAudioRecorder();
            },
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
            currentAudioUrl: null,
            
            generateAudio: () => {
                console.log('üéµ audioGenerationManager.generateAudio');
                return this.processAIGeneration();
            },
            
            deleteAudio: () => {
                console.log('üéµ audioGenerationManager.deleteAudio');
                this.removeAudio();
                return Promise.resolve();
            },
            
            openAudioSettings: () => {
                console.log('üéµ audioGenerationManager.openAudioSettings');
                // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ —Å–µ–∫—Ü–∏–∏ AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
                const aiSection = document.getElementById('ai-audio-generator');
                if (aiSection) {
                    aiSection.scrollIntoView({ behavior: 'smooth' });
                }
            }
        };
    },
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –≤—ã–±–æ—Ä–∞ –≥–æ–ª–æ—Å–æ–≤
    setupVoiceSelection: function() {
        const languageSelect = document.getElementById('ai-language-select');
        const voiceSelect = document.getElementById('ai-voice-select');
        
        if (languageSelect && voiceSelect) {
            const updateVoices = () => {
                const selectedLanguage = languageSelect.value;
                const voices = this.voiceMapByLanguage[selectedLanguage] || this.voiceMapByLanguage['ru-RU'];
                const currentVoice = voiceSelect.value;
                
                voiceSelect.innerHTML = '';
                
                voices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.name;
                    option.textContent = voice.name;
                    voiceSelect.appendChild(option);
                });
                
                const availableVoices = voices.map(v => v.name);
                if (availableVoices.includes(currentVoice)) {
                    voiceSelect.value = currentVoice;
                } else if (voices.length > 0) {
                    voiceSelect.value = voices[0].name;
                }
            };
            
            languageSelect.addEventListener('change', updateVoices);
            updateVoices();
        }
    },
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª–∞–π–¥–µ—Ä–æ–≤ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ –≤—ã—Å–æ—Ç—ã
    setupSliders: function() {
        const speedSlider = document.getElementById('speed-slider');
        const speedValue = document.getElementById('speed-value');
        if (speedSlider && speedValue) {
            speedSlider.addEventListener('input', (e) => {
                speedValue.textContent = `${parseFloat(e.target.value).toFixed(1)}x`;
            });
            speedValue.textContent = `${parseFloat(speedSlider.value).toFixed(1)}x`;
        }
        
        const pitchSlider = document.getElementById('pitch-slider');
        const pitchValue = document.getElementById('pitch-value');
        if (pitchSlider && pitchValue) {
            pitchSlider.addEventListener('input', (e) => {
                pitchValue.textContent = e.target.value;
            });
            pitchValue.textContent = pitchSlider.value;
        }
    },
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    setupGenerationTypeHandlers: function() {
        const generateAudioRadio = document.getElementById('generate-audio');
        const generateBothRadio = document.getElementById('generate-both');
        const audioFromDescriptionSection = document.getElementById('audio-from-description-section');
        const generateDescriptionSection = document.getElementById('generate-description-section');
        const generateBtn = document.getElementById('ai-generate-main-btn');
        const generateBtnText = document.getElementById('generate-btn-text');
        
        if (generateAudioRadio && generateBothRadio) {
            generateAudioRadio.addEventListener('change', (e) => {
                if (e.target.checked) {
                    this.currentGenerationType = 'audio';
                    audioFromDescriptionSection.style.display = 'block';
                    generateDescriptionSection.style.display = 'none';
                    generateBtnText.textContent = '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∞—É–¥–∏–æ';
                    this.updateCoordinatesDisplay();
                }
            });
            
            generateBothRadio.addEventListener('change', (e) => {
                if (e.target.checked) {
                    this.currentGenerationType = 'both';
                    audioFromDescriptionSection.style.display = 'none';
                    generateDescriptionSection.style.display = 'block';
                    generateBtnText.textContent = '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –∞—É–¥–∏–æ';
                    this.updateCoordinatesDisplay();
                }
            });
            
            if (generateAudioRadio.checked) {
                this.currentGenerationType = 'audio';
                audioFromDescriptionSection.style.display = 'block';
                generateDescriptionSection.style.display = 'none';
                generateBtnText.textContent = '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∞—É–¥–∏–æ';
            } else if (generateBothRadio.checked) {
                this.currentGenerationType = 'both';
                audioFromDescriptionSection.style.display = 'none';
                generateDescriptionSection.style.display = 'block';
                generateBtnText.textContent = '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –∞—É–¥–∏–æ';
            }
        }
    },
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
    updateCoordinatesDisplay: function() {
        const lat = document.getElementById('point-lat').value;
        const lng = document.getElementById('point-lng').value;
        const address = document.getElementById('point-address').value || '–Ω–µ —É–∫–∞–∑–∞–Ω';
        
        const displayText = `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${lat || '‚Äî'}, ${lng || '‚Äî'} | –ê–¥—Ä–µ—Å: ${address}`;
        
        const coordinatesDisplay = document.getElementById('current-coordinates-display');
        if (coordinatesDisplay) {
            coordinatesDisplay.textContent = displayText;
        }
    },
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ —Ñ–æ—Ç–æ
    updatePhotoCount: function() {
        const grid = document.querySelector('#point-photos-grid');
        if (!grid) return;
        
        const photoItems = grid.querySelectorAll('.additional-photo-item:not(.additional-photo-upload)');
        const count = photoItems.length;
        const badge = document.getElementById('photo-count-badge');
        
        if (badge) {
            badge.textContent = `${count}/5 —Ñ–æ—Ç–æ`;
            
            if (count >= 5) {
                badge.classList.remove('bg-primary');
                badge.classList.add('bg-danger');
            } else {
                badge.classList.remove('bg-danger');
                badge.classList.add('bg-primary');
            }
        }
        
        return count;
    },
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ –¥–ª—è —Ç–æ—á–∫–∏
    handleAudioForPoint: function(pointId, pointData) {
        this.currentPointId = pointId;
        
        if (pointData?.audio_url) {
            this.pointAudio = {
                url: pointData.audio_url,
                filename: pointData.audio_filename || '–ê—É–¥–∏–æ–≥–∏–¥ —Ç–æ—á–∫–∏',
                is_ai_generated: pointData.ai_audio_generated || false
            };
            this.showAudioPlayer();
            
            if (pointData.ai_audio_generated) {
                this.showAIGenerationSuccess();
            }
        } else {
            this.showAudioRecorder();
        }
        
        if (pointData?.description) {
            this.generatedText = pointData.description;
            const preview = document.getElementById('ai-text-preview');
            if (preview) {
                preview.innerHTML = `<div class="ai-generated-text">${this.escapeHtml(pointData.description)}</div>`;
            }
        }
        
        setTimeout(() => {
            this.updateCoordinatesDisplay();
        }, 100);
        
        const generateBtn = document.getElementById('ai-generate-main-btn');
        if (generateBtn) {
            generateBtn.disabled = !pointId || pointId <= 0;
        }
    },
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    setupAIGenerationHandlers: function() {
        const generateBtn = document.getElementById('ai-generate-main-btn');
        if (generateBtn) {
            generateBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                this.processAIGeneration();
            });
        }
        
        const useDescBtn = document.getElementById('use-description-btn');
        if (useDescBtn) {
            useDescBtn.addEventListener('click', (e) => {
                e.preventDefault();
                this.loadExistingDescription();
            });
        }
        
        const editTextBtn = document.getElementById('edit-text-btn');
        if (editTextBtn) {
            editTextBtn.addEventListener('click', (e) => {
                e.preventDefault();
                this.toggleEditText();
            });
        }
        
        const retryBtn = document.getElementById('retry-ai-generation');
        if (retryBtn) {
            retryBtn.addEventListener('click', (e) => {
                e.preventDefault();
                this.processAIGeneration();
            });
        }
        
        const playAudioBtn = document.getElementById('play-generated-audio-btn');
        if (playAudioBtn) {
            playAudioBtn.addEventListener('click', (e) => {
                e.preventDefault();
                this.toggleAudioPlayback();
            });
        }
    },
    
    // –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    processAIGeneration: async function() {
        console.log('üîÑ –ù–∞—á–∞–ª–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ AI:');
        
        if (!this.currentPointId || this.currentPointId <= 0) {
            this.showToast('–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ç–æ—á–∫—É', 'warning');
            return;
        }
        
        if (this.currentGenerationType === 'audio') {
            if (!this.generatedText || this.generatedText.trim() === '') {
                this.showToast('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞—É–¥–∏–æ', 'warning');
                return;
            }
            
            if (this.generatedText.length > 5000) {
                this.showToast('–¢–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π (–º–∞–∫—Å–∏–º—É–º 5000 —Å–∏–º–≤–æ–ª–æ–≤)', 'warning');
                return;
            }
        }
        
        if (this.isGeneratingAudio) {
            return;
        }
        
        this.showGenerationProgress('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...');
        
        try {
            let textToGenerate = this.generatedText;
            
            if (this.currentGenerationType === 'both') {
                console.log('üìù –†–µ–∂–∏–º: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–ø–∏—Å–∞–Ω–∏—è –∏ –∞—É–¥–∏–æ');
                this.showGenerationProgress('Yandex GPT —Å–æ–∑–¥–∞—ë—Ç –æ–ø–∏—Å–∞–Ω–∏–µ...');
                textToGenerate = await this.generateDescription();
                
                this.generatedText = textToGenerate;
                document.getElementById('point-description').value = textToGenerate;
                this.showToast('‚úÖ –û–ø–∏—Å–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success');
            }
            
            if (textToGenerate) {
                console.log('üîä –ù–∞—á–∞–ª–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞—É–¥–∏–æ, –¥–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞:', textToGenerate.length);
                const audioUrl = await this.generateAudioFromText(textToGenerate);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º currentAudioUrl –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                if (window.audioGenerationManager) {
                    window.audioGenerationManager.currentAudioUrl = audioUrl;
                }
                
            } else {
                throw new Error('–ù–µ—Ç —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞—É–¥–∏–æ');
            }
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:', error);
            this.showGenerationError(error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
            this.showToast(`–û—à–∏–±–∫–∞: ${error.message}`, 'danger');
        } finally {
            this.hideGenerationProgress();
        }
    },
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–ø–∏—Å–∞–Ω–∏—è —Å –ø–æ–º–æ—â—å—é Yandex GPT
    generateDescription: async function() {
        const latInput = document.getElementById('point-lat');
        const lngInput = document.getElementById('point-lng');
        
        if (!latInput || !lngInput) {
            throw new Error('–ü–æ–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —Ñ–æ—Ä–º–µ');
        }
        
        const lat = parseFloat(latInput.value);
        const lng = parseFloat(lngInput.value);
        
        if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
            throw new Error('–°–Ω–∞—á–∞–ª–∞ —É–∫–∞–∂–∏—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–∫–∏ –≤ —Ñ–æ—Ä–º–µ');
        }
        
        this.isGeneratingText = true;
        this.showGenerationProgress('Yandex GPT —Å–æ–∑–¥–∞—ë—Ç —Ç–µ–∫—Å—Ç —ç–∫—Å–∫—É—Ä—Å–∏–∏...');
        
        try {
            const csrftoken = this.getCookie('csrftoken');
            const style = document.getElementById('description-style').value;
            const length = document.getElementById('description-length').value;
            const address = document.getElementById('point-address').value || '';
            
            const response = await fetch(`/api/ai-audio/generate-location-description/${this.currentPointId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    style: style,
                    save_to_point: false,
                    address: address,
                    length: length,
                    lat: lat,
                    lng: lng
                })
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', errorText);
                
                try {
                    const errorData = JSON.parse(errorText);
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                } catch (e) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            }
            
            const data = await response.json();
            
            if (data.status === 'success') {
                this.generatedText = data.description;
                this.lastGeneratedTextSource = 'coordinates';
                this.updateTextPreview(data.description);
                this.showToast('‚úÖ –¢–µ–∫—Å—Ç —ç–∫—Å–∫—É—Ä—Å–∏–∏ —Å–æ–∑–¥–∞–Ω!', 'success');
                return data.description;
            } else {
                throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
            }
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–ø–∏—Å–∞–Ω–∏—è:', error);
            throw error;
        } finally {
            this.isGeneratingText = false;
        }
    },
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞—É–¥–∏–æ –∏–∑ —Ç–µ–∫—Å—Ç–∞
    generateAudioFromText: async function(text) {
        this.isGeneratingAudio = true;
        this.showGenerationProgress('SpeechKit –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∞—É–¥–∏–æ...');
        
        try {
            const csrftoken = this.getCookie('csrftoken');
            
            const voice = document.getElementById('ai-voice-select').value;
            const language = document.getElementById('ai-language-select').value;
            const role = document.getElementById('ai-role-select').value;
            const speed = parseFloat(document.getElementById('speed-slider').value);
            const pitch = parseInt(document.getElementById('pitch-slider').value);
            
            const formatInputs = document.getElementsByName('audio-format');
            let format = 'mp3';
            for (let input of formatInputs) {
                if (input.checked) {
                    format = input.value;
                    break;
                }
            }
            
            const ttsLanguage = language.split('-')[0];
            
            let ttsVoice = 'ermil';
            const voicesForLanguage = this.voiceMapByLanguage[language] || this.voiceMapByLanguage['ru-RU'];
            const voiceInfo = voicesForLanguage.find(v => v.name === voice);
            if (voiceInfo) {
                ttsVoice = voiceInfo.code;
            }
            
            const emotionMapping = {
                '–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π': 'neutral',
                '–†–∞–¥–æ—Å—Ç–Ω—ã–π': 'good',
                '–†–∞–∑–¥—Ä–∞–∂–µ–Ω–Ω—ã–π': 'evil'
            };
            
            const emotion = emotionMapping[role] || 'neutral';
            
            let expressiveness = 50;
            if (role === '–†–∞–¥–æ—Å—Ç–Ω—ã–π') expressiveness = 80;
            if (role === '–†–∞–∑–¥—Ä–∞–∂–µ–Ω–Ω—ã–π') expressiveness = 70;
            
            let voiceType = 'male_guide_ru';
            if (voice === '–î–∞—à–∞' || voice === '–Æ–ª–∏—è' || voice === '–õ–µ—Ä–∞' || voice === '–ú–∞—Ä–∏–Ω–∞' || 
                voice === '–ú–∞—à–∞' || voice === '–ê–º–∏—Ä–∞' || voice === '–ñ–∞–Ω–∞—Ä' || voice === '–°–∞—É–ª–µ' || 
                voice === '–Æ–ª–¥—É–∑' || voice === '–ó–∞–º–∏—Ä–∞' || voice === '–ù–∏–≥–æ—Ä–∞' || voice === '–õ–µ–∞' || 
                voice === '–ù–∞–æ–º–∏') {
                voiceType = 'female_guide_ru';
            }
            
            const response = await fetch(`/api/ai-audio/generate/${this.currentPointId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    text: text,
                    voice_type: voiceType,
                    language: ttsLanguage,
                    expressiveness: expressiveness,
                    generation_type: this.currentGenerationType,
                    voice: ttsVoice,
                    emotion: emotion,
                    speed: speed,
                    pitch: pitch,
                    format: format
                })
            });
            
            const data = await response.json();
            
            if (response.ok && data.status === 'success') {
                this.pointAudio = {
                    url: data.audio_url,
                    filename: `–ê—É–¥–∏–æ–≥–∏–¥_${voice}_${new Date().toLocaleDateString('ru-RU')}.${format}`,
                    is_ai_generated: true
                };
                
                this.showAudioPlayer();
                this.showAudioResult();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞—É–¥–∏–æ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ –º–∞—Ä—à—Ä—É—Ç–∞ –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                if (window.routeEditor && typeof window.routeEditor.updatePointAudio === 'function') {
                    window.routeEditor.updatePointAudio(this.currentPointId, data.audio_url);
                }
                
                this.showToast(`‚úÖ –ê—É–¥–∏–æ–≥–∏–¥ —Å–æ–∑–¥–∞–Ω –≥–æ–ª–æ—Å–æ–º ${voice}!`, 'success');
                
                return data.audio_url;
            } else {
                throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞—É–¥–∏–æ');
            }
        } catch (error) {
            throw error;
        } finally {
            this.isGeneratingAudio = false;
        }
    },
    
    // –ü–æ–∫–∞–∑–∞—Ç—å —É—Å–ø–µ—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ AI
    showAIGenerationSuccess: function() {
        const audioResult = document.getElementById('ai-audio-success');
        if (audioResult) {
            audioResult.style.display = 'block';
        }
    },
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
    toggleEditText: function() {
        const preview = document.getElementById('ai-text-preview');
        const editBtn = document.getElementById('edit-text-btn');
        
        if (!preview || !this.generatedText) {
            this.showToast('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ç–µ–∫—Å—Ç', 'warning');
            return;
        }
        
        if (preview.getAttribute('contenteditable') === 'true') {
            preview.setAttribute('contenteditable', 'false');
            preview.classList.remove('border', 'border-primary');
            
            const textDiv = preview.querySelector('.ai-generated-text');
            if (textDiv) {
                this.generatedText = textDiv.textContent.trim();
            }
            
            editBtn.innerHTML = '<i class="fas fa-edit me-1"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
            editBtn.classList.remove('btn-success');
            editBtn.classList.add('btn-outline-primary');
            this.showToast('–¢–µ–∫—Å—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω', 'info');
        } else {
            preview.setAttribute('contenteditable', 'true');
            preview.classList.add('border', 'border-primary');
            
            const textDiv = preview.querySelector('.ai-generated-text');
            if (textDiv) {
                const range = document.createRange();
                const sel = window.getSelection();
                range.selectNodeContents(textDiv);
                range.collapse(false);
                sel.removeAllRanges();
                sel.addRange(range);
            }
            
            editBtn.innerHTML = '<i class="fas fa-save me-1"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            editBtn.classList.remove('btn-outline-primary');
            editBtn.classList.add('btn-success');
        }
    },
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è
    loadExistingDescription: function() {
        const description = document.getElementById('point-description').value.trim();
        const preview = document.getElementById('ai-text-preview');
        
        if (description) {
            this.generatedText = description;
            preview.innerHTML = `<div class="ai-generated-text">${this.escapeHtml(description)}</div>`;
            preview.setAttribute('contenteditable', 'false');
            this.showToast('–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ—á–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–æ', 'success');
        } else {
            this.showEmptyTextPreview('–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ—á–∫–∏ –ø—É—Å—Ç–æ–µ. –î–æ–±–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π —Ç–∏–ø –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.');
            this.showToast('–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ—á–∫–∏ –ø—É—Å—Ç–æ–µ', 'warning');
        }
    },
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –ø—É—Å—Ç–æ–µ –ø—Ä–µ–≤—å—é —Ç–µ–∫—Å—Ç–∞
    showEmptyTextPreview: function(message) {
        const preview = document.getElementById('ai-text-preview');
        
        preview.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-comment-alt fa-2x mb-2"></i>
                <div>${message}</div>
            </div>
        `;
        preview.setAttribute('contenteditable', 'false');
        this.generatedText = null;
    },
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç–∞
    setupAudioElement: function() {
        this.audioElement = document.createElement('audio');
        this.audioElement.id = 'point-audio-element';
        this.audioElement.style.display = 'none';
        document.body.appendChild(this.audioElement);
    },
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ —Ç–æ—á–∫–∏
    setupPointPhotoHandlers: function() {
        const photosInput = document.getElementById('point-photos-input');
        if (photosInput) {
            photosInput.addEventListener('change', (e) => {
                this.handlePointPhotosUpload(e);
            });
        }
    },
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∞—É–¥–∏–æ
    setupAudioHandlers: function() {
        const audioToggle = document.getElementById('enable-audio-guide');
        if (audioToggle) {
            audioToggle.addEventListener('change', (e) => {
                if (e.target.checked && !this.pointAudio) {
                    this.showAudioRecorder();
                } else if (!e.target.checked && this.pointAudio) {
                    if (confirm('–û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∞—É–¥–∏–æ —Å–∫—Ä–æ–µ—Ç –ø–ª–µ–µ—Ä. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                        this.hideAudioPlayer();
                        this.pointAudio = null;
                    } else {
                        e.target.checked = true;
                    }
                }
            });
        }
        
        const recordBtn = document.getElementById('start-audio-record');
        if (recordBtn) {
            recordBtn.addEventListener('click', (e) => {
                e.preventDefault();
                this.startAudioRecording();
            });
        }
        
        const uploadBtn = document.getElementById('upload-audio-file');
        if (uploadBtn) {
            uploadBtn.addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('audio-file-input').click();
            });
        }
        
        const audioFileInput = document.getElementById('audio-file-input');
        if (audioFileInput) {
            audioFileInput.addEventListener('change', (e) => {
                this.handleAudioUpload(e);
            });
        }
        
        const reRecordBtn = document.getElementById('re-record-audio');
        if (reRecordBtn) {
            reRecordBtn.addEventListener('click', (e) => {
                e.preventDefault();
                this.resetAudio();
            });
        }
        
        const removeBtn = document.getElementById('remove-audio');
        if (removeBtn) {
            removeBtn.addEventListener('click', (e) => {
                e.preventDefault();
                this.removeAudio();
            });
        }
        
        const playBtn = document.querySelector('.audio-play-btn');
        if (playBtn) {
            playBtn.addEventListener('click', (e) => {
                e.preventDefault();
                this.toggleAudioPlayback();
            });
        }
    },
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ—á–∫–∏
    show: function(pointIndex, pointData = null) {
        console.log('üìù –û—Ç–∫—Ä—ã—Ç–∏–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —Ç–æ—á–∫–∏, —Ç–æ—á–∫–∞:', pointData);
        
        this.currentPointIndex = pointIndex;
        this.resetForm();
        
        if (pointData) {
            this.currentPointId = pointData.id || null;
            this.fillForm(pointData);
        } else {
            this.currentPointId = null;
        }
        
        setTimeout(() => {
            this.updateCoordinatesDisplay();
        }, 100);
        
        const modal = new bootstrap.Modal(document.getElementById('point-editor-modal'));
        modal.show();
        
        console.log('‚úÖ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ');
    },
    
    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –¥–∞–Ω–Ω—ã–º–∏ —Ç–æ—á–∫–∏
    fillForm: function(pointData) {
        console.log('üìù –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –¥–∞–Ω–Ω—ã–º–∏ —Ç–æ—á–∫–∏');
        console.log('–ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç–æ—á–∫–∏:', pointData);
        
        // –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è
        document.getElementById('edit-point-id').value = pointData.id || '';
        document.getElementById('point-name').value = pointData.name || '';
        document.getElementById('point-category').value = pointData.category || '';
        document.getElementById('point-address').value = pointData.address || '';
        
        // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
        document.getElementById('point-lat').value = pointData.lat || pointData.latitude || '';
        document.getElementById('point-lng').value = pointData.lng || pointData.longitude || '';
        
        document.getElementById('point-hint-author').value = pointData.hint_author || '';
        document.getElementById('point-description').value = pointData.description || '';
        document.getElementById('point-tags').value = pointData.tags ? pointData.tags.join(', ') : '';
        
        // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–æ—Ç–æ
        this.clearPointPhotos();
        
        // –§–æ—Ç–æ —Ç–æ—á–∫–∏
        let photos = [];
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –¥–∞–Ω–Ω—ã—Ö –æ —Ñ–æ—Ç–æ
        if (pointData.photos) {
            console.log('üì∏ –ü–æ–ª—É—á–µ–Ω—ã —Ñ–æ—Ç–æ –∏–∑ pointData.photos:', pointData.photos);
            
            if (Array.isArray(pointData.photos)) {
                photos = pointData.photos;
            } else if (pointData.photos.all && Array.isArray(pointData.photos.all)) {
                photos = pointData.photos.all;
            } else if (typeof pointData.photos === 'object') {
                // –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç —Å –∫–ª—é—á–∞–º–∏, –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –º–∞—Å—Å–∏–≤
                photos = Object.values(pointData.photos);
            }
        }
        
        // –ï—Å–ª–∏ —Ñ–æ—Ç–æ –µ—Å—Ç—å –≤ pointData, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Ö
        if (photos.length > 0) {
            console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–æ—Ç–æ:', photos.length);
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ñ–æ—Ç–æ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
            const formattedPhotos = photos.map((photo, index) => {
                // –ò—â–µ–º –≥–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ
                let isMain = false;
                if (photo.is_main === true || photo.is_main === 'true') {
                    isMain = true;
                } else if (index === 0) {
                    // –ï—Å–ª–∏ –Ω–µ—Ç —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≥–ª–∞–≤–Ω–æ–≥–æ —Ñ–æ—Ç–æ, –¥–µ–ª–∞–µ–º –ø–µ—Ä–≤–æ–µ –≥–ª–∞–≤–Ω—ã–º
                    isMain = true;
                }
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º URL —Ñ–æ—Ç–æ
                let photoUrl = '';
                if (photo.url) {
                    photoUrl = photo.url;
                } else if (photo.image) {
                    photoUrl = photo.image;
                } else if (photo.image_url) {
                    photoUrl = photo.image_url;
                } else if (typeof photo === 'string') {
                    photoUrl = photo;
                }
                
                // –ï—Å–ª–∏ URL –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å /media/, –¥–æ–±–∞–≤–ª—è–µ–º –¥–æ–º–µ–Ω
                if (photoUrl && photoUrl.startsWith('/media/')) {
                    photoUrl = window.location.origin + photoUrl;
                }
                
                console.log('–§–æ—Ç–æ', index, ':', {
                    url: photoUrl,
                    is_main: isMain,
                    caption: photo.caption || '',
                    id: photo.id || `temp-${index}`
                });
                
                return {
                    id: photo.id || `temp-${index}`,
                    url: photoUrl,
                    caption: photo.caption || '',
                    is_main: isMain
                };
            });
            
            this.loadPointPhotos(formattedPhotos);
        } else {
            console.log('‚ö†Ô∏è –§–æ—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –¥–∞–Ω–Ω—ã—Ö —Ç–æ—á–∫–∏ –∏–ª–∏ –º–∞—Å—Å–∏–≤ –ø—É—Å—Ç–æ–π');
        }
        
        // –ê—É–¥–∏–æ —Ç–æ—á–∫–∏
        if (pointData.audio_url) {
            this.pointAudio = {
                url: pointData.audio_url,
                filename: pointData.audio_filename || '–ê—É–¥–∏–æ–≥–∏–¥ —Ç–æ—á–∫–∏',
                is_ai_generated: pointData.ai_audio_generated || false
            };
            this.showAudioPlayer();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –µ—Å–ª–∏ —ç—Ç–æ AI –∞—É–¥–∏–æ
            if (pointData.ai_audio_generated) {
                this.showAIGenerationSuccess();
            }
        } else {
            this.showAudioRecorder();
        }
        
        // –¢–µ–∫—Å—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        if (pointData.description) {
            this.generatedText = pointData.description;
            this.updateTextPreview(pointData.description);
        } else {
            this.showEmptyTextPreview('–ù–∞–∂–º–∏—Ç–µ "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ—á–∫–∏" –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –∞—É–¥–∏–æ"');
        }
        
        const generateBtn = document.getElementById('ai-generate-main-btn');
        if (generateBtn) {
            generateBtn.disabled = !this.currentPointId || this.currentPointId <= 0;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Ñ–æ—Ç–æ
        setTimeout(() => this.updatePhotoCount(), 100);
        
        console.log('‚úÖ –§–æ—Ä–º–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞');
    },
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é —Ç–µ–∫—Å—Ç–∞
    updateTextPreview: function(text) {
        const preview = document.getElementById('ai-text-preview');
        if (preview) {
            preview.innerHTML = `<div class="ai-generated-text">${this.escapeHtml(text)}</div>`;
            preview.setAttribute('contenteditable', 'false');
        }
    },
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ —Ç–æ—á–∫–∏
    handlePointPhotosUpload: function(e) {
        const files = e.target.files;
        if (!files || files.length === 0) {
            return;
        }
        
        const grid = document.querySelector('#point-photos-grid');
        if (!grid) {
            console.error('–°–µ—Ç–∫–∞ –¥–ª—è —Ñ–æ—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
            return;
        }
        
        const existingCount = this.updatePhotoCount();
        
        if (existingCount >= 5) {
            this.showToast('–ú–∞–∫—Å–∏–º—É–º –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å 5 —Ñ–æ—Ç–æ –¥–ª—è —Ç–æ—á–∫–∏', 'warning');
            e.target.value = '';
            return;
        }
        
        if (existingCount + files.length > 5) {
            const canAdd = 5 - existingCount;
            this.showToast(`–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ ${canAdd} —Ñ–æ—Ç–æ`, 'warning');
            e.target.value = '';
            return;
        }
        
        const uploadButton = grid.querySelector('.additional-photo-upload');
        const filesToProcess = Array.from(files).slice(0, 5 - existingCount);
        
        filesToProcess.forEach((file, index) => {
            if (!this.validateImageFile(file)) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const photoId = 'new-point-' + Date.now() + '-' + index + '-' + Math.random().toString(36).substr(2, 9);
                
                const photoItem = document.createElement('div');
                photoItem.className = 'additional-photo-item new-photo';
                photoItem.dataset.photoId = photoId;
                photoItem.dataset.order = existingCount + index;
                photoItem.innerHTML = `
                    <img src="${e.target.result}" class="w-100 h-100 object-fit-cover" alt="–ù–æ–≤–æ–µ —Ñ–æ—Ç–æ">
                    <div class="photo-controls-top">
                        <button type="button" 
                                onclick="pointEditor.makeMainPointPhoto(this)"
                                title="–°–¥–µ–ª–∞—Ç—å –≥–ª–∞–≤–Ω—ã–º">
                            <i class="fas fa-star text-light"></i>
                        </button>
                        <button type="button" class="photo-remove-btn" 
                                onclick="pointEditor.removePointPhoto(this, '${photoId}')"
                                title="–£–¥–∞–ª–∏—Ç—å">
                            <i class="fas fa-times text-danger"></i>
                        </button>
                    </div>
                    <div class="photo-controls-bottom">
                        <button type="button" 
                                onclick="pointEditor.movePointPhotoUp(this)"
                                title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–≤–µ—Ä—Ö">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button type="button" 
                                onclick="pointEditor.movePointPhotoDown(this)"
                            title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–Ω–∏–∑">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                    </div>
                    <div class="photo-order-badge">${existingCount + index + 1}</div>
                `;
                
                if (!window.newPointPhotoFiles) window.newPointPhotoFiles = [];
                file.previewId = photoId;
                window.newPointPhotoFiles.push(file);
                
                if (uploadButton) {
                    grid.insertBefore(photoItem, uploadButton);
                } else {
                    grid.appendChild(photoItem);
                }
                
                this.updatePointPhotoOrderNumbers();
                this.updatePhotoCount();
            };
            reader.readAsDataURL(file);
        });
        
        e.target.value = '';
    },
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ —Ç–æ—á–∫–∏ –≤ –≥–∞–ª–µ—Ä–µ—é
    loadPointPhotos: function(photos) {
        console.log('üñºÔ∏è –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ —Ç–æ—á–∫–∏ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä:', photos);
        
        const grid = document.querySelector('#point-photos-grid');
        if (!grid) {
            console.error('–°–µ—Ç–∫–∞ –¥–ª—è —Ñ–æ—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
            return;
        }
        
        const uploadButton = grid.querySelector('.additional-photo-upload');
        const photosToShow = photos.slice(0, 5);
        
        console.log(`–ü–æ–∫–∞–∑—ã–≤–∞–µ–º ${photosToShow.length} —Ñ–æ—Ç–æ`);
        
        photosToShow.forEach((photo, index) => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ñ–æ—Ç–æ –≥–ª–∞–≤–Ω—ã–º
            const isMain = photo.is_main || (index === 0);
            
            const photoItem = document.createElement('div');
            photoItem.className = `additional-photo-item ${isMain ? 'main-photo-selected' : ''}`;
            photoItem.dataset.photoId = photo.id || `temp-${index}`;
            photoItem.dataset.order = index;
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º fallback –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –µ—Å–ª–∏ URL –ø—É—Å—Ç–æ–π
            const photoUrl = photo.url || '/static/images/default-photo.jpg';
            
            photoItem.innerHTML = `
                <img src="${photoUrl}" 
                     class="w-100 h-100 object-fit-cover"
                     alt="–§–æ—Ç–æ —Ç–æ—á–∫–∏"
                     data-caption="${photo.caption || ''}"
                     data-is-main="${isMain}"
                     onerror="this.src='/static/images/default-photo.jpg'">
                <div class="photo-controls-top">
                    <button type="button" 
                            onclick="pointEditor.makeMainPointPhoto(this)"
                            title="–°–¥–µ–ª–∞—Ç—å –≥–ª–∞–≤–Ω—ã–º">
                        <i class="fas fa-star ${isMain ? 'text-warning' : 'text-light'}"></i>
                    </button>
                    <button type="button" class="photo-remove-btn" 
                            onclick="pointEditor.removePointPhoto(this, '${photo.id || `temp-${index}`}')"
                            title="–£–¥–∞–ª–∏—Ç—å">
                        <i class="fas fa-times text-danger"></i>
                    </button>
                </div>
                <div class="photo-controls-bottom">
                    <button type="button" 
                            onclick="pointEditor.movePointPhotoUp(this)"
                            title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–≤–µ—Ä—Ö">
                            <i class="fas fa-arrow-up"></i>
                    </button>
                    <button type="button" 
                            onclick="pointEditor.movePointPhotoDown(this)"
                            title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–Ω–∏–∑">
                            <i class="fas fa-arrow-down"></i>
                    </button>
                </div>
                <div class="photo-order-badge">${index + 1}</div>
            `;
            
            // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–¥ –∫–Ω–æ–ø–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
            if (uploadButton) {
                grid.insertBefore(photoItem, uploadButton);
            } else {
                grid.appendChild(photoItem);
            }
            
            console.log(`‚úÖ –§–æ—Ç–æ ${index + 1} –∑–∞–≥—Ä—É–∂–µ–Ω–æ:`, {
                url: photoUrl,
                isMain: isMain,
                id: photo.id
            });
        });
        
        this.updatePhotoCount();
        console.log('‚úÖ –í—Å–µ —Ñ–æ—Ç–æ —Ç–æ—á–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ –≥–∞–ª–µ—Ä–µ—é');
    },
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∞—É–¥–∏–æ
    toggleAudioPlayback: function() {
        if (!this.audioElement || !this.pointAudio?.url) return;
        
        const playBtn = document.querySelector('.audio-play-btn');
        const generatedPlayBtn = document.getElementById('play-generated-audio-btn');
        
        if (this.audioElement.paused) {
            this.audioElement.src = this.pointAudio.url;
            this.audioElement.play().then(() => {
                if (playBtn) playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                if (generatedPlayBtn) generatedPlayBtn.innerHTML = '<i class="fas fa-pause me-1"></i>–ü–∞—É–∑–∞';
                this.setupAudioProgress();
            }).catch(error => {
                console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', error);
                this.showToast('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∞—É–¥–∏–æ', 'danger');
            });
        } else {
            this.audioElement.pause();
            if (playBtn) playBtn.innerHTML = '<i class="fas fa-play"></i>';
            if (generatedPlayBtn) generatedPlayBtn.innerHTML = '<i class="fas fa-play me-1"></i>–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏';
        }
    },
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∞—É–¥–∏–æ
    setupAudioProgress: function() {
        if (!this.audioElement) return;
        
        const progressBar = document.querySelector('.audio-progress');
        const durationSpan = document.querySelector('.audio-duration');
        
        this.audioElement.addEventListener('timeupdate', () => {
            if (this.audioElement.duration && progressBar) {
                const progress = (this.audioElement.currentTime / this.audioElement.duration) * 100;
                progressBar.style.width = `${progress}%`;
            }
            if (durationSpan) {
                const formatTime = (seconds) => {
                    if (isNaN(seconds)) return '0:00';
                    const mins = Math.floor(seconds / 60);
                    const secs = Math.floor(seconds % 60);
                    return `${mins}:${secs.toString().padStart(2, '0')}`;
                };
                durationSpan.textContent = formatTime(this.audioElement.currentTime);
            }
        });
        
        this.audioElement.addEventListener('ended', () => {
            const playBtn = document.querySelector('.audio-play-btn');
            const generatedPlayBtn = document.getElementById('play-generated-audio-btn');
            if (playBtn) playBtn.innerHTML = '<i class="fas fa-play"></i>';
            if (generatedPlayBtn) generatedPlayBtn.innerHTML = '<i class="fas fa-play me-1"></i>–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏';
            if (progressBar) progressBar.style.width = '0%';
        });
    },
    
    // –°–±—Ä–æ—Å –∞—É–¥–∏–æ
    resetAudio: function() {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å –∞—É–¥–∏–æ?')) {
            this.pointAudio = null;
            if (this.audioElement) {
                this.audioElement.pause();
                this.audioElement.src = '';
            }
            this.showAudioRecorder();
            this.showToast('–ê—É–¥–∏–æ —Å–±—Ä–æ—à–µ–Ω–æ. –ú–æ–∂–µ—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å –Ω–æ–≤–æ–µ.', 'info');
        }
    },
    
    // –£–¥–∞–ª–µ–Ω–∏–µ –∞—É–¥–∏–æ
    removeAudio: function() {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∞—É–¥–∏–æ?')) {
            this.pointAudio = null;
            if (this.audioElement) {
                this.audioElement.pause();
                this.audioElement.src = '';
            }
            this.showAudioRecorder();
            
            if (window.routeEditor?.updatePointAudio) {
                window.routeEditor.updatePointAudio(this.currentPointId, null);
            }
            
            this.showToast('–ê—É–¥–∏–æ —É–¥–∞–ª–µ–Ω–æ', 'info');
        }
    },
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –∞—É–¥–∏–æ–ø–ª–µ–µ—Ä
    showAudioPlayer: function() {
        document.getElementById('point-audio-player').style.display = 'block';
        document.getElementById('point-audio-recorder').style.display = 'none';
        
        if (this.pointAudio?.filename) {
            document.getElementById('audio-filename').textContent = this.pointAudio.filename;
        }
        
        document.getElementById('enable-audio-guide').checked = true;
        
        const generatedPlayBtn = document.getElementById('play-generated-audio-btn');
        if (generatedPlayBtn) {
            generatedPlayBtn.innerHTML = '<i class="fas fa-play me-1"></i>–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏';
        }
    },
    
    // –°–∫—Ä—ã—Ç—å –∞—É–¥–∏–æ–ø–ª–µ–µ—Ä
    hideAudioPlayer: function() {
        document.getElementById('point-audio-player').style.display = 'none';
    },
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –∞—É–¥–∏–æ—Ä–µ–∫–æ—Ä–¥–µ—Ä
    showAudioRecorder: function() {
        document.getElementById('point-audio-player').style.display = 'none';
        document.getElementById('point-audio-recorder').style.display = 'block';
        document.getElementById('enable-audio-guide').checked = false;
        
        this.hideGenerationProgress();
        this.hideAudioResult();
        this.hideGenerationError();
    },
    
    // –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å –∞—É–¥–∏–æ
    startAudioRecording: function() {
        console.log('üé§ –ù–∞—á–∞–ª–æ –∑–∞–ø–∏—Å–∏ –∞—É–¥–∏–æ');
        
        document.getElementById('recording-indicator').style.display = 'block';
        document.getElementById('recording-visualizer').style.display = 'block';
        
        let seconds = 0;
        this.recordingTimer = setInterval(() => {
            seconds++;
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            document.getElementById('recording-timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            
            if (seconds >= 30) {
                this.stopAudioRecording();
            }
        }, 1000);
        
        this.updateAudioVisualizer();
    },
    
    // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –∞—É–¥–∏–æ
    stopAudioRecording: function() {
        if (this.recordingTimer) {
            clearInterval(this.recordingTimer);
            this.recordingTimer = null;
        }
        
        document.getElementById('recording-indicator').style.display = 'none';
        document.getElementById('recording-visualizer').style.display = 'none';
        
        this.pointAudio = {
            url: '#demo-audio',
            filename: `–ó–∞–ø–∏—Å—å_${new Date().toLocaleTimeString('ru-RU')}.mp3`
        };
        
        this.showAudioPlayer();
        this.showToast('–ó–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (–¥–µ–º–æ)', 'success');
    },
    
    // –û–±–Ω–æ–≤–∏—Ç—å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä –∞—É–¥–∏–æ
    updateAudioVisualizer: function() {
        const visualizer = document.getElementById('live-visualizer');
        if (!visualizer) return;
        
        visualizer.innerHTML = '';
        
        for (let i = 0; i < 40; i++) {
            const bar = document.createElement('div');
            bar.className = 'audio-bar';
            bar.style.height = `${Math.random() * 40 + 10}px`;
            visualizer.appendChild(bar);
        }
        
        if (this.visualizerInterval) {
            clearInterval(this.visualizerInterval);
        }
        
        this.visualizerInterval = setInterval(() => {
            const bars = visualizer.querySelectorAll('.audio-bar');
            bars.forEach(bar => {
                bar.style.height = `${Math.random() * 40 + 10}px`;
            });
        }, 100);
    },
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—É–¥–∏–æ —Ñ–∞–π–ª–∞
    handleAudioUpload: function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        if (!this.validateAudioFile(file)) {
            e.target.value = '';
            return;
        }
        
        this.pointAudio = {
            file: file,
            filename: file.name,
            url: URL.createObjectURL(file),
            is_ai_generated: false
        };
        
        this.showAudioPlayer();
        this.showToast('–ê—É–¥–∏–æ—Ñ–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω', 'success');
        e.target.value = '';
    },
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    showGenerationProgress: function(message = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...') {
        const progressStatus = document.getElementById('progress-status');
        if (progressStatus) {
            progressStatus.textContent = message;
        }
        
        const progressEl = document.getElementById('ai-generation-progress');
        if (progressEl) {
            progressEl.style.display = 'block';
        }
        
        const generateBtn = document.getElementById('ai-generate-main-btn');
        if (generateBtn) {
            generateBtn.disabled = true;
        }
        
        this.hideAudioResult();
        this.hideGenerationError();
    },
    
    // –°–∫—Ä—ã—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    hideGenerationProgress: function() {
        const progressEl = document.getElementById('ai-generation-progress');
        if (progressEl) {
            progressEl.style.display = 'none';
        }
        
        const generateBtn = document.getElementById('ai-generate-main-btn');
        if (generateBtn) {
            generateBtn.disabled = false;
        }
    },
    
    // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞—É–¥–∏–æ
    showAudioResult: function() {
        const audioResult = document.getElementById('ai-audio-success');
        if (audioResult) {
            audioResult.style.display = 'block';
        }
    },
    
    // –°–∫—Ä—ã—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞—É–¥–∏–æ
    hideAudioResult: function() {
        const audioResult = document.getElementById('ai-audio-success');
        if (audioResult) {
            audioResult.style.display = 'none';
        }
    },
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    showGenerationError: function(errorMessage) {
        const errorMsgEl = document.getElementById('ai-error-message');
        if (errorMsgEl) {
            errorMsgEl.textContent = errorMessage;
        }
        
        const errorEl = document.getElementById('ai-generation-error');
        if (errorEl) {
            errorEl.style.display = 'block';
        }
    },
    
    // –°–∫—Ä—ã—Ç—å –æ—à–∏–±–∫—É –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    hideGenerationError: function() {
        const errorEl = document.getElementById('ai-generation-error');
        if (errorEl) {
            errorEl.style.display = 'none';
        }
    },
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –∞—É–¥–∏–æ —Ñ–∞–π–ª–∞
    validateAudioFile: function(file) {
        const validTypes = ['audio/mpeg', 'audio/wav', 'audio/x-wav', 'audio/mp4', 'audio/x-m4a'];
        if (!validTypes.includes(file.type)) {
            this.showToast('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç –∞—É–¥–∏–æ', 'warning');
            return false;
        }
        
        if (file.size > 50 * 1024 * 1024) {
            this.showToast('–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 50MB', 'warning');
            return false;
        }
        
        return true;
    },
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    validateImageFile: function(file) {
        if (!file.type.startsWith('image/')) {
            this.showToast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–∏—Ä–∞–π—Ç–µ —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'warning');
            return false;
        }
        
        if (file.size > 5 * 1024 * 1024) {
            this.showToast('–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 5MB', 'warning');
            return false;
        }
        
        return true;
    },
    
    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–æ—Ç–æ —Ç–æ—á–∫–∏ –∫–∞–∫ –≥–ª–∞–≤–Ω–æ–≥–æ
    makeMainPointPhoto: function(button) {
        const photoItem = button.closest('.additional-photo-item');
        if (!photoItem) return;
        
        const photoId = photoItem.dataset.photoId;
        if (!photoId) return;
        
        console.log(`‚≠ê –ù–∞–∑–Ω–∞—á–∞–µ–º —Ñ–æ—Ç–æ —Ç–æ—á–∫–∏ ${photoId} –∫–∞–∫ –≥–ª–∞–≤–Ω–æ–µ`);
        
        window.pointMainPhotoToSet = photoId.startsWith('new-point-') ? 'new' : parseInt(photoId);
        
        // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö —Ñ–æ—Ç–æ
        document.querySelectorAll('.additional-photo-item').forEach(item => {
            item.classList.remove('main-photo-selected');
            const starIcon = item.querySelector('.photo-controls-top button i.fa-star');
            if (starIcon) {
                starIcon.className = 'fas fa-star text-light';
            }
        });
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ —Ñ–æ—Ç–æ
        photoItem.classList.add('main-photo-selected');
        const starIcon = photoItem.querySelector('.photo-controls-top button i.fa-star');
        if (starIcon) {
            starIcon.className = 'fas fa-star text-warning';
        }
        
        this.showToast('–§–æ—Ç–æ –≤—ã–±—Ä–∞–Ω–æ –∫–∞–∫ –≥–ª–∞–≤–Ω–æ–µ –¥–ª—è —Ç–æ—á–∫–∏', 'info');
    },
    
    // –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ —Ç–æ—á–∫–∏
    removePointPhoto: function(button, photoId = null) {
        const photoItem = button.closest('.additional-photo-item');
        if (!photoItem) return;
        
        if (photoId && !photoId.startsWith('new-point-')) {
            const idInt = parseInt(photoId);
            if (!isNaN(idInt)) {
                if (!window.removedPointPhotoIds) {
                    window.removedPointPhotoIds = new Set();
                }
                window.removedPointPhotoIds.add(idInt);
                console.log('üóëÔ∏è –§–æ—Ç–æ —Ç–æ—á–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ —Å–ø–∏—Å–æ–∫ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö, ID:', idInt);
            }
        }
        
        if (photoId && photoId.startsWith('new-point-')) {
            const index = window.newPointPhotoFiles.findIndex(file => 
                file.previewId === photoId
            );
            if (index !== -1) {
                window.newPointPhotoFiles.splice(index, 1);
                console.log('üóëÔ∏è –ù–æ–≤–æ–µ —Ñ–æ—Ç–æ —Ç–æ—á–∫–∏ —É–¥–∞–ª–µ–Ω–æ –∏–∑ –º–∞—Å—Å–∏–≤–∞, ID:', photoId);
            }
        }
        
        // –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º –≥–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ
        if (photoItem.classList.contains('main-photo-selected')) {
            window.pointMainPhotoToSet = null;
        }
        
        photoItem.remove();
        console.log('üóëÔ∏è –§–æ—Ç–æ —Ç–æ—á–∫–∏ —É–¥–∞–ª–µ–Ω–æ –∏–∑ DOM');
        
        this.updatePointPhotoOrderNumbers();
        this.updatePhotoCount();
    },
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–æ–≤—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ —Ñ–æ—Ç–æ —Ç–æ—á–∫–∏
    updatePointPhotoOrderNumbers: function() {
        const photoItems = document.querySelectorAll('.additional-photo-item:not(.additional-photo-upload)');
        console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–æ–≤—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ –¥–ª—è', photoItems.length, '—Ñ–æ—Ç–æ');
        
        photoItems.forEach((item, index) => {
            const orderBadge = item.querySelector('.photo-order-badge');
            if (orderBadge) {
                orderBadge.textContent = index + 1;
            } else {
                const badge = document.createElement('div');
                badge.className = 'photo-order-badge';
                badge.textContent = index + 1;
                item.appendChild(badge);
            }
            item.dataset.order = index;
        });
    },
    
    // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Ñ–æ—Ç–æ —Ç–æ—á–∫–∏ –≤–≤–µ—Ä—Ö
    movePointPhotoUp: function(button) {
        const photoItem = button.closest('.additional-photo-item');
        if (!photoItem) return;
        
        const prevItem = photoItem.previousElementSibling;
        if (prevItem && !prevItem.classList.contains('additional-photo-upload')) {
            photoItem.parentNode.insertBefore(photoItem, prevItem);
            this.updatePointPhotoOrderNumbers();
        }
    },
    
    // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Ñ–æ—Ç–æ —Ç–æ—á–∫–∏ –≤–Ω–∏–∑
    movePointPhotoDown: function(button) {
        const photoItem = button.closest('.additional-photo-item');
        if (!photoItem) return;
        
        const nextItem = photoItem.nextElementSibling;
        if (nextItem && !nextItem.classList.contains('additional-photo-upload')) {
            photoItem.parentNode.insertBefore(nextItem, photoItem);
            this.updatePointPhotoOrderNumbers();
        }
    },
    
    // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
    resetForm: function() {
        console.log('üîÑ –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã');
        
        const form = document.getElementById('point-form');
        if (form) {
            form.reset();
        }
        
        // –°–±—Ä–æ—Å —Ñ–æ—Ç–æ
        this.clearPointPhotos();
        
        // –°–±—Ä–æ—Å –∞—É–¥–∏–æ
        this.pointAudio = null;
        this.generatedText = null;
        if (this.audioElement) {
            this.audioElement.pause();
            this.audioElement.src = '';
        }
        this.showAudioRecorder();
        
        // –°–±—Ä–æ—Å AI –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        this.showEmptyTextPreview('–ù–∞–∂–º–∏—Ç–µ "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ—á–∫–∏" –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –∞—É–¥–∏–æ"');
        this.hideGenerationProgress();
        this.hideAudioResult();
        this.hideGenerationError();
        
        // –°–±—Ä–æ—Å —Å–ª–∞–π–¥–µ—Ä–æ–≤
        const speedSlider = document.getElementById('speed-slider');
        const speedValue = document.getElementById('speed-value');
        if (speedSlider && speedValue) {
            speedSlider.value = 1;
            speedValue.textContent = '1.0x';
        }
        
        const pitchSlider = document.getElementById('pitch-slider');
        const pitchValue = document.getElementById('pitch-value');
        if (pitchSlider && pitchValue) {
            pitchSlider.value = 0;
            pitchValue.textContent = '0';
        }
        
        // –°–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        const generateAudioRadio = document.getElementById('generate-audio');
        if (generateAudioRadio) {
            generateAudioRadio.checked = true;
        }
        
        const audioFromDescriptionSection = document.getElementById('audio-from-description-section');
        if (audioFromDescriptionSection) {
            audioFromDescriptionSection.style.display = 'block';
        }
        
        const generateDescriptionSection = document.getElementById('generate-description-section');
        if (generateDescriptionSection) {
            generateDescriptionSection.style.display = 'none';
        }
        
        const generateBtnText = document.getElementById('generate-btn-text');
        if (generateBtnText) {
            generateBtnText.textContent = '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∞—É–¥–∏–æ';
        }
        
        // –°–±—Ä–æ—Å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        const categorySelect = document.getElementById('point-category');
        if (categorySelect) {
            categorySelect.value = '';
        }
        
        // –°–±—Ä–æ—Å –≥–æ–ª–æ—Å–∞ –∏ —è–∑—ã–∫–∞
        const voiceSelect = document.getElementById('ai-voice-select');
        if (voiceSelect) {
            voiceSelect.value = '–ï—Ä–º–∏–ª';
        }
        
        const languageSelect = document.getElementById('ai-language-select');
        if (languageSelect) {
            languageSelect.value = 'ru-RU';
        }
        
        // –°–±—Ä–æ—Å –∞–º–ø–ª—É–∞
        const roleSelect = document.getElementById('ai-role-select');
        if (roleSelect) {
            roleSelect.value = '–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π';
        }
        
        // –°–±—Ä–æ—Å —Ñ–æ—Ä–º–∞—Ç–∞ –∞—É–¥–∏–æ
        const formatMp3 = document.getElementById('format-mp3');
        if (formatMp3) {
            formatMp3.checked = true;
        }
        
        // –í–∫–ª—é—á–∏—Ç—å –∞—É–¥–∏–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const audioToggle = document.getElementById('enable-audio-guide');
        if (audioToggle) {
            audioToggle.checked = true;
        }
        
        // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–∞–π–º–µ—Ä—ã
        if (this.recordingTimer) {
            clearInterval(this.recordingTimer);
            this.recordingTimer = null;
        }
        
        if (this.visualizerInterval) {
            clearInterval(this.visualizerInterval);
            this.visualizerInterval = null;
        }
    },
    
    // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —Ñ–æ—Ç–æ —Ç–æ—á–∫–∏
    clearPointPhotos: function() {
        const grid = document.querySelector('#point-photos-grid');
        if (!grid) {
            console.warn('–°–µ—Ç–∫–∞ –¥–ª—è —Ñ–æ—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ');
            return;
        }
        
        const photos = grid.querySelectorAll('.additional-photo-item:not(.additional-photo-upload)');
        console.log('–û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ç–æ, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:', photos.length);
        
        photos.forEach(photo => {
            console.log('–£–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ:', photo.dataset.photoId);
            photo.remove();
        });
        
        window.newPointPhotoFiles = [];
        window.pointMainPhotoToSet = null;
        window.removedPointPhotoIds = new Set();
        
        console.log('‚úÖ –í—Å–µ —Ñ–æ—Ç–æ —Ç–æ—á–∫–∏ –æ—á–∏—â–µ–Ω—ã');
        
        this.updatePhotoCount();
    },
    
    // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –æ —Ñ–æ—Ç–æ —Ç–æ—á–∫–∏
    collectPointPhotosData: function() {
        const photosData = {
            main_photo_id: null,
            existing_photos: [],
            new_photos: [],
            removed_photo_ids: []
        };
        
        console.log('üîç –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –æ —Ñ–æ—Ç–æ —Ç–æ—á–∫–∏...');
        
        // –í–°–ï –§–û–¢–û –¢–û–ß–ö–ò
        const allPhotoItems = document.querySelectorAll('.additional-photo-item:not(.additional-photo-upload)');
        
        allPhotoItems.forEach((item, index) => {
            const photoId = item.dataset.photoId;
            if (!photoId) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ —Ñ–æ—Ç–æ –≥–ª–∞–≤–Ω—ã–º
            const isMain = item.classList.contains('main-photo-selected');
            const img = item.querySelector('img');
            const caption = img?.dataset.caption || '';
            
            if (isMain) {
                if (!photoId.startsWith('new-point-')) {
                    photosData.main_photo_id = parseInt(photoId);
                }
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –º–∞—Å—Å–∏–≤
            if (!photoId.startsWith('new-point-')) {
                // –°—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Ñ–æ—Ç–æ
                photosData.existing_photos.push({
                    id: parseInt(photoId),
                    order: index + 1,
                    is_main: isMain,
                    caption: caption
                });
            } else {
                // –ù–æ–≤–æ–µ —Ñ–æ—Ç–æ
                const file = window.newPointPhotoFiles?.find(f => f.previewId === photoId);
                if (file) {
                    photosData.new_photos.push({
                        file: file,
                        order: index + 1,
                        is_main: isMain,
                        caption: caption,
                        preview_id: photoId
                    });
                }
            }
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã–µ —Ñ–æ—Ç–æ
        if (window.removedPointPhotoIds && window.removedPointPhotoIds.size > 0) {
            photosData.removed_photo_ids = Array.from(window.removedPointPhotoIds);
        }
        
        console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –æ —Ñ–æ—Ç–æ —Ç–æ—á–∫–∏ —Å–æ–±—Ä–∞–Ω—ã:', photosData);
        return photosData;
    },
    
    // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã —Ç–æ—á–∫–∏
    collectPointFormData: function() {
        const formData = new FormData();
        
        // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        formData.append('name', document.getElementById('point-name').value || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è');
        formData.append('category', document.getElementById('point-category').value || '');
        formData.append('address', document.getElementById('point-address').value || '');
        formData.append('lat', document.getElementById('point-lat').value || 0);
        formData.append('lng', document.getElementById('point-lng').value || 0);
        formData.append('hint_author', document.getElementById('point-hint-author').value || '');
        formData.append('description', document.getElementById('point-description').value || '');
        
        // –¢–µ–≥–∏
        const tags = document.getElementById('point-tags').value
            .split(',')
            .map(tag => tag.trim())
            .filter(tag => tag.length > 0);
        if (tags.length > 0) {
            formData.append('tags', JSON.stringify(tags));
        }
        
        // –î–∞–Ω–Ω—ã–µ –æ —Ñ–æ—Ç–æ
        const photosData = this.collectPointPhotosData();
        
        // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–æ—Ç–æ
        if (photosData.existing_photos.length > 0) {
            formData.append('existing_photos', JSON.stringify(photosData.existing_photos));
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≥–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ
        if (photosData.main_photo_id) {
            formData.append('main_photo_id', photosData.main_photo_id);
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Ñ–æ—Ç–æ
        photosData.new_photos.forEach((photo, index) => {
            formData.append(`new_photo_${index}`, photo.file);
            // –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–æ—Ç–æ
            formData.append(`new_photo_${index}_metadata`, JSON.stringify({
                order: photo.order,
                is_main: photo.is_main,
                caption: photo.caption
            }));
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã–µ —Ñ–æ—Ç–æ
        if (photosData.removed_photo_ids.length > 0) {
            formData.append('removed_photo_ids', JSON.stringify(photosData.removed_photo_ids));
        }
        
        // –ê—É–¥–∏–æ
        if (this.pointAudio && this.pointAudio.file) {
            formData.append('audio', this.pointAudio.file);
        } else if (this.pointAudio && this.pointAudio.url && !this.pointAudio.file) {
            // –°—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –∞—É–¥–∏–æ
            formData.append('audio_url', this.pointAudio.url);
        }
        
        console.log('üìù –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã —Å–æ–±—Ä–∞–Ω—ã');
        
        // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏: –≤—ã–≤–æ–¥–∏–º –≤—Å–µ –∫–ª—é—á–∏ –≤ formData
        for (let [key, value] of formData.entries()) {
            console.log(`${key}:`, value instanceof File ? `File: ${value.name}` : value);
        }
        
        return formData;
    },
    
    // –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–≤—å—é —Ñ–æ—Ç–æ —Ç–æ—á–∫–∏
    getPointPhotosPreview: function() {
        const photos = [];
        const photoItems = document.querySelectorAll('.additional-photo-item:not(.additional-photo-upload)');
        
        photoItems.forEach((item, index) => {
            const photoId = item.dataset.photoId;
            const img = item.querySelector('img');
            
            if (img) {
                photos.push({
                    id: photoId.startsWith('new-point-') ? null : parseInt(photoId),
                    url: img.src,
                    is_main: item.classList.contains('main-photo-selected'),
                    order: index + 1
                });
            }
        });
        
        return photos;
    },
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã —Ç–æ—á–∫–∏
    validatePointForm: function() {
        const name = document.getElementById('point-name').value.trim();
        const lat = document.getElementById('point-lat').value;
        const lng = document.getElementById('point-lng').value;
        
        if (!name) {
            this.showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏', 'warning');
            return false;
        }
        
        if (!lat || !lng || isNaN(parseFloat(lat)) || isNaN(parseFloat(lng))) {
            this.showToast('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–∫–∏', 'warning');
            return false;
        }
        
        return true;
    },
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ—á–∫–∏
    savePoint: async function() {
        console.log('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ—á–∫–∏...');
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        if (!this.validatePointForm()) {
            return;
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
        this.showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ—á–∫–∏...', 'info');
        
        try {
            // –°–æ–±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
            const formData = this.collectPointFormData();
            
            // –ü–æ–ª—É—á–∏—Ç—å CSRF —Ç–æ–∫–µ–Ω
            const csrfToken = this.getCookie('csrftoken');
            
            // –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å URL –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            let url;
            let method;
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å ID —Ç–æ—á–∫–∏ –∏ —ç—Ç–æ —á–∏—Å–ª–æ - —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            if (this.currentPointId && !isNaN(parseInt(this.currentPointId))) {
                url = `/api/points/${this.currentPointId}/`;
                method = 'PUT';
            } else {
                // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Ç–æ—á–∫–∏
                url = '/api/points/';
                method = 'POST';
            }
            
            console.log(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${method} ${url}`);
            
            // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
            const response = await fetch(url, {
                method: method,
                headers: {
                    'X-CSRFToken': csrfToken
                },
                body: formData
            });
            
            console.log('üì• –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status, response.statusText);
            
            let result;
            try {
                result = await response.json();
                console.log('üì• –î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞:', result);
            } catch (e) {
                console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON:', e);
                throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç');
            }
            
            if (response.ok) {
                // –£—Å–ø–µ—à–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
                const savedPoint = {
                    id: result.id || this.currentPointId || Date.now(),
                    name: document.getElementById('point-name').value,
                    category: document.getElementById('point-category').value,
                    address: document.getElementById('point-address').value,
                    lat: parseFloat(document.getElementById('point-lat').value),
                    lng: parseFloat(document.getElementById('point-lng').value),
                    hint_author: document.getElementById('point-hint-author').value,
                    description: document.getElementById('point-description').value,
                    tags: document.getElementById('point-tags').value
                        .split(',')
                        .map(tag => tag.trim())
                        .filter(tag => tag.length > 0)
                };
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ
                if (result.photos && Array.isArray(result.photos)) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–æ—Ç–æ –∏–∑ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞
                    savedPoint.photos = result.photos;
                } else {
                    // –ò–ª–∏ —Å–æ–∑–¥–∞–µ–º –ø—Ä–µ–≤—å—é –∏–∑ —Ç–µ–∫—É—â–∏—Ö —Ñ–æ—Ç–æ
                    savedPoint.photos = this.getPointPhotosPreview();
                }
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ
                if (this.pointAudio) {
                    savedPoint.audio_url = this.pointAudio.url;
                    savedPoint.audio_filename = this.pointAudio.filename;
                }
                
                // –ü–µ—Ä–µ–¥–∞—Ç—å —Ç–æ—á–∫—É –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä –º–∞—Ä—à—Ä—É—Ç–∞
                if (window.routeEditor && typeof window.routeEditor.updatePoint === 'function') {
                    window.routeEditor.updatePoint(this.currentPointIndex, savedPoint);
                }
                
                // –°–±—Ä–æ—Å–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                window.newPointPhotoFiles = [];
                window.removedPointPhotoIds = new Set();
                window.pointMainPhotoToSet = null;
                
                // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const modal = bootstrap.Modal.getInstance(document.getElementById('point-editor-modal'));
                if (modal) {
                    modal.hide();
                }
                
                this.showToast('‚úÖ –¢–æ—á–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ', 'success');
                
                console.log('‚úÖ –¢–æ—á–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞:', savedPoint);
                
            } else {
                // –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
                throw new Error(result.error || result.message || `–û—à–∏–±–∫–∞ ${response.status}`);
            }
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ—á–∫–∏:', error);
            
            // –ë–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
            let errorMessage = '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è';
            if (error.message.includes('Network Error')) {
                errorMessage = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É';
            } else if (error.message.includes('Failed to fetch')) {
                errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º';
            } else {
                errorMessage = error.message;
            }
            
            this.showToast(errorMessage, 'danger');
        }
    },
    
    // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
    escapeHtml: function(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    },
    
    // –ü–æ–ª—É—á–∏—Ç—å CSRF —Ç–æ–∫–µ–Ω –∏–∑ cookies
    getCookie: function(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    },
    
    // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    showToast: function(message, type = 'info') {
        if (window.routeEditor && typeof window.routeEditor.showToast === 'function') {
            window.routeEditor.showToast(message, type);
        } else {
            console.log(`[${type.toUpperCase()}] ${message}`);
            
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0 position-fixed bottom-0 end-0 m-3`;
            toast.setAttribute('role', 'alert');
            toast.style.zIndex = '9999';
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            document.body.appendChild(toast);
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    }
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM
document.addEventListener('DOMContentLoaded', function() {
    if (window.pointEditor && typeof window.pointEditor.init === 'function') {
        window.pointEditor.init();
    }
    
    // –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
    window.makeMainPointPhoto = window.pointEditor.makeMainPointPhoto.bind(window.pointEditor);
    window.removePointPhoto = window.pointEditor.removePointPhoto.bind(window.pointEditor);
    window.movePointPhotoUp = window.pointEditor.movePointPhotoUp.bind(window.pointEditor);
    window.movePointPhotoDown = window.pointEditor.movePointPhotoDown.bind(window.pointEditor);
    
    console.log('‚úÖ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ—á–∫–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
});
</script>