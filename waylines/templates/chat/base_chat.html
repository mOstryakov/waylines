{% block extra_js %}
<!-- –¢–û–õ–¨–ö–û –æ–±—â–∏–µ —É—Ç–∏–ª–∏—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω—ã –¥–ª—è –í–°–ï–• —á–∞—Ç–æ–≤ -->
<script>
// =============================
// –ë–ê–ó–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –í–°–ï–• –ß–ê–¢–û–í
// =============================

// 1. –§—É–Ω–∫—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ HTML (—É–∂–µ –µ—Å—Ç—å –≤ base.html, –Ω–æ –¥–ª—è –ø–æ–ª–Ω–æ—Ç—ã)
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// 2. –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ HH:MM
function getCurrentTime() {
    return new Date().toLocaleTimeString('ru-RU', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
}

// 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤ (–±–∞–∑–æ–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)
function updateCharCounter() {
    const input = document.querySelector('#chat-message-input');
    const counter = document.querySelector('#char-counter');
    if (input && counter) {
        const length = input.value.length;
        counter.textContent = `${length}/1000`;
        // –¶–≤–µ—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–∏–º–≤–æ–ª–æ–≤
        if (length > 950) {
            counter.className = 'text-danger';
        } else if (length > 800) {
            counter.className = 'text-warning';
        } else if (length > 0) {
            counter.className = 'text-success';
        } else {
            counter.className = 'text-muted';
        }
    }
}

// 4. –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
function scrollToBottom() {
    const messagesContainer = document.querySelector('#chat-messages');
    if (messagesContainer) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
}

// 5. –ë–∞–∑–æ–≤—ã–π –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Å–∞–π–¥–±–∞—Ä–∞
function toggleInfoSidebar() {
    const sidebar = document.querySelector('.info-sidebar');
    const overlay = document.querySelector('.info-sidebar-overlay');
    if (sidebar && overlay) {
        if (sidebar.classList.contains('active')) {
            sidebar.classList.remove('active');
            overlay.style.display = 'none';
            document.body.classList.remove('sidebar-open');
        } else {
            sidebar.classList.add('active');
            overlay.style.display = 'block';
            document.body.classList.add('sidebar-open');
        }
    }
}

// 6. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞ (–±–∞–∑–æ–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç, –±—É–¥–µ—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —á–∞—Ç–∞—Ö)
function refreshChat() {
    console.log('üîÑ –ë–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–∞—Ç–∞');
}

// 7. –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
function showTypingIndicator(username) {
    const indicator = document.querySelector('#typing-indicator');
    const userElement = document.querySelector('#typing-user');
    if (indicator && userElement) {
        userElement.textContent = username;
        indicator.style.display = 'block';
    }
}

function hideTypingIndicator() {
    const indicator = document.querySelector('#typing-indicator');
    if (indicator) {
        indicator.style.display = 'none';
    }
}

// 8. –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
function showLoadingIndicator() {
    const indicator = document.querySelector('#chat-loading');
    if (indicator) {
        indicator.style.display = 'block';
    }
}

function hideLoadingIndicator() {
    const indicator = document.querySelector('#chat-loading');
    if (indicator) {
        indicator.style.display = 'none';
    }
}

// =============================
// –ù–ï–û–ë–•–û–î–ò–ú–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –ß–ê–¢–ê (–∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –≤ ChatCore)
// =============================

// 9. –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è ID —Å–æ–æ–±—â–µ–Ω–∏—è
function generateMessageId() {
    return Date.now().toString() + Math.random().toString(36).substr(2, 9);
}

// 10. –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç (–∞–Ω–∞–ª–æ–≥ ChatUI.addMessageToChat)
function addMessageToChat(messageData, containerSelector = '#chat-messages', options = {}) {
    const {
        isOwn = false,
        showSender = true,
        animate = true,
        customClass = ''
    } = options;
    
    const container = document.querySelector(containerSelector);
    if (!container) return null;
    
    // –£–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—É—Å—Ç–æ–º —á–∞—Ç–µ
    const emptyMessage = container.querySelector('#empty-chat-message');
    if (emptyMessage) {
        emptyMessage.remove();
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    const existingMessage = container.querySelector(`[data-message-id="${messageData.id}"]`);
    if (existingMessage && !messageData.is_temp) {
        return existingMessage;
    }
    
    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
    const messageId = messageData.id || generateMessageId();
    const senderName = isOwn ? '–í—ã' : messageData.sender || messageData.user;
    const timestamp = messageData.created_at || getCurrentTime();
    
    const messageElement = document.createElement('div');
    messageElement.className = `message-wrapper mb-4 ${isOwn ? 'own-message' : 'other-message'} ${customClass}`;
    messageElement.dataset.messageId = messageId;
    
    if (animate) {
        messageElement.style.animation = 'messageSlideIn 0.3s ease-out';
    }
    
    messageElement.innerHTML = `
        <div class="message-bubble ${isOwn ? 'own-bubble' : 'other-bubble'}">
            ${!isOwn && showSender ? `
                <div class="message-sender mb-1">
                    <small class="text-primary fw-bold">${escapeHtml(senderName)}</small>
                </div>
            ` : ''}
            <div class="message-content">
                ${escapeHtml(messageData.content || messageData.message || '').replace(/\n/g, '<br>')}
            </div>
            <div class="message-time text-end mt-1">
                <small class="${isOwn ? 'text-light' : 'text-muted'}">${timestamp}</small>
                ${isOwn ? '<i class="fas fa-check-double text-light ms-1" style="font-size: 10px;"></i>' : ''}
            </div>
        </div>
    `;
    
    container.appendChild(messageElement);
    scrollToBottom();
    return messageElement;
}

// 11. –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –ø—É—Å—Ç–æ–≥–æ —á–∞—Ç–∞ (–∞–Ω–∞–ª–æ–≥ ChatUI.showEmptyChatMessage)
function showEmptyChatMessage(containerSelector = '#chat-messages', options = {}) {
    const {
        title = '–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥',
        subtitle = '–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ'
    } = options;
    
    const container = document.querySelector(containerSelector);
    if (container) {
        container.innerHTML = `
            <div class="text-center text-muted py-5" id="empty-chat-message">
                <div class="empty-state-icon mb-4">
                    <i class="fas fa-comments fa-4x text-light"></i>
                </div>
                <h4 class="fw-light">${escapeHtml(title)}</h4>
                <p class="text-muted">${escapeHtml(subtitle)}</p>
            </div>
        `;
    }
}

// 12. –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ —á–∞—Ç–∞
function clearChat(containerSelector = '#chat-messages') {
    const container = document.querySelector(containerSelector);
    if (container) {
        container.innerHTML = '';
    }
}

// 13. –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
function updateConnectionStatus(status, message) {
    const statusElement = document.querySelector('#connection-status');
    if (statusElement) {
        statusElement.textContent = message;
        const statusClasses = {
            connected: 'text-success',
            disconnected: 'text-warning',
            error: 'text-danger',
            connecting: 'text-info'
        };
        statusElement.className = statusClasses[status] || 'text-muted';
    }
}

// 14. –ü–æ–ª—É—á–µ–Ω–∏–µ CSRF —Ç–æ–∫–µ–Ω–∞
function getCSRFToken() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    return csrfToken ? csrfToken.value : '';
}

// =============================
// –û–ë–©–ò–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô
// =============================

document.addEventListener('DOMContentLoaded', function() {
    console.log('üîß –ë–∞–∑–æ–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —á–∞—Ç–∞');
    
    // 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—á–µ—Ç—á–∏–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤
    const messageInput = document.querySelector('#chat-message-input');
    if (messageInput) {
        messageInput.addEventListener('input', updateCharCounter);
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        updateCharCounter();
    }
    
    // 2. –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
    window.addEventListener('resize', scrollToBottom);
    
    // 3. –§–æ–∫—É—Å–∏—Ä–æ–≤–∫–∞ –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    if (messageInput) {
        setTimeout(() => messageInput.focus(), 100);
    }
});

// =============================
// –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
// =============================
// –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ: –∫–∞–∂–¥–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —á–∞—Ç–∞ –¥–æ–ª–∂–Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–≤–æ–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
// –ù–∞–ø—Ä–∏–º–µ—Ä:
// const conversationId = {{ conversation.id }};
// const currentUserId = {{ request.user.id }};
// const routeId = {{ route.id }};

// =============================
// –°–û–ó–î–ê–ï–ú –ì–õ–û–ë–ê–õ–¨–ù–´–ï –û–ë–™–ï–ö–¢–´ –î–õ–Ø –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–ò
// =============================

// –°–æ–∑–¥–∞–µ–º ChatUI –æ–±—ä–µ–∫—Ç –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
window.ChatUI = {
    scrollToBottom: scrollToBottom,
    updateCharCounter: updateCharCounter,
    updateConnectionStatus: updateConnectionStatus,
    showTypingIndicator: showTypingIndicator,
    hideTypingIndicator: hideTypingIndicator,
    showLoadingIndicator: showLoadingIndicator,
    hideLoadingIndicator: hideLoadingIndicator,
    addMessageToChat: addMessageToChat,
    showEmptyChatMessage: showEmptyChatMessage,
    clearChat: clearChat
};

// –°–æ–∑–¥–∞–µ–º ChatUtils –æ–±—ä–µ–∫—Ç –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
window.ChatUtils = {
    escapeHtml: escapeHtml,
    getCurrentTime: getCurrentTime,
    generateId: generateMessageId,
    getCSRFToken: getCSRFToken
};
</script>

<!-- 
    –ö–ê–ñ–î–´–ô –ö–û–ù–ö–†–ï–¢–ù–´–ô –ß–ê–¢ –î–û–õ–ñ–ï–ù –î–û–ë–ê–í–ò–¢–¨ –°–í–û–ô JavaScript:
    - –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    - –ö–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Firebase
    - –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    - –õ–æ–≥–∏–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
-->
{% endblock %}