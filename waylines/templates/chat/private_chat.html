{% extends 'base.html' %}
{% load static %}

{% block title %}Чат с {{ other_user.username }} - Waylines{% endblock %}

{% block content %}
<!-- Уведомления -->
<div id="notifications" class="position-fixed top-0 end-0 p-3" style="z-index: 1050; margin-top: 70px;"></div>

<div class="container-fluid h-100 p-0">
    <div class="row g-0 h-100">
        <!-- Чат -->
        <div class="col-md-9">
            <div class="chat-container h-100 d-flex flex-column">
                <!-- Заголовок чата -->
                <div class="chat-header bg-white border-bottom p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <a href="{% url 'chat:chat_dashboard' %}" class="btn btn-sm btn-outline-secondary me-3">
                                <i class="fas fa-arrow-left"></i>
                            </a>
                            <div class="avatar me-3">
                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                     style="width: 45px; height: 45px; font-size: 16px;">
                                    {{ other_user.username|first|upper }}
                                </div>
                            </div>
                            <div>
                                <h5 class="mb-0">{{ other_user.username }}</h5>
                                <small class="text-muted" id="last-activity">
                                    {% if conversation.get_last_message %}
                                        Последняя активность: {{ conversation.get_last_message.created_at|timesince }} назад
                                    {% else %}
                                        Нет сообщений
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="{% url 'user_profile' other_user.username %}">
                                    <i class="fas fa-user"></i> Профиль
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="blockUser()">
                                    <i class="fas fa-ban"></i> Заблокировать
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="refreshChat()">
                                    <i class="fas fa-sync-alt"></i> Обновить чат
                                </a></li>
                                <li><a class="dropdown-item" href="{% url 'chat:chat_dashboard' %}">
                                    <i class="fas fa-comments"></i> Все чаты
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Сообщения -->
                <div class="chat-messages flex-grow-1 p-3" id="chat-messages" 
                     style="overflow-y: auto; background: #f8f9fa;">
                    {% for message in messages %}
                    <div class="message mb-3 {% if message.sender == request.user %}message-own{% endif %}" data-message-id="{{ message.id }}">
                        <div class="message-header d-flex justify-content-between align-items-center mb-1">
                            <strong>
                                {% if message.sender == request.user %}
                                    Вы
                                {% else %}
                                    {{ message.sender.username }}
                                {% endif %}
                            </strong>
                            <small class="text-muted">{{ message.created_at|date:"H:i" }}</small>
                        </div>
                        <div class="message-body {% if message.sender == request.user %}bg-primary text-white{% else %}bg-white{% endif %} rounded p-3 border">
                            {{ message.content|linebreaks }}
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center text-muted py-5" id="empty-chat-message">
                        <i class="fas fa-comments fa-3x mb-3"></i>
                        <h5>Нет сообщений</h5>
                        <p>Начните диалог с {{ other_user.username }}</p>
                    </div>
                    {% endfor %}
                </div>

                <!-- Индикатор загрузки -->
                <div id="chat-loading" class="text-center py-2 bg-light border-top" style="display: none;">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <small class="text-muted ms-2">Загрузка сообщений...</small>
                </div>

                <!-- Индикатор набора сообщения -->
                <div id="typing-indicator" class="px-3 py-1" style="display: none;">
                    <small class="text-muted">
                        <i class="fas fa-pencil-alt me-1"></i>
                        <span id="typing-user">{{ other_user.username }}</span> печатает...
                    </small>
                </div>

                <!-- Форма отправки сообщения -->
                <div class="chat-input border-top p-3 bg-white">
                    <form id="chat-form" class="d-flex gap-2">
                        {% csrf_token %}
                        <div class="flex-grow-1 position-relative">
                            <input type="text" 
                                   class="form-control" 
                                   id="chat-message-input" 
                                   placeholder="Введите сообщение..." 
                                   maxlength="1000"
                                   required
                                   autocomplete="off">
                        </div>
                        <button type="submit" class="btn btn-primary" id="chat-message-submit">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                    <div class="mt-1 d-flex justify-content-between align-items-center">
                        <small class="text-muted" id="char-counter">0/1000 символов</small>
                        <small class="text-muted">
                            <i class="fas fa-bolt me-1"></i>
                            <span id="connection-status">Подключение...</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Информация о пользователе -->
        <div class="col-md-3">
            <div class="user-info-sidebar h-100 bg-light border-start p-3">
                <div class="text-center mb-4">
                    <div class="avatar mx-auto mb-3">
                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto" 
                             style="width: 80px; height: 80px; font-size: 24px;">
                            {{ other_user.username|first|upper }}
                        </div>
                    </div>
                    <h5>{{ other_user.username }}</h5>
                    <p class="text-muted">Участник Waylines</p>
                    <div class="online-status mb-2">
                        <span class="badge bg-success" id="online-status">
                            <i class="fas fa-circle me-1"></i>Онлайн
                        </span>
                    </div>
                </div>

                <div class="mb-4">
                    <h6>Общая информация</h6>
                    <div class="small">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Маршруты:</span>
                            <strong>{{ other_user.routes.count }}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Друзья:</span>
                            <strong>{{ accepted_friends_count }}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Статус:</span>
                            <strong id="last-seen">Сейчас в сети</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>В чате с:</span>
                            <strong>{{ conversation.created_at|date:"d.m.Y" }}</strong>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <h6>Действия</h6>
                    <div class="d-grid gap-2">
                        <a href="{% url 'user_profile' other_user.username %}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-user me-1"></i> Профиль
                        </a>
                        <a href="{% url 'all_routes' %}?author={{ other_user.username }}" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-route me-1"></i> Маршруты
                        </a>
                        <button class="btn btn-outline-info btn-sm" onclick="startRouteChat()">
                            <i class="fas fa-map-marked-alt me-1"></i> Создать общий маршрут
                        </button>
                    </div>
                </div>

                <div class="mt-auto">
                    <div class="d-grid gap-2">
                        <button class="btn btn-warning btn-sm" onclick="refreshChat()">
                            <i class="fas fa-sync-alt me-1"></i> Обновить чат
                        </button>
                        <a href="{% url 'chat:chat_dashboard' %}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-comments me-1"></i> Все чаты
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.chat-container {
    background: #f8f9fa;
}
.chat-messages {
    max-height: calc(100vh - 280px);
    min-height: 400px;
}
.message-own .message-body {
    background: #007bff !important;
    color: white;
    border-color: #007bff !important;
}
.message-own .message-header {
    flex-direction: row-reverse;
}
.message {
    animation: fadeIn 0.3s ease-in;
}
.message-temp {
    opacity: 0.7;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
.avatar {
    flex-shrink: 0;
}

/* Стили для уведомлений */
#notifications {
    min-width: 300px;
    max-width: 500px;
}

.alert {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border: none;
    border-radius: 8px;
}

.alert-success {
    background: linear-gradient(135deg, #d4edda, #c3e6cb);
    color: #155724;
    border-left: 4px solid #28a745;
}

.alert-danger {
    background: linear-gradient(135deg, #f8d7da, #f5c6cb);
    color: #721c24;
    border-left: 4px solid #dc3545;
}

.alert-warning {
    background: linear-gradient(135deg, #fff3cd, #ffeaa7);
    color: #856404;
    border-left: 4px solid #ffc107;
}

.alert-info {
    background: linear-gradient(135deg, #d1ecf1, #bee5eb);
    color: #0c5460;
    border-left: 4px solid #17a2b8;
}

/* Стили для скроллбара */
.chat-messages::-webkit-scrollbar {
    width: 8px;
}

.chat-messages::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 10px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Анимация печати */
.typing-animation {
    display: inline-block;
}
.typing-animation::after {
    content: '...';
    animation: typing 1.5s infinite;
}
@keyframes typing {
    0%, 20% { content: '.'; }
    40% { content: '..'; }
    60%, 100% { content: '...'; }
}

/* Адаптивность */
@media (max-width: 768px) {
    .col-md-3 {
        display: none;
    }
    .col-md-9 {
        flex: 0 0 100%;
        max-width: 100%;
    }
    .chat-messages {
        max-height: calc(100vh - 200px);
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Глобальные переменные
const conversationId = {{ conversation.id }};
const currentUserId = {{ request.user.id }};
const currentUsername = "{{ request.user.username }}";
const otherUserId = {{ other_user.id }};
const otherUsername = "{{ other_user.username }}";
let isSending = false;
let isConnected = false;
let chatSocket;
let typingTimer;
let lastTypingTime = 0;
const TYPING_TIMEOUT = 3000;
let ajaxPollingInterval;

// Инициализация чата при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    initializeChat();
    setupEventListeners();
    updateCharCounter();
    document.querySelector('#chat-message-input').focus();
});

// Инициализация чата
function initializeChat() {
    initializeWebSocket();
    
    // Резервная проверка: если WebSocket не подключился за 5 секунд, используем AJAX
    setTimeout(() => {
        if (!isConnected && !ajaxPollingInterval) {
            console.log('WebSocket failed, falling back to AJAX');
            showWarning('Используется режим AJAX (обновление каждые 5 сек)');
            startAjaxPolling();
        }
    }, 5000);
}

// Настройка обработчиков событий
function setupEventListeners() {
    // Отправка сообщения
    document.querySelector('#chat-form').onsubmit = handleMessageSubmit;
    
    // Счетчик символов
    const messageInput = document.querySelector('#chat-message-input');
    messageInput.addEventListener('input', updateCharCounter);
    
    // Отслеживание ввода для индикатора печати
    messageInput.addEventListener('input', handleTyping);
    
    // Обработка нажатия Enter
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleMessageSubmit(e);
        }
    });
    
    // Автопрокрутка при изменении размера окна
    window.addEventListener('resize', scrollToBottom);
    
    // Фокус на поле ввода при клике на чат
    document.querySelector('#chat-messages').addEventListener('click', function() {
        messageInput.focus();
    });
}

// Инициализация WebSocket соединения
function initializeWebSocket() {
    try {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/private_chat/${conversationId}/`;
        
        console.log('Connecting to WebSocket:', wsUrl);
        
        chatSocket = new WebSocket(wsUrl);

        chatSocket.onopen = function(e) {
            console.log('WebSocket connected successfully');
            isConnected = true;
            updateConnectionStatus('connected', 'Подключено');
            showSuccess('Чат подключен');
            
            // Останавливаем AJAX polling если был запущен
            if (ajaxPollingInterval) {
                clearInterval(ajaxPollingInterval);
                ajaxPollingInterval = null;
            }
        };

        chatSocket.onclose = function(e) {
            console.log('WebSocket disconnected:', e.code, e.reason);
            isConnected = false;
            updateConnectionStatus('disconnected', 'Переподключение...');
            
            // Автопереподключение через 3 секунды
            setTimeout(initializeWebSocket, 3000);
        };

        chatSocket.onerror = function(e) {
            console.error('WebSocket error:', e);
            isConnected = false;
            updateConnectionStatus('error', 'Ошибка подключения');
        };

        chatSocket.onmessage = function(e) {
            try {
                const data = JSON.parse(e.data);
                handleWebSocketMessage(data);
            } catch (error) {
                console.error('Error parsing WebSocket message:', error);
            }
        };
    } catch (error) {
        console.error('Error initializing WebSocket:', error);
        if (!ajaxPollingInterval) {
            startAjaxPolling();
        }
    }
}

// AJAX polling как резервный метод
function startAjaxPolling() {
    // Сначала загружаем все сообщения
    loadMessages();
    
    // Затем начинаем опрашивать сервер каждые 5 секунд
    ajaxPollingInterval = setInterval(() => {
        if (!isSending) {
            loadNewMessagesAjax();
        }
    }, 5000);
}

function loadNewMessagesAjax() {
    const lastMessage = document.querySelector('#chat-messages .message:last-child');
    const lastMessageId = lastMessage ? lastMessage.dataset.messageId : 0;
    
    fetch(`/chat/get_private_messages/${conversationId}/?last_message_id=${lastMessageId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success && data.messages.length > 0) {
            data.messages.forEach(message => {
                addMessageToChat(message, true);
            });
        }
    })
    .catch(error => {
        console.error('Error loading new messages:', error);
    });
}

// Обработка сообщений WebSocket
function handleWebSocketMessage(data) {
    switch(data.type) {
        case 'history':
            renderMessages(data.messages);
            break;
        case 'chat_message':
            addMessageToChat({
                id: data.message_id,
                content: data.message,
                sender: data.username,
                sender_id: data.user_id,
                created_at: data.timestamp,
                is_own: data.user_id == currentUserId
            }, true);
            break;
        case 'user_typing':
            showTypingIndicator(data.username);
            break;
        case 'user_stop_typing':
            hideTypingIndicator();
            break;
        case 'user_online':
            updateUserStatus(data.user_id, true);
            break;
        case 'user_offline':
            updateUserStatus(data.user_id, false);
            break;
        default:
            console.log('Unknown message type:', data.type);
    }
}

// Обработка отправки сообщения
function handleMessageSubmit(e) {
    e.preventDefault();
    
    if (isSending) {
        showWarning('Сообщение отправляется...');
        return;
    }
    
    const messageInput = document.querySelector('#chat-message-input');
    const message = messageInput.value.trim();
    
    if (message && isConnected) {
        sendMessageViaWebSocket(message);
    } else if (message && !isConnected && ajaxPollingInterval) {
        // Если WebSocket не работает, но есть AJAX polling, используем AJAX
        sendMessageViaAjax(message);
    } else if (!message) {
        showWarning('Введите сообщение');
        messageInput.focus();
    } else {
        showError('Соединение не установлено. Попробуйте обновить страницу.');
    }
}

// Отправка сообщения через WebSocket
function sendMessageViaWebSocket(message) {
    if (isSending || !isConnected) return;
    
    isSending = true;
    const messageInput = document.querySelector('#chat-message-input');
    const submitBtn = document.querySelector('#chat-message-submit');
    
    // Блокируем форму
    messageInput.disabled = true;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    // Останавливаем индикатор печати
    stopTyping();
    
    try {
        // Сначала добавляем сообщение локально для мгновенного отображения
        const tempId = 'temp-' + Date.now();
        addMessageToChat({
            id: tempId,
            content: message,
            sender: currentUsername,
            sender_id: currentUserId,
            created_at: getCurrentTime(),
            is_own: true,
            is_temp: true
        }, true);
        
        // Отправляем через WebSocket
        chatSocket.send(JSON.stringify({
            'type': 'chat_message',
            'message': message,
            'user_id': currentUserId,
            'temp_id': tempId
        }));
        
        messageInput.value = '';
        updateCharCounter();
        
    } catch (error) {
        console.error('Ошибка отправки:', error);
        showError('Ошибка отправки сообщения');
        removeTempMessage('temp-' + Date.now());
    } finally {
        // Разблокируем форму
        isSending = false;
        messageInput.disabled = false;
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
        messageInput.focus();
    }
}

// Отправка сообщения через AJAX (резервный метод)
function sendMessageViaAjax(message) {
    if (isSending) return;
    
    isSending = true;
    const messageInput = document.querySelector('#chat-message-input');
    const submitBtn = document.querySelector('#chat-message-submit');
    
    messageInput.disabled = true;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    stopTyping();
    
    try {
        // Сначала добавляем сообщение локально
        const tempId = 'temp-' + Date.now();
        addMessageToChat({
            id: tempId,
            content: message,
            sender: currentUsername,
            sender_id: currentUserId,
            created_at: getCurrentTime(),
            is_own: true,
            is_temp: true
        }, true);
        
        // Отправляем через AJAX
        fetch('/chat/send_private_message/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                'user_id': otherUserId,
                'message': message
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Заменяем временное сообщение на настоящее
                removeTempMessage(tempId);
                addMessageToChat({
                    id: data.message_id,
                    content: data.content,
                    sender: data.sender,
                    sender_id: data.sender_id,
                    created_at: data.created_at,
                    is_own: true
                }, true);
                showSuccess('Сообщение отправлено');
            } else {
                throw new Error(data.error || 'Ошибка отправки');
            }
        })
        .catch(error => {
            console.error('Ошибка отправки:', error);
            showError('Ошибка отправки сообщения: ' + error.message);
            removeTempMessage(tempId);
        })
        .finally(() => {
            messageInput.value = '';
            updateCharCounter();
        });
        
    } catch (error) {
        console.error('Ошибка отправки:', error);
        showError('Ошибка отправки сообщения');
        removeTempMessage('temp-' + Date.now());
    } finally {
        isSending = false;
        messageInput.disabled = false;
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
        messageInput.focus();
    }
}

// Обработка печати сообщения
function handleTyping() {
    const now = Date.now();
    const messageInput = document.querySelector('#chat-message-input');
    
    if (messageInput.value.trim().length > 0) {
        if (now - lastTypingTime > TYPING_TIMEOUT) {
            // Пользователь начал печатать
            sendTypingSignal(true);
        }
        
        lastTypingTime = now;
        
        // Сбрасываем таймер
        clearTimeout(typingTimer);
        typingTimer = setTimeout(stopTyping, TYPING_TIMEOUT);
    }
}

// Отправка сигнала о печати
function sendTypingSignal(isTyping) {
    if (!isConnected) return;
    
    try {
        chatSocket.send(JSON.stringify({
            'type': isTyping ? 'user_typing' : 'user_stop_typing',
            'user_id': currentUserId,
            'username': currentUsername
        }));
    } catch (error) {
        console.error('Error sending typing signal:', error);
    }
}

// Остановка печати
function stopTyping() {
    sendTypingSignal(false);
    lastTypingTime = 0;
}

// Показать индикатор печати
function showTypingIndicator(username) {
    const typingIndicator = document.getElementById('typing-indicator');
    const typingUser = document.getElementById('typing-user');
    
    if (typingIndicator && typingUser) {
        typingUser.textContent = username;
        typingIndicator.style.display = 'block';
    }
}

// Скрыть индикатор печати
function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
        typingIndicator.style.display = 'none';
    }
}

// Обновление счетчика символов
function updateCharCounter() {
    const input = document.querySelector('#chat-message-input');
    const counter = document.querySelector('#char-counter');
    const length = input.value.length;
    
    counter.textContent = `${length}/1000 символов`;
    
    if (length > 950) {
        counter.className = 'text-danger';
    } else if (length > 800) {
        counter.className = 'text-warning';
    } else if (length > 0) {
        counter.className = 'text-success';
    } else {
        counter.className = 'text-muted';
    }
}

// Обновление статуса подключения
function updateConnectionStatus(status, message) {
    const statusElement = document.getElementById('connection-status');
    if (statusElement) {
        statusElement.textContent = message;
        statusElement.className = status === 'connected' ? 'text-success' : 
                                status === 'disconnected' ? 'text-warning' : 'text-danger';
    }
}

// Загрузка сообщений (резервный метод)
function loadMessages() {
    showLoading(true);
    
    fetch(`/chat/get_private_messages/${conversationId}/`)
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            renderMessages(data.messages);
        } else {
            throw new Error(data.error || 'Неизвестная ошибка');
        }
    })
    .catch(error => {
        console.error('Ошибка загрузки сообщений:', error);
        showError('Ошибка загрузки сообщений: ' + error.message);
    })
    .finally(() => {
        showLoading(false);
    });
}

// Отображение сообщений
function renderMessages(messages) {
    const messagesContainer = document.querySelector('#chat-messages');
    
    // Очищаем контейнер
    messagesContainer.innerHTML = '';
    
    if (messages.length === 0) {
        showEmptyChatMessage();
        return;
    }
    
    // Добавляем сообщения
    messages.forEach(messageData => {
        addMessageToChat(messageData, false);
    });
    
    scrollToBottom();
}

// Добавление сообщения в чат
function addMessageToChat(messageData, isNew = true) {
    const messagesContainer = document.querySelector('#chat-messages');
    
    // Убираем сообщение о пустом чате
    const emptyMessage = messagesContainer.querySelector('#empty-chat-message');
    if (emptyMessage) {
        emptyMessage.remove();
    }
    
    // Удаляем временное сообщение с таким же содержимым
    if (messageData.id && !messageData.id.startsWith('temp-')) {
        const tempMessages = document.querySelectorAll('[data-message-id^="temp-"]');
        tempMessages.forEach(tempMsg => {
            const tempContent = tempMsg.querySelector('.message-body').textContent.trim();
            if (tempContent === messageData.content) {
                tempMsg.remove();
            }
        });
    }
    
    // Проверяем, нет ли уже такого сообщения
    const existingMessage = messagesContainer.querySelector(`[data-message-id="${messageData.id}"]`);
    if (existingMessage && !messageData.id.startsWith('temp-')) {
        return; // Сообщение уже есть
    }

    const messageDiv = document.createElement('div');
    messageDiv.className = 'message mb-3';
    messageDiv.dataset.messageId = messageData.id;
    
    if (messageData.is_temp) {
        messageDiv.classList.add('message-temp');
    }
    
    const isOwn = messageData.sender_id == currentUserId;
    if (isOwn) {
        messageDiv.classList.add('message-own');
    }

    const senderName = isOwn ? 'Вы' : messageData.sender;

    messageDiv.innerHTML = `
        <div class="message-header d-flex justify-content-between align-items-center mb-1">
            <strong>${escapeHtml(senderName)}</strong>
            <small class="text-muted">${messageData.created_at}</small>
        </div>
        <div class="message-body ${isOwn ? 'bg-primary text-white' : 'bg-white'} rounded p-3 border">
            ${escapeHtml(messageData.content).replace(/\n/g, '<br>')}
        </div>
    `;

    if (isNew) {
        messageDiv.style.animation = 'fadeIn 0.2s ease-in';
        
        // Воспроизводим звук для новых входящих сообщений
        if (!isOwn) {
            playMessageSound();
        }
    }
    
    messagesContainer.appendChild(messageDiv);
    
    if (isNew) {
        scrollToBottom();
    }
}

// Удаление временного сообщения
function removeTempMessage(tempId) {
    const tempMessage = document.querySelector(`[data-message-id="${tempId}"]`);
    if (tempMessage) {
        tempMessage.remove();
    }
}

// Воспроизведение звука нового сообщения
function playMessageSound() {
    try {
        // Простой бип-звук using Web Audio API
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.2);
    } catch (error) {
        console.log('Audio play failed:', error);
    }
}

// Получение текущего времени
function getCurrentTime() {
    return new Date().toLocaleTimeString('ru-RU', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
}

// Показать/скрыть индикатор загрузки
function showLoading(show) {
    const loadingElement = document.querySelector('#chat-loading');
    if (loadingElement) {
        loadingElement.style.display = show ? 'block' : 'none';
    }
}

// Показать сообщение о пустом чате
function showEmptyChatMessage() {
    const messagesContainer = document.querySelector('#chat-messages');
    messagesContainer.innerHTML = `
        <div class="text-center text-muted py-5" id="empty-chat-message">
            <i class="fas fa-comments fa-3x mb-3"></i>
            <h5>Нет сообщений</h5>
            <p>Начните диалог с {{ other_user.username }}</p>
        </div>
    `;
}

// Прокрутка к последнему сообщению
function scrollToBottom() {
    const messagesContainer = document.querySelector('#chat-messages');
    if (messagesContainer) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
}

// Обновление статуса пользователя
function updateUserStatus(userId, isOnline) {
    if (userId === otherUserId) {
        const onlineStatus = document.getElementById('online-status');
        const lastSeen = document.getElementById('last-seen');
        
        if (isOnline) {
            onlineStatus.className = 'badge bg-success';
            onlineStatus.innerHTML = '<i class="fas fa-circle me-1"></i>Онлайн';
            lastSeen.textContent = 'Сейчас в сети';
        } else {
            onlineStatus.className = 'badge bg-secondary';
            onlineStatus.innerHTML = '<i class="fas fa-circle me-1"></i>Не в сети';
            lastSeen.textContent = 'Был недавно';
        }
    }
}

// Утилиты
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Уведомления
function showError(message) {
    showNotification(message, 'danger');
}

function showSuccess(message) {
    showNotification(message, 'success');
}

function showWarning(message) {
    showNotification(message, 'warning');
}

function showInfo(message) {
    showNotification(message, 'info');
}

function showNotification(message, type = 'info') {
    const notifications = document.getElementById('notifications');
    const notificationId = 'notification-' + Date.now();
    
    const alertClass = {
        'success': 'alert-success',
        'danger': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
    }[type] || 'alert-info';
    
    const iconClass = {
        'success': 'fa-check-circle',
        'danger': 'fa-exclamation-circle',
        'warning': 'fa-exclamation-triangle',
        'info': 'fa-info-circle'
    }[type] || 'fa-info-circle';
    
    const notification = document.createElement('div');
    notification.id = notificationId;
    notification.className = `alert ${alertClass} alert-dismissible fade show mb-2`;
    notification.innerHTML = `
        <i class="fas ${iconClass} me-2"></i>
        ${escapeHtml(message)}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    notifications.appendChild(notification);
    
    // Автоматическое скрытие
    const hideTime = type === 'success' ? 3000 : 5000;
    setTimeout(() => {
        const alertElement = document.getElementById(notificationId);
        if (alertElement) {
            const alert = bootstrap.Alert.getOrCreateInstance(alertElement);
            alert.close();
        }
    }, hideTime);
}

// Функции управления чатом
function refreshChat() {
    if (isConnected) {
        // Запрашиваем историю сообщений
        chatSocket.send(JSON.stringify({
            'type': 'get_history'
        }));
        showInfo('Чат обновлен');
    } else {
        loadMessages();
    }
}

function blockUser() {
    if (confirm(`Вы уверены, что хотите заблокировать ${otherUsername}?`)) {
        showInfo('Функция блокировки в разработке');
    }
}

function startRouteChat() {
    showInfo('Функция создания общего маршрута в разработке');
}

// Обработка перед закрытием страницы
window.addEventListener('beforeunload', function() {
    if (chatSocket) {
        chatSocket.close();
    }
    if (ajaxPollingInterval) {
        clearInterval(ajaxPollingInterval);
    }
});

// Пинг соединения каждые 25 секунд для поддержания активности
setInterval(() => {
    if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
        chatSocket.send(JSON.stringify({type: 'ping'}));
    }
}, 25000);
</script>
{% endblock %}