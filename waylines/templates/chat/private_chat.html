{% extends 'base.html' %}
{% load static %}

{% block title %}–ß–∞—Ç —Å {{ other_user.username }} - Waylines{% endblock %}

{% block content %}
<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
<div id="notifications" class="notifications-container"></div>

<div class="container-fluid h-100 p-0">
    <div class="row g-0 h-100">
        <!-- –ß–∞—Ç -->
        <div class="col-12" id="chat-main-col">
            <div class="chat-container h-100 d-flex flex-column bg-light">
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ -->
                <div class="chat-header bg-white border-bottom p-4 shadow-sm">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <a href="{% url 'chat:chat_dashboard' %}" class="btn btn-sm btn-outline-secondary me-3">
                                <i class="fas fa-arrow-left"></i>
                            </a>
                            <button class="btn btn-sm btn-outline-info me-3 d-md-none" onclick="toggleUserInfo()">
                                <i class="fas fa-info-circle"></i>
                            </button>
                            <div class="position-relative me-3">
                                <div class="avatar bg-gradient-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                     style="width: 50px; height: 50px; font-size: 18px; font-weight: 600;">
                                    {{ other_user.username|first|upper }}
                                </div>
                                <div class="position-absolute bottom-0 end-0 bg-success rounded-circle border border-2 border-white"
                                     style="width: 12px; height: 12px;"></div>
                            </div>
                            <div>
                                <h5 class="mb-1 fw-bold">{{ other_user.username }}</h5>
                                <small class="text-muted" id="last-activity">
                                    <i class="fas fa-circle text-success me-1" style="font-size: 8px;"></i>
                                    <span id="activity-text">
                                        {% if other_user.is_online %}
                                            –í —Å–µ—Ç–∏
                                        {% else %}
                                            –ë—ã–ª(–∞) {{ other_user.last_seen|timesince }} –Ω–∞–∑–∞–¥
                                        {% endif %}
                                    </span>
                                </small>
                            </div>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-light rounded-circle" type="button" data-bs-toggle="dropdown"
                                    style="width: 40px; height: 40px;">
                                <i class="fas fa-ellipsis-v text-muted"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                                <li><a class="dropdown-item" href="#" onclick="toggleUserInfo()">
                                    <i class="fas fa-info-circle me-2"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                                </a></li>
                                <li><a class="dropdown-item" href="{% url 'user_profile' other_user.username %}">
                                    <i class="fas fa-user me-2"></i> –ü—Ä–æ—Ñ–∏–ª—å
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="blockUser()">
                                    <i class="fas fa-ban me-2"></i> –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="refreshChat()">
                                    <i class="fas fa-sync-alt me-2"></i> –û–±–Ω–æ–≤–∏—Ç—å —á–∞—Ç
                                </a></li>
                                <li><a class="dropdown-item" href="{% url 'chat:chat_dashboard' %}">
                                    <i class="fas fa-comments me-2"></i> –í—Å–µ —á–∞—Ç—ã
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
                <div class="chat-messages flex-grow-1 p-4" id="chat-messages" 
                     style="overflow-y: auto; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                    {% for message in messages %}
                    <div class="message-wrapper mb-4 {% if message.sender == request.user %}own-message{% endif %}" 
                         data-message-id="{{ message.id }}">
                        <div class="message-bubble {% if message.sender == request.user %}own-bubble{% else %}other-bubble{% endif %}">
                            {% if message.sender != request.user %}
                            <div class="message-sender mb-1">
                                <small class="text-primary fw-bold">{{ message.sender.username }}</small>
                            </div>
                            {% endif %}
                            <div class="message-content">
                                {% if message.message_type == 'text' %}
                                    {{ message.content|linebreaks }}
                                {% elif message.message_type == 'image' %}
                                    <div class="media-message">
                                        <img src="{{ message.content }}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" class="img-fluid rounded" style="max-width: 300px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                        <div class="media-error" style="display: none; padding: 20px; text-align: center; color: #6c757d;">
                                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                            <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</p>
                                        </div>
                                    </div>
                                {% elif message.message_type == 'video' %}
                                    <div class="media-message">
                                        <video controls class="img-fluid rounded" style="max-width: 300px;">
                                            <source src="{{ message.content }}" type="video/mp4">
                                            –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
                                        </video>
                                    </div>
                                {% elif message.message_type == 'audio' %}
                                    <div class="media-message">
                                        <audio controls class="w-100">
                                            <source src="{{ message.content }}" type="audio/mpeg">
                                            –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ.
                                        </audio>
                                    </div>
                                {% elif message.message_type == 'voice' %}
                                    <div class="voice-message d-flex align-items-center">
                                        <button class="btn btn-sm btn-outline-primary play-voice-btn me-2" data-audio-url="{{ message.content }}">
                                            <i class="fas fa-play"></i>
                                        </button>
                                        <div class="voice-waveform flex-grow-1 me-2">
                                            <div class="waveform-bar"></div>
                                            <div class="waveform-bar"></div>
                                            <div class="waveform-bar"></div>
                                            <div class="waveform-bar"></div>
                                            <div class="waveform-bar"></div>
                                        </div>
                                        <small class="text-muted voice-duration">0:00</small>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="message-time text-end mt-1">
                                <small class="text-muted">{{ message.created_at|date:"H:i" }}</small>
                                {% if message.sender == request.user %}
                                <i class="fas fa-check-double text-primary ms-1" style="font-size: 10px;"></i>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center text-muted py-5" id="empty-chat-message">
                        <div class="empty-state-icon mb-4">
                            <i class="fas fa-comments fa-4x text-light"></i>
                        </div>
                        <h4 class="fw-light">–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥</h4>
                        <p class="text-muted">–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ {{ other_user.username }}</p>
                    </div>
                    {% endfor %}
                </div>

                <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
                <div id="chat-loading" class="text-center py-3 bg-white border-top" style="display: none;">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                    <small class="text-muted ms-2">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</small>
                </div>

                <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è -->
                <div id="typing-indicator" class="px-4 py-2 bg-white border-top" style="display: none;">
                    <div class="typing-dots">
                        <small class="text-muted">
                            <i class="fas fa-pencil-alt me-2"></i>
                            <span id="typing-user">{{ other_user.username }}</span> –ø–µ—á–∞—Ç–∞–µ—Ç
                            <span class="typing-animation"></span>
                        </small>
                    </div>
                </div>

                <!-- –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è -->
                <div class="chat-input bg-white border-top p-3 shadow-sm">
                    <!-- –ú–µ–¥–∏–∞-–ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä -->
                    <div id="media-preview" class="mb-3" style="display: none;">
                        <div class="d-flex align-items-center bg-light rounded p-2">
                            <div id="preview-content" class="flex-grow-1"></div>
                            <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="clearMedia()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <form id="chat-form" class="d-flex align-items-end gap-2" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="conversation_id" value="{{ conversation.id }}">
                        
                        <div class="flex-grow-1 position-relative">
                            <div class="input-group">
                                <div class="btn-group me-2">
                                    <button type="button" class="btn btn-outline-secondary rounded-circle d-flex align-items-center justify-content-center"
                                            style="width: 40px; height: 40px;" data-bs-toggle="dropdown">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <ul class="dropdown-menu shadow border-0 p-2">
                                        <li>
                                            <button type="button" class="dropdown-item d-flex align-items-center py-2" onclick="triggerFileInput('image')">
                                                <i class="fas fa-image text-success me-2"></i>
                                                <span>–§–æ—Ç–æ</span>
                                            </button>
                                        </li>
                                        <li>
                                            <button type="button" class="dropdown-item d-flex align-items-center py-2" onclick="triggerFileInput('video')">
                                                <i class="fas fa-video text-info me-2"></i>
                                                <span>–í–∏–¥–µ–æ</span>
                                            </button>
                                        </li>
                                        <li>
                                            <button type="button" class="dropdown-item d-flex align-items-center py-2" onclick="triggerFileInput('audio')">
                                                <i class="fas fa-music text-warning me-2"></i>
                                                <span>–ê—É–¥–∏–æ</span>
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                                
                                <!-- –¢–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥ -->
                                <input type="text" 
                                       class="form-control border-end-0" 
                                       id="chat-message-input" 
                                       name="message"
                                       placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                                       maxlength="1000"
                                       autocomplete="off"
                                       style="border-radius: 25px; padding: 12px 20px; border: 1px solid #e0e0e0;">
                                
                                <button type="button" class="btn btn-outline-secondary border-start-0" 
                                        style="border-radius: 0 25px 25px 0; border: 1px solid #e0e0e0;">
                                    <i class="fas fa-smile"></i>
                                </button>
                            </div>
                            
                            <!-- –°–∫—Ä—ã—Ç—ã–µ –∏–Ω–ø—É—Ç—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ -->
                            <input type="file" id="file-input" name="media_file" accept="image/*,video/*,audio/*" style="display: none;">
                            <input type="file" id="image-input" name="media_file" accept="image/*" style="display: none;">
                            <input type="file" id="video-input" name="media_file" accept="video/*" style="display: none;">
                            <input type="file" id="audio-input" name="media_file" accept="audio/*" style="display: none;">
                        </div>
                        
                        <!-- –ö–Ω–æ–ø–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è -->
                        <button type="button" class="btn btn-outline-primary rounded-circle d-flex align-items-center justify-content-center voice-toggle-btn" 
                                id="voice-toggle-btn"
                                style="width: 50px; height: 50px;"
                                onmousedown="startVoiceRecording()" 
                                onmouseup="stopVoiceRecording()"
                                onmouseleave="stopVoiceRecording()"
                                ontouchstart="startVoiceRecording()" 
                                ontouchend="stopVoiceRecording()">
                            <i class="fas fa-microphone"></i>
                        </button>
                        
                        <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è -->
                        <button type="submit" class="btn btn-primary rounded-circle d-flex align-items-center justify-content-center" 
                                id="chat-message-submit"
                                style="width: 50px; height: 50px;">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                    
                    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è -->
                    <div id="voice-recording-indicator" class="mt-3 text-center" style="display: none;">
                        <div class="d-flex align-items-center justify-content-center">
                            <div class="recording-animation me-3">
                                <div class="pulse"></div>
                                <i class="fas fa-microphone text-danger"></i>
                            </div>
                            <div class="recording-info">
                                <div class="recording-timer">
                                    <span id="voice-recording-time">0:00</span>
                                </div>
                                <small class="text-muted">–ó–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è...</small>
                            </div>
                            <button type="button" class="btn btn-danger btn-sm ms-3" onclick="cancelVoiceRecording()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-2 d-flex justify-content-between align-items-center px-2">
                        <small class="text-muted" id="char-counter">0/1000</small>
                        <small class="text-muted">
                            <i class="fas fa-bolt me-1 text-success"></i>
                            <span id="connection-status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –°–∞–π–¥–±–∞—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
<div class="user-info-sidebar-overlay" id="user-info-overlay" style="display: none;"></div>
<div class="user-info-sidebar" id="user-info-sidebar">
    <div class="user-info-content">
        <div class="user-info-header">
            <h5 class="fw-bold mb-0">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h5>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleUserInfo()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="user-info-body">
            <div class="text-center mb-4">
                <div class="position-relative mx-auto mb-3">
                    <div class="avatar bg-gradient-primary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto" 
                         style="width: 100px; height: 100px; font-size: 32px; font-weight: 600;">
                        {{ other_user.username|first|upper }}
                    </div>
                    <div class="position-absolute bottom-0 end-0 bg-success rounded-circle border border-3 border-white"
                         style="width: 20px; height: 20px;"></div>
                </div>
                <h5 class="fw-bold">{{ other_user.username }}</h5>
                <p class="text-muted mb-3">–£—á–∞—Å—Ç–Ω–∏–∫ Waylines</p>
                <div class="online-status">
                    <span class="badge bg-success bg-opacity-10 text-success px-3 py-2 rounded-pill" id="online-status">
                        <i class="fas fa-circle me-1" style="font-size: 8px;"></i>–í —Å–µ—Ç–∏
                    </span>
                </div>
            </div>

            <div class="mb-4">
                <h6 class="fw-semibold text-uppercase small mb-3">–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
                <div class="info-grid">
                    <div class="info-item d-flex justify-content-between align-items-center py-2 border-bottom">
                        <span class="text-muted">–ú–∞—Ä—à—Ä—É—Ç—ã</span>
                        <strong class="text-primary">{{ other_user.routes.count }}</strong>
                    </div>
                    <div class="info-item d-flex justify-content-between align-items-center py-2 border-bottom">
                        <span class="text-muted">–î—Ä—É–∑—å—è</span>
                        <strong class="text-primary">{{ accepted_friends_count }}</strong>
                    </div>
                    <div class="info-item d-flex justify-content-between align-items-center py-2 border-bottom">
                        <span class="text-muted">–°—Ç–∞—Ç—É—Å</span>
                        <strong class="text-success" id="last-seen">–í —Å–µ—Ç–∏</strong>
                    </div>
                    <div class="info-item d-flex justify-content-between align-items-center py-2">
                        <span class="text-muted">–í —á–∞—Ç–µ —Å</span>
                        <strong>{{ conversation.created_at|date:"d.m.Y" }}</strong>
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <h6 class="fw-semibold text-uppercase small mb-3">–î–µ–π—Å—Ç–≤–∏—è</h6>
                <div class="d-grid gap-2">
                    <a href="{% url 'user_profile' other_user.username %}" class="btn btn-outline-primary btn-sm py-2">
                        <i class="fas fa-user me-2"></i> –ü—Ä–æ—Ñ–∏–ª—å
                    </a>
                    <a href="{% url 'all_routes' %}?author={{ other_user.username }}" class="btn btn-outline-success btn-sm py-2">
                        <i class="fas fa-route me-2"></i> –ú–∞—Ä—à—Ä—É—Ç—ã
                    </a>
                    <button class="btn btn-outline-info btn-sm py-2" onclick="startRouteChat()">
                        <i class="fas fa-map-marked-alt me-2"></i> –û–±—â–∏–π –º–∞—Ä—à—Ä—É—Ç
                    </button>
                </div>
            </div>

            <div class="mt-auto">
                <div class="d-grid gap-2">
                    <button class="btn btn-warning btn-sm py-2" onclick="refreshChat()">
                        <i class="fas fa-sync-alt me-2"></i> –û–±–Ω–æ–≤–∏—Ç—å —á–∞—Ç
                    </button>
                    <a href="{% url 'chat:chat_dashboard' %}" class="btn btn-outline-secondary btn-sm py-2">
                        <i class="fas fa-comments me-2"></i> –í—Å–µ —á–∞—Ç—ã
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ —á–∞—Ç–∞ */
.chat-container {
    background: #f8f9fa;
    transition: all 0.3s ease;
}

.chat-messages {
    max-height: calc(100vh - 280px);
    min-height: 400px;
    scroll-behavior: smooth;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π */
.message-wrapper {
    display: flex;
    flex-direction: column;
}

.own-message {
    align-items: flex-end;
}

.other-message {
    align-items: flex-start;
}

.message-bubble {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 18px;
    position: relative;
    animation: messageSlideIn 0.3s ease-out;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.own-bubble {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    border-bottom-right-radius: 6px;
}

.other-bubble {
    background: white;
    color: #333;
    border-bottom-left-radius: 6px;
    border: 1px solid #e9ecef;
}

.message-content {
    line-height: 1.4;
    word-wrap: break-word;
}

.message-time {
    font-size: 0.75rem;
    opacity: 0.8;
}

.message-sender {
    font-size: 0.8rem;
    font-weight: 600;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –º–µ–¥–∏–∞-—Å–æ–æ–±—â–µ–Ω–∏–π */
.media-message img,
.media-message video {
    max-width: 100%;
    border-radius: 12px;
}

.voice-message {
    padding: 8px 12px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 20px;
}

.voice-waveform {
    display: flex;
    align-items: center;
    height: 30px;
}

.waveform-bar {
    width: 3px;
    height: 20px;
    background-color: currentColor;
    margin: 0 1px;
    border-radius: 2px;
    animation: waveform 1.5s ease-in-out infinite;
}

.waveform-bar:nth-child(2) { animation-delay: 0.2s; }
.waveform-bar:nth-child(3) { animation-delay: 0.4s; }
.waveform-bar:nth-child(4) { animation-delay: 0.6s; }
.waveform-bar:nth-child(5) { animation-delay: 0.8s; }

@keyframes waveform {
    0%, 100% { height: 10px; }
    50% { height: 20px; }
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ */
@keyframes messageSlideIn {
    from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—á–∞—Ç–∏ */
.typing-animation::after {
    content: '...';
    animation: typing 1.5s infinite;
}

@keyframes typing {
    0%, 20% { content: '.'; }
    40% { content: '..'; }
    60%, 100% { content: '...'; }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∞–≤–∞—Ç–∞—Ä–æ–≤ */
.avatar {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.bg-gradient-primary {
    background: linear-gradient(135deg, #007bff, #6610f2) !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è */
.empty-state-icon {
    opacity: 0.5;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
.chat-messages::-webkit-scrollbar {
    width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 10px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
.notifications-container {
    position: fixed;
    top: 80px;
    right: 20px;
    z-index: 1060;
    max-width: 350px;
    width: 100%;
}

.notification {
    background: white;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 10px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    border-left: 4px solid;
    transform: translateX(400px);
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    position: relative;
    overflow: hidden;
}

.notification.show {
    transform: translateX(0);
    opacity: 1;
}

.notification.hide {
    transform: translateX(400px);
    opacity: 0;
}

.notification-success {
    border-left-color: #10b981;
    color: #065f46;
}

.notification-error {
    border-left-color: #ef4444;
    color: #7f1d1d;
}

.notification-warning {
    border-left-color: #f59e0b;
    color: #78350f;
}

.notification-info {
    border-left-color: #3b82f6;
    color: #1e3a8a;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∞–π–¥–±–∞—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ */
.user-info-sidebar {
    position: fixed;
    top: 0;
    right: -400px;
    width: 350px;
    height: 100vh;
    background: white;
    box-shadow: -5px 0 15px rgba(0,0,0,0.1);
    z-index: 1040;
    transition: right 0.3s ease;
    overflow-y: auto;
}

.user-info-sidebar.active {
    right: 0;
}

.user-info-sidebar-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1039;
    display: none;
}

.user-info-content {
    height: 100%;
    display: flex;
    flex-direction: column;
}

.user-info-header {
    padding: 20px;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.user-info-body {
    padding: 20px;
    flex: 1;
    display: flex;
    flex-direction: column;
}

.info-grid .info-item {
    transition: background-color 0.2s ease;
}

.info-grid .info-item:hover {
    background-color: #f8f9fa;
    border-radius: 8px;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .chat-messages {
        max-height: calc(100vh - 200px);
        padding: 16px;
    }
    .message-bubble {
        max-width: 85%;
    }
    .notifications-container {
        right: 10px;
        left: 10px;
        max-width: none;
    }
    
    .user-info-sidebar {
        width: 100%;
        right: -100%;
    }
}

/* –≠—Ñ—Ñ–µ–∫—Ç—ã –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
.btn:hover {
    transform: translateY(-1px);
    transition: all 0.2s ease;
}

.message-bubble:hover {
    transform: translateY(-1px);
    transition: all 0.2s ease;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–µ–¥–∏–∞ */
#media-preview img,
#media-preview video {
    max-width: 150px;
    max-height: 150px;
    border-radius: 8px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π */
.recording-animation {
    position: relative;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.pulse {
    position: absolute;
    width: 100%;
    height: 100%;
    background-color: #dc3545;
    border-radius: 50%;
    animation: pulse 1.5s infinite;
    opacity: 0.6;
}

@keyframes pulse {
    0% {
        transform: scale(0.8);
        opacity: 0.6;
    }
    50% {
        transform: scale(1.2);
        opacity: 0.3;
    }
    100% {
        transform: scale(0.8);
        opacity: 0.6;
    }
}

.voice-toggle-btn.recording {
    background-color: #dc3545 !important;
    border-color: #dc3545 !important;
    color: white !important;
    animation: recordingPulse 1s infinite;
}

@keyframes recordingPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

#voice-recording-indicator {
    background: linear-gradient(135deg, #ffe6e6, #ffcccc);
    border-radius: 25px;
    padding: 12px 20px;
    border: 2px solid #dc3545;
}

/* –°–¥–≤–∏–≥ —á–∞—Ç–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–º —Å–∞–π–¥–±–∞—Ä–µ */
body.sidebar-open #chat-main-col {
    margin-right: 350px;
    transition: margin-right 0.3s ease;
}

@media (max-width: 768px) {
    body.sidebar-open #chat-main-col {
        margin-right: 0;
    }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –æ—à–∏–±–æ–∫ –º–µ–¥–∏–∞ */
.media-error {
    background: #f8f9fa;
    border-radius: 12px;
    border: 2px dashed #dee2e6;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
const conversationId = {{ conversation.id }};
const currentUserId = {{ request.user.id }};
const currentUsername = "{{ request.user.username }}";
const otherUserId = {{ other_user.id }};
const otherUsername = "{{ other_user.username }}";
let isSending = false;
let firebaseChat;
let mediaFile = null;
let mediaType = null;
let voiceBlob = null;
let mediaRecorder = null;
let audioChunks = [];
let recordingTimer = null;
let recordingStartTime = null;
let isRecording = false;
let currentAudio = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞...');
    
    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É —Ñ–æ—Ä–º—ã
    const chatForm = document.querySelector('#chat-form');
    if (chatForm) {
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            handleMessageSubmit(e);
        });
    }
    
    initializeFirebaseChat();
    setupEventListeners();
    updateCharCounter();
    document.querySelector('#chat-message-input').focus();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    updateActivityStatus();
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase —á–∞—Ç–∞
function initializeFirebaseChat() {
    try {
        firebaseChat = new FirebaseChat(conversationId, {
            id: currentUserId,
            username: currentUsername
        });
        console.log('‚úÖ –ß–∞—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        updateConnectionStatus('connected', '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ');
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
        updateConnectionStatus('error', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
        showError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —á–∞—Ç—É');
    }
}

// –ö–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Firebase
class FirebaseChat {
    constructor(conversationId, currentUser) {
        this.conversationId = conversationId;
        this.currentUser = currentUser;
        this.database = firebase.database();
        this.messagesRef = this.database.ref(`chats/${conversationId}/messages`);
        this.typingRef = this.database.ref(`chats/${conversationId}/typing`);
        this.usersRef = this.database.ref(`chats/${conversationId}/users`);
        this.connectedRef = this.database.ref('.info/connected');
        
        this.init();
    }

    async init() {
        await this.setupConnectionMonitoring();
        await this.setupMessagesListener();
        await this.setupTypingListener();
        await this.setUserOnline();
        await this.loadMessageHistory();
    }

    async setupConnectionMonitoring() {
        this.connectedRef.on('value', (snap) => {
            if (snap.val() === true) {
                updateConnectionStatus('connected', '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ');
            } else {
                updateConnectionStatus('disconnected', '–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
            }
        });
    }

    async setupMessagesListener() {
        // –°–ª—É—à–∞–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        this.messagesRef.orderByChild('timestamp').on('child_added', (snapshot) => {
            const message = snapshot.val();
            this.addMessageToChat(message);
        });
    }

    async setupTypingListener() {
        // –°–ª—É—à–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø–µ—á–∞—Ç–∏
        this.typingRef.on('child_changed', (snapshot) => {
            const typingData = snapshot.val();
            if (typingData.isTyping && typingData.userId !== this.currentUser.id) {
                showTypingIndicator(typingData.username);
            } else {
                hideTypingIndicator();
            }
        });
    }

    async setUserOnline() {
        // –û—Ç–º–µ—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ –æ–Ω–ª–∞–π–Ω
        this.usersRef.child(this.currentUser.id).set({
            userId: this.currentUser.id,
            username: this.currentUser.username,
            lastSeen: Date.now(),
            isOnline: true
        });
        
        // –°–ª—É—à–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        this.usersRef.on('child_changed', (snapshot) => {
            const userData = snapshot.val();
            if (userData.userId === otherUserId) {
                updateUserStatus(userData);
            }
        });
        
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
        this.usersRef.child(otherUserId).once('value').then((snapshot) => {
            const userData = snapshot.val();
            if (userData) {
                updateUserStatus(userData);
            }
        });
    }

    async loadMessageHistory() {
        try {
            const snapshot = await this.messagesRef.orderByChild('timestamp').limitToLast(50).once('value');
            const messages = [];
            
            snapshot.forEach((childSnapshot) => {
                const message = childSnapshot.val();
                messages.push(message);
            });
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (—Å—Ç–∞—Ä—ã–µ –ø–µ—Ä–≤—ã–º–∏)
            messages.sort((a, b) => a.timestamp - b.timestamp);
            this.renderMessages(messages);
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
            showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π');
        }
    }

    async sendMessage(messageText, messageType = 'text', mediaFile = null) {
        if (isSending) {
            showWarning('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è...');
            return false;
        }
        
        isSending = true;
        const messageInput = document.querySelector('#chat-message-input');
        const submitBtn = document.querySelector('#chat-message-submit');
        
        // –ë–ª–æ–∫–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É
        messageInput.disabled = true;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        try {
            let mediaUrl = null;
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –º–µ–¥–∏–∞—Ñ–∞–π–ª, –∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            if (mediaFile) {
                mediaUrl = await this.uploadMediaToServer(mediaFile, messageType);
                if (!mediaUrl) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–¥–∏–∞—Ñ–∞–π–ª–∞');
                }
            }
            
            const messageId = Date.now().toString();
            const messageData = {
                id: messageId,
                content: messageText || (mediaUrl ? '' : ''),
                sender: this.currentUser.username,
                sender_id: this.currentUser.id,
                timestamp: Date.now(),
                created_at: getCurrentTime(),
                message_type: messageType
            };
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –º–µ–¥–∏–∞-—Ñ–∞–π–ª, –¥–æ–±–∞–≤–ª—è–µ–º URL
            if (mediaUrl) {
                messageData.content = mediaUrl;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            this.addMessageToChat({
                ...messageData,
                is_own: true,
                is_temp: true
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase
            await this.messagesRef.child(messageId).set(messageData);
            
            console.log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
            
            messageInput.value = '';
            updateCharCounter();
            this.setTyping(false);
            clearMedia();
            
            return true;
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
            showError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
            return false;
        } finally {
            isSending = false;
            messageInput.disabled = false;
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
        }
    }

    async uploadMediaToServer(file, messageType) {
        return new Promise((resolve, reject) => {
            const formData = new FormData();
            formData.append('media_file', file);
            formData.append('conversation_id', conversationId);
            formData.append('message_type', messageType);
            
            fetch('/chat/upload-media/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.file_url) {
                    resolve(data.file_url);
                } else {
                    reject(new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞'));
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                reject(error);
            });
        });
    }

    setTyping(isTyping) {
        this.typingRef.child(this.currentUser.id).set({
            isTyping: isTyping,
            userId: this.currentUser.id,
            username: this.currentUser.username,
            timestamp: Date.now()
        });
    }

    renderMessages(messages) {
        const messagesContainer = document.querySelector('#chat-messages');
        messagesContainer.innerHTML = '';
        
        if (messages.length === 0) {
            this.showEmptyChatMessage();
            return;
        }
        
        console.log('üé® –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π:', messages.length);
        
        messages.forEach(messageData => {
            this.addMessageToChat(messageData);
        });
    }

    addMessageToChat(messageData) {
        const messagesContainer = document.querySelector('#chat-messages');
        
        // –£–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—É—Å—Ç–æ–º —á–∞—Ç–µ
        const emptyMessage = messagesContainer.querySelector('#empty-chat-message');
        if (emptyMessage) {
            emptyMessage.remove();
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        const existingMessage = messagesContainer.querySelector(`[data-message-id="${messageData.id}"]`);
        if (existingMessage) {
            if (messageData.is_temp) {
                existingMessage.remove();
            } else {
                return;
            }
        }

        const messageWrapper = document.createElement('div');
        messageWrapper.className = `message-wrapper mb-4 ${messageData.sender_id == currentUserId ? 'own-message' : 'other-message'}`;
        messageWrapper.dataset.messageId = messageData.id;
        
        const isOwn = messageData.sender_id == currentUserId;
        const senderName = isOwn ? '–í—ã' : messageData.sender;

        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
        let messageContent = '';
        switch(messageData.message_type) {
            case 'text':
                messageContent = `<div class="message-content">${escapeHtml(messageData.content).replace(/\n/g, '<br>')}</div>`;
                break;
            case 'image':
                messageContent = `
                    <div class="message-content">
                        <div class="media-message">
                            <img src="${messageData.content}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" class="img-fluid rounded" style="max-width: 300px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <div class="media-error" style="display: none; padding: 20px; text-align: center; color: #6c757d;">
                                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</p>
                            </div>
                        </div>
                    </div>
                `;
                break;
            case 'video':
                messageContent = `
                    <div class="message-content">
                        <div class="media-message">
                            <video controls class="img-fluid rounded" style="max-width: 300px;">
                                <source src="${messageData.content}" type="video/mp4">
                                –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
                            </video>
                        </div>
                    </div>
                `;
                break;
            case 'audio':
                messageContent = `
                    <div class="message-content">
                        <div class="media-message">
                            <audio controls class="w-100">
                                <source src="${messageData.content}" type="audio/mpeg">
                                –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ.
                            </audio>
                        </div>
                    </div>
                `;
                break;
            case 'voice':
                messageContent = `
                    <div class="message-content">
                        <div class="voice-message d-flex align-items-center">
                            <button class="btn btn-sm btn-outline-primary play-voice-btn me-2" data-audio-url="${messageData.content}">
                                <i class="fas fa-play"></i>
                            </button>
                            <div class="voice-waveform flex-grow-1 me-2">
                                <div class="waveform-bar"></div>
                                <div class="waveform-bar"></div>
                                <div class="waveform-bar"></div>
                                <div class="waveform-bar"></div>
                                <div class="waveform-bar"></div>
                            </div>
                            <small class="text-muted voice-duration">0:00</small>
                        </div>
                    </div>
                `;
                break;
            default:
                messageContent = `<div class="message-content">${escapeHtml(messageData.content).replace(/\n/g, '<br>')}</div>`;
        }

        messageWrapper.innerHTML = `
            <div class="message-bubble ${isOwn ? 'own-bubble' : 'other-bubble'}">
                ${!isOwn ? `<div class="message-sender mb-1"><small class="text-primary fw-bold">${escapeHtml(senderName)}</small></div>` : ''}
                ${messageContent}
                <div class="message-time text-end mt-1">
                    <small class="${isOwn ? 'text-light' : 'text-muted'}">${messageData.created_at}</small>
                    ${isOwn ? '<i class="fas fa-check-double text-light ms-1" style="font-size: 10px;"></i>' : ''}
                </div>
            </div>
        `;

        // –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        if (!messageData.is_temp || messageData.is_own) {
            messageWrapper.style.animation = 'messageSlideIn 0.3s ease-out';
        }
        
        messagesContainer.appendChild(messageWrapper);
        scrollToBottom();
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        if (messageData.message_type === 'voice') {
            const playBtn = messageWrapper.querySelector('.play-voice-btn');
            if (playBtn) {
                playBtn.addEventListener('click', function() {
                    playVoiceMessage(this.dataset.audioUrl, this);
                });
            }
        }
    }

    showEmptyChatMessage() {
        const messagesContainer = document.querySelector('#chat-messages');
        messagesContainer.innerHTML = `
            <div class="text-center text-muted py-5" id="empty-chat-message">
                <div class="empty-state-icon mb-4">
                    <i class="fas fa-comments fa-4x text-light"></i>
                </div>
                <h4 class="fw-light">–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥</h4>
                <p class="text-muted">–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ {{ other_user.username }}</p>
            </div>
        `;
    }

    destroy() {
        if (this.messagesRef) this.messagesRef.off();
        if (this.typingRef) this.typingRef.off();
        if (this.usersRef) this.usersRef.off();
        if (this.connectedRef) this.connectedRef.off();
    }
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
function setupEventListeners() {
    const messageInput = document.querySelector('#chat-message-input');
    
    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤–≤–æ–¥–∞ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø–µ—á–∞—Ç–∏
    let typingTimer;
    messageInput.addEventListener('input', function() {
        if (firebaseChat && messageInput.value.trim().length > 0) {
            firebaseChat.setTyping(true);
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                if (firebaseChat) {
                    firebaseChat.setTyping(false);
                }
            }, 1000);
        }
        updateCharCounter();
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è Enter
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleMessageSubmit(e);
        }
    });
    
    // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞
    window.addEventListener('resize', scrollToBottom);
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ñ–∞–π–ª–æ–≤—ã—Ö –∏–Ω–ø—É—Ç–æ–≤
    document.getElementById('file-input').addEventListener('change', handleFileSelect);
    document.getElementById('image-input').addEventListener('change', handleFileSelect);
    document.getElementById('video-input').addEventListener('change', handleFileSelect);
    document.getElementById('audio-input').addEventListener('change', handleFileSelect);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
async function handleMessageSubmit(e) {
    e.preventDefault();
    
    const messageInput = document.querySelector('#chat-message-input');
    const message = messageInput.value.trim();
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å –º–µ–¥–∏–∞—Ñ–∞–π–ª, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–≥–æ –¥–∞–∂–µ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞
    if (!message && !mediaFile) {
        showWarning('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–∞–π–ª');
        messageInput.focus();
        return;
    }
    
    if (!firebaseChat) {
        showError('–ß–∞—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
        return;
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    await firebaseChat.sendMessage(message, mediaType || 'text', mediaFile);
}

// –†–∞–±–æ—Ç–∞ —Å –º–µ–¥–∏–∞—Ñ–∞–π–ª–∞–º–∏
function triggerFileInput(type) {
    mediaType = type;
    
    switch(type) {
        case 'image':
            document.getElementById('image-input').click();
            break;
        case 'video':
            document.getElementById('video-input').click();
            break;
        case 'audio':
            document.getElementById('audio-input').click();
            break;
        default:
            document.getElementById('file-input').click();
    }
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    mediaFile = file;
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
    if (file.type.startsWith('image/')) {
        mediaType = 'image';
    } else if (file.type.startsWith('video/')) {
        mediaType = 'video';
    } else if (file.type.startsWith('audio/')) {
        mediaType = 'audio';
    } else {
        showError('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞');
        clearMedia();
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (–º–∞–∫—Å–∏–º—É–º 10MB)
    if (file.size > 10 * 1024 * 1024) {
        showError('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 10MB');
        clearMedia();
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
    showMediaPreview(file, mediaType);
    
    // –û—á–∏—â–∞–µ–º –∏–Ω–ø—É—Ç –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤—ã–±–æ—Ä–∞ —Ç–æ–≥–æ –∂–µ —Ñ–∞–π–ª–∞ —Å–Ω–æ–≤–∞
    event.target.value = '';
}

function showMediaPreview(file, type) {
    const preview = document.getElementById('media-preview');
    const previewContent = document.getElementById('preview-content');
    
    preview.style.display = 'block';
    
    if (type === 'image') {
        const reader = new FileReader();
        reader.onload = function(e) {
            previewContent.innerHTML = `<img src="${e.target.result}" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä" style="max-width: 150px; max-height: 150px; border-radius: 8px;">`;
        };
        reader.readAsDataURL(file);
    } else if (type === 'video') {
        const reader = new FileReader();
        reader.onload = function(e) {
            previewContent.innerHTML = `
                <video controls style="max-width: 150px; max-height: 150px;">
                    <source src="${e.target.result}" type="${file.type}">
                    –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
                </video>
                <div class="mt-1"><small>${file.name}</small></div>
            `;
        };
        reader.readAsDataURL(file);
    } else if (type === 'audio') {
        previewContent.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-music text-warning me-2"></i>
                <div>
                    <div><strong>–ê—É–¥–∏–æ—Ñ–∞–π–ª</strong></div>
                    <small>${file.name}</small>
                </div>
            </div>
        `;
    }
}

function clearMedia() {
    mediaFile = null;
    mediaType = null;
    document.getElementById('media-preview').style.display = 'none';
    document.getElementById('preview-content').innerHTML = '';
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Ñ–∞–π–ª–æ–≤—ã–µ –∏–Ω–ø—É—Ç—ã
    document.getElementById('file-input').value = '';
    document.getElementById('image-input').value = '';
    document.getElementById('video-input').value = '';
    document.getElementById('audio-input').value = '';
}

// –†–∞–±–æ—Ç–∞ —Å –≥–æ–ª–æ—Å–æ–≤—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
async function startVoiceRecording() {
    if (isRecording) return;
    
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = () => {
            voiceBlob = new Blob(audioChunks, { type: 'audio/wav' });
            sendVoiceMessage();
        };
        
        mediaRecorder.start();
        isRecording = true;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏
        showRecordingIndicator();
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
        recordingStartTime = Date.now();
        recordingTimer = setInterval(updateRecordingTimer, 1000);
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', error);
        showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
    }
}

function stopVoiceRecording() {
    if (isRecording && mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
        isRecording = false;
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –∏ —Å–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
        clearInterval(recordingTimer);
        hideRecordingIndicator();
    }
}

function cancelVoiceRecording() {
    if (isRecording && mediaRecorder) {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
        isRecording = false;
        voiceBlob = null;
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –∏ —Å–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
        clearInterval(recordingTimer);
        hideRecordingIndicator();
        
        showInfo('–ó–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞');
    }
}

function showRecordingIndicator() {
    const voiceBtn = document.getElementById('voice-toggle-btn');
    const recordingIndicator = document.getElementById('voice-recording-indicator');
    
    voiceBtn.classList.add('recording');
    recordingIndicator.style.display = 'block';
}

function hideRecordingIndicator() {
    const voiceBtn = document.getElementById('voice-toggle-btn');
    const recordingIndicator = document.getElementById('voice-recording-indicator');
    
    voiceBtn.classList.remove('recording');
    recordingIndicator.style.display = 'none';
}

function updateRecordingTimer() {
    const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    document.getElementById('voice-recording-time').textContent = 
        `${minutes}:${seconds.toString().padStart(2, '0')}`;
}

async function sendVoiceMessage() {
    if (!voiceBlob) {
        showError('–ù–µ—Ç –∑–∞–ø–∏—Å–∞–Ω–Ω–æ–≥–æ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è');
        return;
    }
    
    try {
        // –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –∏–∑ blob
        const voiceFile = new File([voiceBlob], `voice_message_${Date.now()}.wav`, {
            type: 'audio/wav'
        });
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        await firebaseChat.sendMessage('–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', 'voice', voiceFile);
        
        showSuccess('–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
        showError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è');
    }
}

// –§—É–Ω–∫—Ü–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
function playVoiceMessage(audioUrl, button) {
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
    if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
        document.querySelectorAll('.play-voice-btn').forEach(btn => {
            btn.innerHTML = '<i class="fas fa-play"></i>';
            btn.classList.remove('playing');
        });
    }
    
    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç
    currentAudio = new Audio(audioUrl);
    const icon = button.querySelector('i');
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    currentAudio.onplay = function() {
        icon.className = 'fas fa-pause';
        button.classList.add('playing');
    };
    
    currentAudio.onpause = function() {
        icon.className = 'fas fa-play';
        button.classList.remove('playing');
    };
    
    currentAudio.onended = function() {
        icon.className = 'fas fa-play';
        button.classList.remove('playing');
        currentAudio = null;
    };
    
    currentAudio.onerror = function() {
        icon.className = 'fas fa-play';
        button.classList.remove('playing');
        showError('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è');
        currentAudio = null;
    };
    
    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∞—É–¥–∏–æ
    currentAudio.play().catch(error => {
        console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', error);
        showError('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
        currentAudio = null;
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏
    button.onclick = function() {
        if (currentAudio && !currentAudio.paused) {
            currentAudio.pause();
        } else {
            playVoiceMessage(audioUrl, button);
        }
    };
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
function toggleUserInfo() {
    const sidebar = document.getElementById('user-info-sidebar');
    const overlay = document.getElementById('user-info-overlay');
    const body = document.body;
    
    if (sidebar.classList.contains('active')) {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–∞–π–¥–±–∞—Ä
        sidebar.classList.remove('active');
        overlay.style.display = 'none';
        body.classList.remove('sidebar-open');
    } else {
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å–∞–π–¥–±–∞—Ä
        sidebar.classList.add('active');
        overlay.style.display = 'block';
        body.classList.add('sidebar-open');
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–∞–π–¥–±–∞—Ä –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –æ–≤–µ—Ä–ª–µ–π
        overlay.onclick = function() {
            toggleUserInfo();
        };
    }
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
function updateActivityStatus() {
    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É
    // –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —Å—Ç–∞—Ç—É—Å
    const isOnline = Math.random() > 0.5;
    const lastSeen = new Date(Date.now() - Math.floor(Math.random() * 24 * 60 * 60 * 1000));
    
    updateUserStatus({
        userId: otherUserId,
        isOnline: isOnline,
        lastSeen: lastSeen.getTime()
    });
}

function updateUserStatus(userData) {
    const onlineStatus = document.getElementById('online-status');
    const lastSeen = document.getElementById('last-seen');
    const activityText = document.getElementById('activity-text');
    const activityIcon = document.querySelector('#last-activity i');
    
    if (userData.isOnline) {
        onlineStatus.className = 'badge bg-success bg-opacity-10 text-success px-3 py-2 rounded-pill';
        onlineStatus.innerHTML = '<i class="fas fa-circle me-1" style="font-size: 8px;"></i>–í —Å–µ—Ç–∏';
        lastSeen.textContent = '–í —Å–µ—Ç–∏';
        lastSeen.className = 'text-success';
        activityText.textContent = '–í —Å–µ—Ç–∏';
        activityIcon.className = 'fas fa-circle text-success me-1';
    } else {
        onlineStatus.className = 'badge bg-secondary bg-opacity-10 text-secondary px-3 py-2 rounded-pill';
        onlineStatus.innerHTML = '<i class="fas fa-circle me-1" style="font-size: 8px;"></i>–ù–µ –≤ —Å–µ—Ç–∏';
        
        const timeAgo = getTimeAgo(userData.lastSeen);
        lastSeen.textContent = timeAgo;
        lastSeen.className = 'text-muted';
        activityText.textContent = `–ë—ã–ª(–∞) ${timeAgo} –Ω–∞–∑–∞–¥`;
        activityIcon.className = 'fas fa-circle text-secondary me-1';
    }
}

function getTimeAgo(timestamp) {
    const now = Date.now();
    const diff = now - timestamp;
    
    const minutes = Math.floor(diff / (1000 * 60));
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    
    if (minutes < 1) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
    if (minutes < 60) return `${minutes} –º–∏–Ω`;
    if (hours < 24) return `${hours} —á`;
    return `${days} –¥–Ω`;
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function showTypingIndicator(username) {
    const typingIndicator = document.getElementById('typing-indicator');
    const typingUser = document.getElementById('typing-user');
    if (typingIndicator && typingUser) {
        typingUser.textContent = username;
        typingIndicator.style.display = 'block';
    }
}

function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
        typingIndicator.style.display = 'none';
    }
}

function updateCharCounter() {
    const input = document.querySelector('#chat-message-input');
    const counter = document.querySelector('#char-counter');
    const length = input.value.length;
    counter.textContent = `${length}/1000`;
    counter.className = length > 950 ? 'text-danger' : length > 800 ? 'text-warning' : length > 0 ? 'text-success' : 'text-muted';
}

function updateConnectionStatus(status, message) {
    const statusElement = document.getElementById('connection-status');
    if (statusElement) {
        statusElement.textContent = message;
        statusElement.className = status === 'connected' ? 'text-success' : 
                                status === 'disconnected' ? 'text-warning' : 'text-danger';
    }
}

function scrollToBottom() {
    const messagesContainer = document.querySelector('#chat-messages');
    if (messagesContainer) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
}

function getCurrentTime() {
    return new Date().toLocaleTimeString('ru-RU', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getCSRFToken() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    return csrfToken ? csrfToken.value : '';
}

// –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–∞—Ç–æ–º
function refreshChat() {
    console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞');
    if (firebaseChat) {
        firebaseChat.loadMessageHistory();
        showInfo('–ß–∞—Ç –æ–±–Ω–æ–≤–ª–µ–Ω');
    } else {
        showError('–ß–∞—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    }
}

function blockUser() {
    if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å ${otherUsername}?`)) {
        showInfo('–§—É–Ω–∫—Ü–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
    }
}

function startRouteChat() {
    showInfo('–§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—â–µ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
}

// –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showError(message) { showNotification(message, 'error'); }
function showSuccess(message) { showNotification(message, 'success'); }
function showWarning(message) { showNotification(message, 'warning'); }
function showInfo(message) { showNotification(message, 'info'); }

function showNotification(message, type = 'info') {
    const notifications = document.getElementById('notifications');
    const notificationId = 'notification-' + Date.now();
    
    const typeConfig = {
        'success': { class: 'notification-success', icon: 'fa-check-circle', duration: 3000 },
        'error': { class: 'notification-error', icon: 'fa-exclamation-circle', duration: 5000 },
        'warning': { class: 'notification-warning', icon: 'fa-exclamation-triangle', duration: 4000 },
        'info': { class: 'notification-info', icon: 'fa-info-circle', duration: 3000 }
    };
    
    const config = typeConfig[type] || typeConfig.info;
    
    const notification = document.createElement('div');
    notification.id = notificationId;
    notification.className = `notification ${config.class}`;
    notification.innerHTML = `
        <div class="notification-content">
            <div class="notification-icon"><i class="fas ${config.icon}"></i></div>
            <div class="notification-message">${escapeHtml(message)}</div>
            <button type="button" class="notification-close" onclick="closeNotification('${notificationId}')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="notification-progress"></div>
    `;
    
    notifications.appendChild(notification);
    setTimeout(() => notification.classList.add('show'), 10);
    
    setTimeout(() => closeNotification(notificationId), config.duration);
}

function closeNotification(notificationId) {
    const notification = document.getElementById(notificationId);
    if (notification) {
        notification.classList.remove('show');
        notification.classList.add('hide');
        setTimeout(() => notification.remove(), 400);
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', function() {
    if (firebaseChat) {
        firebaseChat.destroy();
    }
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞—É–¥–∏–æ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    if (currentAudio) {
        currentAudio.pause();
    }
});

console.log('üéâ –ß–∞—Ç —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ñ–∞–π–ª–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!');
</script>
{% endblock %}