{% extends 'chat/base_chat.html' %}
{% load static %}

{% block chat_title %}–ß–∞—Ç –º–∞—Ä—à—Ä—É—Ç–∞ {{ route.title }}{% endblock %}

{% block chat_header_content %}
<div class="position-relative me-3">
    <div class="avatar bg-gradient-success text-white rounded-circle d-flex align-items-center justify-content-center" 
         style="width: 50px; height: 50px; font-size: 18px;">
        <i class="fas fa-route"></i>
    </div>
</div>
<div>
    <h5 class="mb-1 fw-bold">{{ route.title }}</h5>
    <small class="text-muted" id="route-info">
        <i class="fas fa-user me-1"></i>
        –ê–≤—Ç–æ—Ä: 
        <a href="{% url 'user_profile' route.author.username %}" class="text-decoration-none">
            {{ route.author.username }}
        </a>
        ‚Ä¢ {{ route.get_privacy_display }}
    </small>
</div>
{% endblock %}

{% block chat_menu_items %}
<li><a class="dropdown-item" href="#" onclick="toggleRouteInfo()">
    <i class="fas fa-info-circle me-2"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∞—Ä—à—Ä—É—Ç–µ
</a></li>
<li><a class="dropdown-item" href="{% url 'route_detail' route.id %}">
    <i class="fas fa-map me-2"></i> –î–µ—Ç–∞–ª–∏ –º–∞—Ä—à—Ä—É—Ç–∞
</a></li>
<li><a class="dropdown-item" href="{% url 'user_profile' route.author.username %}">
    <i class="fas fa-user me-2"></i> –ü—Ä–æ—Ñ–∏–ª—å –∞–≤—Ç–æ—Ä–∞
</a></li>
{% endblock %}

{% block chat_messages %}
{% for message in chat_messages %}
<div class="message-wrapper mb-4 {% if message.user == request.user %}own-message{% endif %}" 
     data-message-id="{{ message.id }}">
    <div class="message-bubble {% if message.user == request.user %}own-bubble{% else %}other-bubble{% endif %}">
        {% if message.user != request.user %}
        <div class="message-sender mb-1">
            <small class="text-primary fw-bold">
                <a href="{% url 'user_profile' message.user.username %}" class="text-decoration-none">
                    {{ message.user.username }}
                </a>
            </small>
        </div>
        {% endif %}
        <div class="message-content">
            {{ message.message|linebreaks }}
        </div>
        <div class="message-time text-end mt-1">
            <small class="{% if message.user == request.user %}text-light{% else %}text-muted{% endif %}">
                {{ message.timestamp|date:"H:i" }}
            </small>
            {% if message.user == request.user %}
            <i class="fas fa-check-double {% if message.user == request.user %}text-light{% else %}text-primary{% endif %} ms-1" style="font-size: 10px;"></i>
            {% endif %}
        </div>
    </div>
</div>
{% empty %}
<div class="text-center text-muted py-5" id="empty-chat-message">
    <div class="empty-state-icon mb-4">
        <i class="fas fa-comments fa-4x text-light"></i>
    </div>
    <h4 class="fw-light">–ù–∞—á–Ω–∏—Ç–µ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞</h4>
    <p class="text-muted">–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç –º–∞—Ä—à—Ä—É—Ç–∞</p>
</div>
{% endfor %}
{% endblock %}

{% block chat_input_form %}
<form id="chat-form" class="d-flex align-items-end gap-2">
    {% csrf_token %}
    <input type="hidden" name="route_id" value="{{ route.id }}">
    
    <div class="flex-grow-1 position-relative">
        <div class="input-group">
            <input type="text" 
                   class="form-control border-end-0" 
                   id="chat-message-input" 
                   name="message"
                   placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç –º–∞—Ä—à—Ä—É—Ç–∞..." 
                   maxlength="1000"
                   autocomplete="off"
                   style="border-radius: 25px; padding: 12px 20px; border: 1px solid #e0e0e0;">
            
            <button type="button" class="btn btn-outline-secondary border-start-0" 
                    style="border-radius: 0 25px 25px 0; border: 1px solid #e0e0e0;">
                <i class="fas fa-smile"></i>
            </button>
        </div>
    </div>
    
    <button type="submit" class="btn btn-primary rounded-circle d-flex align-items-center justify-content-center" 
            id="chat-message-submit"
            style="width: 50px; height: 50px;">
        <i class="fas fa-paper-plane"></i>
    </button>
</form>

<div class="mt-2 d-flex justify-content-between align-items-center px-2">
    <small class="text-muted" id="char-counter">0/1000</small>
    <small class="text-muted">
        <i class="fas fa-users me-1 text-success"></i>
        –ß–∞—Ç –º–∞—Ä—à—Ä—É—Ç–∞ ‚Ä¢ {{ route.get_privacy_display }}
    </small>
</div>
{% endblock %}

{% block chat_sidebar %}
<!-- –°–∞–π–¥–±–∞—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–∞—Ä—à—Ä—É—Ç–µ -->
<div class="info-sidebar-overlay" id="route-info-overlay" style="display: none;"></div>
<div class="info-sidebar" id="route-info-sidebar">
    <div class="info-sidebar-content">
        <div class="info-sidebar-header">
            <h5 class="fw-bold mb-0">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∞—Ä—à—Ä—É—Ç–µ</h5>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleRouteInfo()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="info-sidebar-body">
            <div class="text-center mb-4">
                <div class="position-relative mx-auto mb-3">
                    <div class="avatar bg-gradient-success text-white rounded-circle d-flex align-items-center justify-content-center mx-auto" 
                         style="width: 100px; height: 100px; font-size: 32px;">
                        <i class="fas fa-route"></i>
                    </div>
                </div>
                <h5 class="fw-bold">{{ route.title }}</h5>
                <p class="text-muted mb-3">{{ route.description|default:"–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"|truncatewords:20 }}</p>
                <div class="route-status">
                    <span class="badge {% if route.is_active %}bg-success{% else %}bg-secondary{% endif %} bg-opacity-10 {% if route.is_active %}text-success{% else %}text-secondary{% endif %} px-3 py-2 rounded-pill">
                        <i class="fas fa-circle me-1" style="font-size: 8px;"></i>
                        {% if route.is_active %}–ê–∫—Ç–∏–≤–Ω—ã–π{% else %}–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π{% endif %}
                    </span>
                </div>
            </div>

            <div class="mb-4">
                <h6 class="fw-semibold text-uppercase small mb-3">–î–µ—Ç–∞–ª–∏ –º–∞—Ä—à—Ä—É—Ç–∞</h6>
                <div class="info-grid">
                    <div class="info-item d-flex justify-content-between align-items-center py-2 border-bottom">
                        <span class="text-muted">–ê–≤—Ç–æ—Ä</span>
                        <strong class="text-primary">
                            <a href="{% url 'user_profile' route.author.username %}" class="text-decoration-none">
                                {{ route.author.username }}
                            </a>
                        </strong>
                    </div>
                    <div class="info-item d-flex justify-content-between align-items-center py-2 border-bottom">
                        <span class="text-muted">–î–∏—Å—Ç–∞–Ω—Ü–∏—è</span>
                        <strong class="text-success">{{ route.total_distance|default:"0" }} –∫–º</strong>
                    </div>
                    <div class="info-item d-flex justify-content-between align-items-center py-2 border-bottom">
                        <span class="text-muted">–°–ª–æ–∂–Ω–æ—Å—Ç—å</span>
                        <strong class="text-warning">{{ route.get_difficulty_display|default:"–ù–µ —É–∫–∞–∑–∞–Ω–∞" }}</strong>
                    </div>
                    <div class="info-item d-flex justify-content-between align-items-center py-2 border-bottom">
                        <span class="text-muted">–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</span>
                        <strong class="text-info">{{ route.get_privacy_display }}</strong>
                    </div>
                    <div class="info-item d-flex justify-content-between align-items-center py-2">
                        <span class="text-muted">–°–æ–∑–¥–∞–Ω</span>
                        <strong>{{ route.created_at|date:"d.m.Y" }}</strong>
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <h6 class="fw-semibold text-uppercase small mb-3">–î–µ–π—Å—Ç–≤–∏—è</h6>
                <div class="d-grid gap-2">
                    <a href="{% url 'route_detail' route.id %}" class="btn btn-outline-primary btn-sm py-2">
                        <i class="fas fa-map me-2"></i> –î–µ—Ç–∞–ª–∏ –º–∞—Ä—à—Ä—É—Ç–∞
                    </a>
                    <a href="{% url 'user_profile' route.author.username %}" class="btn btn-outline-success btn-sm py-2">
                        <i class="fas fa-user me-2"></i> –ü—Ä–æ—Ñ–∏–ª—å –∞–≤—Ç–æ—Ä–∞
                    </a>
                    {% if request.user == route.author %}
                    <a href="{% url 'edit_route' route.id %}" class="btn btn-outline-warning btn-sm py-2">
                        <i class="fas fa-edit me-2"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                    </a>
                    {% endif %}
                </div>
            </div>

            <div class="mt-auto">
                <div class="d-grid gap-2">
                    <button class="btn btn-warning btn-sm py-2" onclick="refreshChat()">
                        <i class="fas fa-sync-alt me-2"></i> –û–±–Ω–æ–≤–∏—Ç—å —á–∞—Ç
                    </button>
                    <a href="{% url 'chat:chat_dashboard' %}" class="btn btn-outline-secondary btn-sm py-2">
                        <i class="fas fa-comments me-2"></i> –í—Å–µ —á–∞—Ç—ã
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–∞—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–∞
const ROUTE_CHAT_CONFIG = {
    routeId: {{ route.id }},
    currentUser: {
        id: {{ request.user.id }},
        username: "{{ request.user.username }}"
    },
    routeAuthor: {
        id: {{ route.author.id }},
        username: "{{ route.author.username }}"
    }
};

// –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
const originalInitializeChat = window.initializeChat;

window.initializeChat = function() {
    console.log('üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–∞...');
    
    // –í—ã–∑—ã–≤–∞–µ–º –±–∞–∑–æ–≤—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
    if (typeof originalInitializeChat === 'function') {
        originalInitializeChat();
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–∞
    initializeRouteChat();
};

function initializeRouteChat() {
    try {
        console.log('üöÄ –ó–∞–ø—É—Å–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —á–∞—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–∞...');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Firebase
        if (typeof firebase === 'undefined') {
            console.error('‚ùå Firebase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
            showError('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —á–∞—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.');
            return;
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase —á–∞—Ç–∞
        firebaseChat = new RouteFirebaseChat(
            ROUTE_CHAT_CONFIG.routeId,
            ROUTE_CHAT_CONFIG.currentUser
        );
        
        console.log('‚úÖ –ß–∞—Ç –º–∞—Ä—à—Ä—É—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
        setupRouteChatEventListeners();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
        setTimeout(() => {
            if (firebaseChat && typeof firebaseChat.loadMessageHistory === 'function') {
                firebaseChat.loadMessageHistory();
            }
        }, 1000);
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —á–∞—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–∞:', error);
        showError('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —á–∞—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–∞: ' + error.message);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Django
        showExistingMessages();
    }
}

// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è, –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∏–∑ Django
function showExistingMessages() {
    const messagesContainer = document.querySelector('#chat-messages');
    if (!messagesContainer) return;
    
    const existingMessages = messagesContainer.querySelectorAll('.message-wrapper');
    console.log(`üì® –ù–∞–π–¥–µ–Ω–æ ${existingMessages.length} —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π`);
    
    if (existingMessages.length === 0) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        ChatUI.showEmptyChatMessage('#chat-messages', {
            title: '–ù–∞—á–Ω–∏—Ç–µ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞',
            subtitle: '–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç –º–∞—Ä—à—Ä—É—Ç–∞'
        });
    }
}

// –ö–ª–∞—Å—Å —á–∞—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–∞
class RouteFirebaseChat {
    constructor(routeId, currentUser) {
        this.routeId = routeId;
        this.currentUser = currentUser;
        this.isSending = false;
        this.messagesRef = null;
        this.typingRef = null;
        
        this.init();
    }
    
    init() {
        try {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Firebase —Å—Å—ã–ª–∫–∏
            const database = firebase.database();
            this.messagesRef = database.ref(`route_chats/${this.routeId}/messages`);
            this.typingRef = database.ref(`route_chats/${this.routeId}/typing`);
            
            console.log('üî• Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∞:', this.routeId);
            
            // –°–ª—É—à–∞–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            this.setupMessageListener();
            
            // –°–ª—É—à–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø–µ—á–∞—Ç–∏
            this.setupTypingListener();
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:', error);
            throw error;
        }
    }
    
    setupMessageListener() {
        if (!this.messagesRef) return;
        
        this.messagesRef.orderByChild('timestamp').on('child_added', (snapshot) => {
            const messageData = snapshot.val();
            console.log('üì® –ü–æ–ª—É—á–µ–Ω–æ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:', messageData);
            this.displayMessage(messageData);
        });
    }
    
    setupTypingListener() {
        if (!this.typingRef) return;
        
        this.typingRef.on('value', (snapshot) => {
            const typingData = snapshot.val();
            this.handleTypingIndicator(typingData);
        });
    }
    
    displayMessage(messageData) {
        if (!messageData) return;
        
        const isOwn = messageData.user_id === this.currentUser.id;
        
        // –°–∫—Ä—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        const emptyState = document.querySelector('#empty-chat-message');
        if (emptyState) {
            emptyState.style.display = 'none';
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
        ChatUI.addMessageToChat(messageData, '#chat-messages', {
            isOwn: isOwn,
            showSender: !isOwn,
            animate: true
        });
        
        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
        scrollToBottom();
    }
    
    handleTypingIndicator(typingData) {
        const typingIndicator = document.querySelector('#typing-indicator');
        const typingUser = document.querySelector('#typing-user');
        
        if (!typingData || !typingIndicator) return;
        
        // –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –ø–µ—á–∞—Ç–∞—é—Ç (–∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–≥–æ)
        const typingUsers = Object.keys(typingData).filter(userId => {
            return userId != this.currentUser.id && typingData[userId] === true;
        });
        
        if (typingUsers.length > 0) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
            if (typingUser) {
                typingUser.textContent = typingUsers.map(userId => {
                    // –ó–¥–µ—Å—å –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å username –ø–æ ID, –ø–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º ID
                    return `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId}`;
                }).join(', ');
            }
            typingIndicator.style.display = 'block';
        } else {
            // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
            typingIndicator.style.display = 'none';
        }
    }
    
    async sendMessage(messageText) {
        if (this.isSending) {
            showWarning('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è...');
            return false;
        }
        
        this.isSending = true;
        const messageInput = document.querySelector('#chat-message-input');
        const submitBtn = document.querySelector('#chat-message-submit');
        
        // –ë–ª–æ–∫–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É
        if (messageInput) messageInput.disabled = true;
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        }
        
        try {
            const messageData = {
                id: this.generateMessageId(),
                message: messageText,
                user: this.currentUser.username,
                user_id: this.currentUser.id,
                timestamp: Date.now(),
                created_at: new Date().toLocaleTimeString('ru-RU', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                })
            };
            
            console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:', messageData);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Firebase
            await this.messagesRef.child(messageData.id).set(messageData);
            
            console.log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —á–∞—Ç –º–∞—Ä—à—Ä—É—Ç–∞');
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            if (messageInput) {
                messageInput.value = '';
                messageInput.focus();
            }
            
            this.updateCharCounter();
            this.setTyping(false);
            
            return true;
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
            showError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + error.message);
            return false;
            
        } finally {
            this.isSending = false;
            if (messageInput) messageInput.disabled = false;
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            }
        }
    }
    
    setTyping(isTyping) {
        if (!this.typingRef) return;
        
        try {
            this.typingRef.child(this.currentUser.id).set(isTyping);
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø–µ—á–∞—Ç–∏:', error);
        }
    }
    
    generateMessageId() {
        return `${this.currentUser.id}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    }
    
    updateCharCounter() {
        const input = document.querySelector('#chat-message-input');
        const counter = document.querySelector('#char-counter');
        
        if (input && counter) {
            const length = input.value.length;
            counter.textContent = `${length}/1000`;
            counter.className = length > 950 ? 'text-danger' : 
                              length > 800 ? 'text-warning' : 
                              length > 0 ? 'text-success' : 'text-muted';
        }
    }
    
    loadMessageHistory() {
        console.log('üìñ –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π...');
        // Firebase –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —á–µ—Ä–µ–∑ —Å–ª—É—à–∞—Ç–µ–ª—å child_added
    }
    
    destroy() {
        // –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
        if (this.messagesRef) {
            this.messagesRef.off();
        }
        if (this.typingRef) {
            this.typingRef.off();
            this.setTyping(false);
        }
    }
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è —á–∞—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–∞
function setupRouteChatEventListeners() {
    const messageInput = document.querySelector('#chat-message-input');
    
    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤–≤–æ–¥–∞ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø–µ—á–∞—Ç–∏
    if (messageInput) {
        let typingTimer;
        
        messageInput.addEventListener('input', function() {
            if (firebaseChat && messageInput.value.trim().length > 0) {
                firebaseChat.setTyping(true);
                clearTimeout(typingTimer);
                typingTimer = setTimeout(() => {
                    if (firebaseChat) {
                        firebaseChat.setTyping(false);
                    }
                }, 1000);
            }
        });
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞
        messageInput.addEventListener('blur', function() {
            if (firebaseChat) {
                firebaseChat.setTyping(false);
            }
        });
    }
}

// –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–∞–π–¥–±–∞—Ä–∞
function toggleInfoSidebar() {
    const sidebar = document.getElementById('route-info-sidebar');
    const overlay = document.getElementById('route-info-overlay');
    const body = document.body;
    
    if (sidebar && overlay) {
        if (sidebar.classList.contains('active')) {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–∞–π–¥–±–∞—Ä
            sidebar.classList.remove('active');
            overlay.style.display = 'none';
            body.classList.remove('sidebar-open');
        } else {
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å–∞–π–¥–±–∞—Ä
            sidebar.classList.add('active');
            overlay.style.display = 'block';
            body.classList.add('sidebar-open');
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–∞–π–¥–±–∞—Ä –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –æ–≤–µ—Ä–ª–µ–π
            overlay.onclick = function() {
                toggleInfoSidebar();
            };
        }
    }
}

// –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showSuccess(message) {
    console.log('‚úÖ ' + message);
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–∞—à—É —Å–∏—Å—Ç–µ–º—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    if (typeof NotificationSystem !== 'undefined') {
        NotificationSystem.success(message);
    }
}

function showError(message) {
    console.error('‚ùå ' + message);
    if (typeof NotificationSystem !== 'undefined') {
        NotificationSystem.error(message);
    }
}

function showWarning(message) {
    console.warn('‚ö†Ô∏è ' + message);
    if (typeof NotificationSystem !== 'undefined') {
        NotificationSystem.warning(message);
    }
}

function showInfo(message) {
    console.log('‚ÑπÔ∏è ' + message);
    if (typeof NotificationSystem !== 'undefined') {
        NotificationSystem.info(message);
    }
}

console.log('üéâ –ß–∞—Ç –º–∞—Ä—à—Ä—É—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω!');
</script>
{% endblock %}