{% extends 'base.html' %}
{% load static %}

{% block title %}–ß–∞—Ç —Å {{ other_user.username }} - Waylines{% endblock %}

{% block content %}
<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
<div id="notifications" class="notifications-container"></div>

<div class="container-fluid h-100 p-0">
    <div class="row g-0 h-100">
        <!-- –ß–∞—Ç -->
        <div class="col-md-9">
            <div class="chat-container h-100 d-flex flex-column bg-light">
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ -->
                <div class="chat-header bg-white border-bottom p-4 shadow-sm">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <a href="{% url 'chat:chat_dashboard' %}" class="btn btn-sm btn-outline-secondary me-3">
                                <i class="fas fa-arrow-left"></i>
                            </a>
                            <div class="position-relative me-3">
                                <div class="avatar bg-gradient-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                     style="width: 50px; height: 50px; font-size: 18px; font-weight: 600;">
                                    {{ other_user.username|first|upper }}
                                </div>
                                <div class="position-absolute bottom-0 end-0 bg-success rounded-circle border border-2 border-white"
                                     style="width: 12px; height: 12px;"></div>
                            </div>
                            <div>
                                <h5 class="mb-1 fw-bold">{{ other_user.username }}</h5>
                                <small class="text-muted" id="last-activity">
                                    <i class="fas fa-circle text-success me-1" style="font-size: 8px;"></i>
                                    –í —Å–µ—Ç–∏
                                </small>
                            </div>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-light rounded-circle" type="button" data-bs-toggle="dropdown"
                                    style="width: 40px; height: 40px;">
                                <i class="fas fa-ellipsis-v text-muted"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                                <li><a class="dropdown-item" href="{% url 'user_profile' other_user.username %}">
                                    <i class="fas fa-user me-2"></i> –ü—Ä–æ—Ñ–∏–ª—å
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="blockUser()">
                                    <i class="fas fa-ban me-2"></i> –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="refreshChat()">
                                    <i class="fas fa-sync-alt me-2"></i> –û–±–Ω–æ–≤–∏—Ç—å —á–∞—Ç
                                </a></li>
                                <li><a class="dropdown-item" href="{% url 'chat:chat_dashboard' %}">
                                    <i class="fas fa-comments me-2"></i> –í—Å–µ —á–∞—Ç—ã
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
                <div class="chat-messages flex-grow-1 p-4" id="chat-messages" 
                     style="overflow-y: auto; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                    <div class="text-center text-muted py-5" id="empty-chat-message">
                        <div class="empty-state-icon mb-4">
                            <i class="fas fa-comments fa-4x text-light"></i>
                        </div>
                        <h4 class="fw-light">–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥</h4>
                        <p class="text-muted">–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ {{ other_user.username }}</p>
                    </div>
                </div>

                <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
                <div id="chat-loading" class="text-center py-3 bg-white border-top" style="display: none;">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                    <small class="text-muted ms-2">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</small>
                </div>

                <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è -->
                <div id="typing-indicator" class="px-4 py-2 bg-white border-top" style="display: none;">
                    <div class="typing-dots">
                        <small class="text-muted">
                            <i class="fas fa-pencil-alt me-2"></i>
                            <span id="typing-user">{{ other_user.username }}</span> –ø–µ—á–∞—Ç–∞–µ—Ç
                            <span class="typing-animation"></span>
                        </small>
                    </div>
                </div>

                <!-- –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è -->
                <div class="chat-input bg-white border-top p-3 shadow-sm">
                    <form id="chat-form" class="d-flex align-items-end gap-2">
                        {% csrf_token %}
                        <div class="flex-grow-1 position-relative">
                            <div class="input-group">
                                <input type="text" 
                                       class="form-control border-end-0" 
                                       id="chat-message-input" 
                                       placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                                       maxlength="1000"
                                       autocomplete="off"
                                       style="border-radius: 25px; padding: 12px 20px; border: 1px solid #e0e0e0;">
                                <button type="button" class="btn btn-outline-secondary border-start-0" 
                                        style="border-radius: 0 25px 25px 0; border: 1px solid #e0e0e0;">
                                    <i class="fas fa-smile"></i>
                                </button>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary rounded-circle d-flex align-items-center justify-content-center" 
                                id="chat-message-submit"
                                style="width: 50px; height: 50px;">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                    <div class="mt-2 d-flex justify-content-between align-items-center px-2">
                        <small class="text-muted" id="char-counter">0/1000</small>
                        <small class="text-muted">
                            <i class="fas fa-bolt me-1 text-success"></i>
                            <span id="connection-status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
        <div class="col-md-3">
            <div class="user-info-sidebar h-100 bg-white border-start p-4">
                <div class="text-center mb-4">
                    <div class="position-relative mx-auto mb-3">
                        <div class="avatar bg-gradient-primary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto" 
                             style="width: 100px; height: 100px; font-size: 32px; font-weight: 600;">
                            {{ other_user.username|first|upper }}
                        </div>
                        <div class="position-absolute bottom-0 end-0 bg-success rounded-circle border border-3 border-white"
                             style="width: 20px; height: 20px;"></div>
                    </div>
                    <h5 class="fw-bold">{{ other_user.username }}</h5>
                    <p class="text-muted mb-3">–£—á–∞—Å—Ç–Ω–∏–∫ Waylines</p>
                    <div class="online-status">
                        <span class="badge bg-success bg-opacity-10 text-success px-3 py-2 rounded-pill" id="online-status">
                            <i class="fas fa-circle me-1" style="font-size: 8px;"></i>–í —Å–µ—Ç–∏
                        </span>
                    </div>
                </div>

                <div class="mb-4">
                    <h6 class="fw-semibold text-uppercase small mb-3">–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
                    <div class="info-grid">
                        <div class="info-item d-flex justify-content-between align-items-center py-2 border-bottom">
                            <span class="text-muted">–ú–∞—Ä—à—Ä—É—Ç—ã</span>
                            <strong class="text-primary">{{ other_user.routes.count }}</strong>
                        </div>
                        <div class="info-item d-flex justify-content-between align-items-center py-2 border-bottom">
                            <span class="text-muted">–î—Ä—É–∑—å—è</span>
                            <strong class="text-primary">{{ accepted_friends_count }}</strong>
                        </div>
                        <div class="info-item d-flex justify-content-between align-items-center py-2 border-bottom">
                            <span class="text-muted">–°—Ç–∞—Ç—É—Å</span>
                            <strong class="text-success" id="last-seen">–í —Å–µ—Ç–∏</strong>
                        </div>
                        <div class="info-item d-flex justify-content-between align-items-center py-2">
                            <span class="text-muted">–í —á–∞—Ç–µ —Å</span>
                            <strong>{{ conversation.created_at|date:"d.m.Y" }}</strong>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <h6 class="fw-semibold text-uppercase small mb-3">–î–µ–π—Å—Ç–≤–∏—è</h6>
                    <div class="d-grid gap-2">
                        <a href="{% url 'user_profile' other_user.username %}" class="btn btn-outline-primary btn-sm py-2">
                            <i class="fas fa-user me-2"></i> –ü—Ä–æ—Ñ–∏–ª—å
                        </a>
                        <a href="{% url 'all_routes' %}?author={{ other_user.username }}" class="btn btn-outline-success btn-sm py-2">
                            <i class="fas fa-route me-2"></i> –ú–∞—Ä—à—Ä—É—Ç—ã
                        </a>
                        <button class="btn btn-outline-info btn-sm py-2" onclick="startRouteChat()">
                            <i class="fas fa-map-marked-alt me-2"></i> –û–±—â–∏–π –º–∞—Ä—à—Ä—É—Ç
                        </button>
                    </div>
                </div>

                <div class="mt-auto">
                    <div class="d-grid gap-2">
                        <button class="btn btn-warning btn-sm py-2" onclick="refreshChat()">
                            <i class="fas fa-sync-alt me-2"></i> –û–±–Ω–æ–≤–∏—Ç—å —á–∞—Ç
                        </button>
                        <a href="{% url 'chat:chat_dashboard' %}" class="btn btn-outline-secondary btn-sm py-2">
                            <i class="fas fa-comments me-2"></i> –í—Å–µ —á–∞—Ç—ã
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ —á–∞—Ç–∞ */
.chat-container {
    background: #f8f9fa;
}

.chat-messages {
    max-height: calc(100vh - 280px);
    min-height: 400px;
    scroll-behavior: smooth;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π */
.message-wrapper {
    display: flex;
    flex-direction: column;
}

.own-message {
    align-items: flex-end;
}

.other-message {
    align-items: flex-start;
}

.message-bubble {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 18px;
    position: relative;
    animation: messageSlideIn 0.3s ease-out;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.own-bubble {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    border-bottom-right-radius: 6px;
}

.other-bubble {
    background: white;
    color: #333;
    border-bottom-left-radius: 6px;
    border: 1px solid #e9ecef;
}

.message-content {
    line-height: 1.4;
    word-wrap: break-word;
}

.message-time {
    font-size: 0.75rem;
    opacity: 0.8;
}

.message-sender {
    font-size: 0.8rem;
    font-weight: 600;
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ */
@keyframes messageSlideIn {
    from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—á–∞—Ç–∏ */
.typing-animation::after {
    content: '...';
    animation: typing 1.5s infinite;
}

@keyframes typing {
    0%, 20% { content: '.'; }
    40% { content: '..'; }
    60%, 100% { content: '...'; }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∞–≤–∞—Ç–∞—Ä–æ–≤ */
.avatar {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.bg-gradient-primary {
    background: linear-gradient(135deg, #007bff, #6610f2) !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è */
.empty-state-icon {
    opacity: 0.5;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
.chat-messages::-webkit-scrollbar {
    width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 10px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
.notifications-container {
    position: fixed;
    top: 80px;
    right: 20px;
    z-index: 1060;
    max-width: 350px;
    width: 100%;
}

.notification {
    background: white;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 10px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    border-left: 4px solid;
    transform: translateX(400px);
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    position: relative;
    overflow: hidden;
}

.notification.show {
    transform: translateX(0);
    opacity: 1;
}

.notification.hide {
    transform: translateX(400px);
    opacity: 0;
}

.notification-success {
    border-left-color: #10b981;
    color: #065f46;
}

.notification-error {
    border-left-color: #ef4444;
    color: #7f1d1d;
}

.notification-warning {
    border-left-color: #f59e0b;
    color: #78350f;
}

.notification-info {
    border-left-color: #3b82f6;
    color: #1e3a8a;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∞–π–¥–±–∞—Ä–∞ */
.user-info-sidebar {
    background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
}

.info-grid .info-item {
    transition: background-color 0.2s ease;
}

.info-grid .info-item:hover {
    background-color: #f8f9fa;
    border-radius: 8px;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .col-md-3 {
        display: none;
    }
    .col-md-9 {
        flex: 0 0 100%;
        max-width: 100%;
    }
    .chat-messages {
        max-height: calc(100vh - 200px);
        padding: 16px;
    }
    .message-bubble {
        max-width: 85%;
    }
    .notifications-container {
        right: 10px;
        left: 10px;
        max-width: none;
    }
}

/* –≠—Ñ—Ñ–µ–∫—Ç—ã –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
.btn:hover {
    transform: translateY(-1px);
    transition: all 0.2s ease;
}

.message-bubble:hover {
    transform: translateY(-1px);
    transition: all 0.2s ease;
}
</style>
{% endblock %}

{% block extra_js %}
<!-- Firebase SDK (compat mode –¥–ª—è legacy API) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  // üîë –¢–≤–æ–π –∫–æ–Ω—Ñ–∏–≥ Firebase (–∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è)
  const firebaseConfig = {
    apiKey: "AIzaSyDwAp4Qe5kIlOSewu7FLMj7IHDi4ofQI7E",
    authDomain: "project-e123e.firebaseapp.com",
    databaseURL: "https://project-e123e-default-rtdb.firebaseio.com",
    projectId: "project-e123e",
    storageBucket: "project-e123e.firebasestorage.app",
    messagingSenderId: "849440145534",
    appId: "1:849440145534:web:9873b2bc94bf0db959982f",
    measurementId: "G-WG5K1M2D1V"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
</script>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
const conversationId = {{ conversation.id }};
const currentUserId = {{ request.user.id }};
const currentUsername = "{{ request.user.username }}";
const otherUserId = {{ other_user.id }};
const otherUsername = "{{ other_user.username }}";
let isSending = false;
let firebaseChat;

// –£—Ç–∏–ª–∏—Ç—ã
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return String(text).replace(/[&<>"']/g, (s) => map[s]);
}

function formatTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
}

function playMessageSound() {
    try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = ctx.createOscillator();
        const gainNode = ctx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(ctx.destination);
        oscillator.frequency.value = 600;
        gainNode.gain.value = 0.05;
        oscillator.start();
        setTimeout(() => {
            oscillator.stop();
        }, 100);
    } catch (e) {
        // Silent fail
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.querySelector('#chat-form');
    if (chatForm) {
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            handleMessageSubmit(e);
        });
    }

    initializeFirebaseChat();
    setupEventListeners();
    updateCharCounter();
    document.querySelector('#chat-message-input').focus();
});

function initializeFirebaseChat() {
    try {
        if (typeof firebase === 'undefined') throw new Error('Firebase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
        firebaseChat = new FirebaseChat(conversationId, {
            id: currentUserId,
            username: currentUsername
        });
        updateConnectionStatus('connected', '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ');
        showSuccess('–ß–∞—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω');
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:', error);
        updateConnectionStatus('error', '–û—à–∏–±–∫–∞');
        showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —á–∞—Ç—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
    }
}

class FirebaseChat {
    constructor(conversationId, currentUser) {
        this.conversationId = conversationId;
        this.currentUser = currentUser;
        this.database = firebase.database();
        this.messagesRef = this.database.ref(`chats/${conversationId}/messages`);
        this.typingRef = this.database.ref(`chats/${conversationId}/typing`);
        this.usersRef = this.database.ref(`chats/${conversationId}/users`);
        this.connectedRef = this.database.ref('.info/connected');
        this.init();
    }

    async init() {
        await this.setupConnectionMonitoring();
        await this.setupMessagesListener();
        await this.setupTypingListener();
        await this.setUserOnline();
        await this.loadMessageHistory();
    }

    async setupConnectionMonitoring() {
        this.connectedRef.on('value', (snap) => {
            updateConnectionStatus(snap.val() ? 'connected' : 'disconnected', 
                snap.val() ? '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ' : '–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
        });
    }

    async setupMessagesListener() {
        this.messagesRef.orderByChild('timestamp').on('child_added', (snapshot) => {
            const message = snapshot.val();
            this.addMessageToChat(message);
        });
    }

    async setupTypingListener() {
        this.typingRef.on('child_changed', (snapshot) => {
            const typingData = snapshot.val();
            if (typingData?.isTyping && typingData.userId !== this.currentUser.id) {
                showTypingIndicator(typingData.username);
            } else {
                hideTypingIndicator();
            }
        });
    }

    async setUserOnline() {
        this.usersRef.child(this.currentUser.id).set({
            userId: this.currentUser.id,
            username: this.currentUser.username,
            lastSeen: Date.now(),
            isOnline: true
        });

        this.usersRef.on('child_changed', (snapshot) => {
            const userData = snapshot.val();
            if (userData?.userId === otherUserId) {
                updateUserStatus(userData.userId, userData.isOnline);
            }
        });
    }

    async loadMessageHistory() {
        try {
            const snapshot = await this.messagesRef.orderByChild('timestamp').limitToLast(50).once('value');
            const messages = [];
            snapshot.forEach((child) => messages.push(child.val()));
            messages.sort((a, b) => a.timestamp - b.timestamp);
            this.renderMessages(messages);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
            showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞.');
        }
    }

    async sendMessage(messageText) {
        if (isSending || !messageText.trim()) return false;
        isSending = true;

        const messageInput = document.querySelector('#chat-message-input');
        const submitBtn = document.querySelector('#chat-message-submit');
        messageInput.disabled = true;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        try {
            const messageId = Date.now().toString();
            const messageData = {
                id: messageId,
                content: messageText.trim(),
                sender: this.currentUser.username,
                sender_id: this.currentUser.id,
                timestamp: Date.now()
            };

            this.addMessageToChat({ ...messageData, is_own: true, is_temp: true });
            await this.messagesRef.child(messageId).set(messageData);
            this.setTyping(false);
            messageInput.value = '';
            updateCharCounter();
            showSuccess('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
            return true;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
            showError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ.');
            return false;
        } finally {
            isSending = false;
            messageInput.disabled = false;
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
        }
    }

    setTyping(isTyping) {
        if (isTyping) {
            this.typingRef.child(this.currentUser.id).set({
                isTyping: true,
                userId: this.currentUser.id,
                username: this.currentUser.username,
                timestamp: Date.now()
            });
        } else {
            this.typingRef.child(this.currentUser.id).remove();
        }
    }

    renderMessages(messages) {
        const container = document.querySelector('#chat-messages');
        container.innerHTML = '';
        if (messages.length === 0) {
            this.showEmptyChat();
            return;
        }
        messages.forEach(msg => this.addMessageToChat(msg));
        scrollToBottom();
    }

    addMessageToChat(messageData) {
        const container = document.querySelector('#chat-messages');
        const emptyMsg = container.querySelector('#empty-chat-message');
        if (emptyMsg) emptyMsg.remove();

        const existing = container.querySelector(`[data-message-id="${messageData.id}"]`);
        if (existing && !messageData.is_temp) {
            existing.remove();
        } else if (existing) {
            return;
        }

        const isOwn = messageData.is_own || messageData.sender_id == currentUserId;
        const content = escapeHtml(messageData.content).replace(/\n/g, '<br>');
        const timeStr = formatTime(messageData.timestamp);

        const wrapper = document.createElement('div');
        wrapper.className = `message-wrapper mb-4 ${isOwn ? 'own-message' : 'other-message'}`;
        wrapper.dataset.messageId = messageData.id;
        wrapper.innerHTML = `
            <div class="message-bubble ${isOwn ? 'own-bubble' : 'other-bubble'}">
                ${!isOwn ? `<div class="message-sender mb-1"><small class="text-primary fw-bold">${escapeHtml(messageData.sender)}</small></div>` : ''}
                <div class="message-content">${content}</div>
                <div class="message-time text-end mt-1">
                    <small class="${isOwn ? 'text-light' : 'text-muted'}">${timeStr}</small>
                    ${isOwn ? '<i class="fas fa-check-double text-light ms-1" style="font-size: 10px;"></i>' : ''}
                </div>
            </div>
        `;
        container.appendChild(wrapper);
        scrollToBottom();

        if (!isOwn && !messageData.is_temp) {
            playMessageSound();
        }
    }

    showEmptyChat() {
        const container = document.querySelector('#chat-messages');
        container.innerHTML = `
            <div class="text-center text-muted py-5" id="empty-chat-message">
                <div class="empty-state-icon mb-4">
                    <i class="fas fa-comments fa-4x text-light"></i>
                </div>
                <h4 class="fw-light">–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥</h4>
                <p class="text-muted">–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ${escapeHtml(otherUsername)}</p>
            </div>
        `;
    }

    destroy() {
        ['messagesRef', 'typingRef', 'usersRef', 'connectedRef'].forEach(ref => {
            if (this[ref]) this[ref].off();
        });
    }
}

// Event Listeners
function setupEventListeners() {
    const input = document.querySelector('#chat-message-input');
    let typingTimer;

    input.addEventListener('input', () => {
        const text = input.value.trim();
        if (firebaseChat) {
            firebaseChat.setTyping(text.length > 0);
            clearTimeout(typingTimer);
            if (text.length > 0) {
                typingTimer = setTimeout(() => firebaseChat.setTyping(false), 1000);
            }
        }
        updateCharCounter();
    });

    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleMessageSubmit(e);
        }
    });

    window.addEventListener('resize', scrollToBottom);
}

async function handleMessageSubmit(e) {
    const input = document.querySelector('#chat-message-input');
    const message = input.value.trim();
    if (!message) return;

    if (!firebaseChat) {
        showError('–ß–∞—Ç –Ω–µ –≥–æ—Ç–æ–≤. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
        return;
    }

    await firebaseChat.sendMessage(message);
}

// –£—Ç–∏–ª–∏—Ç—ã UI
function showTypingIndicator(username) {
    const el = document.getElementById('typing-indicator');
    const userEl = document.getElementById('typing-user');
    if (el && userEl) {
        userEl.textContent = username;
        el.style.display = 'block';
    }
}

function hideTypingIndicator() {
    const el = document.getElementById('typing-indicator');
    if (el) el.style.display = 'none';
}

function updateCharCounter() {
    const input = document.querySelector('#chat-message-input');
    const counter = document.querySelector('#char-counter');
    const len = input.value.length;
    counter.textContent = `${len}/1000`;
    counter.className = len > 950 ? 'text-danger' : len > 800 ? 'text-warning' : len > 0 ? 'text-success' : 'text-muted';
}

function updateConnectionStatus(status, message) {
    const el = document.getElementById('connection-status');
    if (el) {
        el.textContent = message;
        el.className = 
            status === 'connected' ? 'text-success' :
            status === 'disconnected' ? 'text-warning' : 'text-danger';
    }
}

function scrollToBottom() {
    const container = document.querySelector('#chat-messages');
    if (container) {
        container.scrollTop = container.scrollHeight;
    }
}

function updateUserStatus(userId, isOnline) {
    if (userId === otherUserId) {
        const onlineBadge = document.getElementById('online-status');
        const lastSeen = document.getElementById('last-seen');
        if (isOnline) {
            onlineBadge.className = 'badge bg-success bg-opacity-10 text-success px-3 py-2 rounded-pill';
            onlineBadge.innerHTML = '<i class="fas fa-circle me-1" style="font-size: 8px;"></i>–í —Å–µ—Ç–∏';
            lastSeen.textContent = '–í —Å–µ—Ç–∏';
            lastSeen.className = 'text-success';
        } else {
            onlineBadge.className = 'badge bg-secondary bg-opacity-10 text-secondary px-3 py-2 rounded-pill';
            onlineBadge.innerHTML = '<i class="fas fa-circle me-1" style="font-size: 8px;"></i>–ù–µ –≤ —Å–µ—Ç–∏';
            lastSeen.textContent = '–ë—ã–ª –Ω–µ–¥–∞–≤–Ω–æ';
            lastSeen.className = 'text-muted';
        }
    }
}

// –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showNotification(message, type = 'info') {
    const container = document.getElementById('notifications');
    const id = 'notification-' + Date.now();

    const config = {
        'success': { cls: 'notification-success', icon: 'fa-check-circle', dur: 3000 },
        'error': { cls: 'notification-error', icon: 'fa-exclamation-circle', dur: 5000 },
        'warning': { cls: 'notification-warning', icon: 'fa-exclamation-triangle', dur: 4000 },
        'info': { cls: 'notification-info', icon: 'fa-info-circle', dur: 3000 }
    }[type] || { cls: 'notification-info', icon: 'fa-info-circle', dur: 3000 };

    const el = document.createElement('div');
    el.id = id;
    el.className = `notification ${config.cls}`;
    el.innerHTML = `
        <div class="notification-content d-flex align-items-start">
            <i class="fas ${config.icon} me-2 mt-1"></i>
            <div class="notification-message flex-grow-1">${escapeHtml(message)}</div>
            <button type="button" class="btn-close btn-sm" onclick="closeNotification('${id}')"></button>
        </div>
        <div class="notification-progress mt-2" style="height: 3px; background: currentColor; opacity: 0.2;"></div>
    `;
    container.appendChild(el);
    setTimeout(() => el.classList.add('show'), 10);
    setTimeout(() => closeNotification(id), config.dur);
}

function closeNotification(id) {
    const el = document.getElementById(id);
    if (el) {
        el.classList.remove('show');
        el.classList.add('hide');
        setTimeout(() => el.remove(), 400);
    }
}

function showError(msg) { showNotification(msg, 'error'); }
function showSuccess(msg) { showNotification(msg, 'success'); }
function showWarning(msg) { showNotification(msg, 'warning'); }
function showInfo(msg) { showNotification(msg, 'info'); }

// –§—É–Ω–∫—Ü–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π
function refreshChat() {
    if (firebaseChat) {
        firebaseChat.loadMessageHistory();
        showInfo('–ß–∞—Ç –æ–±–Ω–æ–≤–ª—ë–Ω');
    } else {
        showError('–ß–∞—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    }
}

function blockUser() {
    if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å ${otherUsername}?`)) {
        showInfo('–§—É–Ω–∫—Ü–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
    }
}

function startRouteChat() {
    showInfo('–°–æ–∑–¥–∞–Ω–∏–µ –æ–±—â–µ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞ ‚Äî –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
}

// Cleanup
window.addEventListener('beforeunload', () => {
    if (firebaseChat) firebaseChat.destroy();
});
</script>
{% endblock %}