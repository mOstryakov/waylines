{% extends 'base.html' %}
{% load static %}

{% block title %}Чаты - Waylines{% endblock %}

{% block extra_css %}
<style>
:root {
    --primary-blue: #1a73e8;
    --primary-dark: #0d47a1;
    --primary-light: #e8f0fe;
    --secondary-blue: #4285f4;
    --accent-blue: #8ab4f8;
    --bg-light: #f8f9fa;
    --border-light: #e0e0e0;
    --text-dark: #202124;
    --text-muted: #5f6368;
    --success: #34a853;
    --warning: #fbbc05;
    --danger: #ea4335;
}

/* Основные улучшения */
.container-fluid {
    max-width: 1400px;
}

/* Боковая панель - фиксированная высота */
.chats-sidebar {
    position: sticky;
    top: 20px;
    height: calc(100vh - 100px);
    display: flex;
    flex-direction: column;
    border-radius: 16px;
    overflow: hidden;
    background: white;
    border: 1px solid var(--border-light);
}

.profile-section {
    flex-shrink: 0;
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-light);
}

.conversations-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0;
}

.conversations-header {
    flex-shrink: 0;
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--border-light);
    background: white;
    z-index: 10;
}

.conversations-list-container {
    flex: 1;
    overflow: hidden;
    position: relative;
}

.conversations-list {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    overflow-y: auto;
    padding: 0.5rem 0;
}

/* Единые контейнеры с фиксированной высотой */
.scrollable-container {
    height: 400px;
    display: flex;
    flex-direction: column;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--border-light);
    background: white;
    margin-bottom: 1.5rem;
}

.container-header {
    flex-shrink: 0;
    padding: 1.25rem;
    border-bottom: 1px solid var(--border-light);
    background: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.container-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
}

.container-scrollable {
    flex: 1;
    overflow-y: auto;
    padding: 0 1rem;
}

/* Сетка карточек - упрощенный дизайн */
.routes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
    padding: 1rem 0;
}

.route-card-grid {
    height: 100%;
    transition: all 0.3s ease;
    border: 1px solid var(--border-light);
    border-radius: 12px;
    overflow: hidden;
    background: white;
    cursor: pointer;
    padding: 16px;
    display: flex;
    flex-direction: column;
}

.route-card-grid:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(26, 115, 232, 0.15);
    border-color: var(--primary-blue);
}

.route-card-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 12px;
}

.route-card-info {
    flex: 1;
}

.route-name {
    font-weight: 600;
    font-size: 1rem;
    color: var(--text-dark);
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.route-author {
    font-size: 0.875rem;
    color: var(--text-muted);
    display: flex;
    align-items: center;
    gap: 4px;
}

.route-status {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 4px;
    font-weight: 600;
}

.route-status.published {
    background: rgba(52, 168, 83, 0.1);
    color: var(--success);
}

.route-status.participant {
    background: rgba(66, 133, 244, 0.1);
    color: var(--primary-blue);
}

.route-status.public {
    background: rgba(251, 188, 5, 0.1);
    color: var(--warning);
}

.route-status.draft {
    background: rgba(96, 96, 96, 0.1);
    color: var(--text-muted);
}

.route-description {
    font-size: 0.875rem;
    color: var(--text-muted);
    margin-bottom: 16px;
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    flex: 1;
}

.route-meta {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-top: auto;
    padding-top: 12px;
    border-top: 1px solid var(--border-light);
}

.route-meta-item {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.75rem;
    color: var(--text-muted);
}

.route-messages {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.75rem;
    color: var(--primary-blue);
    font-weight: 500;
}

/* Элементы диалогов */
.conversation-item {
    transition: all 0.2s ease;
    border-left: 3px solid transparent;
    cursor: pointer;
    margin: 0.25rem 0.5rem;
    border-radius: 10px;
    padding: 0.75rem 1rem;
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: center;
}

.conversation-item:hover {
    background-color: var(--primary-light);
    transform: translateX(2px);
}

.conversation-item.active {
    background-color: var(--primary-light);
    border-left-color: var(--primary-blue);
    box-shadow: 0 2px 8px rgba(26, 115, 232, 0.1);
}

.conversation-item.unread {
    background-color: rgba(138, 180, 248, 0.1);
    border-left-color: var(--accent-blue);
}

/* Аватарки пользователей */
.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
    color: white;
    font-size: 14px;
    position: relative;
    margin-right: 12px;
    flex-shrink: 0;
}

.user-avatar.small {
    width: 32px;
    height: 32px;
    font-size: 12px;
}

.user-status {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    border: 2px solid white;
    background: var(--success);
}

.user-status.offline {
    background: var(--text-muted);
}

/* Текст и утилиты */
.conversation-content {
    flex: 1;
    min-width: 0;
}

.conversation-username {
    font-weight: 600;
    font-size: 0.875rem;
    color: var(--text-dark);
    margin-bottom: 2px;
}

.conversation-message {
    font-size: 0.75rem;
    color: var(--text-muted);
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
    margin-bottom: 2px;
}

.conversation-time {
    font-size: 0.7rem;
    color: var(--text-muted);
    white-space: nowrap;
}

.conversation-unread {
    background: var(--primary-blue);
    color: white;
    font-size: 0.7rem;
    font-weight: 600;
    min-width: 18px;
    height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 8px;
}

/* Поиск */
.search-box {
    position: relative;
}

.search-box .input-group-text {
    background: white;
    border: 1px solid var(--border-light);
    border-right: none;
    padding-left: 16px;
}

.search-box .form-control {
    background: white;
    border: 1px solid var(--border-light);
    border-left: none;
    padding-left: 0;
}

.search-box .form-control:focus {
    background: white;
    box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
    border-color: var(--primary-blue);
}

/* Карточки друзей */
.friends-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 1rem;
    padding: 1rem 0;
}

.friend-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1.25rem;
    border-radius: 12px;
    background: white;
    border: 1px solid var(--border-light);
    transition: all 0.3s ease;
    cursor: pointer;
    text-align: center;
}

.friend-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(26, 115, 232, 0.15);
    border-color: var(--primary-blue);
}

.friend-avatar {
    position: relative;
    margin-bottom: 12px;
}

.friend-name {
    font-weight: 600;
    font-size: 0.875rem;
    color: var(--text-dark);
    margin-bottom: 4px;
}

.friend-status {
    font-size: 0.75rem;
    color: var(--text-muted);
}

/* Заголовки секций */
.section-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-dark);
    margin-bottom: 0.5rem;
}

.section-subtitle {
    font-size: 0.875rem;
    color: var(--text-muted);
    margin-bottom: 1.5rem;
}

/* Анимации */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.fade-in {
    animation: fadeIn 0.3s ease forwards;
}

/* Кнопка нового чата в заголовке */
.header-actions {
    display: flex;
    gap: 1rem;
}

.new-chat-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1.25rem;
    background: var(--primary-blue);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s ease;
    cursor: pointer;
}

.new-chat-btn:hover {
    background: var(--primary-dark);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
}

/* Кастомные скроллбары */
::-webkit-scrollbar {
    width: 6px;
}

::-webkit-scrollbar-track {
    background: transparent;
}

::-webkit-scrollbar-thumb {
    background: #c5c5c5;
    border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
    background: #a5a5a5;
}

.container-scrollable::-webkit-scrollbar {
    width: 4px;
}

/* Адаптивность */
@media (max-width: 1200px) {
    .routes-grid {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    }
}

@media (max-width: 992px) {
    .chats-sidebar {
        height: auto;
        position: static;
        margin-bottom: 1.5rem;
    }
    
    .scrollable-container {
        height: 350px;
    }
    
    .routes-grid,
    .friends-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .scrollable-container {
        height: 300px;
    }
    
    .container-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .header-actions {
        width: 100%;
        justify-content: space-between;
    }
}

@media (max-width: 576px) {
    .section-title {
        font-size: 1.25rem;
    }
    
    .new-chat-btn {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
    }
}

/* Состояния пустоты */
.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
}

.empty-state-icon {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1.5rem;
    background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
}

.empty-state-icon i {
    color: white;
    font-size: 2rem;
}

.empty-state-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.5rem;
}

.empty-state-text {
    color: var(--text-muted);
    margin-bottom: 1.5rem;
    max-width: 400px;
    text-align: center;
}

/* Утилиты */
.text-muted {
    color: var(--text-muted) !important;
}

.badge {
    font-size: 0.75rem;
    font-weight: 600;
}

/* Секция быстрого начала чата */
.quick-chat-friends {
    padding: 1rem 0;
    border-top: 1px solid var(--border-light);
    margin-top: 1rem;
}

.quick-chat-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-muted);
    margin-bottom: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Стили для модального окна */
.modal-content {
    border: none;
    border-radius: 16px;
    overflow: hidden;
}

.modal-header {
    background: var(--primary-light);
    border-bottom: 1px solid var(--border-light);
}

.friend-item {
    margin-bottom: 0.5rem;
    border-radius: 10px;
    border: 1px solid transparent;
    transition: all 0.2s ease;
}

.friend-item:hover {
    background: var(--primary-light);
    border-color: var(--primary-blue);
}

/* Стили для поиска */
.no-results-message {
    padding: 2rem;
    text-align: center;
    color: var(--text-muted);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Заголовок страницы -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="section-title">Сообщения и чаты</h1>
            <p class="section-subtitle">Общайтесь с друзьями и обсуждайте маршруты</p>
        </div>
        <div class="header-actions">
            {% if friends %}
            <button class="new-chat-btn" data-bs-toggle="modal" data-bs-target="#newChatModal">
                <i class="fas fa-plus"></i>
                <span>Новый чат</span>
            </button>
            {% endif %}
            <a href="{% url 'all_routes' %}" class="btn btn-outline-primary rounded-pill px-4">
                <i class="fas fa-route me-1"></i>Все маршруты
            </a>
        </div>
    </div>

    <div class="row g-4">
        <!-- Боковая панель с личными сообщениями -->
        <div class="col-xl-4 col-lg-5">
            <div class="chats-sidebar">
                <!-- Профиль пользователя -->
                <div class="profile-section">
                    <div class="d-flex align-items-center mb-3">
                        <div class="position-relative me-3">
                            <div class="user-avatar">
                                {{ user.username|first|upper }}
                            </div>
                            <div class="user-status bg-success"></div>
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="mb-1 fw-bold text-dark">{{ user.username }}</h5>
                            <small class="text-success d-flex align-items-center">
                                <i class="fas fa-circle me-1" style="font-size: 8px;"></i>
                                Активен сейчас
                            </small>
                        </div>
                    </div>
                    
                    <!-- Поиск в чатах -->
                    <div class="search-box mb-3">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-0">
                                <i class="fas fa-search text-muted"></i>
                            </span>
                            <input type="text" class="form-control border-0" id="chatSearch" 
                                   placeholder="Поиск чатов и друзей...">
                        </div>
                    </div>
                </div>

                <!-- Список диалогов -->
                <div class="conversations-section">
                    <div class="conversations-header">
                        <h6 class="fw-bold mb-0 text-dark d-flex align-items-center">
                            <i class="fas fa-comments me-2" style="color: var(--primary-blue);"></i>
                            Личные сообщения
                            {% if total_unread_count > 0 %}
                            <span class="badge bg-primary ms-2">{{ total_unread_count }}</span>
                            {% endif %}
                        </h6>
                    </div>
                    
                    <div class="conversations-list-container">
                        {% if conversations_data %}
                        <div class="conversations-list" id="conversationsList">
                            <!-- Показываем все активные диалоги -->
                            {% for conv_data in conversations_data %}
                            <div class="conversation-item d-flex align-items-center {% if conv_data.unread_count > 0 %}unread{% endif %} fade-in"
                                 onclick="window.location.href='{% url 'chat:private_chat' conv_data.other_user.id %}'"
                                 data-username="{{ conv_data.other_user.username|lower }}">
                                <div class="position-relative">
                                    <div class="user-avatar small">
                                        {{ conv_data.other_user.username|first|upper }}
                                    </div>
                                    <div class="user-status {% if conv_data.is_online %}bg-success{% else %}bg-secondary offline{% endif %}"></div>
                                </div>
                                
                                <div class="conversation-content">
                                    <div class="d-flex justify-content-between align-items-start mb-1">
                                        <div class="conversation-username">{{ conv_data.other_user.username }}</div>
                                        {% if conv_data.last_message %}
                                        <div class="conversation-time">
                                            {{ conv_data.last_message.created_at|date:"H:i" }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="conversation-message">
                                            {% if conv_data.last_message %}
                                                {% if conv_data.last_message.sender == user %}
                                                    Вы: {{ conv_data.last_message.content|truncatechars:30 }}
                                                {% else %}
                                                    {{ conv_data.last_message.content|truncatechars:30 }}
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">Начать диалог</span>
                                            {% endif %}
                                        </div>
                                        {% if conv_data.unread_count > 0 %}
                                        <div class="conversation-unread">{{ conv_data.unread_count }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            
                            <!-- Если есть друзья без диалогов, показываем их как быстрый доступ -->
                            {% if friends_without_chats %}
                            <div class="quick-chat-friends">
                                <div class="quick-chat-title">Быстрый доступ</div>
                                {% for friend in friends_without_chats %}
                                <div class="conversation-item d-flex align-items-center fade-in"
                                     onclick="window.location.href='{% url 'chat:private_chat' friend.id %}'"
                                     data-username="{{ friend.username|lower }}">
                                    <div class="position-relative">
                                        <div class="user-avatar small">
                                            {{ friend.username|first|upper }}
                                        </div>
                                        <div class="user-status bg-secondary offline"></div>
                                    </div>
                                    
                                    <div class="conversation-content">
                                        <div class="conversation-username">{{ friend.username }}</div>
                                        <div class="conversation-message text-muted">
                                            Начать диалог
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        {% else %}
                        <!-- Если нет диалогов, показываем друзей как быстрый доступ -->
                        {% if friends %}
                        <div class="conversations-list" id="conversationsList">
                            <div class="quick-chat-friends">
                                <div class="quick-chat-title">Начните общение с друзьями</div>
                                {% for friend in friends|slice:":5" %}
                                <div class="conversation-item d-flex align-items-center fade-in"
                                     onclick="window.location.href='{% url 'chat:private_chat' friend.id %}'"
                                     data-username="{{ friend.username|lower }}">
                                    <div class="position-relative">
                                        <div class="user-avatar small">
                                            {{ friend.username|first|upper }}
                                        </div>
                                        <div class="user-status bg-secondary offline"></div>
                                    </div>
                                    
                                    <div class="conversation-content">
                                        <div class="conversation-username">{{ friend.username }}</div>
                                        <div class="conversation-message text-muted">
                                            Начать диалог
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <div class="empty-state" style="padding: 2rem 1rem;">
                                <p class="empty-state-text">У вас еще нет сообщений</p>
                                <button class="btn btn-primary rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#newChatModal">
                                    <i class="fas fa-plus me-1"></i>Начать чат
                                </button>
                            </div>
                        </div>
                        {% else %}
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                            <h6 class="empty-state-title">Нет сообщений</h6>
                            <p class="empty-state-text">Начните общение с друзьями</p>
                            <button class="btn btn-primary rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#newChatModal">
                                <i class="fas fa-plus me-1"></i>Начать чат
                            </button>
                        </div>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Основной контент -->
        <div class="col-xl-8 col-lg-7">
            <!-- Мои маршруты -->
            {% if user_routes_chats %}
            <div class="scrollable-container">
                <div class="container-header">
                    <h5 class="container-title">
                        <i class="fas fa-route" style="color: var(--primary-blue);"></i>
                        Мои маршруты
                        <span class="badge bg-primary ms-2">{{ user_routes_chats|length }}</span>
                    </h5>
                </div>
                
                <div class="container-scrollable">
                    <div class="routes-grid">
                        {% for chat in user_routes_chats %}
                        {% with route=chat.route %}
                        <div class="route-card-grid" 
                             onclick="window.location.href='{% url 'chat:route_chat' route.id %}'">
                            <div class="route-card-header">
                                <div class="route-card-info">
                                    <div class="route-name">
                                        {{ route.name }}
                                        {% if route.privacy == 'public' %}
                                        <span class="route-status public">Публичный</span>
                                        {% elif route.shared_with.exists %}
                                        <span class="route-status participant">Закрытый</span>
                                        {% else %}
                                        <span class="route-status draft">Черновик</span>
                                        {% endif %}
                                    </div>
                                    <div class="route-author">
                                        <i class="fas fa-user"></i>
                                        {{ route.author.username }}
                                    </div>
                                </div>
                            </div>
                            
                            {% if route.description %}
                            <div class="route-description">
                                {{ route.description|truncatechars:100 }}
                            </div>
                            {% endif %}
                            
                            <div class="route-meta">
                                <div class="route-meta-item">
                                    <i class="fas fa-calendar"></i>
                                    {{ route.created_at|date:"d.m.Y" }}
                                </div>
                                <div class="route-messages">
                                    <i class="fas fa-comment"></i>
                                    Чат маршрута
                                </div>
                            </div>
                        </div>
                        {% endwith %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Доступные маршруты -->
            {% if participant_chats or public_chats %}
            <div class="scrollable-container">
                <div class="container-header">
                    <h5 class="container-title">
                        <i class="fas fa-users" style="color: var(--success);"></i>
                        Доступные маршруты
                        <span class="badge bg-success ms-2">{{ participant_chats|length|add:public_chats|length }}</span>
                    </h5>
                </div>
                
                <div class="container-scrollable">
                    <div class="routes-grid">
                        {% for chat in participant_chats %}
                        {% with route=chat.route %}
                        <div class="route-card-grid" 
                             onclick="window.location.href='{% url 'chat:route_chat' route.id %}'">
                            <div class="route-card-header">
                                <div class="route-card-info">
                                    <div class="route-name">
                                        {{ route.name }}
                                        <span class="route-status participant">Вы участник</span>
                                    </div>
                                    <div class="route-author">
                                        <i class="fas fa-crown"></i>
                                        {{ route.author.username }}
                                    </div>
                                </div>
                            </div>
                            
                            {% if route.description %}
                            <div class="route-description">
                                {{ route.description|truncatechars:100 }}
                            </div>
                            {% endif %}
                            
                            <div class="route-meta">
                                <div class="route-meta-item">
                                    <i class="fas fa-calendar"></i>
                                    {{ route.created_at|date:"d.m.Y" }}
                                </div>
                                <div class="route-messages">
                                    <i class="fas fa-comment"></i>
                                    Чат маршрута
                                </div>
                            </div>
                        </div>
                        {% endwith %}
                        {% endfor %}
                        
                        {% for chat in public_chats %}
                        {% with route=chat.route %}
                        <div class="route-card-grid" 
                             onclick="window.location.href='{% url 'chat:route_chat' route.id %}'">
                            <div class="route-card-header">
                                <div class="route-card-info">
                                    <div class="route-name">
                                        {{ route.name }}
                                        <span class="route-status public">Публичный</span>
                                    </div>
                                    <div class="route-author">
                                        <i class="fas fa-user"></i>
                                        {{ route.author.username }}
                                    </div>
                                </div>
                            </div>
                            
                            {% if route.description %}
                            <div class="route-description">
                                {{ route.description|truncatechars:100 }}
                            </div>
                            {% endif %}
                            
                            <div class="route-meta">
                                <div class="route-meta-item">
                                    <i class="fas fa-calendar"></i>
                                    {{ route.created_at|date:"d.m.Y" }}
                                </div>
                                <div class="route-messages">
                                    <i class="fas fa-comment"></i>
                                    Чат маршрута
                                </div>
                            </div>
                        </div>
                        {% endwith %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Друзья -->
            {% if friends %}
            <div class="scrollable-container">
                <div class="container-header">
                    <h5 class="container-title">
                        <i class="fas fa-user-friends" style="color: var(--primary-blue);"></i>
                        Все друзья
                        <span class="badge bg-primary ms-2">{{ friends|length }}</span>
                    </h5>
                </div>
                
                <div class="container-scrollable">
                    <div class="friends-grid">
                        {% for friend in friends %}
                        <div class="friend-card" 
                             onclick="window.location.href='{% url 'chat:private_chat' friend.id %}'">
                            <div class="friend-avatar">
                                <div class="user-avatar">
                                    {{ friend.username|first|upper }}
                                </div>
                                <div class="user-status bg-success"></div>
                            </div>
                            <div class="friend-name">{{ friend.username }}</div>
                            <div class="friend-status">
                                <span class="text-success">Друг</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Пустое состояние -->
            {% if not user_routes_chats and not participant_chats and not public_chats and not friends %}
            <div class="scrollable-container">
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-route"></i>
                    </div>
                    <h3 class="empty-state-title">Нет доступных маршрутов</h3>
                    <p class="empty-state-text">
                        Создайте свой маршрут или присоединитесь к существующим
                    </p>
                    <div class="d-flex gap-3 justify-content-center">
                        <a href="{% url 'create_route' %}" class="btn btn-primary rounded-pill px-4">
                            <i class="fas fa-plus me-2"></i>Создать маршрут
                        </a>
                        <a href="{% url 'all_routes' %}" class="btn btn-outline-primary rounded-pill px-4">
                            <i class="fas fa-route me-2"></i>Найти маршруты
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Модальное окно нового чата -->
<div class="modal fade" id="newChatModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-3">
            <div class="modal-header border-0 p-4 pb-0">
                <h5 class="modal-title fw-bold text-dark">Новый чат</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                {% if friends %}
                <div class="search-box mb-4">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-0">
                            <i class="fas fa-search text-muted"></i>
                        </span>
                        <input type="text" class="form-control border-0" id="friendSearch" 
                               placeholder="Поиск друзей...">
                    </div>
                </div>
                
                <div class="friends-list" style="max-height: 400px; overflow-y: auto;" id="modalFriendsList">
                    {% for friend in friends %}
                    <div class="conversation-item d-flex align-items-center p-3 mb-2 rounded-3 friend-item"
                         onclick="window.location.href='{% url 'chat:private_chat' friend.id %}'"
                         style="cursor: pointer;"
                         data-username="{{ friend.username|lower }}">
                        <div class="position-relative">
                            <div class="user-avatar small">
                                {{ friend.username|first|upper }}
                            </div>
                            <div class="user-status bg-success"></div>
                        </div>
                        <div class="conversation-content">
                            <div class="conversation-username">{{ friend.username }}</div>
                            <div class="conversation-message">
                                <span class="text-success">Друг</span>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-muted ms-2"></i>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <h6 class="empty-state-title">У вас пока нет друзей</h6>
                    <p class="empty-state-text">Найдите друзей чтобы начать общение</p>
                    <a href="{% url 'find_friends' %}" class="btn btn-primary rounded-pill px-4">
                        <i class="fas fa-user-plus me-2"></i>Найти друзей
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Поиск в чатах на боковой панели
    const chatSearch = document.getElementById('chatSearch');
    if (chatSearch) {
        chatSearch.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            const conversationItems = document.querySelectorAll('#conversationsList .conversation-item');
            const noResultsMessage = document.querySelector('.no-results-message');
            
            let hasVisibleItems = false;
            
            conversationItems.forEach((item) => {
                const username = item.getAttribute('data-username');
                const usernameElement = item.querySelector('.conversation-username');
                
                if (username && username.includes(searchTerm)) {
                    item.style.display = 'flex';
                    item.classList.add('highlight-search');
                    hasVisibleItems = true;
                    
                    // Подсветка текста
                    if (usernameElement && searchTerm) {
                        const originalText = usernameElement.textContent;
                        const regex = new RegExp(`(${searchTerm})`, 'gi');
                        usernameElement.innerHTML = originalText.replace(regex, '<span class="text-primary fw-bold">$1</span>');
                    }
                } else {
                    item.style.display = 'none';
                    if (usernameElement) {
                        // Восстанавливаем оригинальный текст
                        usernameElement.innerHTML = usernameElement.textContent;
                    }
                }
            });
            
            // Показать/скрыть сообщение "не найдено"
            if (searchTerm && !hasVisibleItems) {
                if (!noResultsMessage) {
                    const conversationsList = document.querySelector('#conversationsList');
                    if (conversationsList) {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'no-results-message';
                        messageDiv.innerHTML = `
                            <div class="text-muted mb-2">
                                <i class="fas fa-search fa-lg"></i>
                            </div>
                            <p class="mb-1">Не найдено чатов по запросу</p>
                            <p class="small text-muted">"${searchTerm}"</p>
                        `;
                        conversationsList.appendChild(messageDiv);
                    }
                }
            } else if (noResultsMessage) {
                noResultsMessage.remove();
            }
        });
    }
    
    // Поиск в модальном окне друзей
    const friendSearch = document.getElementById('friendSearch');
    if (friendSearch) {
        friendSearch.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            const friendItems = document.querySelectorAll('#modalFriendsList .friend-item');
            
            friendItems.forEach((item) => {
                const username = item.getAttribute('data-username');
                const usernameElement = item.querySelector('.conversation-username');
                
                if (username && username.includes(searchTerm)) {
                    item.style.display = 'flex';
                    
                    // Подсветка текста
                    if (usernameElement && searchTerm) {
                        const originalText = usernameElement.textContent;
                        const regex = new RegExp(`(${searchTerm})`, 'gi');
                        usernameElement.innerHTML = originalText.replace(regex, '<span class="text-primary fw-bold">$1</span>');
                    }
                } else {
                    item.style.display = 'none';
                    if (usernameElement) {
                        // Восстанавливаем оригинальный текст
                        usernameElement.innerHTML = usernameElement.textContent;
                    }
                }
            });
        });
    }
    
    // Анимация для непрочитанных сообщений
    const unreadBadges = document.querySelectorAll('.conversation-unread');
    unreadBadges.forEach(badge => {
        badge.classList.add('pulse-animation');
        setTimeout(() => {
            badge.classList.remove('pulse-animation');
        }, 2000);
    });
    
    // Автоматический фокус на поиске при открытии модального окна
    const newChatModal = document.getElementById('newChatModal');
    if (newChatModal) {
        newChatModal.addEventListener('shown.bs.modal', function () {
            const friendSearch = document.getElementById('friendSearch');
            if (friendSearch) {
                setTimeout(() => {
                    friendSearch.focus();
                }, 100);
            }
        });
    }
    
    // Добавить стили для анимации
    const style = document.createElement('style');
    style.textContent = `
        .highlight-search {
            background-color: rgba(26, 115, 232, 0.1) !important;
            border-left-color: var(--primary-blue) !important;
        }
        
        .pulse-animation {
            animation: pulse 1.5s ease-in-out 3;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* Улучшенные стили для кликабельности */
        .conversation-item,
        .route-card-grid,
        .friend-card {
            cursor: pointer !important;
        }
        
        .conversation-item:hover,
        .friend-item:hover {
            background-color: var(--primary-light) !important;
        }
        
        /* Скрытие элементов при поиске */
        .search-hidden {
            display: none !important;
        }
    `;
    document.head.appendChild(style);
});
</script>
{% endblock %}