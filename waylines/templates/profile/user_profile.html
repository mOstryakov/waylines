{% extends 'base.html' %}
{% load static i18n %}

{% block title %}{% blocktrans with username=profile_user.username %}{{ username }}'s Profile - Waylines{% endblocktrans %}{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
  <div class="mb-4">
    <h1 class="h3 fw-bold mb-0">{% blocktrans with username=profile_user.username %}{{ username }}'s Profile{% endblocktrans %}</h1>
  </div>

  <div class="row g-4">
    <div class="col-xl-3 col-lg-4">
      <div class="d-flex flex-column" style="height: 100%;">
        <div class="card border-0 shadow-sm mb-3" style="height: 680px; overflow-y: auto;">
          <div class="card-body text-center p-4 d-flex flex-column">
            <div class="mb-3">
              {% if profile_user.profile.avatar %}
              <img src="{{ profile_user.profile.avatar.url }}"
                   class="rounded-circle border border-3 border-primary profile-avatar"
                   style="width: 140px; height: 140px; object-fit: cover;"
                   alt="{{ profile_user.username }}">
              {% else %}
              <div class="rounded-circle bg-light bg-gradient border border-3 border-primary d-flex align-items-center justify-content-center mx-auto profile-avatar"
                   style="width: 140px; height: 140px;">
                <i class="fas fa-user fa-4x text-primary"></i>
              </div>
              {% endif %}
            </div>

            <h3 class="card-title mb-2">{{ profile_user.get_full_name|default:profile_user.username }}</h3>
            <p class="text-muted mb-3">@{{ profile_user.username }}</p>

            {% if profile_user.profile.bio %}
            <p class="card-text text-muted mb-3">{{ profile_user.profile.bio }}</p>
            {% endif %}

            <div class="contact-info mb-3">
              {% if profile_user.profile.location %}
              <p class="mb-2">
                <i class="fas fa-map-marker-alt text-primary me-2"></i>
                <span class="text-muted">{{ profile_user.profile.location }}</span>
              </p>
              {% endif %}

              {% if profile_user.email and profile_user.profile.show_email %}
              <p class="mb-2">
                <i class="fas fa-envelope text-primary me-2"></i>
                <a href="mailto:{{ profile_user.email }}" class="text-decoration-none">{{ profile_user.email }}</a>
              </p>
              {% endif %}

              {% if profile_user.profile.phone and profile_user.profile.show_phone %}
              <p class="mb-2">
                <i class="fas fa-phone text-primary me-2"></i>
                <a href="tel:{{ profile_user.profile.phone }}" class="text-decoration-none">{{ profile_user.profile.phone }}</a>
              </p>
              {% endif %}

              {% if profile_user.profile.website %}
              <p class="mb-2">
                <i class="fas fa-globe text-primary me-2"></i>
                <a href="{{ profile_user.profile.website }}" target="_blank" class="text-decoration-none">{% trans "Website" %}</a>
              </p>
              {% endif %}
            </div>

            <div class="stats-grid mb-4">
              <div class="row g-2 text-center">
                <div class="col-4">
                  <div class="stat-item p-3 rounded bg-light">
                    <div class="h4 mb-1 text-primary fw-bold">{{ public_routes.count }}</div>
                    <small class="text-muted d-block">{% trans "Routes" %}</small>
                  </div>
                </div>
                <div class="col-4">
                  <div class="stat-item p-3 rounded bg-light">
                    <div class="h4 mb-1 text-primary fw-bold">{{ friends|length }}</div>
                    <small class="text-muted d-block">{% trans "Friends" %}</small>
                  </div>
                </div>
                <div class="col-4">
                  <div class="stat-item p-3 rounded bg-light">
                    <div class="h4 mb-1 text-primary fw-bold">{{ total_distance|floatformat:0|default:"0" }}</div>
                    <small class="text-muted d-block">{% trans "km traveled" %}</small>
                  </div>
                </div>
              </div>
            </div>

            {% if user == profile_user and private_routes.exists %}
            <div class="alert alert-warning mb-3 p-2" role="alert">
              <div class="d-flex align-items-center">
                <i class="fas fa-lock text-warning me-2 fs-5"></i>
                <div>
                  <div class="fw-bold small mb-1">{% trans "Private Routes" %}</div>
                  <div class="small">
                    {% blocktrans count count=private_routes.count %}
                      You have {{ count }} private route.
                    {% plural %}
                      You have {{ count }} private routes.
                    {% endblocktrans %}
                    <a href="{% url 'my_routes' %}" class="alert-link text-decoration-none">{% trans "View" %}</a>
                  </div>
                </div>
              </div>
            </div>
            {% endif %}

            {% if user.is_authenticated and user != profile_user %}
            <div class="d-grid gap-2 mb-3">
              {% if is_friend %}
              <div class="d-flex gap-2">
                <span class="badge bg-success bg-gradient w-100 py-2">
                  <i class="fas fa-check-circle me-1"></i> {% trans "Friend" %}
                </span>
                <form method="post" action="{% url 'remove_friend' profile_user.id %}" class="d-inline">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('{% trans "Remove from friends?" %}')">
                    <i class="fas fa-user-minus"></i>
                  </button>
                </form>
              </div>
              {% elif friend_request_sent %}
              <div class="d-flex gap-2">
                <span class="badge bg-warning bg-gradient w-100 py-2">
                  <i class="fas fa-clock me-1"></i> {% trans "Request Sent" %}
                </span>
                <form method="post" action="{% url 'cancel_friend_request' profile_user.id %}" class="d-inline">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-outline-secondary btn-sm">
                    {% trans "Cancel" %}
                  </button>
                </form>
              </div>
              {% elif friend_request_received %}
              <div class="d-flex gap-2">
                <form method="post" action="{% url 'accept_friend_request' profile_user.id %}" class="d-inline w-100">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-success w-100">
                    <i class="fas fa-check me-1"></i> {% trans "Accept Request" %}
                  </button>
                </form>
                <form method="post" action="{% url 'reject_friend_request' profile_user.id %}" class="d-inline">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-outline-danger btn-sm">
                    <i class="fas fa-times"></i>
                  </button>
                </form>
              </div>
              {% else %}
              <form method="post" action="{% url 'send_friend_request' profile_user.id %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary btn-lg w-100">
                  <i class="fas fa-user-plus me-2"></i> {% trans "Add Friend" %}
                </button>
              </form>
              {% endif %}
            </div>
            {% endif %}

            {% if user == profile_user %}
            <div class="d-grid gap-2 mb-3">
              <a href="{% url 'profile' %}" class="btn btn-primary">
                <i class="fas fa-edit me-2"></i> {% trans "Edit Profile" %}
              </a>
              <a href="{% url 'my_routes' %}" class="btn btn-outline-primary">
                <i class="fas fa-route me-2"></i> {% trans "My Routes" %}
              </a>
            </div>
            {% endif %}

            <div class="mt-auto pt-3 border-top">
              <small class="text-muted">
                <i class="fas fa-calendar-plus me-1"></i>
                {% blocktrans with date=profile_user.date_joined|date:"d.m.Y" %}Member since {{ date }}{% endblocktrans %}
              </small>
            </div>
          </div>
        </div>

        {% if friends %}
        <div class="card border-0 shadow-sm mt-2">
          <div class="card-header bg-white border-bottom py-2 px-3">
            <h6 class="card-title mb-0">
              <i class="fas fa-users text-primary me-2 fs-6"></i>
              {% blocktrans with username=profile_user.username count count=friends|length %}
                {{ username }}'s Friend
              {% plural %}
                {{ username }}'s Friends
              {% endblocktrans %}
              <span class="badge bg-primary ms-2">{{ friends|length }}</span>
            </h6>
          </div>
          <div class="card-body p-2">
            <div class="row g-1">
              {% for friend in friends|slice:":6" %}
              <div class="col-4">
                <div class="friend-card text-center p-1 rounded hover-bg">
                  <a href="{% url 'user_profile' friend.username %}" class="text-decoration-none text-dark">
                    {% if friend.profile.avatar %}
                    <img src="{{ friend.profile.avatar.url }}"
                         class="rounded-circle mb-1"
                         style="width: 40px; height: 40px; object-fit: cover;"
                         alt="{{ friend.username }}">
                    {% else %}
                    <div class="rounded-circle bg-light d-flex align-items-center justify-content-center mx-auto mb-1"
                         style="width: 40px; height: 40px;">
                      <i class="fas fa-user text-muted fs-6"></i>
                    </div>
                    {% endif %}
                    <div class="small text-truncate">@{{ friend.username|truncatechars:10 }}</div>
                  </a>
                </div>
              </div>
              {% endfor %}
            </div>

            {% if friends|length > 6 %}
            <div class="text-center mt-2">
              <a href="#" class="btn btn-outline-primary btn-sm py-1">
                {% blocktrans with count=friends|length %}Show all ({{ count }}){% endblocktrans %}
              </a>
            </div>
            {% endif %}
          </div>
        </div>
        {% endif %}
      </div>
    </div>

    <div class="col-xl-9 col-lg-8">
      {% if public_routes %}
      <div class="row g-4">
        {% for route in public_routes %}
        <div class="col-xl-4 col-lg-6 col-md-6">
          <div class="route-card-wrapper">
            {% include 'routes/partials/route_card.html' with route=route %}
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
          <div class="empty-state">
            <i class="fas fa-route fa-4x text-muted mb-4"></i>
            <h4 class="text-muted mb-3">
              {% if user == profile_user %}
              {% trans "You don't have any public routes yet" %}
              {% else %}
              {% blocktrans with username=profile_user.username %}{{ username }} hasn't published any public routes yet{% endblocktrans %}
              {% endif %}
            </h4>
            <p class="text-muted mb-4">
              {% if user == profile_user %}
              {% trans "Create your first route and share it with the community!" %}
              {% else %}
              {% trans "This user hasn't published any routes yet" %}
              {% endif %}
            </p>
            {% if user == profile_user %}
            <a href="{% url 'create_route' %}" class="btn btn-primary btn-lg">
              <i class="fas fa-plus-circle me-2"></i> {% trans "Create Route" %}
            </a>
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<style>
.container-fluid {
  max-width: 1800px;
  margin: 0 auto;
}

.profile-avatar {
  border: 4px solid var(--bs-primary);
  box-shadow: 0 4px 12px rgba(13, 110, 253, 0.2);
}

.stat-item {
  transition: all 0.3s ease;
  border: 1px solid #f1f3f4;
  min-width: 80px;
}

.stat-item:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  border-color: var(--bs-primary);
}

.friend-card {
  transition: all 0.2s ease;
  border: 1px solid #f1f3f4;
}

.friend-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 3px 6px rgba(0,0,0,0.1);
  border-color: var(--bs-primary);
  background-color: #f8f9fa;
}

.hover-bg {
  transition: background-color 0.2s ease;
}

.hover-bg:hover {
  background-color: #f8f9fa;
}

.empty-state {
  max-width: 500px;
  margin: 0 auto;
}

.alert-warning {
  background-color: rgba(255, 193, 7, 0.1);
  border: 1px solid rgba(255, 193, 7, 0.2);
  border-radius: 8px;
}

.alert-warning .alert-link {
  color: #664d03;
  text-decoration: underline;
}

.alert-warning .alert-link:hover {
  color: #523e02;
}

.route-card-wrapper {
  min-width: 280px;
  width: 100%;
  display: flex;
  justify-content: center;
}

.route-card-wrapper .card {
  width: 100%;
  min-width: 280px;
  height: 100%;
}

.row.g-4 {
  margin-right: -0.75rem;
  margin-left: -0.75rem;
}

.row.g-4 > [class*="col-"] {
  padding-right: 0.75rem;
  padding-left: 0.75rem;
  margin-bottom: 1.5rem;
}

@media (max-width: 1399px) {
  .col-xl-3 { flex: 0 0 25%; max-width: 25%; }
  .col-xl-9 { flex: 0 0 75%; max-width: 75%; }
  .stats-grid .col-4 { padding: 0 4px; }
  .stat-item { min-width: 70px; padding: 0.5rem !important; }
  .stats-grid .h4 { font-size: 1.1rem; }
  .friend-card img,
  .friend-card div[style*="width: 40px"] {
    width: 35px !important;
    height: 35px !important;
  }
}

@media (max-width: 1199px) {
  .col-xl-3 { flex: 0 0 30%; max-width: 30%; }
  .col-xl-9 { flex: 0 0 75%; max-width: 75%; }
  .col-lg-4 { flex: 0 0 40%; max-width: 40%; }
  .col-lg-8 { flex: 0 0 60%; max-width: 60%; }
}

@media (max-width: 991px) {
  .col-lg-4, .col-lg-8 {
    flex: 0 0 100%;
    max-width: 100%;
  }
  .friend-card {
    padding: 0.4rem !important;
  }
}

@media (max-width: 767px) {
  .col-md-6 {
    flex: 0 0 100%;
    max-width: 100%;
  }
  .friend-card img,
  .friend-card div[style*="width: 40px"] {
    width: 30px !important;
    height: 30px !important;
  }
  .friend-card div.small {
    font-size: 0.6rem !important;
  }
  .alert-warning {
    padding: 0.75rem;
  }
}

@media (max-width: 575px) {
  .container-fluid {
    padding-left: 1rem !important;
    padding-right: 1rem !important;
  }
  .profile-avatar {
    width: 120px !important;
    height: 120px !important;
  }
  .contact-info p {
    font-size: 0.9rem;
  }
  .stat-item {
    min-width: 60px;
    padding: 0.4rem !important;
  }
  .stats-grid .h4 {
    font-size: 1rem;
  }
  .stats-grid .col-4 {
    padding: 0 2px;
  }
  .friend-card {
    padding: 0.2rem !important;
  }
}
</style>
{% endblock %}